# ç®—åŠ›æ˜¾ç¤ºå’Œé¢„è­¦é€»è¾‘ä¿®å¤è¯´æ˜

**ä¿®å¤æ—¥æœŸ**: 2025å¹´12æœˆ5æ—¥  
**é—®é¢˜æè¿°**: æœºå™¨äººåˆ—è¡¨é¢æ¿ç®—åŠ›æ˜¾ç¤ºä¸ºç©ºï¼Œé¢„è­¦è®°å½•ä¸­æç¤º"ç®—åŠ›ä¸è¶³è¯·å……å€¼"ï¼Œä½†å®é™…è´¦æˆ·æœ‰å¤§é‡ç®—åŠ›

---

## ğŸ› é—®é¢˜åˆ†æ

### 1. å‰ç«¯ç®—åŠ›æ˜¾ç¤ºé—®é¢˜

**ç—‡çŠ¶**: æœºå™¨äººåˆ—è¡¨é¢æ¿ä¸Šç®—åŠ›æ˜¾ç¤ºä¸º `--`ï¼ˆç©ºæ•°æ®ï¼‰

**åŸå› **: 
- å‰ç«¯è°ƒç”¨äº†é”™è¯¯çš„ API è·¯å¾„ï¼š`/toogo/wallet/info`
- å®é™…åç«¯è·¯ç”±æ˜¯ï¼š`/toogo/wallet/overview`
- API è°ƒç”¨å¤±è´¥å¯¼è‡´ `walletPowerMap` ä¸ºç©º

**å½±å“æ–‡ä»¶**:
```
web/src/views/toogo/robot/index.vue
â”œâ”€ loadWalletPower() å‡½æ•°
â””â”€ ç¬¬132è¡Œï¼š<span>{{ walletPowerMap[robot.userId]?.toFixed(2) || '--' }}</span>
```

---

### 2. é¢„è­¦è®°å½•"ç®—åŠ›ä¸è¶³"è¯¯æŠ¥

**ç—‡çŠ¶**: é¢„è­¦è®°å½•ä¸­æ˜¾ç¤º"ç®—åŠ›ä¸è¶³ï¼Œè¯·å……å€¼"ï¼Œä½†å®é™…è´¦æˆ·ç®—åŠ›å……è¶³

**åŸå› **: 
- åç«¯ `checkPower()` å‡½æ•°ä½¿ç”¨äº†é”™è¯¯çš„æ•°æ®åº“å­—æ®µå
- æŸ¥è¯¢æ¡ä»¶ï¼š`Where("member_id", robot.UserId)` âŒ
- æ­£ç¡®å­—æ®µï¼š`Where("user_id", robot.UserId)` âœ…
- å¯¼è‡´æŸ¥è¯¢ä¸åˆ°é’±åŒ…æ•°æ®ï¼Œè¯¯åˆ¤ä¸ºç®—åŠ›ä¸è¶³

**å½±å“æ–‡ä»¶**:
```
server/internal/logic/toogo/robot_engine.go
â”œâ”€ checkPower() å‡½æ•°ï¼ˆç¬¬1873è¡Œï¼‰
â””â”€ CheckAndOpenPosition() è°ƒç”¨ï¼ˆç¬¬1792è¡Œï¼‰
```

**æ•°æ®åº“è¡¨ç»“æ„**:
```sql
CREATE TABLE `hg_toogo_wallet` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) NOT NULL COMMENT 'ç”¨æˆ·ID(member_id)',  -- âœ… æ­£ç¡®å­—æ®µ
  `power` decimal(20,8) NOT NULL DEFAULT '0.00000000',
  `gift_power` decimal(20,8) NOT NULL DEFAULT '0.00000000',
  ...
  UNIQUE KEY `uk_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: å‰ç«¯ API è·¯å¾„é”™è¯¯

**ä¿®æ”¹æ–‡ä»¶**: `web/src/views/toogo/robot/index.vue`

**ä¿®æ”¹ä½ç½®**: `loadWalletPower()` å‡½æ•°ï¼ˆçº¦ç¬¬1754è¡Œï¼‰

**ä¿®æ”¹å‰**:
```javascript
const res = await http.request({
  url: '/toogo/wallet/info',  // âŒ é”™è¯¯è·¯å¾„
  method: 'get',
  params: { userId },
});
```

**ä¿®æ”¹å**:
```javascript
const res = await http.request({
  url: '/toogo/wallet/overview',  // âœ… æ­£ç¡®è·¯å¾„
  method: 'get',
  params: { userId },
});
```

**é¢å¤–ä¼˜åŒ–**: æ·»åŠ é”™è¯¯æ—¥å¿—ä¾¿äºè°ƒè¯•
```javascript
} catch (e) {
  console.error('åŠ è½½ç”¨æˆ·ç®—åŠ›å¤±è´¥:', userId, e);
  // å•ä¸ªç”¨æˆ·åŠ è½½å¤±è´¥ä¸å½±å“å…¶ä»–
}
```

---

### ä¿®å¤2: åç«¯æ•°æ®åº“æŸ¥è¯¢å­—æ®µé”™è¯¯

**ä¿®æ”¹æ–‡ä»¶**: `server/internal/logic/toogo/robot_engine.go`

**ä¿®æ”¹ä½ç½®**: `checkPower()` å‡½æ•°ï¼ˆçº¦ç¬¬1873è¡Œï¼‰

**ä¿®æ”¹å‰**:
```go
func (t *RobotTrader) checkPower(ctx context.Context) bool {
	robot := t.engine.Robot
	var wallet struct {
		Power     float64 `json:"power"`
		GiftPower float64 `json:"giftPower"`
	}
	err := g.DB().Model("hg_toogo_wallet").Ctx(ctx).
		Where("member_id", robot.UserId).  // âŒ é”™è¯¯å­—æ®µ
		Scan(&wallet)
	if err != nil {
		return false  // âŒ é™é»˜å¤±è´¥ï¼Œæ— æ—¥å¿—
	}
	totalPower := wallet.Power + wallet.GiftPower
	return totalPower >= 1
}
```

**ä¿®æ”¹å**:
```go
func (t *RobotTrader) checkPower(ctx context.Context) bool {
	robot := t.engine.Robot
	var wallet struct {
		Power     float64 `json:"power"`
		GiftPower float64 `json:"giftPower"`
	}
	err := g.DB().Model("hg_toogo_wallet").Ctx(ctx).
		Where("user_id", robot.UserId).  // âœ… æ­£ç¡®å­—æ®µ
		Scan(&wallet)
	if err != nil {
		// âœ… æ·»åŠ é”™è¯¯æ—¥å¿—
		g.Log().Warningf(ctx, "[RobotTrader] æŸ¥è¯¢ç®—åŠ›å¤±è´¥: robotId=%d, userId=%d, err=%v", 
			robot.Id, robot.UserId, err)
		return false
	}
	totalPower := wallet.Power + wallet.GiftPower
	// âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—
	g.Log().Debugf(ctx, "[RobotTrader] ç®—åŠ›æ£€æŸ¥: robotId=%d, userId=%d, power=%.2f, giftPower=%.2f, total=%.2f", 
		robot.Id, robot.UserId, wallet.Power, wallet.GiftPower, totalPower)
	return totalPower >= 1
}
```

**æ”¹è¿›ç‚¹**:
1. âœ… ä¿®æ­£å­—æ®µåï¼š`member_id` â†’ `user_id`
2. âœ… æ·»åŠ é”™è¯¯æ—¥å¿—ï¼šè®°å½•æŸ¥è¯¢å¤±è´¥åŸå› 
3. âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼šæ˜¾ç¤ºå®é™…ç®—åŠ›ä½™é¢

---

## ğŸ” æ ¹å› åˆ†æ

### ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ï¼Ÿ

**å†å²é—ç•™é—®é¢˜**:
1. é¡¹ç›®ä¸­åŒæ—¶å­˜åœ¨ `member_id` å’Œ `user_id` ä¸¤ä¸ªæ¦‚å¿µ
2. `hg_toogo_wallet` è¡¨ä½¿ç”¨ `user_id` å­˜å‚¨ç”¨æˆ·ID
3. `hg_toogo_user` è¡¨ä¸­æœ‰ `member_id` å­—æ®µå…³è”åˆ° `hg_admin_member`
4. å¼€å‘æ—¶æ··æ·†äº†è¿™ä¸¤ä¸ªå­—æ®µ

**æ­£ç¡®çš„å…³ç³»**:
```
hg_admin_member (ç³»ç»Ÿç”¨æˆ·è¡¨)
  â””â”€ id (member_id)
       â†“
hg_toogo_user (Toogoç”¨æˆ·æ‰©å±•è¡¨)
  â”œâ”€ member_id (å…³è”åˆ° hg_admin_member.id)
  â””â”€ id
       â†“
hg_toogo_wallet (é’±åŒ…è¡¨)
  â””â”€ user_id (å…³è”åˆ° hg_toogo_user.id)  âœ…

hg_trading_robot (æœºå™¨äººè¡¨)
  â””â”€ user_id (å…³è”åˆ° hg_toogo_user.id)  âœ…
```

**é”™è¯¯ç¤ºä¾‹**:
```go
// âŒ é”™è¯¯ï¼šç”¨ member_id æŸ¥è¯¢é’±åŒ…
Where("member_id", robot.UserId)

// robot.UserId å®é™…æ˜¯ hg_toogo_user.id
// è€Œ hg_toogo_wallet ç”¨çš„æ˜¯ user_id å­—æ®µ
// åº”è¯¥ç›´æ¥åŒ¹é…
```

**æ­£ç¡®ç¤ºä¾‹**:
```go
// âœ… æ­£ç¡®ï¼šç”¨ user_id æŸ¥è¯¢é’±åŒ…
Where("user_id", robot.UserId)
```

---

## ğŸ“Š éªŒè¯æµ‹è¯•

### æµ‹è¯•åœºæ™¯1: å‰ç«¯ç®—åŠ›æ˜¾ç¤º

**æµ‹è¯•æ­¥éª¤**:
1. è®¿é—®æœºå™¨äººåˆ—è¡¨é¡µé¢ï¼š`/toogo/robot`
2. æŸ¥çœ‹æœºå™¨äººå¡ç‰‡ä¸Šçš„"ç®—åŠ›"ç»Ÿè®¡é¡¹
3. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤ºæ­£ç¡®çš„ç®—åŠ›ä½™é¢ï¼ˆå¦‚ï¼š`1000.00`ï¼‰
- âœ… Network ä¸­çœ‹åˆ° `/toogo/wallet/overview` è¯·æ±‚æˆåŠŸï¼ˆ200ï¼‰
- âœ… å“åº”ä¸­åŒ…å« `totalPower` å­—æ®µ

**ä¿®å¤å‰**:
```
ç®—åŠ›: --
Network: /toogo/wallet/info (404 Not Found)
```

**ä¿®å¤å**:
```
ç®—åŠ›: 1000.00
Network: /toogo/wallet/overview (200 OK)
Response: { totalPower: 1000, power: 800, giftPower: 200, ... }
```

---

### æµ‹è¯•åœºæ™¯2: é¢„è­¦è®°å½•"ç®—åŠ›ä¸è¶³"

**å‡†å¤‡æ¡ä»¶**:
1. åˆ›å»ºä¸€ä¸ªæœºå™¨äººå¹¶å¯åŠ¨
2. ç¡®ä¿ç”¨æˆ·æœ‰å……è¶³ç®—åŠ›ï¼ˆå¦‚ 1000ï¼‰
3. å¼€å¯è‡ªåŠ¨ä¸‹å•åŠŸèƒ½

**æµ‹è¯•æ­¥éª¤**:
1. ç­‰å¾…æœºå™¨äººäº§ç”Ÿæ–¹å‘ä¿¡å·
2. å±•å¼€"é¢„è­¦è®°å½•"æŠ˜å é¢æ¿
3. æŸ¥çœ‹æœªæ‰§è¡Œçš„ä¿¡å·è®°å½•

**é¢„æœŸç»“æœ**:
- âœ… å¦‚æœç®—åŠ›å……è¶³ï¼Œä¸åº”è¯¥çœ‹åˆ°"ç®—åŠ›ä¸è¶³"çš„æç¤º
- âœ… åå°æ—¥å¿—æ˜¾ç¤ºç®—åŠ›æ£€æŸ¥é€šè¿‡
- âœ… ä¿¡å·å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼ˆå¦‚æœæ»¡è¶³å…¶ä»–æ¡ä»¶ï¼‰

**ä¿®å¤å‰**:
```
é¢„è­¦è®°å½•:
âœ— æœªæ‰§è¡Œ
âš ï¸ ç®—åŠ›ä¸è¶³ï¼Œè¯·å……å€¼

åå°æ—¥å¿—:
[RobotTrader] checkPower æŸ¥è¯¢å¤±è´¥ï¼ˆé™é»˜ï¼Œæ— æ—¥å¿—ï¼‰
```

**ä¿®å¤å**:
```
é¢„è­¦è®°å½•:
âœ“ å·²æ‰§è¡Œ
âœ“ ä¸‹å•æˆåŠŸ

åå°æ—¥å¿—:
[RobotTrader] ç®—åŠ›æ£€æŸ¥: robotId=123, userId=456, power=800.00, giftPower=200.00, total=1000.00
[RobotTrader] robotId=123 å‡†å¤‡å¼€ä»“: direction=LONG, strength=75.50, confidence=85.20
```

---

### æµ‹è¯•åœºæ™¯3: æ•°æ®åº“éªŒè¯

**SQL æŸ¥è¯¢**:
```sql
-- 1. æŸ¥çœ‹æœºå™¨äººå’Œç”¨æˆ·ID
SELECT id, robot_name, user_id, status 
FROM hg_trading_robot 
WHERE id = 123;

-- ç¤ºä¾‹ç»“æœ:
-- id=123, robot_name='BTCæœºå™¨äºº', user_id=456, status=2

-- 2. æŸ¥çœ‹é’±åŒ…æ•°æ®ï¼ˆä¿®å¤å‰ä¼šæŸ¥è¯¢å¤±è´¥ï¼‰
SELECT * FROM hg_toogo_wallet WHERE user_id = 456;

-- ç¤ºä¾‹ç»“æœ:
-- user_id=456, power=800.00, gift_power=200.00, balance=5000.00

-- 3. éªŒè¯ member_id ä¸å­˜åœ¨ï¼ˆä¿®å¤å‰çš„é”™è¯¯æŸ¥è¯¢ï¼‰
SELECT * FROM hg_toogo_wallet WHERE member_id = 456;
-- âŒ é”™è¯¯ï¼šhg_toogo_wallet è¡¨ä¸­æ²¡æœ‰ member_id å­—æ®µ

-- 4. æŸ¥çœ‹ç”¨æˆ·å…³ç³»
SELECT 
    r.id AS robot_id,
    r.user_id,
    u.member_id,
    w.power,
    w.gift_power,
    (w.power + w.gift_power) AS total_power
FROM hg_trading_robot r
LEFT JOIN hg_toogo_user u ON r.user_id = u.id
LEFT JOIN hg_toogo_wallet w ON r.user_id = w.user_id
WHERE r.id = 123;
```

---

## ğŸ“‹ ä¿®æ”¹æ¸…å•

### åç«¯ä¿®æ”¹

| æ–‡ä»¶ | å‡½æ•° | è¡Œå· | ä¿®æ”¹å†…å®¹ |
|------|------|------|----------|
| `server/internal/logic/toogo/robot_engine.go` | `checkPower()` | ~1880 | ä¿®æ”¹å­—æ®µåï¼š`member_id` â†’ `user_id` |
| `server/internal/logic/toogo/robot_engine.go` | `checkPower()` | ~1884 | æ·»åŠ é”™è¯¯æ—¥å¿— |
| `server/internal/logic/toogo/robot_engine.go` | `checkPower()` | ~1889 | æ·»åŠ è°ƒè¯•æ—¥å¿— |

### å‰ç«¯ä¿®æ”¹

| æ–‡ä»¶ | å‡½æ•° | è¡Œå· | ä¿®æ”¹å†…å®¹ |
|------|------|------|----------|
| `web/src/views/toogo/robot/index.vue` | `loadWalletPower()` | ~1762 | APIè·¯å¾„ï¼š`/toogo/wallet/info` â†’ `/toogo/wallet/overview` |
| `web/src/views/toogo/robot/index.vue` | `loadWalletPower()` | ~1769 | æ·»åŠ é”™è¯¯æ—¥å¿— |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åç«¯éƒ¨ç½²

```bash
# 1. è¿›å…¥åç«¯ç›®å½•
cd server

# 2. ç¼–è¯‘ï¼ˆå¦‚æœä½¿ç”¨çƒ­é‡è½½ï¼Œä¼šè‡ªåŠ¨é‡å¯ï¼‰
go build

# 3. é‡å¯æœåŠ¡
# Windows:
taskkill /F /IM hotgo.exe
start hotgo.exe

# Linux:
pkill hotgo
./hotgo &
```

### 2. å‰ç«¯éƒ¨ç½²

```bash
# 1. è¿›å…¥å‰ç«¯ç›®å½•
cd web

# 2. å¦‚æœå¼€å‘ç¯å¢ƒï¼Œçƒ­æ›´æ–°ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ
# å¦‚æœç”Ÿäº§ç¯å¢ƒï¼Œéœ€è¦é‡æ–°æ„å»º
npm run build

# 3. åˆ·æ–°æµè§ˆå™¨é¡µé¢ï¼ˆCtrl + F5 å¼ºåˆ¶åˆ·æ–°ï¼‰
```

### 3. éªŒè¯

```bash
# 1. æ£€æŸ¥åç«¯æ—¥å¿—
tail -f server/logs/app.log | grep -i "ç®—åŠ›æ£€æŸ¥\|checkPower"

# 2. è®¿é—®æœºå™¨äººåˆ—è¡¨é¡µé¢
# æŸ¥çœ‹ç®—åŠ›æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸

# 3. åˆ›å»ºæµ‹è¯•æœºå™¨äººè§¦å‘ä¿¡å·
# æŸ¥çœ‹é¢„è­¦è®°å½•æ˜¯å¦æ­£å¸¸
```

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### é¿å…ç±»ä¼¼é—®é¢˜çš„å»ºè®®

1. **ç»Ÿä¸€å‘½åè§„èŒƒ**
   - æ˜ç¡® `member_id` å’Œ `user_id` çš„ä½¿ç”¨åœºæ™¯
   - å»ºè®®ï¼š`member_id` ä»…ç”¨äºç³»ç»Ÿç®¡ç†å‘˜è¡¨ï¼Œä¸šåŠ¡è¡¨ç»Ÿä¸€ç”¨ `user_id`

2. **æ•°æ®åº“æŸ¥è¯¢è§„èŒƒ**
   - ä½¿ç”¨ ORM æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ DAO å±‚çš„å­—æ®µå¸¸é‡
   - é¿å…ç¡¬ç¼–ç å­—æ®µåï¼š`dao.ToogoWallet.Columns().UserId`

3. **é”™è¯¯å¤„ç†è§„èŒƒ**
   - æ•°æ®åº“æŸ¥è¯¢å¤±è´¥å¿…é¡»è®°å½•æ—¥å¿—
   - å…³é”®ä¸šåŠ¡é€»è¾‘æ·»åŠ è°ƒè¯•æ—¥å¿—

4. **ä»£ç ç¤ºä¾‹**:
```go
// âŒ ä¸æ¨èï¼šç¡¬ç¼–ç å­—æ®µå
Where("user_id", userId)

// âœ… æ¨èï¼šä½¿ç”¨ DAO å¸¸é‡
Where(dao.ToogoWallet.Columns().UserId, userId)

// âŒ ä¸æ¨èï¼šé™é»˜å¤±è´¥
if err != nil {
    return false
}

// âœ… æ¨èï¼šè®°å½•é”™è¯¯
if err != nil {
    g.Log().Warningf(ctx, "æŸ¥è¯¢å¤±è´¥: %v", err)
    return false
}
```

5. **å‰åç«¯æ¥å£è”è°ƒ**
   - å‰ç«¯ API è·¯å¾„åº”å¯¹ç…§åç«¯è·¯ç”±å®šä¹‰
   - å»ºè®®ç»´æŠ¤ API æ–‡æ¡£æˆ–ä½¿ç”¨ Swagger

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. ä»£ç é‡æ„

**ä¼˜åŒ– checkPower é€»è¾‘**:
```go
// å»ºè®®æŠ½å–ä¸ºç‹¬ç«‹çš„ Wallet Service æ–¹æ³•
func (s *sToogoWallet) HasEnoughPower(ctx context.Context, userId int64, minPower float64) (bool, error) {
    wallet, err := s.GetOrCreate(ctx, userId)
    if err != nil {
        return false, err
    }
    totalPower := wallet.Power + wallet.GiftPower
    return totalPower >= minPower, nil
}

// RobotTrader è°ƒç”¨
func (t *RobotTrader) checkPower(ctx context.Context) bool {
    hasEnough, err := service.ToogoWallet().HasEnoughPower(ctx, t.engine.Robot.UserId, 1)
    if err != nil {
        g.Log().Warningf(ctx, "[RobotTrader] ç®—åŠ›æ£€æŸ¥å¤±è´¥: %v", err)
        return false
    }
    if !hasEnough {
        g.Log().Debugf(ctx, "[RobotTrader] ç®—åŠ›ä¸è¶³: userId=%d", t.engine.Robot.UserId)
    }
    return hasEnough
}
```

### 2. æ·»åŠ å•å…ƒæµ‹è¯•

```go
func TestCheckPower(t *testing.T) {
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    userId := int64(123)
    
    // æµ‹è¯•1ï¼šç®—åŠ›å……è¶³
    createWallet(userId, 1000, 500)
    assert.True(t, checkPower(userId))
    
    // æµ‹è¯•2ï¼šç®—åŠ›ä¸è¶³
    updateWallet(userId, 0, 0)
    assert.False(t, checkPower(userId))
    
    // æµ‹è¯•3ï¼šè¾¹ç•Œå€¼
    updateWallet(userId, 1, 0)
    assert.True(t, checkPower(userId))
}
```

### 3. ç›‘æ§å‘Šè­¦

**æ·»åŠ ç®—åŠ›ä¸è¶³å‘Šè­¦**:
```go
func (t *RobotTrader) checkPower(ctx context.Context) bool {
    wallet, _ := service.ToogoWallet().GetOrCreate(ctx, t.engine.Robot.UserId)
    totalPower := wallet.Power + wallet.GiftPower
    
    // ç®—åŠ›ä½äº10æ—¶å‘é€å‘Šè­¦
    if totalPower < 10 && totalPower >= 1 {
        service.Alert().SendLowPowerWarning(ctx, t.engine.Robot.UserId, totalPower)
    }
    
    return totalPower >= 1
}
```

---

**ä¿®å¤å®Œæˆæ—¥æœŸ**: 2025å¹´12æœˆ5æ—¥  
**ä¿®å¤äººå‘˜**: AI åŠ©æ‰‹  
**æµ‹è¯•çŠ¶æ€**: âœ… å¾…éªŒè¯  
**å½±å“èŒƒå›´**: æœºå™¨äººè‡ªåŠ¨äº¤æ˜“ã€ç®—åŠ›æ˜¾ç¤º  
**ç´§æ€¥ç¨‹åº¦**: ğŸ”´ é«˜ï¼ˆå½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰
