# Toogo 机器人架构与运行机制

## 一、整体架构

### 1.1 系统组成
- **后端服务**：Go 语言开发，使用 GoFrame 框架
- **前端界面**：Vue3 + Naive UI
- **数据库**：MySQL
- **定时任务**：独立运行的 cron 服务

### 1.2 核心模块
- **机器人引擎** (`internal/logic/toogo/engine.go`)：执行机器人交易逻辑
- **交易所管理器** (`internal/logic/toogo/exchange_manager.go`)：管理交易所连接（全局单例）
- **代理配置** (`internal/logic/trading/proxy_config.go`)：全局代理配置管理
- **定时任务** (`internal/crons/toogo_robot_engine.go`)：定时执行机器人逻辑

## 二、机器人运行机制

### 2.1 定时任务执行流程

```
定时任务 (每10秒)
    ↓
ToogoRobotEngine.Execute()
    ↓
service.ToogoRobot().RunRobotEngine()
    ↓
GetEngine().RunAllRobots()
    ↓
查询所有 status=2 的机器人
    ↓
并发执行每个机器人的交易逻辑
```

### 2.2 机器人状态管理

- **status=1**：未启动
- **status=2**：运行中（定时任务会执行）
- **status=3**：已暂停
- **status=4**：已停用

### 2.3 机器人执行流程（单个机器人）

```
runSingleRobot()
    ↓
1. 获取或创建 RobotRunner（缓存运行器）
    ↓
2. 获取实时行情 (GetTicker)
    ↓
3. 获取当前持仓 (GetPositions)
    ↓
4. 检查最大盈亏限制
    ↓
5. 检查现有持仓是否需要平仓（自动平仓）
    ↓
6. 分析市场生成信号 (analyzeMarket)
    ↓
7. 根据信号决定是否开仓（自动下单）
```

## 三、全局连接管理

### 3.1 ExchangeManager（交易所管理器）

**特点**：
- 单例模式，全局唯一
- 使用 `apiConfigId` 作为 key 缓存交易所实例
- 线程安全（使用 sync.RWMutex）

**连接复用**：
```go
// 第一次使用某个 API 配置时创建连接
ex, err := GetExchangeManager().GetExchangeFromConfig(ctx, apiConfig)

// 后续使用相同 API 配置时，直接返回缓存的连接
// 避免重复创建连接，提高性能
```

### 3.2 代理配置（全局）

**配置位置**：数据库 `hg_trading_proxy_config` 表
- `user_id=0` 且 `tenant_id=0` 表示全局配置
- 所有机器人共享同一个代理配置

**获取方式**：
```go
// ExchangeManager 和 Engine 都从数据库读取全局代理配置
proxyConfig := GetExchangeManager().getProxyConfig(ctx)
```

**代理类型**：
- HTTP 代理：用于 HTTP/HTTPS 请求
- SOCKS5 代理：用于需要 SOCKS5 协议的连接

## 四、业务流程

### 4.1 机器人启动流程

```
用户在前端点击"启动机器人"
    ↓
前端调用 /trading/robot/start API
    ↓
后端执行 StartRobot()
    ↓
1. 检查机器人是否存在
2. 检查用户机器人配额
3. 检查算力余额
4. 更新机器人状态为 status=2
5. 更新用户活跃机器人数量
    ↓
定时任务自动开始执行该机器人
```

### 4.2 机器人停止流程

```
用户在前端点击"停止机器人"
    ↓
前端调用 /trading/robot/stop API
    ↓
后端执行 StopRobot()
    ↓
1. 检查机器人状态
2. 更新机器人状态为 status=3
3. 更新用户活跃机器人数量
    ↓
定时任务不再执行该机器人
```

### 4.3 自动交易流程

```
定时任务执行（每10秒）
    ↓
获取实时行情
    ↓
分析市场状态（趋势/震荡/高波动/低波动）
    ↓
生成交易信号（做多/做空/无信号）
    ↓
检查是否满足开仓条件
    ↓
执行开仓/平仓操作
    ↓
记录订单和盈亏
```

## 五、关键特性

### 5.1 无需客户端连接
- 机器人运行在后端服务中
- 定时任务独立执行
- 用户关闭浏览器不影响机器人运行
- 只有启动/停止操作需要前端交互

### 5.2 全局连接复用
- 相同 API 配置的机器人共享连接
- 减少连接数，提高性能
- 代理配置全局共享

### 5.3 并发执行
- 多个机器人并发执行
- 每个机器人独立运行
- 使用 goroutine 实现并发

### 5.4 自动交易
- 自动分析市场
- 自动生成交易信号
- 自动执行开仓/平仓
- 自动止损/止盈

## 六、数据流

### 6.1 行情数据流
```
交易所 API
    ↓
ExchangeManager（缓存连接）
    ↓
GetTicker() / GetKlines()
    ↓
机器人引擎分析
    ↓
生成交易信号
```

### 6.2 订单数据流
```
机器人引擎生成信号
    ↓
检查开仓条件
    ↓
调用交易所 API 下单
    ↓
记录订单到数据库
    ↓
更新机器人盈亏
```

## 七、配置说明

### 7.1 定时任务配置
- **任务名称**：`toogo_robot_engine`
- **执行频率**：每10秒（可在数据库 `hg_sys_cron` 表中配置）
- **执行策略**：并行执行（多个机器人并发）

### 7.2 代理配置
- **配置位置**：系统配置 → 代理配置
- **作用范围**：全局（所有机器人共享）
- **配置项**：
  - 启用/禁用
  - 代理类型（HTTP/SOCKS5）
  - 代理地址（host:port）
  - 认证信息（可选）

## 八、注意事项

1. **定时任务必须运行**：机器人依赖定时任务执行，需要确保 cron 服务正常运行
2. **API 配置有效性**：机器人启动前需要确保 API 配置已测试通过
3. **算力余额**：机器人运行需要消耗算力，需要确保有足够的算力余额
4. **代理配置**：如果交易所 API 需要代理访问，需要先配置全局代理
5. **并发安全**：ExchangeManager 使用锁保证线程安全，但需要注意避免死锁

## 九、故障排查

### 9.1 机器人不执行
- 检查定时任务是否运行：`go run main.go cron`
- 检查机器人状态是否为 `status=2`
- 查看定时任务日志

### 9.2 API 连接失败
- 检查 API 配置是否正确
- 检查代理配置是否正确
- 检查网络连接

### 9.3 代理连接失败
- 检查代理服务器是否运行
- 检查代理类型是否正确（HTTP/SOCKS5）
- 检查代理地址和端口是否正确

