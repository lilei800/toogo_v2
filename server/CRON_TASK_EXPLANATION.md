# 定时任务（Cron Task）说明

## 一、什么是定时任务？

**定时任务（Cron Task）** 是一种在指定时间或间隔自动执行的任务机制。类似于：
- Windows 的"计划任务"
- Linux 的 `crontab`
- 手机的"定时提醒"

在这个项目中，定时任务用于**自动执行机器人的交易逻辑**，无需人工干预。

## 二、为什么需要定时任务？

### 2.1 机器人需要持续运行
- 机器人需要**每10秒**检查一次市场行情
- 需要实时分析市场并执行交易
- 需要自动平仓、止损、止盈

### 2.2 无需客户端连接
- 用户关闭浏览器，机器人仍然运行
- 服务器后台自动执行
- 24小时不间断运行

### 2.3 自动化交易
- 自动获取行情
- 自动分析市场
- 自动执行买卖操作

## 三、项目中的定时任务

### 3.1 机器人引擎定时任务

**任务名称**：`toogo_robot_engine`

**执行频率**：每10秒执行一次

**执行内容**：
```go
1. 查询所有 status=2（运行中）的机器人
2. 并发执行每个机器人的交易逻辑：
   - 获取实时行情
   - 获取当前持仓
   - 检查是否需要平仓
   - 分析市场生成信号
   - 根据信号执行开仓/平仓
```

**代码位置**：`internal/crons/toogo_robot_engine.go`

### 3.2 订阅检查定时任务

**任务名称**：`toogo_subscription_check`

**执行频率**：每小时执行一次

**执行内容**：
- 检查过期的订阅
- 处理订阅到期后的操作

## 四、如何启动定时任务？

### 4.1 启动方式

定时任务是一个**独立的服务**，需要单独启动：

```bash
# 方式1：直接运行
cd D:\go\src\hotgo_v2\server
go run main.go cron

# 方式2：编译后运行
go build -o hotgo.exe
./hotgo.exe cron
```

### 4.2 与主服务的关系

```
主服务 (main.go server)
    ↓
提供 Web API、前端界面
    ↓
用户可以启动/停止机器人

定时任务服务 (main.go cron)
    ↓
后台自动执行机器人逻辑
    ↓
机器人自动交易
```

**注意**：
- 主服务和定时任务服务可以运行在同一台服务器
- 也可以分开部署（分布式部署）
- 定时任务通过 TCP 与主服务通信

## 五、定时任务配置

### 5.1 数据库配置

定时任务配置存储在 `hg_sys_cron` 表中：

| 字段 | 说明 | 示例 |
|------|------|------|
| `name` | 任务名称（代码中定义） | `toogo_robot_engine` |
| `title` | 任务标题（显示名称） | `机器人引擎主循环` |
| `pattern` | Cron 表达式（执行频率） | `*/10 * * * * *` (每10秒) |
| `policy` | 执行策略 | `1` (并行执行) |
| `status` | 任务状态 | `1` (启用) / `2` (禁用) |

### 5.2 Cron 表达式格式

格式：`秒 分 时 日 月 周`

```
*/10 * * * * *  → 每10秒执行一次
0 */1 * * * *   → 每分钟执行一次
0 0 */1 * * *   → 每小时执行一次
0 0 0 * * *     → 每天0点执行
```

**机器人引擎任务**：`*/10 * * * * *` (每10秒)

### 5.3 执行策略（Policy）

| 值 | 策略 | 说明 |
|----|------|------|
| 1 | 并行执行 | 多个任务可以同时执行 |
| 2 | 单例执行 | 同一时间只能有一个任务在执行 |
| 3 | 单次执行 | 只执行一次 |
| 4 | 多次执行 | 执行指定次数后停止 |

**机器人引擎任务**：`1` (并行执行，多个机器人并发运行)

## 六、定时任务管理

### 6.1 后台管理界面

可以在后台管理界面管理定时任务：
- **路径**：系统监控 → 定时任务
- **功能**：
  - 查看所有定时任务
  - 启用/禁用任务
  - 修改执行频率
  - 查看执行日志

### 6.2 任务注册

任务在代码中注册：

```go
// internal/crons/toogo_robot_engine.go
func init() {
    cron.Register(ToogoRobotEngine)  // 注册机器人引擎任务
    cron.Register(ToogoSubscriptionCheck)  // 注册订阅检查任务
}
```

### 6.3 任务启动流程

```
1. 启动定时任务服务：go run main.go cron
    ↓
2. 加载所有注册的任务
    ↓
3. 从数据库读取任务配置（hg_sys_cron表）
    ↓
4. 根据配置启动定时任务
    ↓
5. 按照 pattern 表达式定时执行
```

## 七、机器人定时任务详解

### 7.1 执行流程

```
定时任务触发（每10秒）
    ↓
ToogoRobotEngine.Execute()
    ↓
service.ToogoRobot().RunRobotEngine()
    ↓
GetEngine().RunAllRobots()
    ↓
查询所有 status=2 的机器人
    ↓
并发执行每个机器人：
    ├─ 获取行情
    ├─ 获取持仓
    ├─ 检查平仓条件
    ├─ 分析市场
    └─ 执行交易
```

### 7.2 关键特性

1. **并发执行**：多个机器人同时运行，互不影响
2. **自动重试**：如果某次执行失败，下次定时任务会继续执行
3. **状态检查**：只执行 `status=2`（运行中）的机器人
4. **错误处理**：执行失败会记录日志，不影响其他机器人

## 八、常见问题

### 8.1 定时任务没有执行？

**检查项**：
1. 定时任务服务是否启动：`go run main.go cron`
2. 数据库中任务是否启用：`status=1`
3. 任务名称是否正确：`name='toogo_robot_engine'`
4. 查看日志：检查是否有错误信息

### 8.2 如何修改执行频率？

**方法1**：通过后台管理界面
- 系统监控 → 定时任务 → 编辑任务
- 修改 `pattern` 字段（Cron 表达式）

**方法2**：直接修改数据库
```sql
UPDATE hg_sys_cron 
SET pattern = '*/5 * * * * *'  -- 改为每5秒
WHERE name = 'toogo_robot_engine';
```

### 8.3 如何停止定时任务？

**方法1**：禁用任务（推荐）
- 后台管理界面：禁用任务
- 或数据库：`UPDATE hg_sys_cron SET status=2 WHERE name='toogo_robot_engine'`

**方法2**：停止定时任务服务
- 按 `Ctrl+C` 停止服务
- 或使用进程管理工具停止

### 8.4 定时任务和主服务的关系？

- **主服务**：处理用户请求（启动/停止机器人）
- **定时任务**：自动执行机器人逻辑
- **关系**：定时任务读取数据库中的机器人状态，自动执行

## 九、部署建议

### 9.1 单机部署

```
同一台服务器运行：
- 主服务：go run main.go server
- 定时任务：go run main.go cron
```

### 9.2 分布式部署

```
服务器A：主服务（Web API）
服务器B：定时任务服务（自动执行）
```

**优势**：
- 负载分离
- 可以独立扩展
- 定时任务故障不影响主服务

### 9.3 进程管理

**推荐使用**：
- **Supervisor**（Linux）
- **PM2**（Node.js 进程管理，也可管理 Go 进程）
- **systemd**（Linux 系统服务）

**示例（systemd）**：
```ini
[Unit]
Description=HotGo Cron Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/hotgo_v2/server
ExecStart=/path/to/hotgo cron
Restart=always

[Install]
WantedBy=multi-user.target
```

## 十、总结

**定时任务 = 自动执行机器人交易的"后台工人"**

- ✅ 每10秒自动检查并执行所有运行中的机器人
- ✅ 无需人工干预，24小时不间断运行
- ✅ 用户关闭浏览器，机器人仍然运行
- ✅ 支持并发执行，多个机器人同时运行
- ✅ 可配置执行频率和策略

**关键点**：
1. 定时任务服务必须运行，机器人才能自动交易
2. 定时任务独立于主服务，可以分开部署
3. 通过数据库配置管理任务，无需修改代码

