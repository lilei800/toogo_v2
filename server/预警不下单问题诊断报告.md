# é¢„è­¦æ˜¾ç¤º"å·²è¯»"ä½†æœªè‡ªåŠ¨ä¸‹å•é—®é¢˜è¯Šæ–­æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

**é¢„è­¦ä¿¡æ¯ï¼š**
- æ—¶é—´ï¼š14:31:14
- æ–¹å‘ï¼šåšç©º
- ä»·æ ¼ï¼š87110.70
- çŠ¶æ€ï¼š**å·²è¯»**
- çª—å£ï¼š87080.8 ~ 87190.4
- ä¿¡å·ï¼šğŸ“‰ åšç©ºä¿¡å· | å½“å‰ä»·: 87110.70 | çª—å£æœ€é«˜: 87190.40 | è·ç¦»: 79.70 | é˜ˆå€¼: 30
- **é—®é¢˜ï¼šæœ‰é¢„è­¦è®°å½•ï¼Œä½†æ²¡æœ‰æ‰§è¡Œè‡ªåŠ¨ä¸‹å•**

## ğŸ” æ ¸å¿ƒé€»è¾‘åˆ†æ

### ä¸€ã€å®Œæ•´æµç¨‹é“¾è·¯

```
ä¿¡å·æ£€æµ‹ â†’ ä¿å­˜é¢„è­¦è®°å½• â†’ åŸå­æ ‡è®°å¤„ç† â†’ æ£€æŸ¥æ¡ä»¶ â†’ æ‰§è¡Œä¸‹å•
    â†“            â†“               â†“            â†“          â†“
EvaluateWindow  saveSignal   TryAutoTrade  å„ç§æ£€æŸ¥   executeOpen
  Signal        AlertSimple  AndUpdate      é€»è¾‘
```

### äºŒã€å…³é”®ä»£ç åˆ†æ

#### 1. ä¿¡å·æ£€æµ‹ä¸è§¦å‘ï¼ˆrobot_engine.go:2988-3028ï¼‰

```go
// ä¿¡å·æ–¹å‘å˜åŒ–æ—¶æ‰è§¦å‘
if isNewDirection {
    e.LastWindowSignal = newSignal
    
    // æ£€æŸ¥å†…å­˜ç¼“å­˜æ˜¯å¦å·²æœ‰æŒä»“
    if e.HasActivePosition(positionSide) {
        // å·²æœ‰æŒä»“ï¼Œè·³è¿‡ï¼ˆä¸ä¿å­˜é¢„è­¦ï¼Œä¸è§¦å‘ä¸‹å•ï¼‰
        return
    }
    
    // ä¿å­˜é¢„è­¦è®°å½•
    logId := e.saveSignalAlertSimple(&signalCopy)  // â† å…³é”®ç‚¹1
    if logId > 0 {
        // è§¦å‘ä¸‹å•
        go func() {
            e.Trader.TryAutoTradeAndUpdate(ctx, &signalCopy, logId)
        }()
    } else {
        // âš ï¸ logId = 0ï¼Œä¿å­˜å¤±è´¥ï¼Œä¸ä¼šè§¦å‘ä¸‹å•
        g.Log().Warningf("ä¿å­˜é¢„è­¦è®°å½•å¤±è´¥")
    }
}
```

**å…³é”®ç‚¹1ï¼š** å¦‚æœ `saveSignalAlertSimple` è¿”å› 0ï¼Œåˆ™ä¸ä¼šè§¦å‘ `TryAutoTradeAndUpdate`

#### 2. ä¿å­˜é¢„è­¦è®°å½•ï¼ˆrobot_engine.go:3039-3128ï¼‰

```go
func (e *RobotEngine) saveSignalAlertSimple(signal *RobotSignal) int64 {
    data := g.Map{
        // ... å…¶ä»–å­—æ®µ
        "is_processed": 0,  // â† å…³é”®ç‚¹2ï¼šé»˜è®¤ä¸º0ï¼ˆæœªå¤„ç†ï¼‰
    }
    
    logId, err := g.DB().Model("hg_trading_signal_log").
        Ctx(ctx).Data(data).InsertAndGetId()
    
    if err != nil {
        g.Log().Warningf("ä¿å­˜ä¿¡å·é¢„è­¦å¤±è´¥: robotId=%d, err=%v", robot.Id, err)
        return 0  // â† å…³é”®ç‚¹3ï¼šå¤±è´¥è¿”å›0
    }
    
    return logId
}
```

**å…³é”®ç‚¹2ï¼š** æ–°è®°å½•çš„ `is_processed` åº”è¯¥æ˜¯ 0ï¼ˆæœªå¤„ç†ï¼‰  
**å…³é”®ç‚¹3ï¼š** å¦‚æœä¿å­˜å¤±è´¥ï¼ˆå¦‚å­—æ®µä¸å­˜åœ¨ã€ç±»å‹é”™è¯¯ï¼‰ï¼Œè¿”å› 0

#### 3. é˜²é‡å¤ä¸‹å•æ£€æŸ¥ï¼ˆrobot_engine.go:4268-4291ï¼‰

```go
func (t *RobotTrader) TryAutoTradeAndUpdate(ctx context.Context, signal *RobotSignal, logId int64) {
    // ã€åŸå­æ“ä½œã€‘æ ‡è®°ä¸ºå·²å¤„ç†
    result, err := g.DB().Model("hg_trading_signal_log").Ctx(ctx).
        Where("id", logId).
        Where("(is_processed = 0 OR is_processed IS NULL)").  // â† å…³é”®ç‚¹4
        Update(g.Map{
            "is_processed": 1,  // â† è®¾ç½®ä¸º1ï¼ˆå·²å¤„ç†/"å·²è¯»"ï¼‰
        })
    
    if err != nil {
        g.Log().Errorf("æ›´æ–°é¢„è­¦è®°å½•å¤±è´¥: %v", err)
        // âš ï¸ å³ä½¿å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œï¼ˆé¿å…å› æ•°æ®åº“é—®é¢˜å¯¼è‡´æ— æ³•ä¸‹å•ï¼‰
    } else {
        rowsAffected, _ := result.RowsAffected()
        if rowsAffected == 0 {
            // âš ï¸ å½±å“è¡Œæ•°ä¸º0ï¼šå·²è¢«å…¶ä»–goroutineå¤„ç†ï¼Œæˆ– is_processed å·²ç»æ˜¯ 1
            g.Log().Infof("é¢„è­¦è®°å½•å·²è¢«å¤„ç†ï¼Œè·³è¿‡é‡å¤ä¸‹å•")
            return  // â† å…³é”®ç‚¹5ï¼šç›´æ¥è¿”å›ï¼Œä¸ä¸‹å•
        }
    }
    
    // åç»­æ£€æŸ¥ï¼šè‡ªåŠ¨äº¤æ˜“å¼€å…³ã€æŒä»“æ£€æŸ¥ã€ä¸‹å•é”...
}
```

**å…³é”®ç‚¹4ï¼š** åªæ›´æ–° `is_processed = 0 OR NULL` çš„è®°å½•  
**å…³é”®ç‚¹5ï¼š** å¦‚æœæ›´æ–°å½±å“è¡Œæ•°ä¸º 0ï¼Œç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œåç»­ä¸‹å•é€»è¾‘

## ğŸš¨ é—®é¢˜æ ¹æºåˆ†æ

### åŸå› ä¸€ï¼šPostgreSQL å…¼å®¹æ€§é—®é¢˜ï¼ˆæœ€å¯èƒ½ï¼‰â­â­â­â­â­

**é—®é¢˜æè¿°ï¼š**
- æ‚¨æåˆ°"æ›´æ¢è¿‡ pg æ•°æ®åº“"
- `is_processed` å­—æ®µæ˜¯é€šè¿‡ MySQL è„šæœ¬æ·»åŠ çš„ï¼š

```sql
-- add_is_processed_to_signal_log.sql (MySQL è¯­æ³•)
ALTER TABLE `hg_trading_signal_log` 
ADD COLUMN `is_processed` TINYINT(1) NOT NULL DEFAULT 0;
```

**PostgreSQL å·®å¼‚ï¼š**
1. PostgreSQL æ²¡æœ‰ `TINYINT` ç±»å‹ï¼ˆåº”è¯¥ç”¨ `SMALLINT` æˆ– `BOOLEAN`ï¼‰
2. MySQL çš„åå¼•å· `` `è¡¨å` `` åœ¨ PostgreSQL ä¸­åº”è¯¥æ˜¯åŒå¼•å· `"è¡¨å"` æˆ–æ— å¼•å·
3. `CURRENT_TIMESTAMP` é»˜è®¤å€¼åœ¨ PostgreSQL ä¸­å¯èƒ½æœ‰å·®å¼‚

**å¯èƒ½å¯¼è‡´çš„é—®é¢˜ï¼š**
- âŒ `is_processed` å­—æ®µä¸å­˜åœ¨
- âŒ å­—æ®µå­˜åœ¨ä½†ç±»å‹ä¸å…¼å®¹
- âŒ å­—æ®µé»˜è®¤å€¼ä¸º `NULL` è€Œä¸æ˜¯ `0`

**éªŒè¯æ–¹æ³•ï¼š**
```sql
-- PostgreSQL æŸ¥è¯¢å­—æ®µä¿¡æ¯
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'hg_trading_signal_log' 
  AND column_name = 'is_processed';
```

### åŸå› äºŒï¼šä¿å­˜é¢„è­¦è®°å½•å¤±è´¥ï¼ˆlogId = 0ï¼‰â­â­â­â­

**è§¦å‘æ¡ä»¶ï¼š**
- PostgreSQL å­—æ®µä¸å…¼å®¹å¯¼è‡´ INSERT å¤±è´¥
- `InsertAndGetId()` å¤±è´¥è¿”å› 0
- ä»æŠ¥å‘Šç¬¬77-93è¡Œå¯çŸ¥ï¼Œä¹‹å‰ç¡®å®æœ‰ä¿å­˜å¤±è´¥çš„æƒ…å†µ

**ç»“æœï¼š**
- `logId = 0`
- ä¸ä¼šè°ƒç”¨ `TryAutoTradeAndUpdate`
- **å‰ç«¯å¯èƒ½æ˜¾ç¤º"å·²è¯»"æ˜¯å› ä¸ºå…¶ä»–åŸå› ï¼ˆè§åŸå› ä¸‰ï¼‰**

### åŸå› ä¸‰ï¼šå‰ç«¯/æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´â­â­â­

**å¯èƒ½æƒ…å†µï¼š**

1. **é‡è¯•æœºåˆ¶è§¦å‘äº†ä¸¤æ¬¡å¤„ç†ï¼š**
   - `processPendingAutoTradeSignals` ä»»åŠ¡ä¼šé‡è¯•æœªå¤„ç†çš„é¢„è­¦ï¼ˆrobot_task_manager.go:289-411ï¼‰
   - ç¬¬ä¸€æ¬¡è°ƒç”¨ `TryAutoTradeAndUpdate` æ—¶ï¼ŒåŸå­æ›´æ–°æˆåŠŸï¼ˆ`is_processed=1`ï¼Œæ˜¾ç¤º"å·²è¯»"ï¼‰
   - ä½†åç»­æ£€æŸ¥å¤±è´¥ï¼ˆè‡ªåŠ¨äº¤æ˜“å¼€å…³ã€æŒä»“æ£€æŸ¥ç­‰ï¼‰ï¼Œæ²¡æœ‰ä¸‹å•
   - ç¬¬äºŒæ¬¡é‡è¯•æ—¶ï¼Œå‘ç° `rowsAffected = 0`ï¼Œç›´æ¥è¿”å›

2. **å¹¶å‘å¤„ç†ï¼š**
   - å¤šä¸ª goroutine åŒæ—¶å¤„ç†åŒä¸€ä¸ªé¢„è­¦
   - ç¬¬ä¸€ä¸ªæˆåŠŸè®¾ç½® `is_processed=1`
   - å…¶ä»–çš„å‘ç°å·²å¤„ç†ï¼Œç›´æ¥è¿”å›

### åŸå› å››ï¼šåç»­æ£€æŸ¥å¤±è´¥ï¼ˆä¸‹å•é€»è¾‘è¢«é˜»æ­¢ï¼‰â­â­â­

å³ä½¿ `is_processed` æˆåŠŸè®¾ç½®ä¸º 1ï¼Œåç»­æ£€æŸ¥ä»å¯èƒ½é˜»æ­¢ä¸‹å•ï¼š

#### æ£€æŸ¥1ï¼šè‡ªåŠ¨äº¤æ˜“å¼€å…³ï¼ˆ4298-4306è¡Œï¼‰
```go
if autoTradeEnabled != 1 {
    // âŒ è‡ªåŠ¨äº¤æ˜“æœªå¼€å¯ï¼Œä¿å­˜å¤±è´¥æ—¥å¿—ï¼Œè¿”å›
    t.saveExecutionLog(ctx, logId, 0, "order_failed", "failed", "è‡ªåŠ¨ä¸‹å•æœªå¼€å¯", ...)
    return
}
```

#### æ£€æŸ¥2ï¼šæŒä»“æ£€æŸ¥ï¼ˆå•å‘æ¨¡å¼ï¼‰ï¼ˆ4365-4386è¡Œï¼‰
```go
if robot.DualSidePosition == 0 && hasAnyPosition {
    // âŒ å•å‘æ¨¡å¼ï¼šå·²æœ‰ä»»æ„æ–¹å‘æŒä»“ï¼Œæ‹’ç»æ–°å¼€ä»“
    reason := "å•å‘æŒä»“æ¨¡å¼ï¼šå·²æœ‰æŒä»“ï¼ŒæŒä»“å†…åªèƒ½æœ‰ä¸€å•"
    t.saveExecutionLog(ctx, logId, 0, "order_failed", "failed", reason, ...)
    return
}
```

#### æ£€æŸ¥3ï¼šæŒä»“æ£€æŸ¥ï¼ˆåŒå‘æ¨¡å¼ï¼‰ï¼ˆ4389-4406è¡Œï¼‰
```go
if robot.DualSidePosition == 1 && hasSameSidePosition {
    // âŒ åŒå‘æ¨¡å¼ï¼šåŒæ–¹å‘å·²æœ‰æŒä»“ï¼Œç¦æ­¢åŠ ä»“
    reason := "åŒå‘æŒä»“æ¨¡å¼ï¼šåŒæ–¹å‘å·²æœ‰æŒä»“ï¼Œç¦æ­¢åŠ ä»“"
    t.saveExecutionLog(ctx, logId, 0, "order_failed", "failed", reason, ...)
    return
}
```

#### æ£€æŸ¥4ï¼šä¸‹å•é”è·å–å¤±è´¥ï¼ˆ4408-4425è¡Œï¼‰
```go
locked := false
for i := 0; i < 5; i++ {
    if t.engine.orderLock.TryLock() {
        locked = true
        break
    }
    time.Sleep(10 * time.Millisecond)
}
if !locked {
    // âŒ ç³»ç»Ÿç¹å¿™ï¼Œè·å–é”è¶…æ—¶
    t.saveExecutionLog(ctx, logId, 0, "order_failed", "failed", "ç³»ç»Ÿç¹å¿™", ...)
    return
}
```

#### æ£€æŸ¥5ï¼šè·å–é”åäºŒæ¬¡æŒä»“æ£€æŸ¥ï¼ˆ4428-4491è¡Œï¼‰
- å†æ¬¡æ£€æŸ¥æŒä»“ï¼Œé˜²æ­¢å¹¶å‘ä¸‹å•

## ğŸ”§ è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥ PostgreSQL è¡¨ç»“æ„ âš¡ æœ€é‡è¦

```sql
-- 1. æŸ¥çœ‹ is_processed å­—æ®µæ˜¯å¦å­˜åœ¨åŠå…¶å±æ€§
SELECT 
    column_name, 
    data_type, 
    is_nullable, 
    column_default,
    character_maximum_length
FROM information_schema.columns
WHERE table_name = 'hg_trading_signal_log' 
  AND column_name = 'is_processed';

-- 2. å¦‚æœå­—æ®µä¸å­˜åœ¨ï¼ŒæŸ¥çœ‹è¡¨çš„æ‰€æœ‰å­—æ®µ
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'hg_trading_signal_log'
ORDER BY ordinal_position;

-- 3. æ£€æŸ¥å½“å‰é¢„è­¦è®°å½•
SELECT 
    id,
    robot_id,
    signal_type,
    current_price,
    is_processed,
    executed,
    reason,
    created_at
FROM hg_trading_signal_log
WHERE robot_id = 35  -- æ›¿æ¢ä¸ºæ‚¨çš„æœºå™¨äººID
  AND created_at >= NOW() - INTERVAL '1 hour'
ORDER BY id DESC
LIMIT 10;
```

### æ­¥éª¤2ï¼šæ£€æŸ¥äº¤æ˜“æ‰§è¡Œæ—¥å¿—

```sql
-- æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—ï¼ˆå¦‚æœæœ‰ä¿å­˜ï¼‰
SELECT 
    id,
    signal_log_id,
    robot_id,
    event_type,
    status,
    message,
    event_data,
    created_at
FROM hg_trading_execution_log
WHERE robot_id = 35  -- æ›¿æ¢ä¸ºæ‚¨çš„æœºå™¨äººID
  AND created_at >= NOW() - INTERVAL '1 hour'
ORDER BY id DESC
LIMIT 20;
```

### æ­¥éª¤3ï¼šæ£€æŸ¥æœºå™¨äººé…ç½®

```sql
-- æ£€æŸ¥æœºå™¨äººçŠ¶æ€å’Œé…ç½®
SELECT 
    id,
    name,
    symbol,
    auto_trade_enabled,      -- âš¡ è‡ªåŠ¨äº¤æ˜“å¼€å…³
    dual_side_position,      -- å•å‘/åŒå‘æ¨¡å¼
    status
FROM hg_trading_robot
WHERE id = 35;  -- æ›¿æ¢ä¸ºæ‚¨çš„æœºå™¨äººID
```

### æ­¥éª¤4ï¼šæ£€æŸ¥åº”ç”¨æ—¥å¿—

æœç´¢æ—¥å¿—ä¸­çš„å…³é”®ä¿¡æ¯ï¼š
```bash
# æœç´¢é¢„è­¦è®°å½•ä¿å­˜
grep "é¢„è­¦è®°å½•å·²ä¿å­˜" logs/

# æœç´¢ä¸‹å•å¤±è´¥åŸå› 
grep "order_failed" logs/
grep "å·²è¢«å…¶ä»–goroutineå¤„ç†" logs/

# æœç´¢è‡ªåŠ¨äº¤æ˜“æ£€æŸ¥
grep "è‡ªåŠ¨ä¸‹å•æœªå¼€å¯" logs/
grep "å•å‘æŒä»“æ¨¡å¼" logs/
grep "åŒå‘æŒä»“æ¨¡å¼" logs/
```

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¿®å¤ PostgreSQL çš„ is_processed å­—æ®µï¼ˆæ¨èï¼‰â­â­â­â­â­

#### æ–¹æ³•Aï¼šå­—æ®µä¸å­˜åœ¨ - æ·»åŠ å­—æ®µ

```sql
-- PostgreSQL ç‰ˆæœ¬ï¼šæ·»åŠ  is_processed å­—æ®µ
ALTER TABLE hg_trading_signal_log 
ADD COLUMN IF NOT EXISTS is_processed SMALLINT NOT NULL DEFAULT 0;

-- æˆ–è€…ä½¿ç”¨ BOOLEAN ç±»å‹ï¼ˆæ›´ç¬¦åˆ PostgreSQL ä¹ æƒ¯ï¼‰
ALTER TABLE hg_trading_signal_log 
ADD COLUMN IF NOT EXISTS is_processed BOOLEAN NOT NULL DEFAULT FALSE;

-- æ·»åŠ æ³¨é‡Š
COMMENT ON COLUMN hg_trading_signal_log.is_processed IS 'å·²è¯»æ ‡è¯†ï¼š0/false=æœªå¤„ç†ï¼Œ1/true=å·²å¤„ç†ï¼ˆç”¨äºé˜²æ­¢é‡å¤ä¸‹å•ï¼‰';

-- ä¸ºå·²å­˜åœ¨çš„è®°å½•è®¾ç½®é»˜è®¤å€¼
UPDATE hg_trading_signal_log 
SET is_processed = 0 
WHERE is_processed IS NULL;

-- åˆ›å»ºç´¢å¼•ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
CREATE INDEX IF NOT EXISTS idx_is_processed_robot 
ON hg_trading_signal_log(robot_id, is_processed, created_at);
```

#### æ–¹æ³•Bï¼šå­—æ®µå­˜åœ¨ä½†ç±»å‹é”™è¯¯ - ä¿®æ”¹å­—æ®µç±»å‹

```sql
-- 1. æ£€æŸ¥å½“å‰ç±»å‹
SELECT data_type FROM information_schema.columns
WHERE table_name = 'hg_trading_signal_log' AND column_name = 'is_processed';

-- 2. å¦‚æœç±»å‹ä¸å¯¹ï¼Œä¿®æ”¹ä¸º SMALLINT
ALTER TABLE hg_trading_signal_log 
ALTER COLUMN is_processed TYPE SMALLINT USING is_processed::SMALLINT;

-- 3. è®¾ç½®é»˜è®¤å€¼
ALTER TABLE hg_trading_signal_log 
ALTER COLUMN is_processed SET DEFAULT 0;

-- 4. è®¾ç½®éç©ºçº¦æŸ
ALTER TABLE hg_trading_signal_log 
ALTER COLUMN is_processed SET NOT NULL;
```

### æ–¹æ¡ˆäºŒï¼šå…¼å®¹ MySQL å’Œ PostgreSQL çš„é€šç”¨æ–¹æ¡ˆ

åˆ›å»ºæ–°çš„è¿ç§»è„šæœ¬ï¼š`add_is_processed_pg.sql`

```sql
-- ============================================================
-- PostgreSQL: ä¸º hg_trading_signal_log è¡¨æ·»åŠ  is_processed å­—æ®µ
-- ============================================================

DO $$
BEGIN
    -- æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
    IF NOT EXISTS (
        SELECT 1 
        FROM information_schema.columns 
        WHERE table_name = 'hg_trading_signal_log' 
          AND column_name = 'is_processed'
    ) THEN
        -- æ·»åŠ å­—æ®µ
        ALTER TABLE hg_trading_signal_log 
        ADD COLUMN is_processed SMALLINT NOT NULL DEFAULT 0;
        
        -- æ·»åŠ æ³¨é‡Š
        COMMENT ON COLUMN hg_trading_signal_log.is_processed 
        IS 'å·²è¯»æ ‡è¯†ï¼š0=æœªå¤„ç†ï¼Œ1=å·²å¤„ç†ï¼ˆç”¨äºé˜²æ­¢é‡å¤ä¸‹å•ï¼‰';
        
        -- åˆ›å»ºç´¢å¼•
        CREATE INDEX idx_is_processed_robot 
        ON hg_trading_signal_log(robot_id, is_processed, created_at);
        
        RAISE NOTICE 'å­—æ®µ is_processed å·²æˆåŠŸæ·»åŠ ';
    ELSE
        RAISE NOTICE 'å­—æ®µ is_processed å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ';
    END IF;
    
    -- ç¡®ä¿æ‰€æœ‰è®°å½•éƒ½æœ‰å€¼
    UPDATE hg_trading_signal_log 
    SET is_processed = 0 
    WHERE is_processed IS NULL;
    
END $$;

-- éªŒè¯å­—æ®µ
SELECT 
    column_name, 
    data_type, 
    is_nullable, 
    column_default
FROM information_schema.columns
WHERE table_name = 'hg_trading_signal_log' 
  AND column_name = 'is_processed';
```

### æ–¹æ¡ˆä¸‰ï¼šæ·»åŠ å…¶ä»–å¯èƒ½ç¼ºå¤±çš„å­—æ®µ

æ ¹æ®ä»£ç åˆ†æï¼Œå¯èƒ½è¿˜éœ€è¦è¿™äº›å­—æ®µï¼š

```sql
-- PostgreSQL: æ·»åŠ  window_min_price å’Œ window_max_price
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'hg_trading_signal_log' 
          AND column_name = 'window_min_price'
    ) THEN
        ALTER TABLE hg_trading_signal_log 
        ADD COLUMN window_min_price NUMERIC(20,8) NOT NULL DEFAULT 0;
    END IF;
    
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'hg_trading_signal_log' 
          AND column_name = 'window_max_price'
    ) THEN
        ALTER TABLE hg_trading_signal_log 
        ADD COLUMN window_max_price NUMERIC(20,8) NOT NULL DEFAULT 0;
    END IF;
    
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'hg_trading_signal_log' 
          AND column_name = 'threshold'
    ) THEN
        ALTER TABLE hg_trading_signal_log 
        ADD COLUMN threshold NUMERIC(20,8) NOT NULL DEFAULT 0;
    END IF;
    
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'hg_trading_signal_log' 
          AND column_name = 'market_state'
    ) THEN
        ALTER TABLE hg_trading_signal_log 
        ADD COLUMN market_state VARCHAR(50) NOT NULL DEFAULT '';
    END IF;
END $$;
```

### æ–¹æ¡ˆå››ï¼šä»£ç å±‚é¢å…¼å®¹ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœæ— æ³•ç«‹å³ä¿®æ”¹æ•°æ®åº“ï¼Œå¯ä»¥ä¸´æ—¶ä¿®æ”¹ä»£ç ï¼š

ä¿®æ”¹ `saveSignalAlertSimple` å‡½æ•°ï¼ˆrobot_engine.go:3095è¡Œï¼‰ï¼š

```go
// æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨ï¼ˆä»…ç¬¬ä¸€æ¬¡ï¼‰
var hasIsProcessed = true  // å…¨å±€å˜é‡

data := g.Map{
    "robot_id":         robot.Id,
    "strategy_id":      0,
    "symbol":           robot.Symbol,
    "signal_type":      signal.Direction,
    "signal_source":    "window_weighted",
    "signal_strength":  signal.Strength,
    "current_price":    signal.CurrentPrice,
    "window_min_price": signal.WindowMinPrice,
    "window_max_price": signal.WindowMaxPrice,
    "threshold":        signal.SignalThreshold,
    "market_state":     marketState,
    "risk_preference":  "",
    "target_price":     0,
    "stop_loss":        0,
    "take_profit":      0,
    "executed":         0,
    "execute_result":   "",
    "reason":           reason,
    "indicators":       "{}",
}

// ä»…åœ¨å­—æ®µå­˜åœ¨æ—¶æ·»åŠ 
if hasIsProcessed {
    data["is_processed"] = 0
}

logId, err := g.DB().Model("hg_trading_signal_log").Ctx(ctx).Data(data).InsertAndGetId()
if err != nil {
    // å¦‚æœæ˜¯å­—æ®µä¸å­˜åœ¨é”™è¯¯ï¼Œæ ‡è®°å¹¶é‡è¯•
    if strings.Contains(err.Error(), "is_processed") || 
       strings.Contains(err.Error(), "column") {
        hasIsProcessed = false
        delete(data, "is_processed")
        logId, err = g.DB().Model("hg_trading_signal_log").Ctx(ctx).Data(data).InsertAndGetId()
    }
}
```

**æ³¨æ„ï¼š** è¿™åªæ˜¯ä¸´æ—¶æ–¹æ¡ˆï¼Œæœ€å¥½è¿˜æ˜¯ä¿®å¤æ•°æ®åº“ç»“æ„ã€‚

### æ–¹æ¡ˆäº”ï¼šé‡å»ºè¡¨ç»“æ„ï¼ˆå¦‚æœå…¶ä»–æ–¹æ¡ˆéƒ½å¤±è´¥ï¼‰

```sql
-- å¤‡ä»½ç°æœ‰æ•°æ®
CREATE TABLE hg_trading_signal_log_backup AS 
SELECT * FROM hg_trading_signal_log;

-- åˆ é™¤æ—§è¡¨
DROP TABLE hg_trading_signal_log;

-- é‡æ–°åˆ›å»ºè¡¨ï¼ˆPostgreSQL ç‰ˆæœ¬ï¼‰
CREATE TABLE hg_trading_signal_log (
    id BIGSERIAL PRIMARY KEY,
    robot_id BIGINT NOT NULL DEFAULT 0,
    strategy_id BIGINT NOT NULL DEFAULT 0,
    symbol VARCHAR(50) NOT NULL DEFAULT '',
    signal_type VARCHAR(20) NOT NULL DEFAULT '',
    signal_source VARCHAR(50) NOT NULL DEFAULT '',
    signal_strength NUMERIC(10,4) NOT NULL DEFAULT 0.0000,
    current_price NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    window_min_price NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    window_max_price NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    threshold NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    market_state VARCHAR(50) NOT NULL DEFAULT '',
    risk_preference VARCHAR(50) NOT NULL DEFAULT '',
    target_price NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    stop_loss NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    take_profit NUMERIC(20,8) NOT NULL DEFAULT 0.00000000,
    executed SMALLINT NOT NULL DEFAULT 0,
    is_processed SMALLINT NOT NULL DEFAULT 0,  -- âš¡ å…³é”®å­—æ®µ
    execute_result VARCHAR(20) NOT NULL DEFAULT '',
    reason VARCHAR(500) NOT NULL DEFAULT '',
    indicators TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_robot_time ON hg_trading_signal_log(robot_id, created_at);
CREATE INDEX idx_symbol_time ON hg_trading_signal_log(symbol, created_at);
CREATE INDEX idx_signal_type ON hg_trading_signal_log(signal_type);
CREATE INDEX idx_is_processed_robot ON hg_trading_signal_log(robot_id, is_processed, created_at);

-- æ¢å¤æ•°æ®
INSERT INTO hg_trading_signal_log 
SELECT 
    id, robot_id, strategy_id, symbol, signal_type, signal_source,
    signal_strength, current_price, 
    COALESCE(window_min_price, 0), 
    COALESCE(window_max_price, 0),
    COALESCE(threshold, 0),
    COALESCE(market_state, ''),
    risk_preference, target_price, stop_loss, take_profit,
    executed, 
    0 AS is_processed,  -- é»˜è®¤ä¸º0
    execute_result, reason, indicators, created_at
FROM hg_trading_signal_log_backup;

-- é‡ç½®åºåˆ—
SELECT setval('hg_trading_signal_log_id_seq', (SELECT MAX(id) FROM hg_trading_signal_log));
```

## ğŸ“Š éªŒè¯ä¿®å¤

### 1. éªŒè¯å­—æ®µæ·»åŠ æˆåŠŸ

```sql
-- æ£€æŸ¥å­—æ®µ
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'hg_trading_signal_log' 
  AND column_name = 'is_processed';

-- åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
-- column_name  | data_type | is_nullable | column_default
-- is_processed | smallint  | NO          | 0
```

### 2. æµ‹è¯•æ’å…¥è®°å½•

```sql
-- æ’å…¥æµ‹è¯•è®°å½•
INSERT INTO hg_trading_signal_log (
    robot_id, symbol, signal_type, signal_source, 
    current_price, is_processed, reason
) VALUES (
    35, 'BTCUSDT', 'SHORT', 'window_weighted', 
    87110.70, 0, 'æµ‹è¯•è®°å½•'
) RETURNING id;

-- æŸ¥è¯¢æµ‹è¯•è®°å½•
SELECT id, robot_id, signal_type, is_processed, created_at
FROM hg_trading_signal_log
WHERE robot_id = 35
ORDER BY id DESC
LIMIT 1;

-- åˆ é™¤æµ‹è¯•è®°å½•
DELETE FROM hg_trading_signal_log WHERE robot_id = 35 AND reason = 'æµ‹è¯•è®°å½•';
```

### 3. æµ‹è¯•åŸå­æ›´æ–°

```sql
-- 1. æ’å…¥ä¸€æ¡æœªå¤„ç†è®°å½•
INSERT INTO hg_trading_signal_log (
    robot_id, symbol, signal_type, is_processed, reason
) VALUES (35, 'BTCUSDT', 'SHORT', 0, 'æµ‹è¯•åŸå­æ›´æ–°')
RETURNING id;  -- å‡è®¾è¿”å› id = 999

-- 2. æ¨¡æ‹ŸåŸå­æ›´æ–°ï¼ˆåªæ›´æ–° is_processed=0 çš„è®°å½•ï¼‰
UPDATE hg_trading_signal_log
SET is_processed = 1
WHERE id = 999 
  AND (is_processed = 0 OR is_processed IS NULL);
-- åº”è¯¥è¿”å›ï¼šUPDATE 1

-- 3. å†æ¬¡å°è¯•æ›´æ–°ï¼ˆåº”è¯¥å¤±è´¥ï¼Œå› ä¸ºå·²ç»æ˜¯ 1 äº†ï¼‰
UPDATE hg_trading_signal_log
SET is_processed = 1
WHERE id = 999 
  AND (is_processed = 0 OR is_processed IS NULL);
-- åº”è¯¥è¿”å›ï¼šUPDATE 0  â† è¡¨ç¤ºå·²è¢«å¤„ç†

-- 4. æ¸…ç†æµ‹è¯•æ•°æ®
DELETE FROM hg_trading_signal_log WHERE id = 999;
```

### 4. ç›‘æ§ä¸‹æ¬¡é¢„è­¦

ä¿®å¤åï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªé¢„è­¦ä¿¡å·ï¼Œè§‚å¯Ÿï¼š
- âœ… æ—¥å¿—ä¸­åº”è¯¥æœ‰ "é¢„è­¦è®°å½•å·²ä¿å­˜: logId=xxx"
- âœ… æ—¥å¿—ä¸­åº”è¯¥æœ‰ "é¢„è­¦è®°å½•å·²æ ‡è®°ä¸ºå·²å¤„ç†"
- âœ… å¦‚æœä¸‹å•å¤±è´¥ï¼Œæ—¥å¿—ä¸­ä¼šæœ‰å…·ä½“åŸå› ï¼ˆè‡ªåŠ¨äº¤æ˜“å¼€å…³ã€æŒä»“æ£€æŸ¥ç­‰ï¼‰
- âœ… å¯ä»¥åœ¨ `hg_trading_execution_log` è¡¨ä¸­æŸ¥çœ‹å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—

## ğŸ¯ æ€»ç»“

### æœ€å¯èƒ½çš„åŸå› ï¼ˆæŒ‰æ¦‚ç‡æ’åºï¼‰

1. **â­â­â­â­â­ PostgreSQL çš„ `is_processed` å­—æ®µä¸å­˜åœ¨æˆ–ç±»å‹é”™è¯¯**
   - å¯¼è‡´ä¿å­˜é¢„è­¦è®°å½•å¤±è´¥ï¼ˆlogId=0ï¼‰
   - æˆ–å¯¼è‡´åŸå­æ›´æ–°å¤±è´¥
   
2. **â­â­â­â­ è‡ªåŠ¨äº¤æ˜“å¼€å…³æœªå¼€å¯**
   - `is_processed` æˆåŠŸè®¾ç½®ä¸º 1ï¼ˆæ˜¾ç¤º"å·²è¯»"ï¼‰
   - ä½†åç»­æ£€æŸ¥å‘ç° `auto_trade_enabled != 1`ï¼Œæ‹’ç»ä¸‹å•
   
3. **â­â­â­ å·²æœ‰æŒä»“ï¼Œè¢«æŒä»“æ£€æŸ¥é˜»æ­¢**
   - å•å‘æ¨¡å¼ï¼šå·²æœ‰ä»»æ„æ–¹å‘æŒä»“
   - åŒå‘æ¨¡å¼ï¼šåŒæ–¹å‘å·²æœ‰æŒä»“ï¼ˆç¦æ­¢åŠ ä»“ï¼‰
   
4. **â­â­ å¹¶å‘é‡å¤å¤„ç†**
   - é‡è¯•æœºåˆ¶æˆ–å¹¶å‘å¯¼è‡´åŒä¸€é¢„è­¦è¢«å¤šæ¬¡å¤„ç†
   - ç¬¬ä¸€æ¬¡è®¾ç½® `is_processed=1`ï¼Œç¬¬äºŒæ¬¡å‘ç°å·²å¤„ç†ï¼Œè·³è¿‡

### å»ºè®®æ“ä½œé¡ºåº

1. **ç«‹å³æ‰§è¡Œï¼š** æ£€æŸ¥ PostgreSQL è¡¨ç»“æ„ï¼ˆæ­¥éª¤1ï¼‰
2. **å¦‚æœå­—æ®µç¼ºå¤±ï¼š** æ‰§è¡Œæ–¹æ¡ˆä¸€æˆ–æ–¹æ¡ˆäºŒæ·»åŠ å­—æ®µ
3. **éªŒè¯ä¿®å¤ï¼š** æ‰§è¡ŒéªŒè¯æ­¥éª¤
4. **æ£€æŸ¥é…ç½®ï¼š** ç¡®è®¤è‡ªåŠ¨äº¤æ˜“å¼€å…³å’ŒæŒä»“çŠ¶æ€ï¼ˆæ­¥éª¤2-3ï¼‰
5. **ç›‘æ§æ—¥å¿—ï¼š** ç­‰å¾…ä¸‹ä¸€ä¸ªä¿¡å·ï¼Œè§‚å¯Ÿå®Œæ•´æµç¨‹

### é¢„æœŸç»“æœ

ä¿®å¤åï¼Œæ— è®ºä¸‹å•æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½åº”è¯¥åœ¨ `hg_trading_execution_log` è¡¨ä¸­çœ‹åˆ°è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ï¼ŒåŒ…æ‹¬ï¼š
- `event_type`: order_success / order_failed
- `status`: success / failed
- `message`: å…·ä½“çš„æˆåŠŸ/å¤±è´¥åŸå› 
- `event_data`: å®Œæ•´çš„å‚æ•°ä¿¡æ¯ï¼ˆJSON æ ¼å¼ï¼‰

è¿™æ ·å°±èƒ½å‡†ç¡®å®šä½é—®é¢˜æ‰€åœ¨äº†ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š** 2025-12-23  
**ç‰ˆæœ¬ï¼š** v1.0  
**çŠ¶æ€ï¼š** å¾…éªŒè¯

