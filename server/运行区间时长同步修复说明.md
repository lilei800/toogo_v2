# è¿è¡ŒåŒºé—´æ—¶é•¿åŒæ­¥ä¿®å¤è¯´æ˜

## ğŸ“ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š"é’±åŒ…--äº¤æ˜“æ˜ç»†"é¡µé¢ä¸­çš„**è¿è¡ŒåŒºé—´å’Œç»“æŸæ—¶é—´åŒæ­¥æœ‰è¯¯ï¼Œè¿è¡Œæ—¶é•¿è¦åŒ…æ‹¬è¿è¡Œä¸­çš„æ—¶é—´**

## ğŸ” é—®é¢˜åˆ†æ

### åŸæœ‰é—®é¢˜

1. **æœºå™¨äººå¯åŠ¨æ—¶æœªåˆ›å»ºè¿è¡ŒåŒºé—´è®°å½•**
   - `StartRobot` å‡½æ•°åªæ›´æ–°äº†æœºå™¨äººçŠ¶æ€ï¼Œæ²¡æœ‰åˆ›å»º `hg_trading_robot_run_session` è®°å½•
   - è¿è¡ŒåŒºé—´è®°å½•ä¾èµ– `RunSessionSummaryList` è‡ªåŠ¨è¡¥æ’ï¼Œå¯¼è‡´æ—¶æœºä¸å‡†ç¡®

2. **åŒæ­¥åŠŸèƒ½æœªæ›´æ–°è¿è¡Œæ—¶é•¿**
   - `SyncRunSession` å‡½æ•°åªåŒæ­¥äº† `total_pnl`ã€`total_fee`ã€`trade_count`
   - æ²¡æœ‰æ›´æ–° `runtime_seconds` å­—æ®µ
   - å¯¼è‡´å·²ç»“æŸåŒºé—´çš„è¿è¡Œæ—¶é•¿å¯èƒ½ä¸º0æˆ–ä¸å‡†ç¡®

3. **è¿è¡Œä¸­åŒºé—´çš„è¿è¡Œæ—¶é•¿è®¡ç®—ä¸ä¸€è‡´**
   - åˆ—è¡¨æŸ¥è¯¢æ—¶ä½¿ç”¨å®æ—¶è®¡ç®—ï¼ˆæ­£ç¡®ï¼‰
   - ä½†åœæ­¢æ—¶å¯èƒ½æ²¡æœ‰æ­£ç¡®ä¿å­˜ï¼ˆå·²ä¿®å¤ï¼‰

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æœºå™¨äººå¯åŠ¨æ—¶åˆ›å»ºè¿è¡ŒåŒºé—´è®°å½•

**æ–‡ä»¶**: `internal/logic/toogo/robot.go`  
**å‡½æ•°**: `StartRobot`  
**ä¿®æ”¹ä½ç½®**: ç¬¬84-100è¡Œ

```go
// æ›´æ–°æœºå™¨äººçŠ¶æ€å’Œå¯åŠ¨æ—¶é—´
now := gtime.Now()
_, err = dao.TradingRobot.Ctx(ctx).Where(dao.TradingRobot.Columns().Id, in.RobotId).Data(g.Map{
    "status":     2,   // è¿è¡Œä¸­
    "start_time": now, // è®°å½•å¯åŠ¨æ—¶é—´
}).Update()

// åˆ›å»ºè¿è¡ŒåŒºé—´è®°å½•
_, err = dao.TradingRobotRunSession.Ctx(ctx).Data(g.Map{
    "robot_id":   robot.Id,
    "user_id":    robot.UserId,
    "exchange":   robot.Exchange,
    "symbol":     robot.Symbol,
    "start_time": now,
    // end_time ä¸º NULL è¡¨ç¤ºè¿è¡Œä¸­
}).Insert()
```

**ä¼˜åŠ¿**:
- âœ… å¯åŠ¨æ—¶ç«‹å³åˆ›å»ºè®°å½•ï¼Œæ—¶é—´æ›´å‡†ç¡®
- âœ… é¿å…ä¾èµ–åç»­çš„è‡ªåŠ¨è¡¥æ’é€»è¾‘
- âœ… æ¯æ¬¡å¯åŠ¨éƒ½ä¼šåˆ›å»ºæ–°çš„è¿è¡ŒåŒºé—´

### 2. åŒæ­¥åŠŸèƒ½æ­£ç¡®æ›´æ–°è¿è¡Œæ—¶é•¿

**æ–‡ä»¶**: `internal/logic/toogo/wallet.go`  
**å‡½æ•°**: `SyncRunSession`  
**ä¿®æ”¹ä½ç½®**: ç¬¬1872-1913è¡Œ

```go
// è®¡ç®—è¿è¡Œæ—¶é•¿
var runtimeSeconds int
if session.StartTime != nil && !session.StartTime.IsZero() {
    if session.EndTime != nil && !session.EndTime.IsZero() {
        // å·²ç»“æŸçš„åŒºé—´ï¼šè®¡ç®—start_timeåˆ°end_timeçš„æ—¶é•¿
        runtimeSeconds = int(session.EndTime.Sub(session.StartTime).Seconds())
    } else {
        // è¿è¡Œä¸­çš„åŒºé—´ï¼šè®¡ç®—start_timeåˆ°ç°åœ¨çš„æ—¶é•¿
        runtimeSeconds = int(gtime.Now().Sub(session.StartTime).Seconds())
    }
}

// æ›´æ–°åŒºé—´è®°å½•
updateData := g.Map{
    "total_pnl":   totalPnl,
    "total_fee":   totalFee,
    "trade_count": tradeCount,
    "synced_at":   gtime.Now(),
}

// æ›´æ–°è¿è¡Œæ—¶é•¿ï¼ˆåªåœ¨æœ‰æ•ˆæ—¶æ›´æ–°ï¼‰
if runtimeSeconds > 0 {
    updateData["runtime_seconds"] = runtimeSeconds
}
```

**ä¼˜åŠ¿**:
- âœ… å·²ç»“æŸåŒºé—´ï¼šä» `start_time` å’Œ `end_time` è®¡ç®—å‡†ç¡®æ—¶é•¿
- âœ… è¿è¡Œä¸­åŒºé—´ï¼šä» `start_time` åˆ°å½“å‰æ—¶é—´è®¡ç®—å®æ—¶æ—¶é•¿
- âœ… é¿å…è¿è¡Œæ—¶é•¿ä¸º0æˆ–ä¸å‡†ç¡®çš„æƒ…å†µ

### 3. åœæ­¢æ—¶æ­£ç¡®ä¿å­˜è¿è¡Œæ—¶é•¿

**æ–‡ä»¶**: 
- `internal/logic/toogo/robot.go` - `StopRobot` (ç¬¬128-157è¡Œ)
- `internal/logic/toogo/robot_task_manager.go` - `StopRobot` (ç¬¬684-719è¡Œ)

```go
// æŸ¥è¯¢å½“å‰è¿è¡Œä¸­çš„åŒºé—´
var session *entity.TradingRobotRunSession
err = dao.TradingRobotRunSession.Ctx(ctx).
    Where(dao.TradingRobotRunSession.Columns().RobotId, robotId).
    WhereNull(dao.TradingRobotRunSession.Columns().EndTime).
    Scan(&session)

if err == nil && session != nil && session.StartTime != nil {
    // è®¡ç®—è¿è¡Œæ—¶é•¿ï¼ˆç§’ï¼‰
    now := gtime.Now()
    runtimeSeconds := int(now.Sub(session.StartTime).Seconds())
    
    // æ›´æ–°è¿è¡ŒåŒºé—´
    _, updateErr := dao.TradingRobotRunSession.Ctx(ctx).
        Where(dao.TradingRobotRunSession.Columns().Id, session.Id).
        Data(g.Map{
            "end_time":        now,
            "end_reason":      "stop",
            "runtime_seconds": runtimeSeconds,
        }).Update()
}
```

**ä¼˜åŠ¿**:
- âœ… åœæ­¢æ—¶ç«‹å³è®¡ç®—å¹¶ä¿å­˜è¿è¡Œæ—¶é•¿
- âœ… ç¡®ä¿å·²ç»“æŸåŒºé—´çš„æ—¶é•¿æ•°æ®å®Œæ•´
- âœ… è®°å½•åœæ­¢åŸå› ï¼ˆstop/pause/auto_stop/errorï¼‰

## ğŸ“Š æ•°æ®æµè¯´æ˜

### å®Œæ•´çš„è¿è¡ŒåŒºé—´ç”Ÿå‘½å‘¨æœŸ

```
1. ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨"
   â†“
2. StartRobot() æ‰§è¡Œ
   â”œâ”€ æ›´æ–° hg_trading_robot.status = 2 (è¿è¡Œä¸­)
   â”œâ”€ æ›´æ–° hg_trading_robot.start_time = now
   â””â”€ åˆ›å»º hg_trading_robot_run_session è®°å½•
      â””â”€ start_time = now
      â””â”€ end_time = NULL (è¿è¡Œä¸­)
      â””â”€ runtime_seconds = 0

3. æœºå™¨äººè¿è¡Œä¸­
   â”œâ”€ é¡µé¢æŸ¥è¯¢æ—¶å®æ—¶è®¡ç®—ï¼šruntime = now - start_time
   â””â”€ ç”¨æˆ·å¯ç‚¹å‡»"åŒæ­¥"æŒ‰é’®

4. ç”¨æˆ·ç‚¹å‡»"åŒæ­¥"
   â†“
5. SyncRunSession() æ‰§è¡Œ
   â”œâ”€ ä»äº¤æ˜“æ‰€è·å–æˆäº¤æ•°æ®
   â”œâ”€ è®¡ç®— runtime_seconds (è€ƒè™‘æ˜¯å¦å·²ç»“æŸ)
   â””â”€ æ›´æ–° hg_trading_robot_run_session
      â”œâ”€ total_pnl, total_fee, trade_count
      â”œâ”€ runtime_seconds âœ… æ–°å¢
      â””â”€ synced_at = now

6. ç”¨æˆ·ç‚¹å‡»"åœæ­¢"
   â†“
7. StopRobot() æ‰§è¡Œ
   â”œâ”€ æ›´æ–° hg_trading_robot.status = 3 (æš‚åœ)
   â””â”€ æ›´æ–° hg_trading_robot_run_session
      â”œâ”€ end_time = now âœ…
      â”œâ”€ end_reason = "stop"
      â””â”€ runtime_seconds = end_time - start_time âœ…

8. é¡µé¢æ˜¾ç¤ºå·²ç»“æŸåŒºé—´
   â”œâ”€ ä½¿ç”¨æ•°æ®åº“ä¸­çš„ runtime_seconds
   â””â”€ æ˜¾ç¤ºä¸º "Xå¤©Xå°æ—¶Xåˆ†é’Ÿ" æ ¼å¼
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

| åœºæ™¯ | é—®é¢˜ |
|------|------|
| å¯åŠ¨æœºå™¨äºº | âŒ ä¸ä¼šç«‹å³åˆ›å»ºè¿è¡ŒåŒºé—´è®°å½• |
| è¿è¡Œä¸­æŸ¥è¯¢ | âœ… èƒ½å®æ—¶è®¡ç®—è¿è¡Œæ—¶é•¿ |
| ç‚¹å‡»åŒæ­¥ | âŒ ä¸ä¼šæ›´æ–° runtime_seconds |
| åœæ­¢æœºå™¨äºº | âœ… ä¼šä¿å­˜ runtime_seconds |
| å·²ç»“æŸåŒºé—´ | âš ï¸ å¯èƒ½æ˜¾ç¤ºä¸º0æˆ–ä¸å‡†ç¡® |

### ä¿®å¤å

| åœºæ™¯ | æ•ˆæœ |
|------|------|
| å¯åŠ¨æœºå™¨äºº | âœ… ç«‹å³åˆ›å»ºè¿è¡ŒåŒºé—´è®°å½• |
| è¿è¡Œä¸­æŸ¥è¯¢ | âœ… å®æ—¶è®¡ç®—è¿è¡Œæ—¶é•¿ |
| ç‚¹å‡»åŒæ­¥ | âœ… æ­£ç¡®æ›´æ–° runtime_seconds |
| åœæ­¢æœºå™¨äºº | âœ… æ­£ç¡®ä¿å­˜ runtime_seconds |
| å·²ç»“æŸåŒºé—´ | âœ… æ˜¾ç¤ºå‡†ç¡®çš„è¿è¡Œæ—¶é•¿ |

## ğŸ”„ å…¼å®¹æ€§è¯´æ˜

### å†å²æ•°æ®å¤„ç†

å¯¹äºä¿®å¤å‰å·²å­˜åœ¨çš„è¿è¡ŒåŒºé—´è®°å½•ï¼š

1. **è¿è¡Œä¸­çš„åŒºé—´**
   - é¡µé¢æŸ¥è¯¢æ—¶ä½¿ç”¨å®æ—¶è®¡ç®—ï¼š`runtime = now - start_time`
   - ç‚¹å‡»"åŒæ­¥"åä¼šè‡ªåŠ¨è¡¥å…¨ `runtime_seconds`
   - åœæ­¢æ—¶ä¼šæ­£ç¡®ä¿å­˜æœ€ç»ˆçš„ `runtime_seconds`

2. **å·²ç»“æŸçš„åŒºé—´ï¼ˆruntime_seconds = 0ï¼‰**
   - å¦‚æœ `start_time` å’Œ `end_time` éƒ½å­˜åœ¨ï¼Œç‚¹å‡»"åŒæ­¥"ä¼šè‡ªåŠ¨è®¡ç®—å¹¶æ›´æ–°
   - å…¬å¼ï¼š`runtime_seconds = end_time - start_time`

3. **æ²¡æœ‰ start_time çš„è®°å½•**
   - è¿™ç§æƒ…å†µå¾ˆå°‘è§ï¼Œå±äºå¼‚å¸¸æ•°æ®
   - å»ºè®®æ‰‹åŠ¨æ¸…ç†æˆ–è¡¥å…¨

### æ•°æ®åº“è¡¨ç»“æ„

æ— éœ€ä¿®æ”¹ï¼Œä½¿ç”¨ç°æœ‰å­—æ®µï¼š

```sql
hg_trading_robot_run_session:
  - start_time TIMESTAMP        -- å¯åŠ¨æ—¶é—´
  - end_time TIMESTAMP          -- ç»“æŸæ—¶é—´ï¼ˆNULLè¡¨ç¤ºè¿è¡Œä¸­ï¼‰
  - runtime_seconds INT         -- è¿è¡Œæ—¶é•¿ï¼ˆç§’ï¼‰
  - end_reason VARCHAR          -- ç»“æŸåŸå› 
  - total_pnl DECIMAL           -- æ€»ç›ˆäº
  - total_fee DECIMAL           -- æ€»æ‰‹ç»­è´¹
  - trade_count INT             -- æˆäº¤ç¬”æ•°
  - synced_at TIMESTAMP         -- æœ€ååŒæ­¥æ—¶é—´
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å¯åŠ¨æ–°æœºå™¨äºº

```bash
# é¢„æœŸç»“æœï¼š
# - hg_trading_robot.status = 2
# - hg_trading_robot.start_time = å½“å‰æ—¶é—´
# - hg_trading_robot_run_session æ–°å¢ä¸€æ¡è®°å½•
#   - start_time = å½“å‰æ—¶é—´
#   - end_time = NULL
#   - runtime_seconds = 0
```

### 2. æŸ¥è¯¢è¿è¡Œä¸­çš„åŒºé—´

```bash
# é¢„æœŸç»“æœï¼š
# - è¿è¡Œæ—¶é•¿ = å½“å‰æ—¶é—´ - start_time
# - æ˜¾ç¤ºæ ¼å¼ï¼šå¦‚ "2å°æ—¶35åˆ†é’Ÿ"
# - çŠ¶æ€æ˜¾ç¤º"è¿è¡Œä¸­"
```

### 3. ç‚¹å‡»åŒæ­¥æŒ‰é’®

```bash
# é¢„æœŸç»“æœï¼š
# - total_pnl, total_fee, trade_count æ­£å¸¸æ›´æ–°
# - runtime_seconds æ›´æ–°ä¸ºå®æ—¶è®¡ç®—å€¼
# - synced_at æ›´æ–°ä¸ºå½“å‰æ—¶é—´
# - æ—¥å¿—è¾“å‡ºï¼šåŒæ­¥è¿è¡ŒåŒºé—´æˆåŠŸ: sessionId=X, runtime=XXXs, pnl=X.XX, fee=X.XX, trades=X
```

### 4. åœæ­¢æœºå™¨äºº

```bash
# é¢„æœŸç»“æœï¼š
# - hg_trading_robot.status = 3
# - hg_trading_robot_run_session æ›´æ–°
#   - end_time = å½“å‰æ—¶é—´
#   - end_reason = "stop"
#   - runtime_seconds = end_time - start_time
# - æ—¥å¿—è¾“å‡ºï¼šè¿è¡ŒåŒºé—´å·²ç»“æŸ: robotId=X, sessionId=X, runtime=XXXs
```

### 5. æŸ¥è¯¢å·²ç»“æŸçš„åŒºé—´

```bash
# é¢„æœŸç»“æœï¼š
# - è¿è¡Œæ—¶é•¿ = æ•°æ®åº“ä¸­çš„ runtime_seconds
# - æ˜¾ç¤ºæ ¼å¼ï¼šå¦‚ "1å¤©5å°æ—¶20åˆ†é’Ÿ"
# - çŠ¶æ€æ˜¾ç¤º"å·²ç»“æŸ"
# - ç»“æŸæ—¶é—´æ­£ç¡®æ˜¾ç¤º
```

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **è¿è¡Œä¸­åŒºé—´çš„è¿è¡Œæ—¶é•¿æ˜¯åŠ¨æ€çš„**
   - æ¯æ¬¡æŸ¥è¯¢éƒ½ä¼šé‡æ–°è®¡ç®—
   - ä¸ä¼šä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå› ä¸ºè¿˜åœ¨è¿è¡Œï¼‰
   - åªåœ¨åœæ­¢æˆ–åŒæ­¥æ—¶ä¿å­˜å¿«ç…§

2. **åŒæ­¥æ“ä½œä¸ä¼šä¿®æ”¹ end_time**
   - åªæ›´æ–°ç›ˆäºã€æ‰‹ç»­è´¹ã€æˆäº¤ç¬”æ•°å’Œè¿è¡Œæ—¶é•¿
   - è¿è¡Œä¸­çš„åŒºé—´åŒæ­¥åä»ç„¶æ˜¯è¿è¡Œä¸­
   - end_time åªåœ¨åœæ­¢æ—¶è®¾ç½®

3. **è¿è¡Œæ—¶é•¿çš„ç²¾åº¦**
   - ä¿å­˜åˆ°æ•°æ®åº“ï¼šç§’çº§ç²¾åº¦ï¼ˆINTï¼‰
   - é¡µé¢æ˜¾ç¤ºï¼šè½¬æ¢ä¸º"Xå¤©Xå°æ—¶Xåˆ†é’Ÿ"æ ¼å¼
   - ä¸è¶³1åˆ†é’Ÿæ˜¾ç¤ºä¸º"Xç§’"

4. **å¤šæ¬¡å¯åŠ¨çš„åŒºé—´å¤„ç†**
   - æ¯æ¬¡å¯åŠ¨éƒ½ä¼šåˆ›å»ºæ–°çš„è¿è¡ŒåŒºé—´è®°å½•
   - å†å²åŒºé—´è®°å½•ä¼šä¿ç•™ï¼ˆç”¨äºç»Ÿè®¡æ€»è¿è¡Œæ—¶é•¿ï¼‰
   - å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å†å²è¿è¡ŒåŒºé—´

## ğŸ“ˆ ç›¸å…³ç»Ÿè®¡åŠŸèƒ½

### æ€»è¿è¡Œæ—¶é•¿è®¡ç®—

åœ¨ `RunSessionSummaryList` å‡½æ•°ä¸­ï¼ˆç¬¬1630-1750è¡Œï¼‰ï¼Œä¼šç»Ÿè®¡ï¼š

```go
// å·²ç»“æŸåŒºé—´ï¼šä»æ•°æ®åº“èšåˆ
SELECT COALESCE(SUM(runtime_seconds), 0) AS total_runtime
FROM hg_trading_robot_run_session
WHERE end_time IS NOT NULL

// è¿è¡Œä¸­åŒºé—´ï¼šå®æ—¶è®¡ç®—å¹¶ç´¯åŠ 
for _, session := range runningSessions {
    runtime := int(now.Sub(session.StartTime).Seconds())
    totalRuntime += runtime
}
```

**æ˜¾ç¤ºæ•ˆæœ**ï¼š
```
æ€»è¿è¡Œæ—¶é•¿ï¼š5å¤©12å°æ—¶30åˆ†é’Ÿ
```

## âœ… éªŒæ”¶æ ‡å‡†

- [x] å¯åŠ¨æœºå™¨äººæ—¶åˆ›å»ºè¿è¡ŒåŒºé—´è®°å½•
- [x] è¿è¡Œä¸­åŒºé—´æ˜¾ç¤ºå®æ—¶è¿è¡Œæ—¶é•¿
- [x] åœæ­¢æœºå™¨äººæ—¶æ­£ç¡®ä¿å­˜è¿è¡Œæ—¶é•¿
- [x] åŒæ­¥æ“ä½œæ­£ç¡®æ›´æ–°è¿è¡Œæ—¶é•¿
- [x] å·²ç»“æŸåŒºé—´æ˜¾ç¤ºå‡†ç¡®çš„è¿è¡Œæ—¶é•¿
- [x] æ€»è¿è¡Œæ—¶é•¿åŒ…å«è¿è¡Œä¸­çš„æ—¶é—´
- [x] æ— ç¼–è¯‘é”™è¯¯
- [x] å…¼å®¹å†å²æ•°æ®

---

**ä¿®å¤å®Œæˆæ—¥æœŸ**ï¼š2025-12-25  
**ä¿®å¤äºº**ï¼šAI Assistant  
**å½±å“æ–‡ä»¶**ï¼š
- `internal/logic/toogo/robot.go` (StartRobot)
- `internal/logic/toogo/wallet.go` (SyncRunSession)
- `internal/logic/toogo/robot_task_manager.go` (StopRobot - å·²æœ‰æ­£ç¡®é€»è¾‘)

**æµ‹è¯•çŠ¶æ€**ï¼šå¾…ç”¨æˆ·æµ‹è¯•éªŒè¯

