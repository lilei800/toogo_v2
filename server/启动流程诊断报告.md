# å¯åŠ¨æµç¨‹è¯Šæ–­æŠ¥å‘Š

## ğŸ¯ ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼

### æ¶æ„è®¾è®¡

ç³»ç»Ÿç¡®å®æœ‰**ä¸¤ä¸ªç‹¬ç«‹çš„WebSocketç³»ç»Ÿ**ï¼š

1. **å…¨å±€å¼•æ“çš„å…¬å…±WebSocket**ï¼ˆMarketServiceManagerï¼‰
   - ç”¨é€”ï¼šè·å–å…¬å…±è¡Œæƒ…æ•°æ®ï¼ˆTickerã€Kçº¿ï¼‰
   - ç‰¹ç‚¹ï¼šä¸éœ€è¦API Keyï¼Œæ‰€æœ‰æœºå™¨äººå…±äº«
   - è§¦å‘ï¼šæœºå™¨äººå¼•æ“å¯åŠ¨æ—¶è®¢é˜…Symbol

2. **æœºå™¨äººçš„ç§æœ‰WebSocket**ï¼ˆPrivateStreamManagerï¼‰
   - ç”¨é€”ï¼šè·å–è®¢å•ã€æŒä»“æ›´æ–°
   - ç‰¹ç‚¹ï¼šéœ€è¦API Keyï¼Œæ¯ä¸ªè´¦æˆ·ç‹¬ç«‹
   - çŠ¶æ€ï¼šå·²ç»åœ¨å·¥ä½œï¼ˆæ—¥å¿—ä¸­å¯è§ï¼‰

## ğŸ“Š æ­£å¸¸çš„å¯åŠ¨æµç¨‹

```
HTTPæœåŠ¡å¯åŠ¨
  â†“
RobotTaskManager.Start() (robot_task_manager.go:56)
  â†“
config.GetVolatilityConfigManager().Start() (è¡Œ67-70)
  â†“
market.GetMarketServiceManager().Start() (è¡Œ81-83) â† å…¨å±€MarketæœåŠ¡
  â†“
market.GetMarketAnalyzer().Start() (è¡Œ86)
  â†“
GetOrderStatusSyncService().Start() (è¡Œ89-91)
  â†“
go m.runSyncTask() (è¡Œ94) â† å¯åŠ¨åŒæ­¥ä»»åŠ¡
  â†“
m.syncRobots() (æ¯5ç§’) â† æŸ¥è¯¢æ•°æ®åº“ WHERE status=2
  â†“
ä¸ºæ¯ä¸ªè¿è¡Œä¸­çš„æœºå™¨äººåˆ›å»º RobotEngine
  â†“
engine.Start() (robot_engine.go:359)
  â†“
market.GetMarketServiceManager().SubscribeWithCallback() (è¡Œ371) â† è®¢é˜…Symbol
  â†“
WebSocketå¼€å§‹æ¨é€è¯¥Symbolçš„æ•°æ®
```

## ğŸ” å½“å‰é—®é¢˜

### æ•°æ®åº“çŠ¶æ€ vs å†…å­˜çŠ¶æ€

ä½ è¯´å¾—å¯¹ï¼é—®é¢˜åœ¨äºï¼š

1. **æ•°æ®åº“çŠ¶æ€**ï¼šæœºå™¨äºº50çš„`status=2`ï¼ˆè¿è¡Œä¸­ï¼‰âœ…
2. **å†…å­˜çŠ¶æ€**ï¼š`RobotTaskManager.engines[50]` å¯èƒ½ä¸å­˜åœ¨ â“
3. **è®¢é˜…çŠ¶æ€**ï¼šæ²¡æœ‰è®¢é˜…ï¼Œæ‰€ä»¥MarketServiceManageræ²¡æœ‰æ¨é€ â“

### å…³é”®æ–­ç‚¹

å¯åŠ¨æµç¨‹ä¸­æœ‰å‡ ä¸ªå…³é”®ç‚¹å¯èƒ½å‡ºé—®é¢˜ï¼š

1. **RobotTaskManager.Start()** æ˜¯å¦æˆåŠŸè°ƒç”¨ï¼Ÿ
   - ç¬¬81è¡Œåº”è¯¥è°ƒç”¨ `market.GetMarketServiceManager().Start()`
   
2. **MarketServiceManager.Start()** æ˜¯å¦æˆåŠŸï¼Ÿ
   - å¯èƒ½å› ä¸ºé…ç½®é—®é¢˜è¿”å›é”™è¯¯
   - å¯èƒ½å› ä¸º`m.running=true`è·³è¿‡é‡å¤å¯åŠ¨
   
3. **startWebSocketServices()** æ˜¯å¦æ‰§è¡Œï¼Ÿ
   - æ£€æŸ¥`websocketEnabled`é…ç½®
   - ä»£ç†é…ç½®æ˜¯å¦æ­£ç¡®
   
4. **syncRobots()** æ˜¯å¦æŸ¥è¯¢åˆ°æœºå™¨äºº50ï¼Ÿ
   - æŸ¥è¯¢ `WHERE status=2`
   - æ˜¯å¦æˆåŠŸåˆ›å»ºå¼•æ“
   
5. **engine.Start()** æ˜¯å¦æˆåŠŸè®¢é˜…ï¼Ÿ
   - æ˜¯å¦è°ƒç”¨ `SubscribeWithCallback`
   - æ˜¯å¦è§¦å‘WebSocketè®¢é˜…

## ğŸ”§ è¯Šæ–­æ­¥éª¤

æˆ‘å·²ç»æ·»åŠ äº†è¯¦ç»†çš„WARNINGçº§åˆ«æ—¥å¿—ï¼ˆå› ä¸ºlogger.level=warningï¼‰ï¼š

### 1. MarketServiceManagerå¯åŠ¨æ—¥å¿—
```go
g.Log().Warning(ctx, "[MarketServiceManager] ğŸš€ å¼€å§‹å¯åŠ¨å…¨å±€è¡Œæƒ…æœåŠ¡ç®¡ç†å™¨...")
g.Log().Warningf(ctx, "[MarketServiceManager] æ£€æŸ¥WebSocketé…ç½®: wsEnabled=%v...")
g.Log().Warning(ctx, "[MarketServiceManager] å‡†å¤‡å¯åŠ¨WebSocketæœåŠ¡...")
g.Log().Warning(ctx, "[MarketServiceManager] âœ… Bitget WebSocketå·²å¯åŠ¨")
g.Log().Warning(ctx, "[MarketServiceManager] âœ… Binance WebSocketå·²å¯åŠ¨")
g.Log().Warning(ctx, "[MarketServiceManager] âœ… OKX WebSocketå·²å¯åŠ¨")
g.Log().Warning(ctx, "[MarketServiceManager] âœ… Gate WebSocketå·²å¯åŠ¨")
g.Log().Warning(ctx, "[MarketServiceManager] WebSocketæœåŠ¡å¯åŠ¨æµç¨‹å®Œæˆ")
g.Log().Warning(ctx, "[MarketServiceManager] âœ… å…¨å±€è¡Œæƒ…æœåŠ¡ç®¡ç†å™¨å¯åŠ¨å®Œæˆ")
```

### 2. ä¸‹ä¸€æ­¥ï¼šæ·»åŠ RobotTaskManagerå’ŒRobotEngineçš„å¯åŠ¨æ—¥å¿—

éœ€è¦åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ æ—¥å¿—ï¼š
- `RobotTaskManager.Start()` - ç¡®è®¤å…¨å±€ç®¡ç†å™¨å¯åŠ¨
- `RobotTaskManager.syncRobots()` - ç¡®è®¤æŸ¥è¯¢åˆ°çš„æœºå™¨äººæ•°é‡
- `RobotTaskManager` åˆ›å»ºå¼•æ“å¾ªç¯ - ç¡®è®¤å“ªäº›æœºå™¨äººè¢«åˆ›å»º
- `RobotEngine.Start()` - ç¡®è®¤å¼•æ“å¯åŠ¨å’Œè®¢é˜…

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

1. é‡æ–°ç¼–è¯‘ï¼ˆå·²å®Œæˆï¼‰
2. é‡å¯æœåŠ¡
3. è§‚å¯Ÿå¯åŠ¨æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š
   - `[MarketServiceManager] ğŸš€ å¼€å§‹å¯åŠ¨...`
   - `[MarketServiceManager] âœ… XXX WebSocketå·²å¯åŠ¨`
   - `[RobotTaskManager] ä»æ•°æ®åº“æŸ¥è¯¢åˆ° X ä¸ªè¿è¡Œä¸­çš„æœºå™¨äºº`
   - `[RobotEngine] æœºå™¨äººå¼•æ“å¯åŠ¨: robotId=50...`

å¦‚æœçœ‹åˆ°å®Œæ•´çš„å¯åŠ¨æ—¥å¿—ï¼Œç³»ç»Ÿåº”è¯¥å°±æ­£å¸¸äº†ã€‚
å¦‚æœç¼ºå°‘æŸä¸ªç¯èŠ‚çš„æ—¥å¿—ï¼Œè¯´æ˜è¯¥ç¯èŠ‚å‡ºäº†é—®é¢˜ã€‚

