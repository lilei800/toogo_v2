# 修复订单日志"最近失败"标签点击问题

## 问题描述

在机器人列表页面，订单日志的折叠面板header中显示"最近失败：订单失败"标签，但点击该标签无法展开订单日志列表。

## 问题原因

"最近失败"标签位于 `<n-collapse-item>` 的 `header` 插槽中，点击标签时：
1. 事件被 `<n-collapse-item>` 的header捕获
2. 标签本身没有独立的点击处理逻辑
3. 导致无法正确触发展开/收起操作

## 解决方案

### 修改文件
`web/src/views/toogo/robot/index.vue`

### 修改内容

#### 1. 为标签添加点击事件处理

**位置**: 第445-454行

**修改前**:
```vue
<n-tag v-if="getLastFailedLog(robot.id)" type="error" size="small" :bordered="false">
  最近失败：{{ getLastFailedLog(robot.id)?.eventTypeLabel || '失败' }}
</n-tag>
```

**修改后**:
```vue
<n-tag 
  v-if="getLastFailedLog(robot.id)" 
  type="error" 
  size="small" 
  :bordered="false"
  style="cursor: pointer;"
  @click.stop="toggleExecutionLogs(robot.id)"
>
  最近失败：{{ getLastFailedLog(robot.id)?.eventTypeLabel || '失败' }}
</n-tag>
```

**改进点**:
- ✅ 添加 `cursor: pointer` 样式，提示用户可点击
- ✅ 添加 `@click.stop` 事件，阻止事件冒泡到父级header
- ✅ 调用 `toggleExecutionLogs()` 函数切换展开/收起状态

#### 2. 添加切换函数

**位置**: 第1432行之后（在 `onExecutionExpanded` 函数后）

```typescript
// 切换订单日志展开状态（用于点击"最近失败"标签）
const toggleExecutionLogs = (robotId: number) => {
  if (!robotId) return;
  const currentNames = executionExpandedNames.value[robotId] || [];
  const isExpanded = currentNames.includes('execution-logs');
  
  if (isExpanded) {
    // 当前是展开的，收起
    executionExpandedNames.value[robotId] = [];
  } else {
    // 当前是收起的，展开
    executionExpandedNames.value[robotId] = ['execution-logs'];
    // 触发加载
    onExecutionExpanded(robotId, ['execution-logs']);
  }
};
```

**功能说明**:
1. 检查当前订单日志是否已展开
2. 如果已展开 → 收起（清空 `executionExpandedNames`）
3. 如果未展开 → 展开并触发数据加载

## 效果

### 修复前
- ❌ 点击"最近失败：订单失败"标签无响应
- ❌ 无法通过标签快速查看失败日志
- ❌ 用户体验差

### 修复后
- ✅ 点击"最近失败"标签可以展开/收起订单日志
- ✅ 鼠标悬停显示指针，提示可点击
- ✅ 点击后自动加载订单日志数据
- ✅ 再次点击可以收起
- ✅ 用户可以快速定位失败日志

## 使用说明

1. 在机器人列表页面，找到有"最近失败"标签的机器人
2. 点击红色的"最近失败：订单失败"标签
3. 订单日志列表会自动展开，显示所有订单执行日志
4. 再次点击标签可以收起日志列表

## 技术要点

### 事件处理
```vue
@click.stop="toggleExecutionLogs(robot.id)"
```
- `@click`: Vue的点击事件绑定
- `.stop`: 事件修饰符，阻止事件冒泡（等同于 `event.stopPropagation()`）
- 防止点击标签时触发父级header的默认行为

### 状态管理
```typescript
executionExpandedNames.value[robotId] = ['execution-logs']
```
- 使用 Vue 3 的 `ref` 响应式对象
- 通过数组控制哪些折叠项处于展开状态
- `'execution-logs'` 是折叠项的 `name` 属性值

### 数据加载
```typescript
onExecutionExpanded(robotId, ['execution-logs'])
```
- 复用现有的展开处理逻辑
- 确保展开时自动加载订单日志数据
- 避免代码重复

## 相关功能

### 订单日志其他操作

1. **刷新按钮**: 点击header右侧的刷新图标可以重新加载日志
2. **只看失败开关**: 展开后可以切换"只看失败"过滤失败日志
3. **日志详情**: 每条日志显示时间、类型、状态、参数等详细信息

### 日志类型

订单日志包含以下事件类型：
- `order_attempt`: 尝试下单
- `order_submit`: 提交订单
- `order_success`: 订单成功
- `order_failed`: 订单失败
- `order_cancel`: 订单取消
- `position_check`: 持仓检查
- `balance_check`: 余额检查

## 测试建议

### 功能测试
1. ✅ 点击"最近失败"标签能展开订单日志
2. ✅ 再次点击能收起订单日志
3. ✅ 展开时自动加载日志数据
4. ✅ 鼠标悬停显示指针样式
5. ✅ 不影响其他机器人的日志展开状态

### 兼容性测试
1. ✅ 不影响原有的点击header展开功能
2. ✅ 不影响刷新按钮的功能
3. ✅ 不影响"只看失败"开关的功能

### 边界测试
1. ✅ 机器人无失败日志时不显示标签
2. ✅ 快速连续点击标签不会出错
3. ✅ 多个机器人同时展开不会冲突

## 总结

通过添加独立的点击事件处理和切换函数，成功解决了"最近失败"标签无法点击展开的问题。修改简洁高效，不影响现有功能，提升了用户体验。

---

**修改时间**: 2025-12-26  
**修改文件**: `web/src/views/toogo/robot/index.vue`  
**影响范围**: 机器人列表页面 - 订单日志模块

