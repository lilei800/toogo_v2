# 如何诊断和修复"预警不下单"问题

## 📖 问题概述

**症状：** 系统显示预警记录状态为"已读"，但没有执行自动下单。

**常见原因：**
1. PostgreSQL 的 `is_processed` 字段不存在或类型错误（最常见）
2. 自动交易开关未开启
3. 已有持仓，被持仓检查阻止
4. 保存预警记录失败

## 🚀 快速诊断（3种方法）

### 方法一：使用 Go 诊断工具（推荐）⭐⭐⭐⭐⭐

```bash
cd D:\go\src\hotgo_v2\server
go run diagnose_trading.go
```

**优点：**
- 自动检查所有可能的问题
- 提供详细的分析和建议
- 无需手动执行 SQL

**输出示例：**
```
===========================================
交易预警不下单问题诊断工具
===========================================

【诊断1】检查 is_processed 字段
-------------------------------------------
   ✗ is_processed 字段不存在
   → 解决方案：执行 fix_is_processed_postgresql.sql

【诊断2】检查最近1小时的预警记录
-------------------------------------------
   总预警数: 5
   未处理: 0
   已处理: 5
   已执行: 0
   未执行: 5

...（更多诊断信息）
```

### 方法二：使用 SQL 诊断脚本

```bash
# PostgreSQL
psql -U your_username -d your_database -f storage/data/diagnose_trading_issue.sql
```

**优点：**
- 直接在数据库层面检查
- 适合熟悉 SQL 的用户
- 可以看到原始数据

### 方法三：手动检查（适合学习）

#### 步骤1：检查字段是否存在

```sql
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'hg_trading_signal_log' 
  AND column_name = 'is_processed';
```

**期望结果：**
```
 column_name  | data_type | is_nullable | column_default
--------------+-----------+-------------+----------------
 is_processed | smallint  | NO          | 0
```

**如果返回空：** 字段不存在，需要执行修复脚本（见下文）

#### 步骤2：检查最近的预警记录

```sql
SELECT 
    id,
    robot_id,
    signal_type,
    current_price,
    is_processed,
    executed,
    created_at
FROM hg_trading_signal_log
WHERE created_at >= NOW() - INTERVAL '1 hour'
ORDER BY id DESC
LIMIT 10;
```

**关注点：**
- `is_processed = 1` 但 `executed = 0`：已读但未执行（最常见）
- `is_processed = 0`：未处理（等待重试机制）

#### 步骤3：检查机器人配置

```sql
SELECT 
    id,
    name,
    auto_trade_enabled,  -- 必须是 1
    dual_side_position,  -- 0=单向, 1=双向
    status               -- 必须是 1
FROM hg_trading_robot
WHERE id = YOUR_ROBOT_ID;  -- 替换为你的机器人ID
```

**必须满足：**
- `auto_trade_enabled = 1`（自动交易开关已开启）
- `status = 1`（机器人运行中）

#### 步骤4：检查执行日志

```sql
SELECT 
    id,
    signal_log_id,
    event_type,
    status,
    message,
    created_at
FROM hg_trading_execution_log
WHERE robot_id = YOUR_ROBOT_ID
  AND created_at >= NOW() - INTERVAL '2 hour'
ORDER BY id DESC
LIMIT 20;
```

**关键信息：**
- `event_type = 'order_failed'`：下单失败
- `message`：失败原因（如"自动下单未开启"、"已有持仓"等）

## 🔧 修复方案

### 问题1：is_processed 字段不存在（最常见）

**解决方案：执行修复脚本**

```bash
# PostgreSQL
cd D:\go\src\hotgo_v2\server\storage\data
psql -U your_username -d your_database -f fix_is_processed_postgresql.sql
```

**脚本会自动：**
1. ✅ 检查并添加 `is_processed` 字段
2. ✅ 确保字段类型正确（SMALLINT）
3. ✅ 设置默认值为 0
4. ✅ 添加必要的索引
5. ✅ 创建 `hg_trading_execution_log` 表（如果不存在）
6. ✅ 添加其他可能缺失的字段（window_min_price, window_max_price 等）

**执行后验证：**

```bash
# 方法1：使用 Go 工具
go run diagnose_trading.go

# 方法2：手动查询
psql -U your_username -d your_database -c "
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'hg_trading_signal_log' 
  AND column_name = 'is_processed';
"
```

**预期输出：**
```
 column_name  | data_type | column_default
--------------+-----------+----------------
 is_processed | smallint  | 0
```

### 问题2：自动交易开关未开启

**症状：**
- `is_processed = 1`（已读）
- `executed = 0`（未执行）
- 执行日志显示："自动下单未开启"

**解决方案：**

```sql
-- 开启自动交易
UPDATE hg_trading_robot
SET auto_trade_enabled = 1
WHERE id = YOUR_ROBOT_ID;  -- 替换为你的机器人ID
```

或者在前端管理页面：
1. 进入"机器人管理"
2. 找到对应的机器人
3. 开启"自动交易"开关

### 问题3：已有持仓，被持仓检查阻止

**症状：**
- 执行日志显示：
  - "单向持仓模式：已有持仓，持仓内只能有一单"
  - "双向持仓模式：同方向已有持仓，禁止加仓"

**理解规则：**

| 模式 | 规则 | 示例 |
|------|------|------|
| 单向模式（dual_side_position=0） | 持仓内只能有一单，无论多空 | 已有多头 → 拒绝新的多头或空头 |
| 双向模式（dual_side_position=1） | 同方向只能一单，反方向可开 | 已有多头 → 拒绝新的多头，允许空头 |

**解决方案：**

1. **等待现有持仓平仓后再开新仓**（推荐）
2. **手动平仓现有持仓**
   ```sql
   -- 查看当前持仓
   SELECT * FROM hg_trading_position
   WHERE robot_id = YOUR_ROBOT_ID
     AND status = 1;  -- 1=持仓中
   ```
3. **修改持仓模式**（谨慎）
   ```sql
   -- 改为双向模式（允许多空同时持有）
   UPDATE hg_trading_robot
   SET dual_side_position = 1
   WHERE id = YOUR_ROBOT_ID;
   ```

### 问题4：保存预警记录失败（logId=0）

**症状：**
- 日志显示："保存预警记录失败"
- 没有新的预警记录插入数据库

**原因：**
- 字段不存在或类型错误
- 数据库连接问题

**解决方案：**
1. 执行修复脚本（见问题1）
2. 检查数据库连接配置
3. 查看应用日志，找到具体错误信息

## 📊 监控和验证

### 1. 实时监控日志

```bash
# Linux/Mac
tail -f logs/app.log | grep -E "预警记录|自动下单|order_failed"

# Windows PowerShell
Get-Content logs\app.log -Wait | Select-String -Pattern "预警记录|自动下单|order_failed"
```

**关键日志：**
- ✅ `预警记录已保存: robotId=xxx, logId=xxx`
- ✅ `预警记录已标记为已处理（is_processed=1），开始执行下单`
- ✅ `下单成功: logId=xxx`
- ❌ `保存预警记录失败`
- ❌ `order_failed`

### 2. 定期检查未处理预警

```sql
-- 查找超过5分钟仍未处理的预警
SELECT 
    id,
    robot_id,
    signal_type,
    current_price,
    created_at,
    NOW() - created_at as age
FROM hg_trading_signal_log
WHERE is_processed = 0
  AND executed = 0
  AND created_at >= NOW() - INTERVAL '1 hour'
ORDER BY created_at DESC;
```

### 3. 检查执行成功率

```sql
-- 统计最近24小时的执行情况
SELECT 
    COUNT(*) as total_alerts,
    SUM(CASE WHEN executed = 1 THEN 1 ELSE 0 END) as executed,
    SUM(CASE WHEN is_processed = 1 AND executed = 0 THEN 1 ELSE 0 END) as failed,
    ROUND(100.0 * SUM(CASE WHEN executed = 1 THEN 1 ELSE 0 END) / COUNT(*), 2) as success_rate
FROM hg_trading_signal_log
WHERE created_at >= NOW() - INTERVAL '24 hour';
```

**健康标准：**
- `success_rate >= 80%`：正常
- `success_rate < 50%`：有问题，需要检查

## 🎯 完整流程示例

### 场景：发现预警"已读"但未下单

#### 第1步：快速诊断

```bash
cd D:\go\src\hotgo_v2\server
go run diagnose_trading.go
```

#### 第2步：根据诊断结果采取行动

**如果显示"is_processed 字段不存在"：**
```bash
psql -U postgres -d hotgo -f storage/data/fix_is_processed_postgresql.sql
```

**如果显示"自动交易开关未开启"：**
```sql
UPDATE hg_trading_robot SET auto_trade_enabled = 1 WHERE id = 35;
```

**如果显示"已有持仓"：**
- 等待现有持仓平仓
- 或手动平仓
- 或改为双向模式

#### 第3步：验证修复

```bash
# 再次运行诊断工具
go run diagnose_trading.go
```

**期望输出：**
```
【诊断5】问题分析
-------------------------------------------
   ✓ is_processed 字段存在
   ✓ 没有未处理的预警记录
   ✓ 没有已处理但未执行的预警
   ✓ 所有相关机器人的自动交易开关已开启

【建议操作】
-------------------------------------------
   ✓ 系统运行正常，没有发现问题
     等待下一个交易信号，观察是否正常下单
```

#### 第4步：等待下一个信号

- 观察日志中是否有 `预警记录已保存` 和 `下单成功`
- 检查 `hg_trading_execution_log` 表是否有新记录
- 检查交易所是否有新订单

## 📚 相关文档

1. **详细诊断报告：** `预警不下单问题诊断报告.md`
   - 完整的问题分析
   - 所有可能的原因
   - 详细的代码逻辑说明

2. **修复脚本：**
   - `storage/data/fix_is_processed_postgresql.sql` - PostgreSQL 修复脚本
   - `storage/data/diagnose_trading_issue.sql` - SQL 诊断脚本

3. **诊断工具：**
   - `diagnose_trading.go` - Go 语言诊断工具
   - `check_signal_log.go` - 信号日志检查工具

4. **原始报告：** `自动交易逻辑检查报告.md`
   - 自动下单逻辑说明
   - 自动平仓逻辑说明
   - PostgreSQL 兼容性说明

## ❓ 常见问题

### Q1: 修复后还是不下单怎么办？

**A:** 按顺序检查：
1. 确认 `is_processed` 字段已正确添加（运行诊断工具）
2. 确认自动交易开关已开启
3. 确认没有持仓冲突
4. 查看 `hg_trading_execution_log` 表的详细错误信息
5. 检查应用日志中的错误信息

### Q2: 可以批量重试失败的预警吗？

**A:** 系统有自动重试机制：
- `processPendingAutoTradeSignals` 函数每分钟自动扫描未处理的预警
- 会重新尝试 `is_processed=0` 且 `executed=0` 的记录
- 最多扫描最近10分钟的记录

**手动触发重试：**
- 重启应用服务
- 或等待下一个定时任务周期（1分钟）

### Q3: 如何查看某个预警为什么没下单？

```sql
-- 1. 找到预警记录
SELECT * FROM hg_trading_signal_log WHERE id = YOUR_LOG_ID;

-- 2. 查看执行日志
SELECT * FROM hg_trading_execution_log WHERE signal_log_id = YOUR_LOG_ID;

-- 3. 查看机器人配置
SELECT * FROM hg_trading_robot WHERE id = YOUR_ROBOT_ID;

-- 4. 查看当前持仓
SELECT * FROM hg_trading_position 
WHERE robot_id = YOUR_ROBOT_ID AND status = 1;
```

### Q4: 修复脚本会影响现有数据吗？

**A:** 不会，脚本非常安全：
- ✅ 只添加字段，不删除数据
- ✅ 使用 `IF NOT EXISTS` 检查，不会重复添加
- ✅ 为现有记录设置默认值 `is_processed=0`
- ✅ 创建索引不影响数据

### Q5: 可以在 MySQL 上使用吗？

**A:** 需要修改脚本：
- PostgreSQL 使用 `SMALLINT`，MySQL 使用 `TINYINT(1)`
- PostgreSQL 使用 `DO $$`，MySQL 使用 `DELIMITER`
- 已有 MySQL 版本：`storage/data/add_is_processed_to_signal_log.sql`

## 🆘 需要帮助？

如果以上方法都无法解决问题：

1. **收集诊断信息：**
   ```bash
   go run diagnose_trading.go > diagnosis_report.txt
   ```

2. **导出相关日志：**
   ```sql
   -- 导出最近的预警记录
   COPY (
       SELECT * FROM hg_trading_signal_log 
       WHERE created_at >= NOW() - INTERVAL '2 hour'
       ORDER BY id DESC
   ) TO '/tmp/signal_log.csv' CSV HEADER;
   
   -- 导出执行日志
   COPY (
       SELECT * FROM hg_trading_execution_log 
       WHERE created_at >= NOW() - INTERVAL '2 hour'
       ORDER BY id DESC
   ) TO '/tmp/execution_log.csv' CSV HEADER;
   ```

3. **查看应用日志：**
   ```bash
   # 最近的错误日志
   grep -i "error" logs/app.log | tail -50
   ```

4. **联系技术支持**，提供：
   - 诊断报告（diagnosis_report.txt）
   - 导出的数据（signal_log.csv, execution_log.csv）
   - 应用日志中的错误信息

---

**文档版本：** v1.0  
**更新时间：** 2025-12-23  
**适用版本：** hotgo_v2 (PostgreSQL)

