# HotGo 日志优化说明

## 📋 优化内容

### 1. 配置文件优化 (`config.example.yaml`)

#### 日志级别优化
- **默认日志级别**: `warning` → `error`
  - 仅记录错误及以上级别，大幅减少日志量
  - 排障时可临时改为 `warning` 或 `debug`

#### 日志保留时间优化
- **日志保留时间**: `30天` → `7天`
  - 减少磁盘占用
  - 备份文件数量: `10个` → `3个`

#### 访问日志优化
- **访问日志**: `开启` → `关闭`
  - 生产环境通常不需要详细的访问日志
  - 需要时可手动开启

#### 数据库日志优化
- **数据库日志级别**: `error`（仅记录错误）
- **数据库日志保留**: `3天`

### 2. 代码优化 (`robot_engine.go`)

#### 移除频繁的Debug日志
以下频繁调用的Debug日志已被注释掉：
- 价格更新日志（每次价格变动都会触发）
- 策略配置检查日志
- 映射关系规范化日志
- K线数据获取日志
- 策略加载参数日志

#### 优化原则
- **保留**: Error、Warning级别的日志（重要错误和警告）
- **移除**: Debug级别的频繁日志（价格更新、策略检查等）
- **保留**: 关键操作的Info日志（启动、停止、配置更新等）

## 🚀 使用方法

### 1. 应用配置优化

```bash
# 1. 复制配置文件（如果还没有）
cd /opt/hotgo/hotgo_v2/server
cp manifest/config/config.example.yaml manifest/config/config.yaml

# 2. 编辑配置文件，确保以下设置：
# - defaultLogger.level: "error"
# - defaultLogger.rotateExpire: "7d"
# - defaultLogger.rotateBackupLimit: 3
# - server.accessLogEnabled: false
# - database.logger.level: "error"
# - database.logger.rotateExpire: "3d"

# 3. 重启服务使配置生效
sudo systemctl restart hotgo
```

### 2. 使用日志清理脚本

```bash
# 1. 赋予执行权限
chmod +x /opt/hotgo/hotgo_v2/server/scripts/cleanup_logs.sh

# 2. 手动执行清理
bash /opt/hotgo/hotgo_v2/server/scripts/cleanup_logs.sh

# 3. 添加到定时任务（每天凌晨3点执行）
crontab -e
# 添加以下行：
0 3 * * * /opt/hotgo/hotgo_v2/server/scripts/cleanup_logs.sh >> /var/log/hotgo-cleanup.log 2>&1
```

## 📊 优化效果

### 预期减少的日志量

| 项目 | 优化前 | 优化后 | 减少比例 |
|------|--------|--------|----------|
| 日志级别 | Warning | Error | ~80% |
| 日志保留 | 30天 | 7天 | ~77% |
| 访问日志 | 开启 | 关闭 | 100% |
| Debug日志 | 频繁 | 已移除 | ~90% |

### 磁盘空间节省

假设每天产生 **100MB** 日志：
- **优化前**: 30天 × 100MB = **3GB**
- **优化后**: 7天 × 20MB = **140MB**
- **节省**: 约 **2.86GB** (95%)

## 🔍 排障时的日志配置

如果需要排查问题，可以临时调整日志级别：

### 方法1: 修改配置文件

```yaml
# 临时改为warning级别
defaultLogger: &defaultLogger
  level: "warning"  # 临时改为warning

# 或者临时开启访问日志
server:
  accessLogEnabled: true
```

然后重启服务：
```bash
sudo systemctl restart hotgo
```

### 方法2: 使用环境变量（如果支持）

```bash
# 临时设置日志级别
export LOG_LEVEL=warning
sudo systemctl restart hotgo
```

## ⚠️ 注意事项

1. **备份配置**: 修改配置前请备份原配置文件
2. **监控磁盘**: 定期检查磁盘使用情况
3. **重要日志**: Error级别的日志会保留，确保重要错误不会丢失
4. **排障模式**: 排查问题时可以临时提高日志级别

## 📝 日志文件位置

```
/opt/hotgo/hotgo_v2/server/logs/
├── server/          # HTTP服务器日志
├── logger/          # 应用日志
├── cron/            # 定时任务日志
├── queue/           # 队列日志
├── database/        # 数据库日志
├── tcpServer/       # TCP服务器日志
└── tcpClient/       # TCP客户端日志
```

## 🔧 手动清理日志

如果需要手动清理：

```bash
# 清理7天前的日志
find /opt/hotgo/hotgo_v2/server/logs -type f -name "*.log" -mtime +7 -delete

# 清理压缩的日志文件（保留最近3个）
find /opt/hotgo/hotgo_v2/server/logs -type f -name "*.log.*.gz" -printf '%T@ %p\n' | \
    sort -rn | tail -n +4 | cut -d' ' -f2- | xargs rm -f

# 查看日志目录大小
du -sh /opt/hotgo/hotgo_v2/server/logs
```

## 📞 问题反馈

如果遇到问题：
1. 检查日志配置是否正确
2. 查看服务状态: `sudo systemctl status hotgo`
3. 查看日志: `sudo journalctl -u hotgo -f`
