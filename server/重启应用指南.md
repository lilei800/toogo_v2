# ⚡ 紧急：需要重启应用服务

## 📊 问题确认

您的问题已确诊：

- ✅ 数据库已修复（`is_processed` 字段存在）
- ✅ 机器人配置正确（自动交易已开启，无持仓）
- ✅ 预警记录已保存（ID=13959）
- ❌ **应用服务还在使用旧代码（未重启）**

## 🚀 立即操作

### 步骤1：停止当前服务

找到运行应用的终端窗口，按 `Ctrl+C` 停止服务。

或者强制停止进程：

```powershell
# 查找进程
Get-Process | Where-Object { $_.ProcessName -eq "main" }

# 如果找到，记下进程ID，然后停止
Stop-Process -Id <进程ID>
```

### 步骤2：重新编译（可选，但推荐）

```powershell
cd D:\go\src\hotgo_v2\server
go build -o main.exe main.go
```

### 步骤3：启动服务

```powershell
cd D:\go\src\hotgo_v2\server
.\main.exe http
```

### 步骤4：验证启动成功

启动后应该看到类似的日志：

```
2025-12-23 15:20:00 [INFO] HTTP Server started
2025-12-23 15:20:00 [INFO] RobotTaskManager started
...
```

## ✅ 验证修复

重启后，等待下一个交易信号，应该会看到：

### 1. 应用日志中

```
[RobotEngine] robotId=35 检测到信号: newSignal=short, lastSignal=long, isNew=true
[RobotEngine] ✅ 预警记录已保存: robotId=35, logId=13970, direction=SHORT
[RobotTrader] 预警记录已标记为已处理（is_processed=1），开始执行下单
[RobotTrader] 【步骤2-3】开始执行下单: logId=13970, direction=SHORT
```

### 2. 数据库中

```sql
-- 查看最新预警
SELECT * FROM hg_trading_signal_log ORDER BY id DESC LIMIT 1;
-- 应该看到 executed=1

-- 查看执行日志
SELECT * FROM hg_trading_execution_log ORDER BY id DESC LIMIT 5;
-- 应该有新的执行记录
```

### 3. 使用诊断工具

```powershell
cd D:\go\src\hotgo_v2\server
go run verify_fix.go
```

应该看到：
- ✓ is_processed 字段存在
- ✓ hg_trading_execution_log 表存在
- ✓ 最新预警的 executed=1

## 🔍 如果重启后还是不下单

### 1. 检查执行日志

```sql
SELECT * FROM hg_trading_execution_log 
WHERE signal_log_id = (SELECT MAX(id) FROM hg_trading_signal_log)
ORDER BY id DESC;
```

查看 `message` 字段了解失败原因。

### 2. 常见原因

| 失败原因 | 解决方案 |
|---------|---------|
| `自动下单未开启` | 检查机器人配置 auto_trade_enabled=1 |
| `单向持仓模式：已有持仓` | 等待现有持仓平仓 |
| `双向持仓模式：同方向已有持仓` | 等待同方向持仓平仓或改为反方向 |
| `系统繁忙，获取锁超时` | 检查系统负载 |
| `获取持仓失败` | 检查交易所API连接 |

### 3. 查看应用日志

```powershell
# 实时监控
Get-Content c:\Users\pc\.cursor\projects\c-Users-pc-AppData-Roaming-Cursor-Workspaces-1762164546272-workspace-json\terminals\4.txt -Wait | Select-String -Pattern "预警|下单|RobotTrader"

# 或者查看最近的错误
Get-Content c:\Users\pc\.cursor\projects\c-Users-pc-AppData-Roaming-Cursor-Workspaces-1762164546272-workspace-json\terminals\4.txt | Select-String -Pattern "ERROR|ERRO|panic" | Select-Object -Last 20
```

## 📝 重要提醒

1. **每次修改数据库后都要重启应用**
2. **重启后才能使用新的字段和表**
3. **旧的预警记录（executed=0）不会自动重试**
   - 系统只会重试 is_processed=0 的记录
   - 已经 is_processed=1 的不会再处理

## 🎯 预期结果

重启后：

- ✅ 新的预警会正常保存
- ✅ `TryAutoTradeAndUpdate` 会被调用
- ✅ 执行日志会被记录
- ✅ 可以看到下单成功或失败的具体原因

---

**当前时间：** 15:16  
**需要操作：** 立即重启应用服务  
**预计时间：** 1-2分钟

