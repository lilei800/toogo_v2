# è®¢å•è·å–å¿«é€Ÿå‚è€ƒæ‰‹å†Œ

> **å¿«é€ŸæŸ¥æ‰¾**: è®¢å•è·å–ç›¸å…³çš„æ‰€æœ‰å…³é”®ä¿¡æ¯

---

## ğŸ“Œ æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥

### è®¢å•çŠ¶æ€å®šä¹‰

| çŠ¶æ€ç  | åç§° | è¯´æ˜ | æ•°æ®åº“å€¼ |
|-------|------|------|---------|
| 1 | æŒä»“ä¸­ | è®¢å•å·²å¼€ä»“ï¼ŒæŒä»“å°šæœªå¹³ä»“ | `status = 1` |
| 2 | å·²å¹³ä»“ | è®¢å•å·²å®Œæˆå¹³ä»“ | `status = 2` |
| 3 | å·²å–æ¶ˆ | è®¢å•è¢«å–æ¶ˆï¼ˆæœªæˆäº¤ï¼‰ | `status = 3` |
| 4 | å¤±è´¥ | è®¢å•åˆ›å»º/æ‰§è¡Œå¤±è´¥ | `status = 4` |

### ç¼“å­˜å±‚çº§ä¸TTL

| ç¼“å­˜å±‚ | TTL | ä½œç”¨åŸŸ | æ›´æ–°æ—¶æœº | å‘½ä¸­ç‡ |
|--------|-----|--------|---------|--------|
| å¼•æ“ç¼“å­˜ | 120ç§’ | å•æœºå™¨äºº | å®šæ—¶+è§¦å‘ | 90%+ |
| APIç¼“å­˜ | 5åˆ†é’Ÿ | apiId+symbol | é¦–æ¬¡æŸ¥è¯¢ | 80%+ |
| æ•°æ®åº“ | æ°¸ä¹… | å…¨å±€ | å®æ—¶åŒæ­¥ | - |

### åŒæ­¥é¢‘ç‡

| åŒæ­¥ç±»å‹ | é¢‘ç‡ | èŠ‚æµæ—¶é—´ | è§¦å‘æ¡ä»¶ |
|---------|------|---------|---------|
| è®¢å•å†å²åŒæ­¥ | æ¯ç§’æ‰«æ | 120ç§’ | è¿è¡Œä¸­æœºå™¨äºº |
| æŒä»“çŠ¶æ€å¯¹è´¦ | æ¯ç§’ | æ—  | è¿è¡Œä¸­æœºå™¨äºº |
| æŒ‚å•å…œåº•å¯¹è´¦ | æ¯ç§’æ‰«æ | 10ç§’ | è¿è¡Œä¸­æœºå™¨äºº |
| WebSocketæ¨é€ | å®æ—¶ | æ—  | è®¢å•çŠ¶æ€å˜æ›´ |

---

## ğŸ” APIæ¥å£é€ŸæŸ¥

### è®¢å•å†å²æŸ¥è¯¢

**æ¥å£**: `GET /api/toogo/wallet/order-history`

**è¯·æ±‚å‚æ•°**:
```json
{
  "userId": 1001,           // ç”¨æˆ·IDï¼ˆå¯é€‰ï¼Œç®¡ç†ç«¯ï¼‰
  "robotId": 123,          // æœºå™¨äººIDï¼ˆå¯é€‰ï¼‰
  "exchange": "binance",   // äº¤æ˜“æ‰€ï¼ˆå¯é€‰ï¼‰
  "symbol": "BTCUSDT",     // äº¤æ˜“å¯¹ï¼ˆå¯é€‰ï¼‰
  "direction": "long",     // æ–¹å‘: long/shortï¼ˆå¯é€‰ï¼‰
  "status": 2,             // çŠ¶æ€: 1/2/3ï¼ˆå¯é€‰ï¼‰
  "startTime": "2024-01-01 00:00:00",  // å¼€å§‹æ—¶é—´ï¼ˆå¯é€‰ï¼‰
  "endTime": "2024-12-31 23:59:59",    // ç»“æŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
  "page": 1,               // é¡µç 
  "pageSize": 20           // æ¯é¡µæ•°é‡
}
```

**å“åº”å­—æ®µ**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 12345,
        "orderSn": "TO20241226123456ABC123",
        "exchangeOrderId": "1234567890",
        "symbol": "BTCUSDT",
        "direction": "long",
        "openPrice": 43500.50,
        "closePrice": 44200.00,
        "quantity": 0.1,
        "leverage": 10,
        "realizedProfit": 70.00,
        "openFee": 4.35,
        "closeFee": 4.42,
        "status": 2,
        "closeReason": "take_profit",
        "openTime": "2024-12-26 10:00:00",
        "closeTime": "2024-12-26 12:00:00",
        "runtimeText": "2å°æ—¶"
      }
    ],
    "totalCount": 1250,
    "page": 1,
    "pageSize": 20
  }
}
```

---

## ğŸ“‚ æ•°æ®åº“è¡¨ç»“æ„é€ŸæŸ¥

### `hg_trading_order` æ ¸å¿ƒå­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|-------|------|------|------|
| `id` | BIGINT | ä¸»é”® | PRIMARY |
| `user_id` | BIGINT | ç”¨æˆ·ID | âœ… |
| `robot_id` | BIGINT | æœºå™¨äººID | âœ… |
| `exchange` | VARCHAR(50) | äº¤æ˜“æ‰€ | - |
| `symbol` | VARCHAR(50) | äº¤æ˜“å¯¹ | - |
| `order_sn` | VARCHAR(50) | è®¢å•å· | - |
| `exchange_order_id` | VARCHAR(100) | äº¤æ˜“æ‰€è®¢å•ID | âœ… |
| `direction` | VARCHAR(10) | æ–¹å‘: long/short | - |
| `open_price` | DECIMAL(20,8) | å¼€ä»“ä»·æ ¼ | - |
| `close_price` | DECIMAL(20,8) | å¹³ä»“ä»·æ ¼ | - |
| `quantity` | DECIMAL(20,8) | æ•°é‡ | - |
| `realized_profit` | DECIMAL(20,8) | å·²å®ç°ç›ˆäº | - |
| `status` | INT | çŠ¶æ€: 1/2/3/4 | âœ… |
| `open_time` | TIMESTAMP | å¼€ä»“æ—¶é—´ | - |
| `close_time` | TIMESTAMP | å¹³ä»“æ—¶é—´ | âœ… |

### æ ¸å¿ƒç´¢å¼•

```sql
-- è®¢å•å†å²æŸ¥è¯¢ï¼ˆç”¨æˆ·+çŠ¶æ€+å¹³ä»“æ—¶é—´ï¼‰
CREATE INDEX idx_user_status_closetime ON hg_trading_order(user_id, status, close_time);

-- æœºå™¨äººè®¢å•æŸ¥è¯¢
CREATE INDEX idx_robot_status ON hg_trading_order(robot_id, status);

-- äº¤æ˜“æ‰€è®¢å•IDæŸ¥è¯¢
CREATE INDEX idx_exchange_order_id ON hg_trading_order(exchange_order_id);

-- å¹³ä»“æ—¶é—´æ’åº
CREATE INDEX idx_close_time ON hg_trading_order(close_time);
```

---

## ğŸ”§ æ ¸å¿ƒå‡½æ•°é€ŸæŸ¥

### 1. è®¢å•å†å²æŸ¥è¯¢ï¼ˆAPIå±‚ï¼‰

**æ–‡ä»¶**: `internal/logic/toogo/wallet.go`

```go
func (s *sToogoWallet) OrderHistoryList(ctx context.Context, in *toogoin.OrderHistoryListInp) (
    list []*toogoin.OrderHistoryModel, totalCount int, err error)
```

**åŠŸèƒ½**:
- âœ… æŸ¥è¯¢æ•°æ®åº“è®¢å•åˆ—è¡¨
- âœ… æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦å¢å¼ºï¼ˆè¿‘14å¤©+ç¼ºå¤±å­—æ®µï¼‰
- âœ… è°ƒç”¨äº¤æ˜“æ‰€APIè·å–æˆäº¤æ˜ç»†
- âœ… è®¡ç®—ç²¾ç¡®ç›ˆäºå’Œæ‰‹ç»­è´¹
- âœ… ä½¿ç”¨5åˆ†é’Ÿç¼“å­˜å‡å°‘APIè°ƒç”¨

**è°ƒç”¨é“¾**:
```
OrderHistoryList()
  â†“
æŸ¥è¯¢æ•°æ®åº“ (dao.TradingOrder)
  â†“
enrichOrdersWithTradeHistory() [æ™ºèƒ½å¢å¼º]
  â†“
checkCache (orderHistoryTradeCache, 5min)
  â†“
GetTradeHistory() [äº¤æ˜“æ‰€API]
  â†“
èšåˆè®¡ç®— (ç›ˆäº/æ‰‹ç»­è´¹)
  â†“
è¿”å›å®Œæ•´æ•°æ®
```

### 2. æ™ºèƒ½è®¢å•å†å²è·å–

**æ–‡ä»¶**: `internal/logic/toogo/robot_engine_order_history_smart.go`

```go
func (e *RobotEngine) GetOrderHistorySmart(ctx context.Context, startId int64, limit int) ([]*exchange.Order, error)
```

**åŠŸèƒ½**:
- âœ… 120ç§’å†…å¤ç”¨å¼•æ“ç¼“å­˜
- âœ… ç¼“å­˜è¿‡æœŸè‡ªåŠ¨åˆ·æ–°
- âœ… APIå¤±è´¥æ—¶é™çº§åˆ°ç¼“å­˜
- âœ… çº¿ç¨‹å®‰å…¨

**ä½¿ç”¨åœºæ™¯**:
- è®¢å•çŠ¶æ€åŒæ­¥æœåŠ¡
- æŒä»“æŸ¥è¯¢
- æ‰‹åŠ¨å¹³ä»“æ£€æµ‹

### 3. è®¢å•åŒæ­¥åˆ°æ•°æ®åº“

**æ–‡ä»¶**: `internal/logic/toogo/robot.go`

```go
func (s *sToogoRobot) SyncOrderHistoryToDB(ctx context.Context, robotId int64, robot *entity.TradingRobot, orders []*exchange.Order) error
```

**åŠŸèƒ½**:
- âœ… å°†äº¤æ˜“æ‰€è®¢å•å†™å…¥æ•°æ®åº“
- âœ… å·²å­˜åœ¨è®¢å•ï¼šUPDATEè¡¥å…¨å­—æ®µ
- âœ… æ–°è®¢å•ï¼šINSERTåˆ›å»ºè®°å½•
- âœ… è‡ªåŠ¨ä¿®å¤å†å²è„æ•°æ®ï¼ˆ2006å¹´å ä½å€¼ï¼‰

**å¤„ç†é€»è¾‘**:
```
éå†è®¢å•åˆ—è¡¨
  â†“
åˆ¤æ–­æ˜¯å¦å·²å­˜åœ¨ (exchange_order_id)
  â”œâ”€ å­˜åœ¨ â†’ UPDATE
  â”‚   â”œâ”€ è¡¥å…¨ open_price
  â”‚   â”œâ”€ è¡¥å…¨ quantity
  â”‚   â”œâ”€ è¡¥å…¨ open_time
  â”‚   â””â”€ æ›´æ–° status
  â”‚
  â””â”€ ä¸å­˜åœ¨ â†’ INSERT
      â””â”€ åˆ›å»ºå®Œæ•´è®¢å•è®°å½•
```

### 4. è®¢å•çŠ¶æ€åŒæ­¥æœåŠ¡

**æ–‡ä»¶**: `internal/logic/toogo/order_status_sync.go`

```go
// ä¸»åŒæ­¥å‡½æ•°
func (s *OrderStatusSyncService) syncRobotOrders(ctx context.Context, robot *entity.TradingRobot)

// æŒä»“å¯¹è´¦
func (s *OrderStatusSyncService) syncPositionsWithCache(ctx context.Context, robot *entity.TradingRobot, 
    ex exchange.Exchange, cachedPositions []*exchange.Position, historyOrders []*exchange.Order)

// è®¢å•å­—æ®µè¡¥å…¨
func (s *OrderStatusSyncService) syncLocalOrders(ctx context.Context, robot *entity.TradingRobot, 
    ex exchange.Exchange, historyOrders []*exchange.Order)
```

**æ ¸å¿ƒåŠŸèƒ½**:

#### 4.1 æ‰‹åŠ¨å¹³ä»“æ£€æµ‹
```go
// æ£€æµ‹æ¡ä»¶
æœ¬åœ°è®¢å• status = 1 (æŒä»“ä¸­)
äº¤æ˜“æ‰€æŒä»“ä¸ºç©º
â†“
ä» TradeHistory æ¨æ–­å¹³ä»“ä¿¡æ¯
â†“
æ›´æ–°è®¢å•ä¸º status = 2 (å·²å¹³ä»“)
```

#### 4.2 å¤–éƒ¨æŒä»“æ£€æµ‹
```go
// æ£€æµ‹æ¡ä»¶
äº¤æ˜“æ‰€æœ‰æŒä»“
æœ¬åœ°æ— å¯¹åº”è®¢å•
â†“
ä»å†å²è®¢å•ä¸­æŸ¥æ‰¾åŒ¹é…è®°å½•
â†“
åˆ›å»ºè¡¥å•
```

#### 4.3 æœªå®ç°ç›ˆäºæ›´æ–°
```go
// æŒä»“ä¸­è®¢å•
ä»äº¤æ˜“æ‰€è·å– unrealized_profit
â†“
æ›´æ–°åˆ°æ•°æ®åº“
```

### 5. WebSocketè®¢å•å­˜å‚¨

**æ–‡ä»¶**: `internal/logic/toogo/exchange_order_store.go`

```go
func UpsertExchangeOrdersFromPrivateEvent(ctx context.Context, robotId int64, ev *exchange.PrivateEvent)
```

**åŠŸèƒ½**:
- âœ… å¤„ç†ç§æœ‰WSè®¢å•äº‹ä»¶
- âœ… è§£æè®¢å•æ•°æ®
- âœ… å†™å…¥äº‹å®è¡¨ï¼ˆ`hg_trading_exchange_order`ï¼‰
- âœ… ä¾›å‰ç«¯æŒ‚å•åˆ—è¡¨å±•ç¤º

---

## ğŸŒ äº¤æ˜“æ‰€æ¥å£å¯¹æ¯”

### GetOrderHistory å®ç°å¯¹æ¯”

| äº¤æ˜“æ‰€ | APIç«¯ç‚¹ | å¿…éœ€å‚æ•° | å¯é€‰å‚æ•° | æœ€å¤§limit | è¿”å›æ ¼å¼ |
|--------|---------|---------|---------|-----------|---------|
| **Binance** | `/fapi/v1/allOrders` | - | `symbol`<br>`limit` | 1000 | æ ‡å‡†Order[] |
| **Bitget** | `/api/v2/mix/order/fills` | `symbol` | `pageSize` | 100 | V2æ ¼å¼ |
| **OKX** | `/api/v5/trade/orders-history` | - | `instId`<br>`limit` | 100 | æ ‡å‡†æ ¼å¼ |
| **Gate** | `/futures/usdt/orders` | `contract` | `limit`<br>`status` | - | æ ‡å‡†æ ¼å¼ |

### GetTradeHistory å®ç°å¯¹æ¯”

| äº¤æ˜“æ‰€ | æ˜¯å¦å®ç° | APIç«¯ç‚¹ | ç”¨é€” |
|--------|---------|---------|------|
| **Binance** | âœ… | `/fapi/v1/userTrades` | è·å–æˆäº¤æ˜ç»† |
| **Bitget** | âœ… | `/api/v2/mix/order/fills` | æˆäº¤æµæ°´ |
| **OKX** | âœ… | `/api/v5/trade/fills-history` | æˆäº¤è®°å½• |
| **Gate** | âœ… | `/futures/usdt/my_trades` | æˆäº¤å†å² |

**æ³¨æ„äº‹é¡¹**:
- `GetOrderHistory`: è¿”å›è®¢å•åˆ—è¡¨ï¼ˆå¯èƒ½åŒ…å«æœªæˆäº¤è®¢å•ï¼‰
- `GetTradeHistory`: è¿”å›æˆäº¤è®°å½•ï¼ˆåªæœ‰å®é™…æˆäº¤çš„è®°å½•ï¼‰
- ç›ˆäº/æ‰‹ç»­è´¹ç²¾ç¡®æ•°æ®é€šå¸¸åœ¨ `GetTradeHistory` ä¸­

---

## ğŸ¯ å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: å‰ç«¯æŸ¥è¯¢è®¢å•åˆ—è¡¨

```
ç”¨æˆ·æ‰“å¼€"äº¤æ˜“æ˜ç»†"é¡µé¢
  â†“
è°ƒç”¨ GET /api/toogo/wallet/order-history
  â†“
åç«¯æŸ¥è¯¢æ•°æ®åº“ (10mså“åº”)
  â†“
æ£€æŸ¥æ˜¯å¦éœ€è¦å¢å¼º:
  â”œâ”€ è€è®¢å•/å®Œæ•´æ•°æ® â†’ ç›´æ¥è¿”å› âœ…
  â””â”€ è¿‘14å¤©+ç¼ºå¤±å­—æ®µ â†’ è°ƒç”¨äº¤æ˜“æ‰€APIå¢å¼º
  â†“
è¿”å›å®Œæ•´æ•°æ®ç»™å‰ç«¯
```

### åœºæ™¯2: æœºå™¨äººè¿è¡Œä¸­è®¢å•åŒæ­¥

```
OrderStatusSyncService æ¯ç§’æ‰«æ
  â†“
éå†è¿è¡Œä¸­æœºå™¨äºº
  â†“
æ£€æŸ¥å¼•æ“ç¼“å­˜ (120ç§’)
  â”œâ”€ ç¼“å­˜æœ‰æ•ˆ â†’ ä½¿ç”¨ç¼“å­˜
  â””â”€ ç¼“å­˜è¿‡æœŸ â†’ è°ƒç”¨ GetOrderHistorySmart()
  â†“
åŒæ­¥åˆ°æ•°æ®åº“ SyncOrderHistoryToDB()
  â†“
æŒä»“å¯¹è´¦ syncPositionsWithCache()
  â”œâ”€ æ£€æµ‹æ‰‹åŠ¨å¹³ä»“
  â”œâ”€ æ£€æµ‹å¤–éƒ¨æŒä»“
  â””â”€ æ›´æ–°æœªå®ç°ç›ˆäº
```

### åœºæ™¯3: æ£€æµ‹æ‰‹åŠ¨å¹³ä»“

```
å®šæœŸåŒæ­¥æ£€æµ‹åˆ°:
  æœ¬åœ°è®¢å•: status=1 (æŒä»“ä¸­)
  äº¤æ˜“æ‰€æŒä»“: ä¸ºç©º
  â†“
è§¦å‘æ‰‹åŠ¨å¹³ä»“æ£€æµ‹
  â†“
è°ƒç”¨ tryCloseInfoFromTradeHistory()
  â†“
ä»æˆäº¤è®°å½•æ¨æ–­:
  â”œâ”€ å¹³ä»“ä»·æ ¼ (closePrice)
  â”œâ”€ å·²å®ç°ç›ˆäº (realizedProfit)
  â”œâ”€ å¹³ä»“æ‰‹ç»­è´¹ (closeFee)
  â”œâ”€ å¹³ä»“è®¢å•ID (closeOrderId)
  â””â”€ å¹³ä»“æ—¶é—´ (ts)
  â†“
æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å¹³ä»“:
  UPDATE hg_trading_order SET
    status = 2,
    close_price = ?,
    realized_profit = ?,
    close_fee = ?,
    close_order_id = ?,
    close_time = ?,
    close_reason = 'manual_exchange'
```

### åœºæ™¯4: WebSocketå®æ—¶æ¨é€

```
äº¤æ˜“æ‰€æ¨é€è®¢å•çŠ¶æ€å˜æ›´
  â†“
WebSocket Client æ¥æ”¶ PrivateEvent
  â†“
UpsertExchangeOrdersFromPrivateEvent()
  â†“
è§£æè®¢å•æ•°æ®
  â†“
å†™å…¥äº‹å®è¡¨ hg_trading_exchange_order
  â†“
å‰ç«¯æŒ‚å•åˆ—è¡¨å®æ—¶æ›´æ–°
```

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥æŒ‡å—

### é—®é¢˜1: è®¢å•æ•°æ®ä¸æ›´æ–°

**ç°è±¡**: å‰ç«¯çœ‹åˆ°çš„è®¢å•æ•°æ®ä¸€ç›´ä¸å˜

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æœºå™¨äººæ˜¯å¦åœ¨è¿è¡Œ (`status = 2`)
2. æŸ¥çœ‹å¼•æ“ç¼“å­˜æ—¶é—´: `engine.LastOrderHistoryUpdate`
3. æ£€æŸ¥åŒæ­¥æœåŠ¡æ˜¯å¦æ­£å¸¸: `OrderStatusSyncService`
4. æŸ¥çœ‹äº¤æ˜“æ‰€APIè°ƒç”¨æ—¥å¿—

**è§£å†³æ–¹æ¡ˆ**:
```go
// å¼ºåˆ¶åˆ·æ–°å¼•æ“ç¼“å­˜
engine := GetRobotTaskManager().GetEngine(robotId)
engine.mu.Lock()
engine.LastOrderHistoryUpdate = time.Time{} // é‡ç½®ç¼“å­˜æ—¶é—´
engine.mu.Unlock()

// æ‰‹åŠ¨è§¦å‘åŒæ­¥
service.OrderStatusSync().syncRobotOrders(ctx, robot)
```

### é—®é¢˜2: ç›ˆäº/æ‰‹ç»­è´¹æ•°æ®ä¸º0

**ç°è±¡**: `realized_profit` æˆ– `close_fee` å­—æ®µä¸º0

**åŸå› åˆ†æ**:
- äº¤æ˜“æ‰€APIæœªè¿”å›æˆäº¤æ˜ç»†
- `GetTradeHistory` æœªå‘½ä¸­è®¢å•ID
- ç¼“å­˜æ•°æ®ä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆ**:
```go
// 1. æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°æ‹‰å–
cacheKey := fmt.Sprintf("toogo:orderHistory:trades:%d:%s:%d", apiId, symbol, limit)
orderHistoryTradeCache.Remove(ctx, cacheKey)

// 2. æ‰©å¤§limité‡æ–°æŸ¥è¯¢
trades, err := ex.GetTradeHistory(ctx, symbol, 1200) // ä»400æ‰©å¤§åˆ°1200

// 3. æ‰‹åŠ¨è¡¥å…¨æ•°æ®
dao.TradingOrder.Ctx(ctx).
    Where("id", orderId).
    Update(g.Map{
        "realized_profit": calculatedProfit,
        "close_fee": calculatedFee,
    })
```

### é—®é¢˜3: è®¢å•é‡å¤åˆ›å»º

**ç°è±¡**: åŒä¸€ä¸ªäº¤æ˜“æ‰€è®¢å•åˆ›å»ºäº†å¤šæ¡è®°å½•

**åŸå› åˆ†æ**:
- `exchange_order_id` ä¸ºç©º
- å¹¶å‘åŒæ­¥æ—¶æœªæ­£ç¡®å»é‡

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- 1. æŸ¥æ‰¾é‡å¤è®¢å•
SELECT exchange_order_id, COUNT(*) as cnt
FROM hg_trading_order
WHERE robot_id = 123
  AND exchange_order_id != ''
GROUP BY exchange_order_id
HAVING COUNT(*) > 1;

-- 2. åˆ é™¤é‡å¤è®°å½•ï¼ˆä¿ç•™æœ€æ—©çš„ï¼‰
DELETE FROM hg_trading_order
WHERE id IN (
    SELECT id FROM (
        SELECT id, ROW_NUMBER() OVER (PARTITION BY exchange_order_id ORDER BY created_at) as rn
        FROM hg_trading_order
        WHERE robot_id = 123 AND exchange_order_id != ''
    ) t
    WHERE t.rn > 1
);
```

### é—®é¢˜4: æ‰‹åŠ¨å¹³ä»“æ£€æµ‹å¤±è´¥

**ç°è±¡**: åœ¨äº¤æ˜“æ‰€æ‰‹åŠ¨å¹³ä»“åï¼Œæœ¬åœ°è®¢å•ä»æ˜¾ç¤ºæŒä»“ä¸­

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥äº¤æ˜“æ‰€æ˜¯å¦çœŸçš„æ— æŒä»“: `GetPositions()`
2. æŸ¥çœ‹ `GetTradeHistory()` æ˜¯å¦è¿”å›å¹³ä»“è®°å½•
3. æ£€æŸ¥æ—¥å¿—: `[OrderStatusSync] æ£€æµ‹åˆ°æ‰‹åŠ¨å¹³ä»“`

**è§£å†³æ–¹æ¡ˆ**:
```go
// æ‰‹åŠ¨è§¦å‘å¹³ä»“æ£€æµ‹
robot := getRobot(robotId)
exchange := getExchange(robot)
positions, _ := exchange.GetPositions(ctx, robot.Symbol)

// å¦‚æœäº¤æ˜“æ‰€ç¡®å®æ— æŒä»“ï¼Œæ‰‹åŠ¨æ›´æ–°
if len(positions) == 0 {
    dao.TradingOrder.Ctx(ctx).
        Where("robot_id", robotId).
        Where("status", 1).
        Update(g.Map{
            "status": 2,
            "close_reason": "manual_exchange",
            "close_time": gtime.Now(),
        })
}
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡å‚è€ƒ

### å…³é”®æŒ‡æ ‡

```prometheus
# 1. APIè°ƒç”¨æ¬¡æ•°
exchange_api_calls_total{exchange="binance", method="GetOrderHistory", result="success"} 1234

# 2. ç¼“å­˜å‘½ä¸­ç‡
order_cache_hit_rate{cache_type="engine"} 0.92
order_cache_hit_rate{cache_type="api"} 0.85

# 3. åŒæ­¥è€—æ—¶
order_sync_duration_seconds{robot_id="123", result="success"} 0.015

# 4. æ•°æ®åº“æŸ¥è¯¢è€—æ—¶
order_query_duration_seconds{query_type="list"} 0.010
order_query_duration_seconds{query_type="detail"} 0.005

# 5. è®¢å•çŠ¶æ€åˆ†å¸ƒ
order_status_count{status="open"} 1523
order_status_count{status="closed"} 98456
order_status_count{status="canceled"} 234
```

### å‘Šè­¦è§„åˆ™

```yaml
# APIè°ƒç”¨å¤±è´¥ç‡è¿‡é«˜
- alert: HighExchangeAPIFailureRate
  expr: |
    rate(exchange_api_calls_total{result="error"}[5m]) 
    / 
    rate(exchange_api_calls_total[5m]) > 0.1
  for: 5m
  annotations:
    summary: "äº¤æ˜“æ‰€APIè°ƒç”¨å¤±è´¥ç‡è¶…è¿‡10%"

# ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½
- alert: LowOrderCacheHitRate
  expr: order_cache_hit_rate < 0.6
  for: 10m
  annotations:
    summary: "è®¢å•ç¼“å­˜å‘½ä¸­ç‡ä½äº60%"

# åŒæ­¥è€—æ—¶è¿‡é•¿
- alert: SlowOrderSync
  expr: order_sync_duration_seconds > 1
  for: 5m
  annotations:
    summary: "è®¢å•åŒæ­¥è€—æ—¶è¶…è¿‡1ç§’"
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£é“¾æ¥

- ğŸ“„ **è¯¦ç»†åˆ†ææŠ¥å‘Š**: `è®¢å•è·å–é€»è¾‘å’Œä¸šåŠ¡æµç¨‹åˆ†ææŠ¥å‘Š.md`
- ğŸ¨ **æ¶æ„æµç¨‹å›¾**: `è®¢å•è·å–æµç¨‹æ¶æ„å›¾.md`
- ğŸ” **è‡ªåŠ¨äº¤æ˜“é€»è¾‘**: `è‡ªåŠ¨äº¤æ˜“é€»è¾‘æ£€æŸ¥æŠ¥å‘Š.md`

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ç¼“å­˜ä½¿ç”¨å»ºè®®

```go
// âœ… æ¨èï¼šä¼˜å…ˆä½¿ç”¨å¼•æ“ç¼“å­˜
engine := GetRobotTaskManager().GetEngine(robotId)
if engine != nil {
    orders, lastUpdate := engine.GetCachedOrderHistory()
    if time.Since(lastUpdate) < 120*time.Second {
        return orders // ä½¿ç”¨ç¼“å­˜
    }
}

// âŒ ä¸æ¨èï¼šç›´æ¥è°ƒç”¨äº¤æ˜“æ‰€API
orders, err := exchange.GetOrderHistory(ctx, symbol, 50)
```

### 2. æ•°æ®å¢å¼ºç­–ç•¥

```go
// âœ… æ¨èï¼šæ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦å¢å¼º
needEnhance := (order.Status == 2) && 
               (order.CloseTime.After(now.Add(-14*24*time.Hour))) &&
               (order.RealizedProfit == 0)

// âŒ ä¸æ¨èï¼šæ‰€æœ‰è®¢å•éƒ½å¢å¼º
for _, order := range orders {
    tradeHistory := getTradeHistory(order) // è¿‡åº¦APIè°ƒç”¨
}
```

### 3. é”™è¯¯å¤„ç†

```go
// âœ… æ¨èï¼šé™çº§å¤„ç†
orders, err := engine.GetOrderHistorySmart(ctx, 0, 50)
if err != nil {
    // é™çº§åˆ°æ•°æ®åº“
    orders = getOrdersFromDB(robotId)
}

// âŒ ä¸æ¨èï¼šç›´æ¥è¿”å›é”™è¯¯
orders, err := exchange.GetOrderHistory(ctx, symbol, 50)
if err != nil {
    return nil, err // ç”¨æˆ·ä½“éªŒå·®
}
```

### 4. å¹¶å‘æ§åˆ¶

```go
// âœ… æ¨èï¼šä½¿ç”¨singleflighté˜²é‡
result := singleflight.Do(key, func() (interface{}, error) {
    return exchange.GetOrderHistory(ctx, symbol, 50)
})

// âŒ ä¸æ¨èï¼šæ— å¹¶å‘æ§åˆ¶
for i := 0; i < 10; i++ {
    go func() {
        exchange.GetOrderHistory(ctx, symbol, 50) // é‡å¤è°ƒç”¨
    }()
}
```

---

**æœ€åæ›´æ–°**: 2025-12-26  
**ç»´æŠ¤äºº**: AI Assistant

