# 策略参数显示错误问题修复说明

## 问题描述

用户反映：实时市场状态是"震荡"，风险偏好是"平衡"，应该使用策略模板"BTC-USDT 官方策略 V5.0 (我的副本)"中对应的参数，但实际显示的参数是错误的。

**应该使用的参数：**
- 时间窗口: 60秒
- 波动值: 50U
- 杠杆: 10x
- 保证金: 10%
- 止损: 10%
- 启动止盈: 5%
- 止盈回撤: 10%

**实际显示的参数：**
- 窗口: 1分钟（60秒，正确）
- 波动: 15.0U（错误，应该是50U）
- 杠杆: 7x（错误，应该是10x）
- 保证金: 12%（错误，应该是10%）
- 止损: 5%（错误，应该是10%）
- 启动止盈: 3%（错误，应该是5%）
- 止盈回撤: 25%（错误，应该是10%）
- 亏反: 50%（可能错误）
- 盈反: 100%（可能错误）

## 问题根源

### 1. 策略参数未正确初始化

**问题：** `CurrentStrategyParams` 可能为 `nil`，导致前端显示时使用了数据库中的静态配置（`robot.Leverage`, `robot.MarginPercent` 等），而不是从策略模板动态加载的参数。

**位置：** `server/internal/logic/trading/monitor.go:476-540` - `buildConfigInfo()` 函数

**原因：**
- 如果 `engine.CurrentStrategyParams` 为 `nil`，函数会回退到使用 `robot.Leverage`、`robot.MarginPercent` 等数据库静态字段
- 这些静态字段可能不是最新的策略模板参数

### 2. 策略参数加载时机问题

**问题：** 策略参数只在市场状态变化时更新，首次初始化时可能不会更新。

**位置：** `server/internal/logic/toogo/robot_engine.go:429-477` - `checkAndUpdateStrategyConfig()` 函数

**原因：**
- 原逻辑：`if currentMarketState == "" || currentMarketState == e.LastMarketState { return }`
- 如果首次分析时市场状态与 `LastMarketState`（空字符串）相同，就不会更新

## 修复方案

### 修复1：允许首次初始化时更新策略参数

**文件：** `server/internal/logic/toogo/robot_engine.go`

**修改：** `checkAndUpdateStrategyConfig()` 函数

**修改内容：**
```go
// 修改前：
if currentMarketState == "" || currentMarketState == e.LastMarketState {
    return
}

// 修改后：
// 如果市场状态为空，不更新
if currentMarketState == "" {
    return
}

// 检查是否需要更新：首次初始化（LastMarketState为空）或市场状态变化
e.mu.RLock()
needUpdate := e.LastMarketState == "" || currentMarketState != e.LastMarketState
e.mu.RUnlock()

if !needUpdate {
    return
}
```

**效果：** 首次初始化时（`LastMarketState` 为空），即使市场状态与上次相同，也会更新策略参数。

### 修复2：完善下单时的参数获取逻辑

**文件：** `server/internal/logic/toogo/robot_engine.go`

**修改：** `executeOpen()` 函数

**修改内容：**
- 优先使用 `LastMarketState`
- 如果为空，尝试从 `LastAnalysis.MarketState` 获取
- 如果策略参数为 `nil`，重新加载并缓存

**效果：** 确保下单时使用正确的市场状态和风险偏好。

### 修复3：添加公开方法供外部调用

**文件：** `server/internal/logic/toogo/robot_engine.go`

**修改：** 添加 `LoadFullStrategyParams()` 公开方法

**修改内容：**
```go
// LoadFullStrategyParams 从策略模板加载完整参数（公开方法，供外部调用）
func (e *RobotEngine) LoadFullStrategyParams(ctx context.Context, marketState, riskPreference string) *StrategyParams {
	return e.loadFullStrategyParams(ctx, marketState, riskPreference)
}
```

**效果：** 允许外部代码（如 `monitor.go`）在需要时重新加载策略参数。

### 修复4：完善 buildConfigInfo 中的策略参数获取

**文件：** `server/internal/logic/trading/monitor.go`

**修改：** `buildConfigInfo()` 函数

**修改内容：**
- 如果 `CurrentStrategyParams` 为 `nil`，尝试重新加载
- 使用 `LoadFullStrategyParams()` 方法重新加载策略参数
- 添加日志记录，便于排查问题

**效果：** 确保前端显示时使用正确的策略参数，而不是数据库静态配置。

## 修复后的执行流程

### 1. 机器人启动时

```
启动 → doAnalysis() → Analyzer.Analyze() → 获取市场状态
  → checkAndUpdateStrategyConfig()
  → LastMarketState == "" → 允许更新 ✅
  → loadFullStrategyParams(marketState, riskPreference)
  → CurrentStrategyParams = strategyParams ✅
```

### 2. 前端获取数据时

```
GetBatchRobotAnalysis()
  → GetRobotAnalysis()
    → buildConfigInfo()
      → 检查 engine.CurrentStrategyParams
      → 如果为 nil：
          → LoadFullStrategyParams() 重新加载 ✅
          → 使用加载的参数 ✅
      → 如果不为 nil：
          → 直接使用缓存的参数 ✅
```

### 3. 下单时

```
executeOpen()
  → 检查 CurrentStrategyParams
  → 如果为 nil：
      → 获取 marketState（优先 LastMarketState，其次 LastAnalysis.MarketState）
      → loadFullStrategyParams(marketState, riskPreference)
      → 缓存到 CurrentStrategyParams ✅
  → 使用策略参数下单 ✅
```

## 验证方法

### 1. 查看日志

修复后应该能看到以下日志：

**策略参数初始化：**
```
[RobotEngine] robotId=X 市场状态变化:  → volatile, 风险偏好(机器人配置): balanced, 策略参数: 窗口=60s, 波动=50.0, 杠杆=10-10, 保证金=10.0-10.0%
```

**策略参数重新加载（如果未初始化）：**
```
[Monitor] robotId=X 策略参数已重新加载: market=volatile, risk=balanced, 杠杆=10, 保证金=10.0%, 止损=10.0%, 窗口=60, 波动=50.0
```

### 2. 检查前端显示

前端应该显示：
- 窗口: 1分钟（60秒）
- 波动: 50.0U
- 杠杆: 10x
- 保证金: 10%
- 止损: 10%
- 启动止盈: 5%
- 止盈回撤: 10%

### 3. 检查策略模板

确保数据库中存在对应的策略模板：

```sql
SELECT * FROM hg_trading_strategy_template 
WHERE group_id = (SELECT id FROM hg_trading_strategy_group WHERE group_name LIKE '%BTC-USDT 官方策略 V5.0%')
  AND market_state = 'volatile' 
  AND risk_preference = 'balanced' 
  AND is_active = 1;
```

应该返回：
- `monitor_window`: 60
- `volatility_threshold`: 50.0
- `leverage`: 10
- `margin_percent`: 10.0
- `stop_loss_percent`: 10.0
- `auto_start_retreat_percent`: 5.0
- `profit_retreat_percent`: 10.0

## 注意事项

1. **策略模板必须存在**：如果策略模板不存在，会使用默认参数（根据风险偏好）
2. **市场状态必须正确**：确保市场分析模块正常工作，能正确判断市场状态为 "volatile"（震荡）
3. **风险偏好必须配置**：机器人的 `risk_preference` 字段必须设置为 "balanced"（平衡）
4. **策略组ID必须正确**：机器人的 `strategy_group_id` 必须指向正确的策略组

## 相关文件

- `server/internal/logic/toogo/robot_engine.go` - 机器人引擎核心逻辑
- `server/internal/logic/trading/monitor.go` - 监控模块，负责组装前端数据
- `server/internal/logic/toogo/robot_engine.go:429-477` - `checkAndUpdateStrategyConfig()` 函数
- `server/internal/logic/toogo/robot_engine.go:2413-2521` - `executeOpen()` 函数
- `server/internal/logic/trading/monitor.go:476-540` - `buildConfigInfo()` 函数

## 总结

修复后的系统会：
1. ✅ 在首次初始化时正确加载策略参数
2. ✅ 根据市场状态和风险偏好动态加载策略参数
3. ✅ 在前端显示时使用正确的策略参数
4. ✅ 在下单时使用正确的动态参数
5. ✅ 提供详细的日志信息用于验证

如果问题仍然存在，请检查：
- 策略模板是否正确配置（特别是 `volatile` + `balanced` 组合）
- 市场状态是否正确分析为 "volatile"
- 机器人的风险偏好是否正确设置为 "balanced"
- 机器人的策略组ID是否正确

