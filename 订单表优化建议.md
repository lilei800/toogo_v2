# 订单表优化建议（完整版）

## 一、设计理念：开仓与平仓合并到一个订单表

**答案：完全可以！** 订单表本身就是设计为保存订单的完整生命周期（从开仓到平仓）。

### 1.1 设计优势

✅ **单一数据源**：一个订单记录包含从开仓到平仓的完整信息，便于查询和分析  
✅ **数据一致性**：避免开仓和平仓数据分散在不同表导致的同步问题  
✅ **简化查询**：一次查询即可获取订单的完整信息  
✅ **历史追溯**：可以完整追溯订单的每个关键节点  

### 1.2 表结构设计

订单表使用 `status` 字段区分订单状态：
- `status = 0`：未成交（开仓订单已提交但未成交）
- `status = 1`：持仓中（开仓成功，等待平仓）
- `status = 2`：已平仓（平仓完成，订单生命周期结束）
- `status = 3`：已取消（订单被取消）

**开仓时**：创建订单记录，设置 `status = 1`，填充开仓相关字段  
**平仓时**：更新同一订单记录，设置 `status = 2`，填充平仓相关字段

## 二、创建订单时保存的数据（已修正）

### 2.1 修正说明

**❌ 错误做法（已修正）：**
- 保存信号信息（`signal_reason`, `signal_strength`, `signal_confidence`）
- 使用错误的字段名（`order_id` 应该是 `exchange_order_id`）

**✅ 正确做法：**
- 根据**实时的市场状态和风险偏好**匹配策略参数
- 不保存信号信息（信号信息应保存在信号日志表）
- 使用正确的数据库字段名

### 2.2 创建订单时保存的完整数据

#### A. 基础信息
```go
- user_id              // 用户ID
- robot_id             // 机器人ID
- exchange             // 交易所平台
- symbol               // 交易对
- exchange_order_id    // 交易所订单ID（开仓订单ID）
- client_order_id      // 客户端订单ID
- order_sn             // 系统生成的订单号
- direction            // 持仓方向：long/short
```

#### B. 价格和数量信息
```go
- price                // 委托价格
- avg_price            // 平均成交价格
- open_price           // 开仓价格（明确字段，等于avg_price）
- quantity             // 订单数量
- filled_qty           // 已成交数量
```

#### C. 订单类型信息
```go
- order_type           // 订单类型：MARKET/LIMIT
- order_type_detail    // 订单类型详情：market_open_long/market_open_short/limit_open_long/limit_open_short
- exchange_side        // 交易所买卖方向：BUY/SELL
```

#### D. 开仓信息（创建时填充）
```go
- open_time            // 开仓时间（明确字段，区别于created_at）
- open_margin          // 开仓保证金(USDT) = quantity * price / leverage
- open_fee             // 开仓手续费（待交易所返回后更新）
- open_fee_coin        // 开仓手续费币种
```

#### E. 市场状态和风险偏好（实时映射关系）
```go
- market_state         // 实时市场状态（创建订单时的实时市场状态）
- risk_level           // 实时风险偏好（来自映射关系，根据实时市场状态匹配）
```

#### F. 策略参数（根据实时市场状态和风险偏好匹配）
```go
- leverage             // 杠杆倍数（来自策略模板）
- margin_percent       // 保证金比例(%)
- stop_loss_percent    // 止损百分比(%)
- auto_start_retreat_percent  // 启动止盈百分比(%)
- profit_retreat_percent      // 止盈回撤百分比(%)
```

#### G. 订单状态
```go
- status               // 订单状态：0=未成交, 1=持仓中, 2=已平仓, 3=已取消
- created_at           // 创建时间
- updated_at           // 更新时间
```

## 三、平仓时保存的数据（已优化）

### 3.1 平仓时更新的字段

#### A. 平仓订单信息
```go
- close_order_id       // 平仓订单ID（交易所返回的平仓订单ID）
- close_client_order_id // 平仓客户端订单ID
- close_fee            // 平仓手续费
- close_fee_coin       // 平仓手续费币种
```

#### B. 平仓价格和时间
```go
- close_price          // 平仓价格
- close_time           // 平仓时间
- hold_duration        // 持仓时长(秒) = close_time - open_time
```

#### C. 平仓时的市场环境（用于分析）
```go
- close_market_state   // 平仓时的市场状态（用于分析市场环境变化）
- close_mark_price     // 平仓时的标记价格
- close_leverage       // 平仓时的杠杆倍数（可能已变更）
- close_margin_mode    // 平仓时的保证金模式：isolated/crossed
- close_quantity       // 平仓时的持仓数量
```

#### D. 平仓时的盈亏详情
```go
- realized_profit      // 已实现盈亏
- close_unrealized_profit // 平仓时的未实现盈亏（平仓前最后一次）
- close_highest_profit    // 平仓时的最高盈利（最终值）
```

#### E. 平仓原因和状态
```go
- close_reason         // 平仓原因：stop_loss/take_profit/manual/timeout
- status               // 更新为 2（已平仓）
```

#### F. 算力扣除（业务逻辑）
```go
- 如果 realized_profit > 0，扣除算力（通过 ToogoWallet().ConsumePower）
- 算力扣除记录在钱包表中，不在订单表
```

## 四、数据库表结构优化建议

### 4.1 新增字段（SQL）

```sql
-- ===== 开仓相关字段（创建订单时填充）=====

-- 订单类型详细信息
ALTER TABLE hg_trading_order ADD COLUMN `order_type_detail` VARCHAR(30) DEFAULT NULL COMMENT '订单类型详情：market_open_long/market_open_short/limit_open_long/limit_open_short';

-- 交易所订单信息
ALTER TABLE hg_trading_order ADD COLUMN `exchange_side` VARCHAR(10) DEFAULT NULL COMMENT '交易所买卖方向：BUY/SELL';
ALTER TABLE hg_trading_order ADD COLUMN `order_type` VARCHAR(20) DEFAULT NULL COMMENT '订单类型：MARKET/LIMIT';

-- 开仓时的完整信息
ALTER TABLE hg_trading_order ADD COLUMN `open_time` DATETIME DEFAULT NULL COMMENT '开仓时间（明确的开仓时间，区别于created_at）';
ALTER TABLE hg_trading_order ADD COLUMN `open_margin` DECIMAL(20,8) DEFAULT 0 COMMENT '开仓时使用的保证金(USDT)';
ALTER TABLE hg_trading_order ADD COLUMN `open_fee` DECIMAL(20,8) DEFAULT 0 COMMENT '开仓手续费';
ALTER TABLE hg_trading_order ADD COLUMN `open_fee_coin` VARCHAR(20) DEFAULT NULL COMMENT '开仓手续费币种';

-- ===== 平仓相关字段（平仓时填充）=====

-- 平仓订单信息
ALTER TABLE hg_trading_order ADD COLUMN `close_order_id` VARCHAR(100) DEFAULT NULL COMMENT '平仓订单ID（交易所返回）';
ALTER TABLE hg_trading_order ADD COLUMN `close_client_order_id` VARCHAR(100) DEFAULT NULL COMMENT '平仓客户端订单ID';
ALTER TABLE hg_trading_order ADD COLUMN `close_fee` DECIMAL(20,8) DEFAULT 0 COMMENT '平仓手续费';
ALTER TABLE hg_trading_order ADD COLUMN `close_fee_coin` VARCHAR(20) DEFAULT NULL COMMENT '平仓手续费币种';

-- 平仓时的市场环境
ALTER TABLE hg_trading_order ADD COLUMN `close_market_state` VARCHAR(20) DEFAULT NULL COMMENT '平仓时的市场状态（用于分析）';
ALTER TABLE hg_trading_order ADD COLUMN `close_mark_price` DECIMAL(20,8) DEFAULT NULL COMMENT '平仓时的标记价格';
ALTER TABLE hg_trading_order ADD COLUMN `close_leverage` INT DEFAULT NULL COMMENT '平仓时的杠杆倍数（可能已变更）';
ALTER TABLE hg_trading_order ADD COLUMN `close_margin_mode` VARCHAR(20) DEFAULT NULL COMMENT '平仓时的保证金模式：isolated/crossed';
ALTER TABLE hg_trading_order ADD COLUMN `close_quantity` DECIMAL(20,8) DEFAULT NULL COMMENT '平仓时的持仓数量';

-- 平仓时的盈亏详情
ALTER TABLE hg_trading_order ADD COLUMN `close_unrealized_profit` DECIMAL(20,8) DEFAULT NULL COMMENT '平仓时的未实现盈亏（平仓前最后一次）';
ALTER TABLE hg_trading_order ADD COLUMN `close_highest_profit` DECIMAL(20,8) DEFAULT NULL COMMENT '平仓时的最高盈利（最终值）';

-- ===== 索引优化 =====
CREATE INDEX idx_trading_order_robot_status ON hg_trading_order(robot_id, status);
CREATE INDEX idx_trading_order_exchange_order_id ON hg_trading_order(exchange_order_id);
CREATE INDEX idx_trading_order_open_time ON hg_trading_order(open_time);
CREATE INDEX idx_trading_order_close_time ON hg_trading_order(close_time);
CREATE INDEX idx_trading_order_user_created ON hg_trading_order(user_id, created_at);
```

### 4.2 字段说明

#### 开仓字段（status = 1 时填充）
- `open_time`：明确的开仓时间，区别于 `created_at`（订单创建时间）
- `open_margin`：开仓时使用的保证金 = `quantity * open_price / leverage`
- `open_fee`：开仓手续费（从交易所订单返回后更新）

#### 平仓字段（status = 2 时填充）
- `close_order_id`：交易所返回的平仓订单ID（用于关联平仓订单）
- `close_fee`：平仓手续费
- `close_market_state`：平仓时的市场状态（用于分析市场环境变化对盈亏的影响）
- `close_leverage`：平仓时的杠杆（可能已变更，用于记录最终杠杆）
- `close_margin_mode`：平仓时的保证金模式（isolated/crossed）

## 五、代码实现要点

### 5.1 创建订单时（`robot_engine.go:recordOrder`）

```go
// ✅ 正确：根据实时市场状态和风险偏好匹配策略参数
// ❌ 错误：保存信号信息（信号信息应保存在信号日志表）

orderData := g.Map{
    // 基础信息
    "user_id":           robot.UserId,
    "robot_id":          robot.Id,
    "exchange":          t.engine.Platform,
    "symbol":            order.Symbol,
    "exchange_order_id": order.OrderId,  // ✅ 正确的字段名
    "client_order_id":   order.ClientId,
    "direction":         direction,
    "quantity":          order.Quantity,
    
    // 价格信息
    "price":             order.Price,
    "avg_price":         order.AvgPrice,
    "open_price":        order.AvgPrice,  // 明确的开仓价格
    "filled_qty":        order.FilledQty,
    
    // 订单类型
    "order_type":        order.Type,
    "order_type_detail": orderTypeDetail,
    "exchange_side":     order.Side,
    
    // 开仓信息
    "open_time":         gtime.Now(),
    "open_margin":       openMargin,      // 计算：quantity * price / leverage
    "open_fee":          0.0,              // 待交易所返回后更新
    "open_fee_coin":     "",
    
    // 市场状态和风险偏好（实时映射关系）
    "market_state":      marketState,     // 实时市场状态
    "risk_level":        riskPreference,  // 实时风险偏好（来自映射关系）
    
    // 策略参数（根据实时市场状态和风险偏好匹配）
    "leverage":          leverage,
    "margin_percent":    marginPercent,
    "stop_loss_percent": strategyParams.StopLossPercent,
    "auto_start_retreat_percent": strategyParams.AutoStartRetreatPercent,
    "profit_retreat_percent": strategyParams.ProfitRetreatPercent,
    
    // 订单状态
    "status":            orderStatus,     // 1=持仓中
    "created_at":        gtime.Now(),
    "updated_at":        gtime.Now(),
}
```

### 5.2 平仓时（`order_status_sync.go:closeOrder`）

```go
closeData := g.Map{
    // 平仓订单信息
    "close_order_id":        closeOrder.OrderId,
    "close_client_order_id": closeOrder.ClientId,
    "close_fee":             closeOrder.Fee,
    "close_fee_coin":        closeOrder.FeeCoin,
    
    // 平仓价格和时间
    "close_price":           closePrice,
    "close_time":             closeTime,
    "hold_duration":          holdDuration,
    
    // 平仓时的市场环境
    "close_market_state":    closeMarketState,
    "close_mark_price":      closeMarkPrice,
    "close_leverage":        closeLeverage,
    "close_margin_mode":      closeMarginMode,
    "close_quantity":        closeQuantity,
    
    // 平仓时的盈亏详情
    "realized_profit":       realizedProfit,
    "close_unrealized_profit": order.UnrealizedProfit,
    "close_highest_profit":   order.HighestProfit,
    
    // 平仓原因和状态
    "close_reason":          reason,
    "status":                2,  // 已平仓
    "updated_at":            closeTime,
}
```

## 六、数据流程

### 6.1 开仓流程

```
1. 检测到交易信号
   ↓
2. 获取实时市场状态（MarketAnalyzer）
   ↓
3. 根据市场状态和映射关系获取风险偏好
   ↓
4. 根据市场状态和风险偏好匹配策略模板
   ↓
5. 加载策略参数（杠杆、止损、止盈等）
   ↓
6. 计算订单数量、保证金等
   ↓
7. 调用交易所API下单
   ↓
8. 保存订单记录（status=1，填充开仓字段）
```

### 6.2 平仓流程

```
1. 检测到平仓条件（止损/止盈/手动）
   ↓
2. 调用交易所API平仓
   ↓
3. 获取平仓订单信息（订单ID、手续费等）
   ↓
4. 获取平仓时的市场环境（市场状态、标记价格等）
   ↓
5. 计算已实现盈亏
   ↓
6. 更新订单记录（status=2，填充平仓字段）
   ↓
7. 扣除算力（如果盈利）
```

## 七、总结

### 7.1 关键修正

1. ✅ **移除信号信息**：订单表不保存信号信息（`signal_reason`, `signal_strength`, `signal_confidence`）
2. ✅ **使用实时映射**：根据实时市场状态和风险偏好映射关系匹配策略参数
3. ✅ **字段名修正**：`order_id` → `exchange_order_id`
4. ✅ **完整信息保存**：开仓和平仓的所有关键信息都保存在同一订单记录中

### 7.2 设计优势

- **单一数据源**：一个订单记录包含完整生命周期
- **数据完整性**：开仓和平仓的所有关键信息都有记录
- **便于分析**：可以对比开仓时和平仓时的市场环境
- **简化查询**：一次查询即可获取订单的完整信息

### 7.3 实施建议

1. **分阶段实施**：先添加关键字段，再逐步完善
2. **数据迁移**：对于历史订单，可以通过同步逻辑补充缺失数据
3. **向后兼容**：新增字段设置默认值，确保不影响现有功能
4. **测试验证**：充分测试开仓和平仓流程，确保数据完整性
