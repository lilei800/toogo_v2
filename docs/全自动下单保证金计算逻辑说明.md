# 全自动下单保证金计算逻辑说明

## 一、调用流程

全自动下单调用交易所API开仓的完整流程：

```
机器人引擎检测到开仓信号
    ↓
CheckAndOpenPosition() - 检查并开仓
    ↓
executeOpen() - 执行开仓
    ↓
计算保证金和下单数量
    ↓
设置杠杆 SetLeverage()
    ↓
CreateOrder() - 调用交易所API下单
```

## 二、关键代码位置

**文件**: `server/internal/logic/toogo/engine/trader.go`

**函数**: `executeOpen()` (第73-171行)

## 三、保证金计算逻辑

### 3.1 计算公式

```go
// 第118行：计算保证金
margin := balance.AvailableBalance * marginPercent / 100

// 第119行：计算下单数量
quantity := margin * float64(leverage) / ticker.LastPrice
```

### 3.2 参数说明

1. **balance.AvailableBalance** - 可用余额
   - 来源：`t.engine.AccountBalance.AvailableBalance`
   - 从交易所API获取（Binance/Bitget等）
   - **注意**：这是"可用余额"，不是"总余额"

2. **marginPercent** - 保证金比例
   - 来源：策略模板的 `margin_percent` 字段
   - 计算方式：`(MarginPercentMin + MarginPercentMax) / 2`（取中值）
   - 如果策略模板只有一个值，则 `MarginPercentMin = MarginPercentMax = margin_percent`

3. **leverage** - 杠杆倍数
   - 来源：策略模板的 `leverage` 字段
   - 计算方式：`(LeverageMin + LeverageMax) / 2`（取中值）

### 3.3 计算示例

假设：
- **可用余额** (`AvailableBalance`) = 18.1 USDT
- **保证金比例** (`marginPercent`) = 10%
- **杠杆倍数** (`leverage`) = 10倍
- **当前价格** (`ticker.LastPrice`) = 100,000 USDT/BTC

计算过程：
```
1. 保证金 = 18.1 * 10 / 100 = 1.81 USDT
2. 下单数量 = 1.81 * 10 / 100000 = 0.000181 BTC
```

## 四、问题分析

### 4.1 用户反馈的问题

- 策略模板保证金：10%
- 平台账户余额：9.56 USDT
- 实际开仓保证金：1.81 USDT

### 4.2 可能的原因

#### 原因1：可用余额 vs 总余额

**关键区别**：
- **总余额** (`TotalBalance`) = 账户权益 = 钱包余额 + 未实现盈亏
- **可用余额** (`AvailableBalance`) = 总余额 - 已用保证金 - 冻结余额

**示例**：
```
总余额 = 9.56 USDT
已用保证金 = 0 USDT
未实现盈亏 = 8.54 USDT
可用余额 = 9.56 - 0 = 9.56 USDT（如果没有持仓）

或者：
总余额 = 18.1 USDT
可用余额 = 18.1 USDT
保证金 = 18.1 * 10% = 1.81 USDT ✅
```

#### 原因2：保证金比例范围

如果策略模板设置了范围（`margin_percent_min` 和 `margin_percent_max`），代码会取中值：

```go
marginPercent := (MarginPercentMin + MarginPercentMax) / 2
```

**示例**：
- 如果 `MarginPercentMin = 8%`, `MarginPercentMax = 12%`
- 则 `marginPercent = (8 + 12) / 2 = 10%`

但如果实际使用的是：
- `MarginPercentMin = 15%`, `MarginPercentMax = 25%`
- 则 `marginPercent = (15 + 25) / 2 = 20%`
- 保证金 = 9.56 * 20% = 1.912 USDT ≈ 1.81 USDT ✅

#### 原因3：余额更新延迟

`AvailableBalance` 是从交易所API实时获取的，可能与页面显示的余额有时间差。

## 五、验证方法

### 5.1 查看日志

开仓成功后会记录日志（第155-156行）：
```
[Trader] 开仓成功: robotId=%d, orderId=%s, side=%s, qty=%.4f, price=%.2f, leverage=%d, margin=%.2f%%
```

日志中会显示：
- `margin` - 实际使用的保证金
- `margin=%.2f%%` - 保证金比例

### 5.2 检查策略参数

查看机器人引擎加载的策略参数：
```
[RobotEngine] robotId=%d 策略参数缓存已刷新: market=%s, risk=%s, 窗口=%ds, 波动=%.2f, 杠杆=%d-%d, 保证金=%.1f-%.1f%%
```

### 5.3 检查账户余额

查看交易所API返回的余额：
- Binance: `availableBalance` 字段
- Bitget: `available` 字段

## 六、代码位置总结

| 功能 | 文件 | 行号 | 说明 |
|------|------|------|------|
| 开仓入口 | `engine/trader.go` | 27-64 | `CheckAndOpenPosition()` |
| 执行开仓 | `engine/trader.go` | 73-171 | `executeOpen()` |
| 保证金计算 | `engine/trader.go` | 118 | `margin := balance.AvailableBalance * marginPercent / 100` |
| 下单数量计算 | `engine/trader.go` | 119 | `quantity := margin * leverage / price` |
| 调用交易所API | `engine/trader.go` | 139-145 | `CreateOrder()` |
| 余额获取 | `library/exchange/binance.go` | 58 | `AvailableBalance: j.Get("availableBalance").Float64()` |
| 余额获取 | `library/exchange/bitget.go` | 120 | `AvailableBalance: j.Get("available").Float64()` |

## 七、建议

1. **查看日志**：检查开仓日志中的 `margin` 和 `margin=%.2f%%` 值
2. **检查策略参数**：确认实际使用的保证金比例范围
3. **检查可用余额**：确认 `AvailableBalance` 的实际值（不是总余额）
4. **添加调试日志**：在 `executeOpen()` 函数中添加日志输出 `AvailableBalance` 的值

## 八、调试代码示例

可以在 `executeOpen()` 函数中添加调试日志：

```go
g.Log().Infof(ctx, "[Trader] 开仓计算: robotId=%d, AvailableBalance=%.2f, marginPercent=%.2f%%, leverage=%d, 计算保证金=%.2f",
    robot.Id, balance.AvailableBalance, marginPercent, leverage, margin)
```

这样可以清楚地看到：
- 实际使用的可用余额
- 实际使用的保证金比例
- 计算出的保证金金额

