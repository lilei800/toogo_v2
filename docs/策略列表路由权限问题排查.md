# 策略列表路由权限问题排查

## 问题描述

从"官方策略管理"点击"查看策略"按钮后，跳转到 `/toogo/strategy/list` 出现权限问题。

**跳转路径**:
```
FROM: /toogo-admin/strategy (官方策略管理)
TO:   /toogo/strategy/list?groupId=10&groupName=... (策略列表)
```

---

## 路由结构分析

### 路由层级

```
/toogo (ToogoRoot - 量化交易)
  └─ /strategy (ToogoStrategy - 策略管理)
      ├─ /my (我的策略模板)
      ├─ /official (官方策略模板)
      ├─ /ranking (盈利排行策略)
      └─ /list (策略列表) ← 目标路由

/toogo-admin (ToogoAdmin - 量化管理)
  └─ /strategy (ToogoAdminStrategy - 官方策略管理) ← 起点路由
```

### 权限配置

**父路由 `/toogo`**:
```typescript
{
  path: '/toogo',
  name: 'ToogoRoot',
  component: Layout,
  redirect: '/toogo/dashboard',
  meta: {
    title: '量化交易',
    icon: renderIcon(BarChartOutlined),
    sort: 2,
    // permissions: 未设置，可能继承默认权限
  },
  children: [...]
}
```

**策略管理父路由 `/toogo/strategy`**:
```typescript
{
  path: 'strategy',
  name: 'ToogoStrategy',
  component: ParentLayout,
  redirect: '/toogo/strategy/my',
  meta: {
    title: '策略管理',
    icon: renderIcon(SettingOutlined),
    permissions: [], // ✅ 已设置为空数组
  },
  children: [...]
}
```

**目标路由 `/toogo/strategy/list`**:
```typescript
{
  path: 'list',
  name: 'StrategyList',
  component: () => import('@/views/toogo/strategy/list.vue'),
  meta: {
    title: '策略列表',
    hidden: true,
    activeMenu: '/toogo/strategy/my',
    permissions: [], // ✅ 已设置为空数组
    ignoreAuth: false, // 仍需登录
  },
}
```

---

## 可能的原因

### 1. 跨父路由跳转权限问题

**问题**: 从 `/toogo-admin` 跳转到 `/toogo` 时，可能触发权限重新验证。

**解决**: 确保 `/toogo` 根路由也有合适的权限配置。

### 2. 动态路由未生成

**问题**: 路由守卫在第一次访问时会动态生成路由，如果 `generateRoutes` 没有包含这个路由，就会404。

**解决**: 检查 `asyncRoute.ts` 中的路由生成逻辑。

### 3. 路由未正确注册

**问题**: 由于修改路由后没有重启前端服务，路由可能未正确注册。

**解决**: 重启前端开发服务器。

---

## 解决方案

### 方案1: 添加 `/toogo` 根路由权限配置

**文件**: `web/src/router/modules/toogo.ts`

```typescript
{
  path: '/toogo',
  name: 'ToogoRoot',
  component: Layout,
  redirect: '/toogo/dashboard',
  meta: {
    title: '量化交易',
    icon: renderIcon(BarChartOutlined),
    sort: 2,
    permissions: [], // 添加此行
  },
  children: [...]
}
```

### 方案2: 使用完整路由路径跳转

**文件**: `web/src/views/toogo/admin/strategy/index.vue`

确保跳转使用完整路径：

```typescript
function viewStrategies(row: any) {
  const url = `/toogo/strategy/list?groupId=${row.id}&groupName=${encodeURIComponent(row.groupName)}`;
  router.push(url);
}
```

### 方案3: 重启前端服务

**关键**: 路由配置修改后必须重启！

```bash
cd D:\go\src\hotgo_v2\web
# Ctrl + C 停止
npm run dev
```

---

## 测试步骤

### 1. 重启前端服务

```bash
cd D:\go\src\hotgo_v2\web
# 停止当前服务 (Ctrl + C)
npm run dev
```

### 2. 清除浏览器缓存

```
Ctrl + Shift + R (强制刷新)
或
F12 → Application → Clear storage → Clear site data
```

### 3. 重新登录

有时需要重新登录以刷新权限：

```
1. 退出登录
2. 重新登录
3. 进入"量化管理 → 官方策略管理"
4. 点击"查看策略"
```

### 4. 验证路由

在浏览器控制台执行：

```javascript
// 检查路由是否存在
console.log(router.getRoutes().find(r => r.name === 'StrategyList'))

// 检查当前路由
console.log(router.currentRoute.value)

// 检查权限
console.log(router.currentRoute.value.meta)
```

---

## 调试信息

### 检查路由生成

**文件**: `web/src/store/modules/asyncRoute.ts`

查看 `generateRoutes` 方法中的路由过滤逻辑：

```typescript
// 可能的过滤逻辑
routes.forEach((route) => {
  if (route.meta?.permissions && route.meta.permissions.length > 0) {
    // 检查用户是否有该权限
    if (!hasPermission(route.meta.permissions)) {
      return; // 跳过此路由
    }
  }
  // 添加路由
})
```

### 检查用户权限

在浏览器控制台：

```javascript
// 获取用户信息和权限
import { useUserStoreWidthOut } from '@/store/modules/user'
const userStore = useUserStoreWidthOut()
console.log('用户权限:', userStore.permissions)
console.log('用户角色:', userStore.roles)
```

---

## 最终解决方案

### ✅ 推荐方案（已实施）

1. **已添加父路由权限配置**
   ```typescript
   permissions: [] // 在 ToogoStrategy 路由已设置
   ```

2. **已添加目标路由权限配置**
   ```typescript
   permissions: [] // 在 StrategyList 路由已设置
   ```

3. **使用字符串路径跳转**
   ```typescript
   const url = `/toogo/strategy/list?groupId=${row.id}&groupName=${encodeURIComponent(row.groupName)}`;
   router.push(url);
   ```

### ⚠️ 必须操作

**重启前端开发服务器**（非常重要！）

```bash
cd D:\go\src\hotgo_v2\web
# Ctrl + C 停止
npm run dev
```

---

## 预期结果

### ✅ 成功状态

1. 点击"查看策略"按钮
2. URL 正确跳转到 `/toogo/strategy/list?groupId=xxx`
3. 页面正常加载，显示策略列表
4. 无权限错误，无404错误

### ❌ 如果仍然失败

#### 检查1: 路由是否注册

```javascript
// 在浏览器控制台
const routes = router.getRoutes()
console.log(routes.filter(r => r.path.includes('strategy')))
```

#### 检查2: 是否有权限错误

```javascript
// 查看 Network 标签
// 是否有 API 请求返回 403 或 401
```

#### 检查3: 查看控制台错误

```javascript
// F12 打开开发者工具
// 查看 Console 标签的错误信息
```

---

**创建时间**: 2025-12-03  
**状态**: ⚠️ 待验证（需要重启前端服务）  
**关键**: 必须重启前端服务才能生效！

















