# 定时倒计时功能实现说明

## ✅ 已实现功能

### 1. 更新类型定义

**文件**: `composables/useRobotList.ts`

添加了定时字段：

```typescript
scheduleStart?: string;  // 定时启动时间
scheduleStop?: string;   // 定时停止时间
```

### 2. 创建倒计时组件

**文件**: `components/ScheduleCountdown.vue`

**功能特性**:

- ✅ 每秒自动更新倒计时
- ✅ 智能显示格式（天/小时/分钟/秒）
- ✅ 根据机器人状态自动显示/隐藏
- ✅ 启动倒计时（绿色图标）
- ✅ 停止倒计时（橙色图标）
- ✅ 自动清理定时器

**显示规则**:

- 启动倒计时：只在机器人未运行时显示
- 停止倒计时：只在机器人运行中时显示
- 超时自动隐藏

### 3. 集成到机器人卡片

**文件**: `components/RobotCard.vue`

**显示位置**:

- 启动按钮后面 → 显示定时启动倒计时
- 停止按钮后面 → 显示定时停止倒计时

---

## 🎯 显示效果

### 未启动状态 + 有定时启动

```
[启动] ⏰ 2小时30分后自动启动    [详情] [配置] [删除]
```

### 运行中状态 + 有定时停止

```
[暂停] ⚠️ 5小时45分后自动停止    [详情] [配置] [删除]
```

### 无定时设置

```
[启动]    [详情] [配置] [删除]
```

---

## 💡 技术实现

### 倒计时计算逻辑

```typescript
// 1. 获取时间差
const now = Date.now();
const targetTime = new Date(scheduleTime).getTime();
const diff = targetTime - now;

// 2. 格式化显示
if (days > 0) {
  return `${days}天${hours % 24}小时`;
} else if (hours > 0) {
  return `${hours}小时${minutes % 60}分`;
} else if (minutes > 0) {
  return `${minutes}分${seconds % 60}秒`;
} else {
  return `${seconds}秒`;
}
```

### 智能显示控制

```typescript
// 启动倒计时：只在未运行时显示
if (mode === 'start' && robotStatus === 2) {
  return ''; // 运行中不显示
}

// 停止倒计时：只在运行中时显示
if (mode === 'stop' && robotStatus !== 2) {
  return ''; // 未运行不显示
}
```

### 自动更新机制

```typescript
// 每秒更新一次
const timer = setInterval(calculateCountdown, 1000);

// 组件销毁时清理
onUnmounted(() => {
  if (timer) {
    clearInterval(timer);
  }
});
```

---

## 🎨 样式特点

### 颜色区分

- **启动倒计时**: 绿色 (`success`)

  - 图标: ⏰ ClockCircleOutlined
  - 文字: "X 天 X 小时后自动启动"

- **停止倒计时**: 橙色 (`warning`)
  - 图标: ⚠️ AlertOutlined
  - 文字: "X 天 X 小时后自动停止"

### 字体大小

- 图标: 14px
- 文字: 12px
- 深度: 2 (略灰)

---

## 🔄 数据流

```
后端 API
  ↓
返回 scheduleStart/scheduleStop
  ↓
Robot 接口接收
  ↓
传递给 ScheduleCountdown 组件
  ↓
计算倒计时
  ↓
每秒更新显示
  ↓
倒计时归零 → 自动隐藏
```

---

## 📝 使用方法

### 在其他组件中使用

```vue
<template>
  <ScheduleCountdown
    :schedule-time="robot.scheduleStart"
    :robot-status="robot.status"
    mode="start"
  />
</template>

<script setup>
  import ScheduleCountdown from './components/ScheduleCountdown.vue';
</script>
```

### Props 说明

| 参数         | 类型              | 说明       | 必填 |
| ------------ | ----------------- | ---------- | ---- |
| scheduleTime | string            | 定时时间   | 否   |
| robotStatus  | number            | 机器人状态 | 是   |
| mode         | 'start' \| 'stop' | 模式       | 是   |

---

## ⚠️ 注意事项

1. **时区处理**

   - 后端需要返回统一格式的时间
   - 前端使用 `new Date()` 解析

2. **性能优化**

   - 每个倒计时组件独立定时器
   - 组件销毁时自动清理
   - 不显示时不占用资源

3. **边界情况**

   - 时间已过期 → 自动隐藏
   - 没有定时设置 → 不显示
   - 状态不匹配 → 不显示

4. **响应式更新**
   - 监听 scheduleTime 变化
   - 监听 robotStatus 变化
   - 自动重新计算显示

---

## ✅ 测试建议

### 测试场景

1. **正常倒计时**

   - 创建机器人并设置定时启动
   - 检查倒计时是否每秒更新
   - 检查格式是否正确

2. **状态切换**

   - 手动启动机器人
   - 检查启动倒计时是否消失
   - 检查停止倒计时是否出现

3. **倒计时归零**

   - 设置一个很近的时间
   - 观察倒计时归零后是否隐藏

4. **多机器人**
   - 创建多个机器人
   - 检查每个倒计时是否独立
   - 检查性能是否正常

---

## 🎉 总结

### ✅ 已完成

- ✅ 类型定义更新
- ✅ 倒计时组件创建
- ✅ 集成到机器人卡片
- ✅ 智能显示控制
- ✅ 自动更新机制
- ✅ 样式美化

### 📊 代码统计

- 新增文件: 2 个
- 修改文件: 2 个
- 新增代码: ~150 行
- 核心组件: ScheduleCountdown.vue

### 🎯 效果

用户现在可以直观地看到：

- ✅ 机器人将在多久后自动启动
- ✅ 机器人将在多久后自动停止
- ✅ 实时倒计时更新
- ✅ 清晰的颜色和图标区分

---

**实现完成时间**: 2025-12-23  
**状态**: ✅ 完全实现  
**测试**: ⏳ 等待前端验证
