# 定时停止倒计时不显示问题排查指南

## 问题描述
用户反馈：运行中的机器人看不到定时停止倒计时

---

## 🔍 排查步骤

### 步骤1：检查后端API返回数据

#### 方法A：浏览器 Network 面板
```
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 刷新页面
4. 找到 /toogo/robot/list 请求
5. 点击该请求，查看 Response
```

**期望看到**:
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 1,
        "robotName": "测试机器人",
        "status": 2,
        "scheduleStart": null,
        "scheduleStop": "2025-12-23T22:00:00Z"  ← 检查这个
      }
    ]
  }
}
```

**可能的问题**:
- ❌ 字段不存在 → 后端没有返回
- ❌ 字段为 `null` → 机器人没有设置定时
- ❌ 字段名不对（如 `schedule_stop` 而不是 `scheduleStop`）

---

### 步骤2：检查前端数据接收

#### 在浏览器控制台运行：
```javascript
// 查看前端接收到的数据
console.log('机器人列表数据:', robotList);

// 检查第一个机器人的定时字段
if (robotList && robotList[0]) {
  console.log('scheduleStart:', robotList[0].scheduleStart);
  console.log('scheduleStop:', robotList[0].scheduleStop);
}
```

---

### 步骤3：检查机器人是否设置了定时停止

#### 查询数据库：
```sql
-- 检查机器人的定时设置
SELECT 
  id, 
  robot_name, 
  status,
  schedule_start,
  schedule_stop
FROM hg_trading_robot
WHERE status = 2  -- 运行中
AND deleted_at IS NULL;
```

**预期结果**:
```
id | robot_name | status | schedule_start | schedule_stop
---+------------+--------+----------------+---------------------
1  | 测试机器人  | 2      | NULL           | 2025-12-23 22:00:00
```

如果 `schedule_stop` 为 `NULL`，说明没有设置定时停止。

---

### 步骤4：检查组件显示条件

倒计时组件的显示条件：
```vue
<ScheduleCountdown 
  v-if="robot.status === 2"           ← 机器人必须运行中
  :schedule-time="robot.scheduleStop" ← scheduleStop 必须有值
  :robot-status="robot.status"
  mode="stop"
/>
```

**组件内部的显示逻辑**:
```typescript
// 1. scheduleTime 必须有值
if (!props.scheduleTime) {
  countdown.value = '';
  return;
}

// 2. 机器人状态必须为运行中
if (props.mode === 'stop' && props.robotStatus !== 2) {
  countdown.value = '';
  return;
}

// 3. 定时时间必须 > 当前时间
const now = Date.now();
const targetTime = new Date(props.scheduleTime).getTime();
if (targetTime <= now) {
  countdown.value = '';  // 已过期，不显示
  return;
}
```

---

## 🧪 测试方案

### 方案1：创建新机器人测试

```
1. 进入创建机器人页面
2. 填写基本信息
3. 设置定时停止时间：选择 1 小时后
4. 创建机器人
5. 启动机器人（status 变为 2）
6. 返回列表页，应该看到倒计时
```

### 方案2：更新现有机器人

```sql
-- 手动设置定时停止（1小时后）
UPDATE hg_trading_robot
SET schedule_stop = NOW() + INTERVAL '1 hour'
WHERE id = 1 AND status = 2;
```

然后刷新页面查看。

### 方案3：使用 SQL 设置测试数据

```sql
-- 设置一个运行中的机器人，定时在30分钟后停止
UPDATE hg_trading_robot
SET 
  status = 2,                                    -- 运行中
  schedule_stop = NOW() + INTERVAL '30 minutes'  -- 30分钟后停止
WHERE id = 1;

-- 清空定时启动（避免干扰）
UPDATE hg_trading_robot
SET schedule_start = NULL
WHERE id = 1;
```

---

## 🐛 常见问题及解决方案

### 问题1：scheduleStop 字段不存在

**症状**: Network 响应中没有 `scheduleStop` 字段

**原因**: 
- 后端模型没有包含该字段
- JSON 序列化时被过滤掉了

**解决**:
```go
// 检查 RobotListModel 是否正确嵌入 TradingRobot
type RobotListModel struct {
    *entity.TradingRobot  // ✅ 应该包含所有字段
    // ...
}
```

---

### 问题2：scheduleStop 为 null

**症状**: 字段存在但值为 `null`

**原因**: 机器人没有设置定时停止

**解决**: 
1. 创建机器人时设置定时停止
2. 或手动更新数据库

---

### 问题3：时间已过期

**症状**: 有 `scheduleStop` 值，但倒计时不显示

**原因**: 定时时间已经过去了

**检查**:
```javascript
const scheduleStop = "2025-12-23T20:00:00Z";
const now = new Date();
const target = new Date(scheduleStop);

console.log('当前时间:', now);
console.log('定时时间:', target);
console.log('是否未来:', target > now);
```

**解决**: 设置一个未来的时间

---

### 问题4：字段名不匹配

**症状**: 后端返回 `schedule_stop`，前端期望 `scheduleStop`

**检查**:
```javascript
// 检查字段名
console.log(robot.scheduleStop);   // 驼峰命名
console.log(robot.schedule_stop);  // 下划线命名
```

**解决**: 统一使用驼峰命名（Go 的 json tag）

---

### 问题5：组件未正确导入

**症状**: 倒计时组件没有渲染

**检查**:
```vue
<!-- index.vue 顶部 -->
<script setup>
import ScheduleCountdown from './components/ScheduleCountdown.vue';  ← 检查这行
</script>
```

**解决**: 确保组件已正确导入

---

## 📊 调试命令

### 在浏览器控制台执行：

```javascript
// 1. 检查机器人数据
console.table(robotList.map(r => ({
  id: r.id,
  name: r.robotName,
  status: r.status,
  scheduleStop: r.scheduleStop,
  hasScheduleStop: !!r.scheduleStop
})));

// 2. 检查时间格式
const robot = robotList[0];
if (robot && robot.scheduleStop) {
  const target = new Date(robot.scheduleStop);
  const now = new Date();
  const diff = target - now;
  
  console.log('定时停止时间:', target);
  console.log('当前时间:', now);
  console.log('时间差(毫秒):', diff);
  console.log('时间差(分钟):', Math.floor(diff / 60000));
  console.log('是否未来时间:', diff > 0);
}

// 3. 强制触发更新
// 如果使用 Vue3 composition API
// 可能需要重新加载数据
```

---

## ✅ 最终检查清单

- [ ] 后端返回了 `scheduleStop` 字段
- [ ] 字段值不为 `null`
- [ ] 字段名是驼峰命名 `scheduleStop`
- [ ] 机器人状态 `status === 2` (运行中)
- [ ] 定时时间是未来时间
- [ ] 前端组件已正确导入
- [ ] 显示条件 `v-if="robot.status === 2"` 正确
- [ ] 时间格式可被 `new Date()` 解析

---

## 🎯 预期正常流程

```
1. 创建机器人
   ↓ scheduleStop = "2025-12-23 22:00:00"
   
2. 启动机器人
   ↓ status = 2
   
3. 后端返回列表
   ↓ scheduleStop: "2025-12-23T22:00:00Z"
   
4. 前端接收数据
   ↓ robot.scheduleStop 有值
   
5. 检查显示条件
   ✅ robot.status === 2
   ✅ robot.scheduleStop 有值
   ✅ 定时时间 > 当前时间
   
6. 渲染倒计时组件
   ↓ ⚠️ 5小时45分后自动停止
   
7. 每秒更新
   ↓ 倒计时实时减少
```

---

## 📞 如果问题仍未解决

1. **提供完整的 Network 响应数据**
   - 截图或复制 `/toogo/robot/list` 的 Response

2. **提供数据库查询结果**
   ```sql
   SELECT * FROM hg_trading_robot WHERE status = 2 LIMIT 1;
   ```

3. **提供控制台错误信息**
   - 打开 Console 标签
   - 查看是否有红色错误信息

4. **提供机器人状态**
   - 机器人ID
   - 当前状态
   - 创建时间
   - 定时设置

---

**创建时间**: 2025-12-23  
**用途**: 排查定时停止倒计时不显示的问题


