<template>
  <div class="robot-page">
    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <n-grid cols="1 s:3 m:3 l:5 xl:5 2xl:5" :x-gap="12" :y-gap="12" responsive="screen" class="mb-3">
      <n-gi>
        <n-card :bordered="false" size="small">
          <n-statistic label="æ€»æœºå™¨äºº" :value="total">
            <template #prefix><n-icon :component="RobotOutlined" /></template>
          </n-statistic>
        </n-card>
      </n-gi>
      <n-gi>
        <n-card :bordered="false" size="small" class="running-card">
          <n-statistic label="è¿è¡Œä¸­" :value="runningCount">
            <template #prefix><n-icon :component="PlayCircleOutlined" color="var(--success-color)" /></template>
          </n-statistic>
        </n-card>
      </n-gi>
      <n-gi>
        <n-card :bordered="false" size="small">
          <n-statistic label="ä»Šæ—¥ç›ˆäº">
            <template #default>
              <n-text :type="todayPnl >= 0 ? 'success' : 'error'" strong>
                {{ todayPnl >= 0 ? '+' : '' }}{{ todayPnl.toFixed(2) }}
              </n-text>
            </template>
          </n-statistic>
        </n-card>
      </n-gi>
      <n-gi>
        <n-card :bordered="false" size="small">
          <n-statistic label="ç´¯è®¡ç›ˆäº">
            <template #default>
              <n-text :type="totalPnl >= 0 ? 'success' : 'error'" strong>
                {{ totalPnl >= 0 ? '+' : '' }}{{ totalPnl.toFixed(2) }}
              </n-text>
            </template>
          </n-statistic>
        </n-card>
      </n-gi>
      <n-gi>
        <n-card :bordered="false" size="small">
          <n-statistic label="æ¶ˆè€—ç®—åŠ›" :value="totalPower.toFixed(2)">
            <template #prefix><n-icon :component="ThunderboltOutlined" /></template>
          </n-statistic>
        </n-card>
      </n-gi>
    </n-grid>

    <!-- æ“ä½œæ  -->
    <n-card :bordered="false" size="small" class="mb-3">
      <n-space justify="space-between" align="center">
        <n-space align="center">
          <n-select v-model:value="searchParams.status" :options="statusOptions" placeholder="çŠ¶æ€ç­›é€‰" style="width: 120px" clearable size="small" />
          <n-select v-model:value="searchParams.platform" :options="platformOptions" placeholder="å¹³å°ç­›é€‰" style="width: 120px" clearable size="small" />
          <n-button size="small" @click="loadData">
            <template #icon><n-icon :component="ReloadOutlined" /></template>
            åˆ·æ–°
          </n-button>
        </n-space>
        <n-button type="primary" @click="router.push('/toogo/robot/create')">
          <template #icon><n-icon :component="PlusOutlined" /></template>
          åˆ›å»ºæœºå™¨äºº
        </n-button>
      </n-space>
    </n-card>

    <!-- æœºå™¨äººåˆ—è¡¨ -->
    <n-grid cols="1 s:1 m:2 l:2 xl:2 2xl:3" :x-gap="16" :y-gap="16" responsive="screen" v-if="robotList.length > 0">
      <n-gi v-for="robot in robotList" :key="robot.id">
        <n-card 
          class="robot-card" 
          :class="{ 'running': robot.status === 2 }" 
          :bordered="false"
          hoverable
          size="small"
        >
          <!-- å¤´éƒ¨ -->
          <template #header>
            <n-space align="center" :size="8">
              <n-tag :type="getStatusType(robot.status)" size="small">
                {{ getStatusText(robot.status) }}
              </n-tag>
              <n-text strong>{{ robot.robotName }}</n-text>
              <!-- è¿è¡Œä¸­ï¼šAPIè¿æ¥çŠ¶æ€ + å¸‚åœºçŠ¶æ€ + é£é™©åå¥½ -->
              <template v-if="robot.status === 2">
                <span class="header-connection" :class="getConnectionStatus(robot.id).class">
                  <span class="conn-dot"></span>
                  <span class="conn-text">{{ getConnectionStatus(robot.id).text }}</span>
                </span>
                <n-tag :type="getMarketStateType(analysisData[robot.id]?.config?.marketState || analysisData[robot.id]?.signal?.currentMarketState)" size="tiny" :bordered="false">
                  {{ formatMarketState(analysisData[robot.id]?.config?.marketState || analysisData[robot.id]?.signal?.currentMarketState) }}
                </n-tag>
                <n-tag type="warning" size="tiny" :bordered="false">
                  {{ formatRiskPref(analysisData[robot.id]?.config?.riskPreference) }}
                </n-tag>
              </template>
            </n-space>
          </template>
          <template #header-extra>
            <n-space :size="6">
              <n-tag size="small">{{ robot.exchange?.toUpperCase() || robot.platform?.toUpperCase() }}</n-tag>
              <n-tag size="small" type="info">{{ robot.symbol || robot.tradingPair }}</n-tag>
            </n-space>
          </template>

          <!-- è¿è¡Œä¸­æœºå™¨äºº -->
          <template v-if="robot.status === 2">
            <!-- è´¦æˆ·+ç­–ç•¥å‚æ•°æ•´åˆé¢æ¿ -->
            <div class="account-strategy-panel" v-if="analysisData[robot.id]">
              <!-- ç»Ÿè®¡ä¿¡æ¯ -->
              <n-grid :cols="4" :x-gap="12" :y-gap="12">
                <n-gi>
                  <n-statistic label="ä½™é¢">
                    <template #default>
                      <span class="stat-value primary">{{ analysisData[robot.id]?.account?.availableBalance?.toFixed(2) || '--' }}</span>
                    </template>
                  </n-statistic>
                </n-gi>
                <n-gi>
                  <n-statistic label="æµ®ç›ˆ">
                    <template #default>
                      <n-text :type="(analysisData[robot.id]?.account?.unrealizedPnl || 0) >= 0 ? 'success' : 'error'" strong class="stat-value">
                        {{ (analysisData[robot.id]?.account?.unrealizedPnl || 0) >= 0 ? '+' : '' }}{{ analysisData[robot.id]?.account?.unrealizedPnl?.toFixed(2) || '0.00' }}
                      </n-text>
                    </template>
                  </n-statistic>
                </n-gi>
                <n-gi>
                  <n-statistic label="ç®—åŠ›">
                    <template #default>
                      <span class="stat-value warning">{{ walletPowerMap[robot.userId]?.toFixed(2) || '--' }}</span>
                    </template>
                  </n-statistic>
                </n-gi>
                <n-gi>
                  <n-statistic label="ç´¯è®¡">
                    <template #default>
                      <n-text :type="(analysisData[robot.id]?.config?.totalProfit || 0) >= 0 ? 'success' : 'error'" strong class="stat-value">
                        {{ (analysisData[robot.id]?.config?.totalProfit || 0) >= 0 ? '+' : '' }}{{ (analysisData[robot.id]?.config?.totalProfit || 0).toFixed(2) }}
                      </n-text>
                    </template>
                  </n-statistic>
                </n-gi>
              </n-grid>

              <n-divider style="margin: 12px 0" />

              <!-- ç­–ç•¥å‚æ•° -->
              <n-grid :cols="5" :x-gap="8" :y-gap="8">
                <n-gi>
                  <div class="param-box highlight">
                    <span class="label">çª—å£</span>
                    <span class="value">{{ formatWindowTime(analysisData[robot.id]?.config?.timeWindow || analysisData[robot.id]?.signal?.strategyWindow) }}</span>
                  </div>
                </n-gi>
                <n-gi>
                  <div class="param-box highlight">
                    <span class="label">æ³¢åŠ¨</span>
                    <span class="value">{{ (analysisData[robot.id]?.config?.threshold || analysisData[robot.id]?.signal?.strategyThreshold)?.toFixed(1) || '--' }}U</span>
                  </div>
                </n-gi>
                <n-gi>
                  <div class="param-box">
                    <span class="label">æ æ†</span>
                    <span class="value">{{ analysisData[robot.id]?.config?.leverage || robot.leverage || '--' }}x</span>
                  </div>
                </n-gi>
                <n-gi>
                  <div class="param-box">
                    <span class="label">ä¿è¯é‡‘</span>
                    <span class="value">{{ (analysisData[robot.id]?.config?.marginPercent || robot.marginPercent || 0).toFixed(0) }}%</span>
                  </div>
                </n-gi>
                <n-gi>
                  <div class="param-box error">
                    <span class="label">æ­¢æŸ</span>
                    <span class="value">{{ (analysisData[robot.id]?.config?.stopLossPercent || robot.stopLossPercent || 0).toFixed(0) }}%</span>
                  </div>
                </n-gi>
                <n-gi>
                  <div class="param-box success">
                    <span class="label">å¯ç›ˆ</span>
                    <span class="value">{{ (analysisData[robot.id]?.config?.autoStartRetreat || robot.autoStartRetreatPercent || 0).toFixed(0) }}%</span>
                  </div>
                </n-gi>
                <n-gi>
                  <div class="param-box success">
                    <span class="label">å›æ’¤</span>
                    <span class="value">{{ (analysisData[robot.id]?.config?.takeProfitPercent || robot.profitRetreatPercent || 0).toFixed(0) }}%</span>
                  </div>
                </n-gi>
                <n-gi>
                  <div class="param-box warning">
                    <span class="label">äºå</span>
                    <span class="value">{{ (analysisData[robot.id]?.config?.reverseLossRetreat || 0).toFixed(0) }}%</span>
                  </div>
                </n-gi>
                <n-gi>
                  <div class="param-box warning">
                    <span class="label">ç›ˆå</span>
                    <span class="value">{{ (analysisData[robot.id]?.config?.reverseProfitRetreat || 0).toFixed(0) }}%</span>
                  </div>
                </n-gi>
                <n-gi>
                   <div class="param-box">
                     <span class="label">è¿è¡Œ</span>
                     <span class="value" style="font-size: 10px">{{ formatRuntime(robot.runtimeSeconds || analysisData[robot.id]?.config?.runtimeSeconds) }}</span>
                   </div>
                </n-gi>
              </n-grid>

              <n-divider style="margin: 12px 0" />
              
              <!-- å¼€å…³æ“ä½œ -->
              <n-space justify="space-between">
                 <div class="switch-item" @click.stop="toggleAutoTrade(robot)">
                  <n-tag :type="analysisData[robot.id]?.config?.autoTradeEnabled ? 'success' : 'default'" size="small" :bordered="false" class="clickable-tag" style="cursor: pointer">
                    {{ analysisData[robot.id]?.config?.autoTradeEnabled ? 'ğŸ¤– è‡ªåŠ¨ä¸‹å•' : 'âœ‹ æ‰‹åŠ¨ä¸‹å•' }}
                  </n-tag>
                </div>
                <div class="switch-item" @click.stop="toggleAutoClose(robot)">
                  <n-tag :type="analysisData[robot.id]?.config?.autoCloseEnabled ? 'success' : 'default'" size="small" :bordered="false" class="clickable-tag" style="cursor: pointer">
                    {{ analysisData[robot.id]?.config?.autoCloseEnabled ? 'ğŸ“‰ è‡ªåŠ¨å¹³ä»“' : 'âœ‹ æ‰‹åŠ¨å¹³ä»“' }}
                  </n-tag>
                </div>
              </n-space>
            </div>

            <!-- æ–¹å‘ä¿¡å·é¢„è­¦ï¼ˆä¸‰åˆ—å¸ƒå±€ï¼šæœºå™¨äºº | é¢„è­¦æŒ‰é’® | å›¾è¡¨ï¼‰ -->
            <div class="signal-alert-panel" v-if="analysisData[robot.id]">
              <div class="signal-three-column">
                <!-- ç¬¬ä¸€åˆ—ï¼šæœºå™¨äººåŠ¨ç”» -->
                <div class="column-robot">
                  <div class="mini-robot-scene" :class="getRobotMoodClass(robot)">
                    <svg class="mini-robot" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                      <defs>
                        <linearGradient id="mini-metal" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color: #ffffff" />
                          <stop offset="50%" style="stop-color: #e0e0e0" />
                          <stop offset="100%" style="stop-color: #b0b0b0" />
                        </linearGradient>
                        <radialGradient :id="'eye-glow-' + robot.id" cx="50%" cy="50%" r="50%">
                          <stop offset="0%" :style="'stop-color:' + getRobotEyeColor(robot)" />
                          <stop offset="100%" :style="'stop-color:' + getRobotEyeColor(robot)" />
                        </radialGradient>
                      </defs>
                      <ellipse cx="50" cy="92" rx="18" ry="4" fill="rgba(0,0,0,0.15)" class="robot-shadow" />
                      <g class="tail-group">
                        <path d="M68 68 Q 78 60 82 50" stroke="#ccc" stroke-width="2" fill="none" stroke-linecap="round" class="tail" />
                        <circle cx="82" cy="50" r="2" :fill="getRobotEyeColor(robot)" class="tail-tip" />
                      </g>
                      <rect x="35" y="55" width="30" height="25" rx="5" fill="url(#mini-metal)" class="body" />
                      <rect x="40" y="60" width="20" height="15" rx="3" fill="#111" class="body-screen" />
                      <text x="50" y="70" text-anchor="middle" :fill="getRobotEyeColor(robot)" font-size="4" class="logo-text">Toogo</text>
                      <rect x="38" y="78" width="5" height="10" rx="2" fill="#bbb" />
                      <rect x="57" y="78" width="5" height="10" rx="2" fill="#bbb" />
                      <g class="head-group">
                        <path d="M32 38 L 28 25 L 38 30 Z" fill="#ccc" class="ear left-ear" />
                        <path d="M68 38 L 72 25 L 62 30 Z" fill="#ccc" class="ear right-ear" />
                        <rect x="30" y="30" width="40" height="28" rx="8" fill="url(#mini-metal)" class="head-shell" />
                        <rect x="34" y="34" width="32" height="20" rx="5" fill="#111" class="face-screen" />
                        <path d="M40 40 L 45 40" :stroke="getRobotEyeColor(robot)" stroke-width="1" fill="none" class="eyebrow left-eyebrow" />
                        <path d="M55 40 L 60 40" :stroke="getRobotEyeColor(robot)" stroke-width="1" fill="none" class="eyebrow right-eyebrow" />
                        <circle cx="43" cy="45" r="3" :fill="'url(#eye-glow-' + robot.id + ')'" class="eye left-eye" :style="'filter: drop-shadow(0 0 2px ' + getRobotEyeColor(robot) + ')'" />
                        <circle cx="57" cy="45" r="3" :fill="'url(#eye-glow-' + robot.id + ')'" class="eye right-eye" :style="'filter: drop-shadow(0 0 2px ' + getRobotEyeColor(robot) + ')'" />
                        <path d="M45 51 Q 50 54 55 51" stroke="#00f3ff" stroke-width="1" fill="none" class="mouth-smile" />
                      </g>
                    </svg>
                    <div class="robot-mood-text">{{ getRobotMoodText(robot) }}</div>
                  </div>
                </div>
                
                <!-- ç¬¬äºŒåˆ—ï¼šæ–¹å‘é¢„è­¦æŒ‰é’® + è·ç¦»ä¿¡æ¯ -->
                <div class="column-signal">
                  <!-- åšå¤šé¢„è­¦ -->
                  <div class="signal-block long" :class="{ active: analysisData[robot.id]?.signal?.direction === 'LONG' }">
                    <div class="signal-header">
                      <span class="signal-icon">ğŸ“ˆ</span>
                      <span class="signal-label">åšå¤š</span>
                    </div>
                    <div class="signal-trigger">â‰¤ {{ formatPrice(getLongTriggerPrice(analysisData[robot.id])) }}</div>
                    <div class="signal-distance">è· {{ formatPriceUsdt(analysisData[robot.id]?.signal?.distanceFromMin) }}</div>
                  </div>
                  <!-- åšç©ºé¢„è­¦ -->
                  <div class="signal-block short" :class="{ active: analysisData[robot.id]?.signal?.direction === 'SHORT' }">
                    <div class="signal-header">
                      <span class="signal-icon">ğŸ“‰</span>
                      <span class="signal-label">åšç©º</span>
                    </div>
                    <div class="signal-trigger">â‰¥ {{ formatPrice(getShortTriggerPrice(analysisData[robot.id])) }}</div>
                    <div class="signal-distance">è· {{ formatPriceUsdt(analysisData[robot.id]?.signal?.distanceFromMax) }}</div>
                  </div>
                  <!-- å½“å‰ä»·æ ¼ -->
                  <div class="current-price-block">
                    <span class="price-value" :class="getPriceChangeClass(robot.id)">
                      {{ formatPrice(tickerData[robot.id]?.lastPrice || analysisData[robot.id]?.signal?.currentPrice) }}
                    </span>
                    <span class="price-change" :class="getPriceChangeClass(robot.id)">
                      {{ formatPriceChange(tickerData[robot.id]?.change24h) }}
                    </span>
                  </div>
                </div>
                
                <!-- ç¬¬ä¸‰åˆ—ï¼šä»·æ ¼å›¾è¡¨ï¼ˆåŠ¨æ€æœ€å¤§åŒ–ï¼‰ -->
                <div class="column-chart" v-if="analysisData[robot.id]?.priceWindow?.length > 1">
                   <svg class="chart-svg" viewBox="0 0 640 200" preserveAspectRatio="none">
                    <!-- ä»·æ ¼åŒºåŸŸå¡«å…… -->
                    <path :d="getPriceChartFillPath(analysisData[robot.id])" class="chart-fill" />
                    <!-- ä»·æ ¼æ›²çº¿ -->
                    <path :d="getPriceChartPath(analysisData[robot.id])" class="chart-line" />
                    <!-- åŸºå‡†çº¿ -->
                    <line x1="0" :y1="getBaselineY(analysisData[robot.id])" x2="640" :y2="getBaselineY(analysisData[robot.id])" class="chart-baseline" />
                    <!-- åšç©ºè§¦å‘çº¿ -->
                    <line v-if="analysisData[robot.id]?.signal?.signalThreshold" x1="0" :y1="getShortThresholdY(analysisData[robot.id])" x2="640" :y2="getShortThresholdY(analysisData[robot.id])" class="chart-upper" />
                    <!-- åšå¤šè§¦å‘çº¿ -->
                    <line v-if="analysisData[robot.id]?.signal?.signalThreshold" x1="0" :y1="getLongThresholdY(analysisData[robot.id])" x2="640" :y2="getLongThresholdY(analysisData[robot.id])" class="chart-lower" />
                    
                    <!-- æœ€ä½ä»·ç‚¹ + æ ‡ç­¾ -->
                    <circle :cx="getMinPriceX(analysisData[robot.id])" :cy="getMinPriceY(analysisData[robot.id])" r="4" class="point-min" />
                    <text :x="getMinPriceX(analysisData[robot.id])" :y="getMinPriceY(analysisData[robot.id]) + 14" class="price-label price-label-min">
                      ä½ {{ formatPrice(analysisData[robot.id]?.signal?.windowMinPrice) }}
                    </text>
                    
                    <!-- æœ€é«˜ä»·ç‚¹ + æ ‡ç­¾ -->
                    <circle :cx="getMaxPriceX(analysisData[robot.id])" :cy="getMaxPriceY(analysisData[robot.id])" r="4" class="point-max" />
                    <text :x="getMaxPriceX(analysisData[robot.id])" :y="getMaxPriceY(analysisData[robot.id]) - 6" class="price-label price-label-max">
                      é«˜ {{ formatPrice(analysisData[robot.id]?.signal?.windowMaxPrice) }}
                    </text>
                    
                    <!-- å®æ—¶ä»·ç‚¹ + æ ‡ç­¾ -->
                    <circle :cx="getCurrentPriceX(analysisData[robot.id])" :cy="getCurrentPriceY(analysisData[robot.id])" r="5" class="point-current" />
                    <text :x="getCurrentPriceX(analysisData[robot.id]) + 8" :y="getCurrentPriceY(analysisData[robot.id]) + 4" class="price-label price-label-current">
                      {{ formatPrice(analysisData[robot.id]?.signal?.currentPrice || tickerData[robot.id]?.lastPrice) }}
                    </text>
                  </svg>
                  <div class="chart-labels">
                    <span class="label-high">é«˜ {{ formatPrice(analysisData[robot.id]?.signal?.windowMaxPrice) }}</span>
                    <span class="label-low">ä½ {{ formatPrice(analysisData[robot.id]?.signal?.windowMinPrice) }}</span>
                  </div>
                </div>
              </div>

              <!-- ä¿¡å·è¯´æ˜ -->
              <div v-if="analysisData[robot.id]?.signal?.reason" class="signal-reason">
                {{ analysisData[robot.id]?.signal?.reason }}
              </div>

              <!-- é¢„è­¦è®°å½•ï¼ˆå¯å±•å¼€ï¼‰ -->
              <n-collapse :default-expanded-names="[]" style="margin-top: 6px">
                <n-collapse-item name="logs">
                  <template #header>
                    <span style="font-size: 12px">é¢„è­¦è®°å½• ({{ signalLogs[robot.id]?.length || 0 }})</span>
                  </template>
                  <div class="signal-logs-list" v-if="signalLogs[robot.id]?.length > 0">
                    <div v-for="(log, idx) in signalLogs[robot.id]?.slice(0, 10)" :key="idx" class="log-row-detail" :class="[log.signalType?.toLowerCase(), { 'not-executed': !log.executed }]">
                      <div class="log-header">
                        <span class="log-time">{{ formatLogTime(log.createdAt) }}</span>
                        <n-tag :type="log.signalType?.toLowerCase() === 'long' ? 'success' : 'error'" size="tiny">
                          {{ log.signalType?.toLowerCase() === 'long' ? 'åšå¤š' : 'åšç©º' }}
                        </n-tag>
                        <span class="log-price">{{ log.currentPrice?.toFixed(2) }}</span>
                        <n-tag v-if="log.executed" type="success" size="tiny" :bordered="false">âœ“ å·²æ‰§è¡Œ</n-tag>
                        <n-tag v-else type="error" size="tiny" :bordered="false">âœ— æœªæ‰§è¡Œ</n-tag>
                      </div>
                      <!-- æœªæ‰§è¡ŒåŸå› ï¼ˆå¿…é¡»æ˜¾ç¤ºï¼‰ -->
                      <div class="log-reason" v-if="!log.executed">
                        <n-text type="warning" style="font-size: 11px; font-weight: 500">
                          âš ï¸ {{ log.executeResult || 'æœªçŸ¥åŸå› ' }}
                        </n-text>
                      </div>
                      <!-- å·²æ‰§è¡Œç»“æœ -->
                      <div class="log-success" v-else-if="log.executeResult">
                        <n-text type="success" style="font-size: 10px">
                          {{ log.executeResult }}
                        </n-text>
                      </div>
                      <div class="log-params">
                        <span class="param-badge">çª—å£: {{ log.windowMinPrice?.toFixed(1) }} ~ {{ log.windowMaxPrice?.toFixed(1) }}</span>
                        <span class="param-badge">é˜ˆå€¼: {{ log.threshold?.toFixed(1) }}U</span>
                      </div>
                    </div>
                  </div>
                  <n-empty v-else description="æš‚æ— è®°å½•" size="small" />
                </n-collapse-item>
              </n-collapse>
            </div>

            <!-- åŠ è½½åˆ†ææ•°æ® -->
            <div v-else class="analysis-loading">
              <n-spin size="small" />
              <n-text depth="3" style="font-size: 12px; margin-left: 8px">æ­£åœ¨åˆ†æå¸‚åœº...</n-text>
            </div>

            <!-- ç®—æ³•é€»è¾‘è¯´æ˜ï¼ˆå¯æŠ˜å ï¼‰ -->
            <n-collapse :default-expanded-names="[]" class="algorithm-collapse" style="margin-top: 8px">
              <n-collapse-item name="algorithm">
                <template #header>
                  <span style="font-size: 12px; font-weight: 500">ğŸ“– ç®—æ³•é€»è¾‘è¯´æ˜</span>
                </template>
                
                <!-- 1. æ–¹å‘åˆ¤æ–­ -->
                <div class="algo-section">
                  <div class="algo-title">ğŸ“Š æ–¹å‘åˆ¤æ–­</div>
                  <div class="algo-desc">æ ¹æ®æ—¶é—´çª—å£å’Œæ³¢åŠ¨ç‚¹æ•°åˆ†æå®æ—¶è¡Œæƒ…ï¼Œä¿æŒçª—å£å†…æœ€é«˜ä»·å’Œæœ€ä½ä»·</div>
                  <div class="algo-rules">
                    <div class="rule-item long">
                      <span class="rule-icon">ğŸ“ˆ</span>
                      <div class="rule-content">
                        <span class="rule-name">åšå¤šé¢„è­¦</span>
                        <span class="rule-formula">å®æ—¶ä»·æ ¼ - çª—å£æœ€ä½ä»· = æ³¢åŠ¨å€¼</span>
                        <span class="rule-note">ï¼ˆä»·æ ¼å¿…é¡»ä¸Šå‡æ—¶è§¦å‘ï¼‰</span>
                      </div>
                    </div>
                    <div class="rule-item short">
                      <span class="rule-icon">ğŸ“‰</span>
                      <div class="rule-content">
                        <span class="rule-name">åšç©ºé¢„è­¦</span>
                        <span class="rule-formula">çª—å£æœ€é«˜ä»· - å®æ—¶ä»·æ ¼ = æ³¢åŠ¨å€¼</span>
                        <span class="rule-note">ï¼ˆä»·æ ¼å¿…é¡»ä¸‹é™æ—¶è§¦å‘ï¼‰</span>
                      </div>
                    </div>
                  </div>
                  <div class="algo-warning">âš ï¸ æ–¹å‘å¯¹å†²æ—¶ä¸ç»™æ–¹å‘é¢„è­¦ï¼ˆå¤šç©ºåŒæ—¶æ»¡è¶³æ¡ä»¶æ—¶ä¸è§¦å‘ï¼‰</div>
                </div>
                
                <!-- 2. å…¨è‡ªåŠ¨ä¸‹å• -->
                <div class="algo-section">
                  <div class="algo-title">ğŸ¤– å…¨è‡ªåŠ¨ä¸‹å•</div>
                  <div class="algo-list">
                    <div class="algo-item">â‘  æ ¹æ®æ–¹å‘ä¿¡å·å’Œå¯¹åº”çš„ç­–ç•¥æ¨¡æ¿ä¸‹å•ï¼Œ<strong>æ¯ä¸ªæ–¹å‘åªèƒ½æœ‰ä¸€å•</strong></div>
                    <div class="algo-item">â‘¡ åæ–¹å‘ä¸‹å•ç­–ç•¥ï¼šæ ¹æ®æœºå™¨äººå¯¹åº”çš„<strong>ç­–ç•¥æ¨¡æ¿é‡Œçš„ç­–ç•¥é…ç½®</strong></div>
                    <div class="algo-item">â‘¢ å½“æœºå™¨äººçŠ¶æ€ä¸º<n-tag type="success" size="tiny">è¿è¡Œä¸­</n-tag>æ—¶å¼€å¯è‡ªåŠ¨ä¸‹å•åŠŸèƒ½</div>
                  </div>
                </div>
                
                <!-- 3. å…¨è‡ªåŠ¨å¹³ä»“ -->
                <div class="algo-section">
                  <div class="algo-title">ğŸ“‰ å…¨è‡ªåŠ¨å¹³ä»“</div>
                  <div class="algo-list">
                    <div class="algo-item formula">
                      <span class="item-label">â‘  æ­¢æŸï¼š</span>
                      <span class="item-formula">|æœªå®ç°ç›ˆäº| / (ä¿è¯é‡‘ Ã— æ­¢æŸ%) â‰¥ 100%</span>
                      <span class="item-action">â†’ è‡ªåŠ¨å¹³ä»“</span>
                    </div>
                    <div class="algo-item formula">
                      <span class="item-label">â‘¡ æ­¢ç›ˆå›æ’¤ï¼š</span>
                      <span class="item-formula">(æœ€é«˜ç›ˆåˆ© - å½“å‰ç›ˆäº) / æœ€é«˜ç›ˆåˆ© â‰¥ å›æ’¤%</span>
                      <span class="item-action">â†’ è‡ªåŠ¨å¹³ä»“</span>
                      <span class="item-note">ï¼ˆéœ€å…ˆå¼€å¯æ­¢ç›ˆæŒ‰é’®ï¼‰</span>
                    </div>
                    <div class="algo-item formula">
                      <span class="item-label">â‘¢ å¯åŠ¨æ­¢ç›ˆï¼š</span>
                      <span class="item-formula">æœªå®ç°ç›ˆäº / ä¿è¯é‡‘ â‰¥ å¯åŠ¨%</span>
                      <span class="item-action">â†’ å¼€å¯æ­¢ç›ˆæŒ‰é’®</span>
                      <span class="item-note">ï¼ˆå¼€å¯åæ— æ³•å…³é—­ï¼Œç›´åˆ°å¹³ä»“ï¼‰</span>
                    </div>
                    <div class="algo-item">â‘£ æœºå™¨äººæ‰€æœ‰è®¢å•è¾¾åˆ°<strong>æœ€å¤§ç›ˆåˆ©/æœ€å¤§äºæŸé¢</strong>åï¼Œå…¨éƒ¨å¹³ä»“</div>
                    <div class="algo-item">â‘¤ å½“æœºå™¨äººçŠ¶æ€ä¸º<n-tag type="success" size="tiny">è¿è¡Œä¸­</n-tag>æ—¶å¼€å¯è‡ªåŠ¨å¹³ä»“åŠŸèƒ½</div>
                  </div>
                </div>
              </n-collapse-item>
            </n-collapse>

            <!-- å®æ—¶æŒä»“è®¢å•åˆ—è¡¨ -->
            <div class="positions-section">
              <div class="positions-header">
                <h4 class="positions-title">å®æ—¶æŒä»“è®¢å•åˆ—è¡¨</h4>
                <span class="positions-count">{{ positionData[robot.id]?.length || 0 }}</span>
              </div>
              <div class="positions-table-wrapper">
                <table class="positions-table" v-if="positionData[robot.id]?.length > 0">
                  <thead>
                    <tr>
                      <th class="col-time">ä¸‹å•æ—¶é—´</th>
                      <th class="col-symbol">äº¤æ˜“å¯¹</th>
                      <th class="col-side">æ–¹å‘</th>
                      <th class="col-quantity">æŒä»“æ•°é‡</th>
                      <th class="col-price">å¼€ä»“ä»·æ ¼</th>
                      <th class="col-price">å¸‚ä»·</th>
                      <th class="col-pl">æœªå®ç°ç›ˆäº</th>
                      <th class="col-margin">ä¿è¯é‡‘</th>
                      <th class="col-leverage">æ æ†</th>
                      <th class="col-monitor">ç›‘æ§</th>
                      <th class="col-action">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(pos, idx) in positionData[robot.id]" :key="pos.symbol + pos.positionSide" 
                        :class="['position-row', idx % 2 === 0 ? 'row-even' : 'row-odd']">
                      <td class="col-time">{{ formatTime(pos.updateTime || pos.createTime) }}</td>
                      <td class="col-symbol">{{ pos.symbol }}</td>
                      <td class="col-side">
                        <span :class="['side-tag', pos.positionSide === 'LONG' ? 'long' : 'short']">
                          {{ pos.positionSide === 'LONG' ? 'åšå¤š' : 'åšç©º' }}
                        </span>
                      </td>
                      <td class="col-quantity">{{ Math.abs(pos.positionAmt).toFixed(4) }}</td>
                      <td class="col-price">{{ pos.entryPrice?.toFixed(2) || '--' }}</td>
                      <td class="col-price">{{ pos.markPrice?.toFixed(2) || analysisData[robot.id]?.analysis?.ticker?.lastPrice?.toFixed(2) || '--' }}</td>
                      <td class="col-pl">
                        <span :class="['pnl-value', pos.unrealizedPnl >= 0 ? 'profit' : 'loss']">
                          {{ pos.unrealizedPnl >= 0 ? '+' : '' }}{{ pos.unrealizedPnl?.toFixed(4) || '0.0000' }} U
                        </span>
                      </td>
                      <td class="col-margin">{{ pos.margin?.toFixed(2) || '--' }} U</td>
                      <td class="col-leverage">{{ pos.leverage || '--' }}x</td>
                      <td class="col-monitor">
                        <div class="monitor-cell">
                          <!-- æ­¢æŸè¿›åº¦ -->
                          <div class="monitor-item">
                            <div class="monitor-label">æ­¢æŸ</div>
                            <div class="progress-bar-container">
                              <div class="progress-bar progress-bar-danger" 
                                   :style="{ width: calcStopLossProgress(pos, robot).toFixed(1) + '%' }"></div>
                            </div>
                            <div class="monitor-value" :class="{ 'text-danger': calcStopLossProgress(pos, robot) >= 100 }">
                              {{ calcStopLossProgress(pos, robot) >= 100 ? '100%+' : calcStopLossProgress(pos, robot).toFixed(1) + '%' }}
                            </div>
                          </div>
                          <!-- æ­¢ç›ˆå›æ’¤è¿›åº¦ -->
                          <div class="monitor-item">
                            <div class="monitor-label">æ­¢ç›ˆå›æ’¤</div>
                            <div class="progress-bar-container">
                              <div class="progress-bar progress-bar-success" 
                                   :style="{ width: calcProfitRetreatProgress(pos, robot).toFixed(1) + '%', opacity: 0.6 }"></div>
                            </div>
                            <div class="monitor-value">{{ calcProfitRetreatProgress(pos, robot).toFixed(1) }}%</div>
                          </div>
                          <!-- å¯åŠ¨æ­¢ç›ˆè¿›åº¦ -->
                          <div class="monitor-item">
                            <div class="monitor-label">å¯åŠ¨æ­¢ç›ˆ</div>
                            <div class="progress-bar-container">
                              <div class="progress-bar progress-bar-warning" 
                                   :style="{ width: calcStartProfitProgress(pos, robot).toFixed(1) + '%' }"></div>
                            </div>
                            <div class="monitor-value" :class="{ 'text-success': calcStartProfitProgress(pos, robot) >= 100 }">
                              {{ calcStartProfitProgress(pos, robot) >= 100 ? '100%+' : calcStartProfitProgress(pos, robot).toFixed(1) + '%' }}
                            </div>
                          </div>
                          <!-- æœ€é«˜ç›ˆåˆ© -->
                          <div class="monitor-item monitor-max-profit">
                            <div class="monitor-label" style="font-size: 0.7rem;">æœ€é«˜ç›ˆåˆ©</div>
                            <div class="monitor-value" style="font-size: 0.7rem; font-weight: 600; flex: 1; text-align: right;">
                              <span v-if="(pos.maxProfitReached || 0) > 0" style="color: #22c55e; font-weight: 600;">
                                {{ (pos.maxProfitReached || 0).toFixed(4) }}
                              </span>
                              <span v-else style="color: var(--text-color-3);">--</span>
                              <span v-if="(pos.maxProfitReached || 0) > 0"> USDT</span>
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="col-action">
                        <n-button size="tiny" type="warning" @click="closePosition(robot, pos)">å¹³ä»“</n-button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div v-else class="empty-state">
                  <div class="empty-icon">ğŸ“Š</div>
                  <div class="empty-text">æš‚æ— æŒä»“è®¢å•</div>
                </div>
              </div>
            </div>
          </template>

          <!-- éè¿è¡ŒçŠ¶æ€æ˜¾ç¤ºæ ¸å¿ƒé…ç½® -->
          <template v-else>
            <n-grid :cols="3" :x-gap="12" :y-gap="8">
              <n-gi>
                <n-text depth="3" style="font-size: 12px">æ æ†å€æ•°</n-text>
                <div style="font-size: 14px; font-weight: bold">{{ robot.leverage || '--' }}x</div>
              </n-gi>
              <n-gi>
                <n-text depth="3" style="font-size: 12px">ä¿è¯é‡‘æ¯”ä¾‹</n-text>
                <div style="font-size: 14px; font-weight: bold">{{ robot.marginRatio || '--' }}%</div>
              </n-gi>
              <n-gi>
                <n-text depth="3" style="font-size: 12px">æ­¢æŸæ¯”ä¾‹</n-text>
                <div style="font-size: 14px; font-weight: bold; color: var(--error-color)">{{ robot.stopLossPercent || '--' }}%</div>
              </n-gi>
              <n-gi>
                <n-text depth="3" style="font-size: 12px">æ­¢ç›ˆå›æ’¤</n-text>
                <div style="font-size: 14px; font-weight: bold; color: var(--success-color)">{{ robot.takeProfitRetracePercent || '--' }}%</div>
              </n-gi>
              <n-gi>
                <n-text depth="3" style="font-size: 12px">ç´¯è®¡ç›ˆäº</n-text>
                <n-text :type="(robot.totalPnl || 0) >= 0 ? 'success' : 'error'" strong>
                  {{ (robot.totalPnl || 0) >= 0 ? '+' : '' }}{{ (robot.totalPnl || 0).toFixed(2) }} U
                </n-text>
              </n-gi>
              <n-gi>
                <n-text depth="3" style="font-size: 12px">æ¶ˆè€—ç®—åŠ›</n-text>
                <div style="font-size: 14px">{{ robot.consumedPower?.toFixed(2) || '0.00' }}</div>
              </n-gi>
            </n-grid>
          </template>

          <!-- æ“ä½œæŒ‰é’® -->
          <template #action>
            <n-space justify="space-between">
              <n-space>
                <n-button v-if="robot.status === 2" type="warning" size="small" @click="stopRobot(robot)">
                  <template #icon><n-icon :component="PauseCircleOutlined" /></template>
                  æš‚åœè¿è¡Œ
                </n-button>
                <n-button v-else-if="robot.status === 3 || robot.status === 1" type="primary" size="small" @click="startRobot(robot)">
                  <template #icon><n-icon :component="PlayCircleOutlined" /></template>
                  å¯åŠ¨è¿è¡Œ
                </n-button>
              </n-space>
              <n-space>
                <n-button size="small" @click="viewDetail(robot)">æŸ¥çœ‹è¯¦æƒ…</n-button>
                <n-button size="small" @click="openRiskConfig(robot)">
                  <template #icon><n-icon :component="SettingOutlined" /></template>
                  é£é™©é…ç½®
                </n-button>
                <n-button type="error" ghost size="small" @click="deleteRobot(robot)" :disabled="robot.status === 2">åˆ é™¤</n-button>
              </n-space>
            </n-space>
          </template>
        </n-card>
      </n-gi>
    </n-grid>

    <n-card v-else :bordered="false">
      <n-empty description="æš‚æ— æœºå™¨äººï¼Œåˆ›å»ºä¸€ä¸ªå¼€å§‹è‡ªåŠ¨äº¤æ˜“å§ï¼" size="large">
        <template #extra>
          <n-button type="primary" size="large" @click="router.push('/toogo/robot/create')">
            <template #icon><n-icon :component="PlusOutlined" /></template>
            åˆ›å»ºæœºå™¨äºº
          </n-button>
        </template>
      </n-empty>
    </n-card>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <n-modal v-model:show="showDetailModal" title="æœºå™¨äººè¯¦æƒ…" preset="card" style="width: 960px">
      <n-tabs v-if="currentRobot" type="segment" animated>
        <n-tab-pane name="info" tab="åŸºæœ¬ä¿¡æ¯">
          <!-- åŸºç¡€ä¿¡æ¯ -->
          <n-descriptions :column="3" label-placement="left" bordered size="small" class="mb-3">
            <n-descriptions-item label="æœºå™¨äººåç§°">
              <n-text strong>{{ currentRobot.robotName }}</n-text>
            </n-descriptions-item>
            <n-descriptions-item label="çŠ¶æ€">
              <n-tag :type="getStatusType(currentRobot.status)" size="small">{{ getStatusText(currentRobot.status) }}</n-tag>
            </n-descriptions-item>
            <n-descriptions-item label="åˆ›å»ºæ—¶é—´">{{ currentRobot.createdAt }}</n-descriptions-item>
          </n-descriptions>

          <!-- äº¤æ˜“é…ç½® -->
          <n-card title="äº¤æ˜“é…ç½®" size="small" :bordered="false" class="mb-3">
            <n-grid :cols="5" :x-gap="12">
              <n-gi>
                <n-statistic label="äº¤æ˜“å¹³å°">
                  <template #default>
                    <n-tag type="info" size="small">{{ (currentRobot.platform || currentRobot.exchange || '-').toUpperCase() }}</n-tag>
                  </template>
                </n-statistic>
              </n-gi>
              <n-gi>
                <n-statistic label="äº¤æ˜“å¯¹">
                  <template #default>
                    <n-text type="warning" strong>{{ currentRobot.tradingPair || currentRobot.symbol || '-' }}</n-text>
                  </template>
                </n-statistic>
              </n-gi>
              <n-gi>
                <n-statistic label="äº¤æ˜“ç±»å‹" :value="currentRobot.tradeType === 'perpetual' || !currentRobot.tradeType ? 'æ°¸ç»­åˆçº¦' : currentRobot.tradeType" />
              </n-gi>
              <n-gi>
                <n-statistic label="è®¢å•ç±»å‹" :value="currentRobot.orderType === 'market' || !currentRobot.orderType ? 'å¸‚ä»·å•' : 'é™ä»·å•'" />
              </n-gi>
              <n-gi>
                <n-statistic label="ä¿è¯é‡‘æ¨¡å¼" :value="currentRobot.marginMode === 'isolated' || !currentRobot.marginMode ? 'é€ä»“' : 'å…¨ä»“'" />
              </n-gi>
            </n-grid>
          </n-card>

          <!-- ç­–ç•¥å‚æ•° -->
          <n-card title="ç­–ç•¥å‚æ•°" size="small" :bordered="false" class="mb-3">
            <n-grid :cols="4" :x-gap="12" :y-gap="8">
              <n-gi>
                <n-statistic label="æ æ†å€æ•°">
                  <template #default>
                    <n-text type="primary" strong>{{ currentRobot.leverage || 10 }}x</n-text>
                  </template>
                </n-statistic>
              </n-gi>
              <n-gi>
                <n-statistic label="ä¿è¯é‡‘æ¯”ä¾‹" :value="`${currentRobot.marginRatio || currentRobot.marginPercent || 10}%`" />
              </n-gi>
              <n-gi>
                <n-statistic label="æ­¢æŸæ¯”ä¾‹">
                  <template #default>
                    <n-text type="error">{{ currentRobot.stopLossPercent || 5 }}%</n-text>
                  </template>
                </n-statistic>
              </n-gi>
              <n-gi>
                <n-statistic label="æ­¢ç›ˆå›æ’¤">
                  <template #default>
                    <n-text type="success">{{ currentRobot.takeProfitRetracePercent || currentRobot.profitRetreatPercent || 30 }}%</n-text>
                  </template>
                </n-statistic>
              </n-gi>
              <n-gi>
                <n-statistic label="æœ€å¤§ç›ˆåˆ©">
                  <template #default>
                    <n-text type="success">{{ currentRobot.maxProfit || currentRobot.maxProfitTarget || 100 }} USDT</n-text>
                  </template>
                </n-statistic>
              </n-gi>
              <n-gi>
                <n-statistic label="æœ€å¤§äºæŸ">
                  <template #default>
                    <n-text type="error">{{ currentRobot.maxLoss || currentRobot.maxLossAmount || 50 }} USDT</n-text>
                  </template>
                </n-statistic>
              </n-gi>
              <n-gi>
                <n-statistic label="æ€»ç›ˆäº">
                  <template #default>
                    <n-text :type="(currentRobot.totalPnl || 0) >= 0 ? 'success' : 'error'" strong>
                      {{ (currentRobot.totalPnl || 0) >= 0 ? '+' : '' }}{{ (currentRobot.totalPnl || 0).toFixed(4) }} USDT
                    </n-text>
                  </template>
                </n-statistic>
              </n-gi>
              <n-gi>
                <n-statistic label="æ¶ˆè€—ç®—åŠ›" :value="(currentRobot.consumedPower || 0).toFixed(4)" />
              </n-gi>
            </n-grid>
          </n-card>

          <!-- ç­–ç•¥é…ç½® -->
          <n-card size="small" :bordered="false">
            <template #header>
              <n-space align="center">
                <span>å½“å‰ç­–ç•¥é…ç½®</span>
                <n-tag v-if="currentRobotStrategy?.groupName" type="info" size="small">
                  {{ currentRobotStrategy.groupName }}
                </n-tag>
                <n-tag v-else type="default" size="small">é»˜è®¤ç­–ç•¥</n-tag>
                <n-button type="primary" size="tiny" @click="openStrategySelector" :disabled="currentRobot.status === 2">
                  åˆ‡æ¢ç­–ç•¥æ¨¡æ¿
                </n-button>
              </n-space>
            </template>
            
            <!-- ç­–ç•¥æ¨¡æ¿ä¿¡æ¯ -->
            <n-alert v-if="currentRobotStrategy" type="info" size="small" style="margin-bottom: 12px" :show-icon="false">
              <template #header>
                <n-space align="center" :size="8">
                  <n-icon :component="SettingOutlined" />
                  <span>ç­–ç•¥æ¨¡æ¿ï¼š{{ currentRobotStrategy.groupName || 'é»˜è®¤ç­–ç•¥' }}</span>
                  <n-tag size="tiny" type="warning" v-if="currentRobotStrategy.isOfficial">å®˜æ–¹</n-tag>
                </n-space>
              </template>
              <div style="font-size: 12px; margin-top: 4px">
                <n-space :size="12">
                  <span>å¸‚åœºçŠ¶æ€: {{ formatMarketState(currentRobot.marketState) }}</span>
                  <n-divider vertical />
                  <span>é£é™©åå¥½: {{ formatRiskPref(currentRobot.riskPreference) }}</span>
                  <n-divider vertical />
                  <span>æ æ†: {{ getStrategyLeverage() }}x</span>
                  <n-divider vertical />
                  <span>ä¿è¯é‡‘: {{ getStrategyMarginPercent() }}%</span>
                </n-space>
              </div>
            </n-alert>
            
            <n-space :size="12" :wrap="true">
              <div class="strategy-tag">
                <n-text depth="3" style="font-size: 12px">å¸‚åœºçŠ¶æ€</n-text>
                <n-tag type="info" size="small">
                  {{ formatMarketState(currentRobot.marketState) }}
                </n-tag>
              </div>
              <div class="strategy-tag">
                <n-text depth="3" style="font-size: 12px">é£é™©åå¥½</n-text>
                <n-tag type="warning" size="small">
                  {{ formatRiskPref(currentRobot.riskPreference) }}
                </n-tag>
              </div>
              <div class="strategy-tag">
                <n-text depth="3" style="font-size: 12px">è‡ªåŠ¨å¸‚åœºåˆ†æ</n-text>
                <n-tag :type="currentRobot.autoMarketState === 1 ? 'success' : 'default'" size="small">
                  {{ currentRobot.autoMarketState === 1 ? 'å¼€å¯' : 'å…³é—­' }}
                </n-tag>
              </div>
              <div class="strategy-tag">
                <n-text depth="3" style="font-size: 12px">ä¿¡å·ç›‘æ§</n-text>
                <n-tag :type="currentRobot.useMonitorSignal !== 0 ? 'success' : 'default'" size="small">
                  {{ currentRobot.useMonitorSignal !== 0 ? 'å¼€å¯' : 'å…³é—­' }}
                </n-tag>
              </div>
              <div class="strategy-tag">
                <n-text depth="3" style="font-size: 12px">åå‘ä¸‹å•</n-text>
                <n-tag :type="currentRobot.enableReverseOrder !== 0 ? 'success' : 'default'" size="small">
                  {{ currentRobot.enableReverseOrder !== 0 ? 'å¼€å¯' : 'å…³é—­' }}
                </n-tag>
              </div>
            </n-space>
          </n-card>
        </n-tab-pane>
        <n-tab-pane name="positions" tab="å®æ—¶æŒä»“">
          <n-data-table :columns="positionColumns" :data="currentPositions" :loading="positionLoading" size="small" />
        </n-tab-pane>
        <n-tab-pane name="orders" tab="å½“å‰æŒ‚å•">
          <n-data-table :columns="openOrderColumns" :data="currentOpenOrders" :loading="orderLoading" size="small" />
        </n-tab-pane>
        <n-tab-pane name="history" tab="æˆäº¤æ˜ç»†">
          <n-data-table :columns="historyColumns" :data="orderHistory" :loading="historyLoading" size="small" />
        </n-tab-pane>
        <n-tab-pane name="power" tab="ç®—åŠ›æ¶ˆè€—">
          <n-data-table :columns="powerColumns" :data="powerConsumeList" size="small" />
        </n-tab-pane>
      </n-tabs>
    </n-modal>

    <!-- ç­–ç•¥æ¨¡æ¿é€‰æ‹©å¼¹çª— -->
    <n-modal v-model:show="showStrategySelector" preset="card" title="åˆ‡æ¢ç­–ç•¥æ¨¡æ¿" style="width: 650px">
      <n-alert type="info" style="margin-bottom: 16px" :show-icon="false">
        ä¸ºæœºå™¨äºº <strong>{{ currentRobot?.robotName }}</strong> é€‰æ‹©ç­–ç•¥æ¨¡æ¿
      </n-alert>

      <n-spin :show="loadingStrategyGroups">
        <!-- æˆ‘çš„ç­–ç•¥æ¨¡æ¿ -->
        <n-card v-if="myStrategyGroups.length > 0" title="æˆ‘çš„ç­–ç•¥æ¨¡æ¿" size="small" class="mb-3" :bordered="false">
          <n-radio-group v-model:value="selectedGroupId" name="myGroups">
            <n-space vertical :size="8">
              <n-card 
                v-for="group in myStrategyGroups" 
                :key="group.id"
                size="small"
                hoverable 
                :class="{ 'selected-strategy': selectedGroupId === group.id }"
                @click="selectedGroupId = group.id"
              >
                <n-radio :value="group.id" style="width: 100%">
                  <n-space align="center">
                    <n-text strong>{{ group.groupName }}</n-text>
                    <n-tag v-if="group.isDefault" type="success" size="tiny">é»˜è®¤</n-tag>
                    <n-tag v-if="group.fromOfficial" type="warning" size="tiny">æºè‡ªå®˜æ–¹</n-tag>
                    <n-text depth="3" style="font-size: 12px">{{ group.symbol }} Â· {{ group.strategyCount || 12 }}ç§ç­–ç•¥</n-text>
                  </n-space>
                </n-radio>
              </n-card>
            </n-space>
          </n-radio-group>
        </n-card>

        <!-- å®˜æ–¹ç­–ç•¥æ¨¡æ¿ -->
        <n-card v-if="officialStrategyGroups.length > 0" title="å®˜æ–¹ç­–ç•¥æ¨¡æ¿" size="small" :bordered="false">
          <template #header-extra>
            <n-text depth="3" style="font-size: 12px">é€‰æ‹©åè‡ªåŠ¨æ·»åŠ åˆ°æˆ‘çš„ç­–ç•¥</n-text>
          </template>
          <n-radio-group v-model:value="selectedGroupId" name="officialGroups">
            <n-space vertical :size="8">
              <n-card 
                v-for="group in officialStrategyGroups" 
                :key="'official_' + group.id"
                size="small"
                hoverable 
                :class="{ 'selected-strategy': selectedGroupId === group.id }"
                @click="selectOfficialGroup(group)"
              >
                <n-radio :value="group.id" style="width: 100%">
                  <n-space align="center">
                    <n-tag type="warning" size="tiny">å®˜æ–¹</n-tag>
                    <n-text strong>{{ group.groupName }}</n-text>
                    <n-text depth="3" style="font-size: 12px">{{ group.symbol }} Â· {{ group.strategyCount || 12 }}ç§ç­–ç•¥</n-text>
                  </n-space>
                </n-radio>
              </n-card>
            </n-space>
          </n-radio-group>
        </n-card>

        <n-empty v-if="myStrategyGroups.length === 0 && officialStrategyGroups.length === 0" description="æš‚æ— å¯ç”¨ç­–ç•¥æ¨¡æ¿">
          <template #extra>
            <n-button type="primary" @click="goToStrategy">å»æ·»åŠ ç­–ç•¥æ¨¡æ¿</n-button>
          </template>
        </n-empty>
      </n-spin>

      <template #footer>
        <n-space justify="space-between" style="width: 100%">
          <n-button quaternary @click="goToStrategy">ç®¡ç†æˆ‘çš„ç­–ç•¥</n-button>
          <n-space>
            <n-button @click="showStrategySelector = false">å–æ¶ˆ</n-button>
            <n-button type="primary" @click="applyStrategyGroup" :loading="applyingStrategy" :disabled="!selectedGroupId">
              åº”ç”¨æ­¤ç­–ç•¥æ¨¡æ¿
            </n-button>
          </n-space>
        </n-space>
      </template>
    </n-modal>

    <!-- é£é™©åå¥½é…ç½®å¼¹çª— -->
    <RiskPreferenceConfig
      ref="riskConfigRef"
      :robot-id="riskConfigRobotId"
      :robot-name="riskConfigRobotName"
      @saved="loadData"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, h } from 'vue';
import { useRouter } from 'vue-router';
import { useMessage, useDialog, NTag, NButton, NSpace, NPopconfirm } from 'naive-ui';
import { ToogoRobotApi, ToogoExchangeApi, ToogoStrategyApi } from '@/api/toogo';
import { http } from '@/utils/http/axios';
import {
  RobotOutlined,
  PlusOutlined,
  ReloadOutlined,
  PauseCircleOutlined,
  PlayCircleOutlined,
  ThunderboltOutlined,
  SettingOutlined,
} from '@vicons/antd';
import RiskPreferenceConfig from './components/RiskPreferenceConfig.vue';

const router = useRouter();
const message = useMessage();
const dialog = useDialog();

const robotList = ref<any[]>([]);
const loading = ref(false);
const total = ref(0);
const showDetailModal = ref(false);
const currentRobot = ref<any>(null);
const currentRobotStrategy = ref<any>(null); // å½“å‰æœºå™¨äººä½¿ç”¨çš„ç­–ç•¥ç»„ä¿¡æ¯
const currentStrategyTemplate = ref<any>(null); // å½“å‰ç­–ç•¥ç»„å¯¹åº”çš„ç­–ç•¥æ¨¡æ¿ï¼ˆç”¨äºæ˜¾ç¤ºå‚æ•°ï¼‰

// é£é™©é…ç½®ç›¸å…³
const riskConfigRef = ref<any>(null);
const riskConfigRobotId = ref(0);
const riskConfigRobotName = ref('');

// ç­–ç•¥æ¨¡æ¿é€‰æ‹©ç›¸å…³
const showStrategySelector = ref(false);
const selectedGroupId = ref<number | null>(null);
const selectedIsOfficial = ref(false);
const myStrategyGroups = ref<any[]>([]);
const officialStrategyGroups = ref<any[]>([]);
const loadingStrategyGroups = ref(false);
const applyingStrategy = ref(false);

// ç®—åŠ›ä½™é¢ç¼“å­˜ï¼ˆæŒ‰ç”¨æˆ·IDï¼‰
const walletPowerMap = ref<Record<number, number>>({});

// ç»Ÿè®¡æ•°æ®
const runningCount = ref(0);
const todayPnl = ref(0);
const totalPnl = ref(0);
const totalPower = ref(0);

// å®æ—¶æ•°æ®
const tickerData = ref<Record<number, any>>({});
const positionData = ref<Record<number, any[]>>({});
const robotStatusData = ref<Record<number, any>>({});  // æœºå™¨äººè¿è¡ŒçŠ¶æ€æ•°æ®
const analysisData = ref<Record<number, any>>({});  // ç­–ç•¥åˆ†ææ•°æ®
const signalLogs = ref<Record<number, any[]>>({});  // æ–¹å‘é¢„è­¦æ—¥å¿—

// è¯¦æƒ…å¼¹çª—æ•°æ®
const currentPositions = ref<any[]>([]);
const currentOpenOrders = ref<any[]>([]);
const orderHistory = ref<any[]>([]);
const powerConsumeList = ref<any[]>([]);
const positionLoading = ref(false);
const orderLoading = ref(false);
const historyLoading = ref(false);

// å®šæ—¶å™¨
let refreshTimer: any = null;
let fastRefreshTimer: any = null;  // å¿«é€Ÿåˆ·æ–°ï¼ˆä»·æ ¼æ•°æ®ï¼‰

const searchParams = ref({
  status: null,
  platform: null,
  page: 1,
  pageSize: 20,
  perPage: 20,
});

const statusOptions = [
  { label: 'å…¨éƒ¨', value: null },
  { label: 'æœªå¯åŠ¨', value: 1 },
  { label: 'è¿è¡Œä¸­', value: 2 },
  { label: 'å·²æš‚åœ', value: 3 },
  { label: 'å·²åœç”¨', value: 4 },
];

const platformOptions = [
  { label: 'å…¨éƒ¨', value: null },
  { label: 'Binance', value: 'binance' },
  { label: 'Bitget', value: 'bitget' },
  { label: 'OKX', value: 'okx' },
  { label: 'Gate.io', value: 'gate' },
];

// æŒä»“åˆ—è¡¨åˆ—å®šä¹‰
const positionColumns = [
  { title: 'äº¤æ˜“å¯¹', key: 'symbol' },
  {
    title: 'æ–¹å‘',
    key: 'positionSide',
    render: (row: any) => h(NTag, { type: row.positionSide === 'LONG' ? 'success' : 'error', size: 'small' }, { default: () => row.positionSide === 'LONG' ? 'å¤š' : 'ç©º' }),
  },
  { title: 'æ•°é‡', key: 'positionAmt', render: (row: any) => Math.abs(row.positionAmt).toFixed(4) },
  { title: 'å¼€ä»“ä»·', key: 'entryPrice', render: (row: any) => row.entryPrice.toFixed(4) },
  { title: 'æ ‡è®°ä»·', key: 'markPrice', render: (row: any) => row.markPrice.toFixed(4) },
  {
    title: 'æœªå®ç°ç›ˆäº',
    key: 'unrealizedPnl',
    render: (row: any) => h('span', { style: { color: row.unrealizedPnl >= 0 ? 'var(--success-color)' : 'var(--error-color)' } }, `${row.unrealizedPnl >= 0 ? '+' : ''}${row.unrealizedPnl.toFixed(4)} USDT`),
  },
  { title: 'æ æ†', key: 'leverage', render: (row: any) => `${row.leverage}x` },
  {
    title: 'æ“ä½œ',
    key: 'actions',
    render: (row: any) => h(NButton, { size: 'small', type: 'warning', onClick: () => closePositionInModal(row) }, { default: () => 'å¹³ä»“' }),
  },
];

// å½“å‰æŒ‚å•åˆ—å®šä¹‰
const openOrderColumns = [
  { title: 'è®¢å•ID', key: 'orderId', width: 160, ellipsis: { tooltip: true } },
  { title: 'äº¤æ˜“å¯¹', key: 'symbol', width: 100 },
  {
    title: 'æ–¹å‘',
    key: 'side',
    width: 80,
    render: (row: any) => {
      const sideMap: any = { BUY: 'ä¹°å…¥', SELL: 'å–å‡º' };
      return h(NTag, { type: row.side === 'BUY' ? 'success' : 'error', size: 'small' }, { default: () => sideMap[row.side] || row.side });
    },
  },
  {
    title: 'ç±»å‹',
    key: 'type',
    width: 80,
    render: (row: any) => {
      const typeMap: any = { MARKET: 'å¸‚ä»·', LIMIT: 'é™ä»·' };
      return typeMap[row.type] || row.type;
    },
  },
  {
    title: 'å§”æ‰˜ä»·',
    key: 'price',
    width: 100,
    render: (row: any) => (row.price && row.price > 0 ? row.price.toFixed(2) : 'å¸‚ä»·'),
  },
  { title: 'æ•°é‡', key: 'quantity', width: 100, render: (row: any) => row.quantity?.toFixed(4) || '--' },
  { title: 'å·²æˆäº¤', key: 'filledQty', width: 100, render: (row: any) => row.filledQty?.toFixed(4) || '0' },
  {
    title: 'çŠ¶æ€',
    key: 'status',
    width: 80,
    render: (row: any) => {
      const statusMap: any = {
        NEW: { text: 'å¾…æˆäº¤', type: 'warning' },
        OPEN: { text: 'å¾…æˆäº¤', type: 'warning' },
        PARTIALLY_FILLED: { text: 'éƒ¨åˆ†æˆäº¤', type: 'info' },
      };
      const status = statusMap[row.status] || { text: row.status, type: 'default' };
      return h(NTag, { type: status.type, size: 'small' }, { default: () => status.text });
    },
  },
  {
    title: 'æ“ä½œ',
    key: 'actions',
    width: 80,
    render: (row: any) =>
      h(
        NPopconfirm,
        {
          onPositiveClick: () => cancelOrder(row.orderId),
        },
        {
          trigger: () => h(NButton, { size: 'small', type: 'error' }, { default: () => 'æ’¤å•' }),
          default: () => 'ç¡®å®šè¦æ’¤é”€æ­¤è®¢å•å—ï¼Ÿ',
        }
      ),
  },
];

// æˆäº¤æ˜ç»†åˆ—å®šä¹‰
const historyColumns = [
  { title: 'æˆäº¤ID', key: 'orderId', width: 160, ellipsis: { tooltip: true } },
  {
    title: 'æ–¹å‘',
    key: 'side',
    width: 80,
    render: (row: any) => {
      const sideMap: any = { BUY: 'ä¹°å…¥', SELL: 'å–å‡º' };
      const type = row.side === 'BUY' ? 'success' : 'error';
      return h(NTag, { type, size: 'small' }, { default: () => sideMap[row.side] || row.side });
    },
  },
  {
    title: 'ç±»å‹',
    key: 'type',
    width: 80,
    render: (row: any) => {
      // æˆäº¤æ˜ç»†ç±»å‹ï¼šå¼€ä»“/å¹³ä»“
      const typeMap: any = { MARKET: 'å¸‚ä»·', LIMIT: 'é™ä»·', 'å¼€ä»“': 'å¼€ä»“', 'å¹³ä»“': 'å¹³ä»“' };
      return typeMap[row.type] || row.type || '--';
    },
  },
  {
    title: 'æµåŠ¨æ€§',
    key: 'tradeScope',
    width: 80,
    render: (row: any) => {
      const scopeMap: any = { maker: 'Maker', taker: 'Taker' };
      const type = row.tradeScope === 'maker' ? 'success' : 'warning';
      return h(NTag, { type, size: 'small' }, { default: () => scopeMap[row.tradeScope] || row.tradeScope || '--' });
    },
  },
  {
    title: 'æˆäº¤ä»·',
    key: 'price',
    width: 100,
    render: (row: any) => (row.price && row.price > 0 ? row.price.toFixed(2) : '--'),
  },
  {
    title: 'æˆäº¤æ•°é‡',
    key: 'quantity',
    width: 100,
    render: (row: any) => row.quantity?.toFixed(4) || '--',
  },
  {
    title: 'æ‰‹ç»­è´¹',
    key: 'fee',
    width: 120,
    render: (row: any) => {
      if (row.fee === undefined || row.fee === null) return '--';
      const fee = parseFloat(row.fee);
      const feeCoin = row.feeCoin || 'USDT';
      return h('span', { style: { color: '#d03050' } }, fee.toFixed(6) + ' ' + feeCoin);
    },
  },
  {
    title: 'æˆäº¤æ—¶é—´',
    key: 'createTime',
    width: 160,
    render: (row: any) => {
      if (!row.createTime) return '--';
      // Bitget è¿”å›çš„æ˜¯æ¯«ç§’æ—¶é—´æˆ³
      const ts = row.createTime > 9999999999 ? row.createTime : row.createTime * 1000;
      return new Date(ts).toLocaleString();
    },
  },
];

// ç®—åŠ›æ¶ˆè€—åˆ—å®šä¹‰ï¼ˆç§¯åˆ†ä¸å‚ä¸æ¶ˆè€—ï¼Œåªä»ç®—åŠ›è´¦æˆ·æ‰£é™¤ï¼‰
const powerColumns = [
  { title: 'è®¢å•å·', key: 'orderSn' },
  { title: 'ç›ˆåˆ©é‡‘é¢', key: 'profitAmount', render: (row: any) => `${row.profitAmount?.toFixed(4)} USDT` },
  { title: 'æ¶ˆè€—æ¯”ä¾‹', key: 'consumeRate', render: (row: any) => `${(row.consumeRate * 100).toFixed(1)}%` },
  { title: 'æ¶ˆè€—ç®—åŠ›', key: 'consumePower', render: (row: any) => row.consumePower?.toFixed(4) },
  { title: 'æ‰£é™¤ç®—åŠ›', key: 'fromPower', render: (row: any) => row.fromPower?.toFixed(4) },
  { title: 'æ—¶é—´', key: 'createdAt' },
];

const getStatusType = (status: number) => {
  const types: any = { 1: 'default', 2: 'success', 3: 'warning', 4: 'error' };
  return types[status] || 'default';
};

const getStatusText = (status: number) => {
  const texts: any = { 1: 'æœªå¯åŠ¨', 2: 'è¿è¡Œä¸­', 3: 'å·²æš‚åœ', 4: 'å·²åœç”¨' };
  return texts[status] || 'æœªçŸ¥';
};

// è·å–è¿æ¥çŠ¶æ€
const getConnectionStatus = (robotId: number) => {
  const status = robotStatusData.value[robotId];
  const hasTicker = tickerData.value[robotId]?.lastPrice;
  
  if (!status && !hasTicker) {
    return { text: 'è¿æ¥ä¸­...', class: 'connecting' };
  }
  if (hasTicker) {
    return { text: 'APIå·²è¿æ¥', class: 'connected' };
  }
  if (status?.connectionError) {
    return { text: 'è¿æ¥å¤±è´¥', class: 'disconnected' };
  }
  return { text: 'è¿æ¥ä¸­...', class: 'connecting' };
};

// ==================== æœºå™¨äººåŠ¨ç”»çŠ¶æ€å‡½æ•° ====================
// 10ç§åŠ¨ç”»çŠ¶æ€ï¼šhappy, thinking, confused, tired, excited, focused, sad, conservative, balanced, aggressive

// è·å–æœºå™¨äººæƒ…ç»ªç±»åï¼ˆæ ¹æ®çŠ¶æ€å’Œåˆ†ææ•°æ®è‡ªåŠ¨åˆ‡æ¢ï¼‰
const getRobotMoodClass = (robot: any): string => {
  const data = analysisData.value[robot.id];
  const signal = data?.signal;
  const config = data?.config;
  
  // 1. æ ¹æ®ä¿¡å·æ–¹å‘
  if (signal?.direction === 'LONG') return 'mood-excited';  // åšå¤šä¿¡å· - å…´å¥‹
  if (signal?.direction === 'SHORT') return 'mood-focused'; // åšç©ºä¿¡å· - ä¸“æ³¨
  
  // 2. æ ¹æ®é£é™©åå¥½
  const riskPref = config?.riskPreference || robot.riskPreference;
  if (riskPref === 'conservative') return 'mood-conservative'; // ä¿å®ˆå‹
  if (riskPref === 'aggressive') return 'mood-aggressive';     // æ¿€è¿›å‹
  if (riskPref === 'balanced') return 'mood-balanced';         // å¹³è¡¡å‹
  
  // 3. æ ¹æ®å¸‚åœºçŠ¶æ€
  const marketState = config?.marketState || signal?.currentMarketState;
  if (marketState === 'trend') return 'mood-happy';      // è¶‹åŠ¿å¸‚åœº - å¼€å¿ƒ
  if (marketState === 'range') return 'mood-thinking';   // éœ‡è¡å¸‚åœº - æ€è€ƒ
  if (marketState === 'high_vol') return 'mood-excited'; // é«˜æ³¢åŠ¨ - å…´å¥‹
  if (marketState === 'low_vol') return 'mood-tired';    // ä½æ³¢åŠ¨ - ç–²æƒ«
  
  // 4. æ ¹æ®è¿æ¥çŠ¶æ€
  const connStatus = getConnectionStatus(robot.id);
  if (connStatus.class === 'disconnected') return 'mood-sad';       // æ–­å¼€ - å¤±è½
  if (connStatus.class === 'connecting') return 'mood-thinking';    // è¿æ¥ä¸­ - æ€è€ƒ
  
  return 'mood-balanced'; // é»˜è®¤ - å¹³è¡¡å‹
};

// è·å–æœºå™¨äººçœ¼ç›é¢œè‰²ï¼ˆæ ¹æ®çŠ¶æ€å˜åŒ–ï¼‰
const getRobotEyeColor = (robot: any): string => {
  const moodClass = getRobotMoodClass(robot);
  const colorMap: Record<string, string> = {
    'mood-happy': '#00f3ff',
    'mood-thinking': '#ff9f43',
    'mood-confused': '#00f3ff',
    'mood-tired': '#666666',
    'mood-excited': '#ff0055',
    'mood-focused': '#ff3333',
    'mood-sad': '#4a69bd',
    'mood-conservative': '#4cd137',
    'mood-balanced': '#00a8ff',
    'mood-aggressive': '#e84118',
  };
  return colorMap[moodClass] || '#00f3ff';
};

// è·å–æœºå™¨äººæƒ…ç»ªæ–‡å­—
const getRobotMoodText = (robot: any): string => {
  const moodClass = getRobotMoodClass(robot);
  const textMap: Record<string, string> = {
    'mood-happy': 'ğŸ‰ å¸‚åœºè¶‹åŠ¿æ˜æœ—',
    'mood-thinking': 'ğŸ¤” åˆ†æå¸‚åœºä¸­...',
    'mood-confused': 'â“ ä¿¡å·ä¸æ˜ç¡®',
    'mood-tired': 'ğŸ˜´ å¸‚åœºæ³¢åŠ¨è¾ƒä½',
    'mood-excited': 'ğŸ”¥ æ•æ‰åˆ°ä¿¡å·!',
    'mood-focused': 'ğŸ¯ ä¸“æ³¨åšç©ºä¿¡å·',
    'mood-sad': 'ğŸ˜¢ è¿æ¥å·²æ–­å¼€',
    'mood-conservative': 'ğŸ›¡ï¸ ä¿å®ˆç­–ç•¥è¿è¡Œä¸­',
    'mood-balanced': 'âš–ï¸ å¹³è¡¡ç­–ç•¥è¿è¡Œä¸­',
    'mood-aggressive': 'ğŸš€ æ¿€è¿›ç­–ç•¥è¿è¡Œä¸­',
  };
  return textMap[moodClass] || 'ç›‘æ§ä¸­...';
};

// ==================== çª—å£ä»·æ ¼æ›²çº¿ç›¸å…³å‡½æ•° ====================
const CHART_WIDTH = 640;
const CHART_HEIGHT = 200;

// è·å–ä¿¡å·æ–¹å‘æ–‡æœ¬
const getSignalDirectionText = (direction: string) => {
  if (direction === 'LONG') return 'åšå¤š';
  if (direction === 'SHORT') return 'åšç©º';
  if (direction === 'NEUTRAL') return 'ç›‘æ§ä¸­';
  return 'ç­‰å¾…';
};

// è·å–ä¿¡å·å¾½ç« æ ·å¼ç±»
const getSignalBadgeClass = (direction: string) => {
  if (direction === 'LONG') return 'badge-long';
  if (direction === 'SHORT') return 'badge-short';
  return 'badge-neutral';
};

// è·å–ä¿¡å·å›¾æ ‡
const getSignalIcon = (direction: string) => {
  if (direction === 'LONG') return 'ğŸ“ˆ';
  if (direction === 'SHORT') return 'ğŸ“‰';
  return 'â³';
};

// è·å–å¸‚åœºçŠ¶æ€æ ‡ç­¾ç±»å‹
const getMarketStateType = (state: string | undefined): 'success' | 'warning' | 'error' | 'info' | 'default' => {
  if (state === 'trend') return 'success';
  if (state === 'range') return 'warning';      // æ·»åŠ  range ç±»å‹æ˜ å°„ï¼ˆéœ‡è¡-è­¦å‘Šè‰²ï¼‰
  if (state === 'volatile') return 'warning';
  if (state === 'high_vol') return 'error';
  if (state === 'low_vol') return 'info';
  return 'default';
};

// æ ¼å¼åŒ–ä»·æ ¼ï¼ˆ2ä½å°æ•°ï¼‰
const formatPrice = (price: number | undefined) => {
  if (typeof price !== 'number' || isNaN(price)) return '--';
  return price.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};

// æ ¼å¼åŒ–ä»·æ ¼ï¼ˆå¸¦USDTå•ä½ï¼‰
const formatPriceUsdt = (price: number | undefined) => {
  if (typeof price !== 'number' || isNaN(price)) return '--';
  return price.toFixed(4) + ' USDT';
};

// æ ¼å¼åŒ–ä»·æ ¼æ¶¨è·Œ
const formatPriceChange = (change: number | undefined) => {
  if (typeof change !== 'number' || isNaN(change)) return '';
  const sign = change >= 0 ? '+' : '';
  return `${sign}${change.toFixed(2)}%`;
};

// è·å–ä»·æ ¼æ¶¨è·Œæ ·å¼ç±»
const getPriceChangeClass = (robotId: number) => {
  const ticker = tickerData.value[robotId];
  if (!ticker) return '';
  const change = ticker.change24h || 0;
  return change >= 0 ? 'up' : 'down';
};

// æ ¼å¼åŒ–æ—¶é—´çª—å£ï¼ˆç§’è½¬åˆ†é’Ÿ/ç§’ï¼‰
const formatWindowTime = (seconds: number | undefined) => {
  if (typeof seconds !== 'number' || isNaN(seconds) || seconds <= 0) return '--';
  if (seconds >= 60) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return secs > 0 ? `${mins}åˆ†${secs}ç§’` : `${mins}åˆ†é’Ÿ`;
  }
  return `${seconds}ç§’`;
};

// æ ¼å¼åŒ–è¿è¡Œæ—¶é•¿
const formatRuntime = (seconds: number | undefined) => {
  if (!seconds || seconds <= 0) return '0ç§’';
  
  const days = Math.floor(seconds / 86400);
  const hours = Math.floor((seconds % 86400) / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  
  if (days > 0) {
    return `${days}å¤©${hours}æ—¶`;
  } else if (hours > 0) {
    return `${hours}æ—¶${minutes}åˆ†`;
  } else if (minutes > 0) {
    return `${minutes}åˆ†`;
  } else {
    return `${seconds}ç§’`;
  }
};

// æ ¼å¼åŒ–å¸‚åœºçŠ¶æ€ï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
const formatMarketState = (state: string | undefined) => {
  const stateMap: Record<string, string> = {
    // æ–°æ ¼å¼ï¼ˆå°å†™ï¼‰
    'trend': 'è¶‹åŠ¿',
    'range': 'éœ‡è¡',      // æ·»åŠ  range æ˜ å°„
    'volatile': 'éœ‡è¡',
    'high_vol': 'é«˜æ³¢åŠ¨',
    'low_vol': 'ä½æ³¢åŠ¨',
    // æ—§æ ¼å¼ï¼ˆå¤§å†™ï¼‰
    'STRONG_UPTREND': 'å¼ºåŠ¿ä¸Šæ¶¨',
    'MILD_UPTREND': 'æ¸©å’Œä¸Šæ¶¨',
    'RANGING': 'éœ‡è¡æ•´ç†',
    'MILD_DOWNTREND': 'æ¸©å’Œä¸‹è·Œ',
    'STRONG_DOWNTREND': 'å¼ºåŠ¿ä¸‹è·Œ',
    'HIGH_VOLATILITY': 'é«˜æ³¢åŠ¨',
    'LOW_VOLATILITY': 'ä½æ³¢åŠ¨',
  };
  return stateMap[state || ''] || state || '--';
};

// æ ¼å¼åŒ–é£é™©åå¥½
const formatRiskPref = (pref: string | undefined) => {
  const prefMap: Record<string, string> = {
    'aggressive': 'ğŸš€ æ¿€è¿›',
    'balanced': 'âš–ï¸ å¹³è¡¡',
    'conservative': 'ğŸ›¡ï¸ ä¿å®ˆ',
  };
  return prefMap[pref || ''] || pref || '--';
};

// è·å–ç­–ç•¥æ¨¡æ¿çš„æ æ†å€¼ï¼ˆä¼˜å…ˆä½¿ç”¨ç­–ç•¥æ¨¡æ¿çš„å€¼ï¼Œå¦åˆ™ä½¿ç”¨æœºå™¨äººé…ç½®çš„å€¼ï¼‰
const getStrategyLeverage = () => {
  if (currentStrategyTemplate.value) {
    // ä¼˜å…ˆä»configJsonä¸­è·å–
    try {
      const configJson = typeof currentStrategyTemplate.value.configJson === 'string'
        ? JSON.parse(currentStrategyTemplate.value.configJson || '{}')
        : (currentStrategyTemplate.value.configJson || {});
      if (configJson.leverage) {
        return configJson.leverage;
      }
    } catch (e) {
      // å¿½ç•¥è§£æé”™è¯¯
    }
    // å…¶æ¬¡ä½¿ç”¨ç­–ç•¥æ¨¡æ¿çš„leverageMin
    if (currentStrategyTemplate.value.leverageMin) {
      return currentStrategyTemplate.value.leverageMin;
    }
  }
  // æœ€åä½¿ç”¨æœºå™¨äººé…ç½®çš„å€¼
  return currentRobot.value?.leverage || '--';
};

// è·å–ç­–ç•¥æ¨¡æ¿çš„ä¿è¯é‡‘æ¯”ä¾‹ï¼ˆä¼˜å…ˆä½¿ç”¨ç­–ç•¥æ¨¡æ¿çš„å€¼ï¼Œå¦åˆ™ä½¿ç”¨æœºå™¨äººé…ç½®çš„å€¼ï¼‰
const getStrategyMarginPercent = () => {
  if (currentStrategyTemplate.value) {
    // ä¼˜å…ˆä»configJsonä¸­è·å–
    try {
      const configJson = typeof currentStrategyTemplate.value.configJson === 'string'
        ? JSON.parse(currentStrategyTemplate.value.configJson || '{}')
        : (currentStrategyTemplate.value.configJson || {});
      if (configJson.marginPercent) {
        return configJson.marginPercent;
      }
    } catch (e) {
      // å¿½ç•¥è§£æé”™è¯¯
    }
    // å…¶æ¬¡ä½¿ç”¨ç­–ç•¥æ¨¡æ¿çš„marginPercentMin
    if (currentStrategyTemplate.value.marginPercentMin) {
      return currentStrategyTemplate.value.marginPercentMin;
    }
  }
  // æœ€åä½¿ç”¨æœºå™¨äººé…ç½®çš„å€¼
  return currentRobot.value?.marginPercent || currentRobot.value?.marginRatio || '--';
};

// æ ¼å¼åŒ–æ—¥å¿—æ—¶é—´
const formatLogTime = (time: string | number | undefined) => {
  if (!time) return '--';
  const date = new Date(time);
  return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
};

// æ ¼å¼åŒ–æŒä»“æ—¶é—´ï¼ˆæ—¥æœŸ+æ—¶é—´ï¼‰
const formatTime = (time: string | number | undefined) => {
  if (!time) return '--';
  const date = new Date(typeof time === 'number' ? time : time);
  return date.toLocaleString('zh-CN', { 
    month: '2-digit', 
    day: '2-digit', 
    hour: '2-digit', 
    minute: '2-digit', 
    second: '2-digit' 
  });
};

// è®¡ç®—æ­¢æŸè¿›åº¦ï¼ˆè·ç¦»æœ€å¤§æ­¢æŸçš„ç™¾åˆ†æ¯”ï¼‰
// å…¬å¼ï¼š|æœªå®ç°ç›ˆäº| / (ä¿è¯é‡‘ Ã— æ­¢æŸç™¾åˆ†æ¯”) Ã— 100%
const calcStopLossProgress = (pos: any, robot: any) => {
  const unrealizedPL = pos.unrealizedPnl || 0;
  const margin = pos.margin || 0;
  const stopLossPercent = robot.stopLossPercent || 10; // é»˜è®¤10%
  
  if (margin <= 0 || stopLossPercent <= 0 || unrealizedPL >= 0) return 0;
  
  const stopLossAmount = margin * stopLossPercent / 100;
  const absUnrealizedPL = Math.abs(unrealizedPL);
  const progress = (absUnrealizedPL / stopLossAmount) * 100;
  
  return Math.min(100, progress);
};

// è®¡ç®—æ­¢ç›ˆå›æ’¤è¿›åº¦
// å…¬å¼ï¼š100% - ((æœ€é«˜ç›ˆåˆ© - å½“å‰ç›ˆåˆ©) / æœ€é«˜ç›ˆåˆ©) / è®¾å®šç™¾åˆ†æ¯” Ã— 100%
// è¡€æ¡é»˜è®¤æ»¡æ¡ï¼Œéšç€å›æ’¤é€æ¸å‡å°‘
const calcProfitRetreatProgress = (pos: any, robot: any) => {
  const unrealizedPL = pos.unrealizedPnl || 0;
  const maxProfitReached = pos.maxProfitReached || 0;
  const profitRetreatPercent = robot.takeProfitRetracePercent || 10; // é»˜è®¤10%
  
  // å¦‚æœæ²¡æœ‰æœ€é«˜ç›ˆåˆ©è®°å½•æˆ–æ­¢ç›ˆæœªå¯ç”¨ï¼Œè¿”å›100%ï¼ˆæ»¡æ¡ï¼‰
  if (maxProfitReached <= 0 || profitRetreatPercent <= 0) return 100;
  
  // è®¡ç®—å›æ’¤ç™¾åˆ†æ¯”
  const retreatPercent = ((maxProfitReached - unrealizedPL) / maxProfitReached) * 100;
  
  // è¡€æ¡è¿›åº¦ = 100% - (å›æ’¤ç™¾åˆ†æ¯” / è®¾å®šç™¾åˆ†æ¯”) Ã— 100%
  const progress = 100 - (retreatPercent / profitRetreatPercent) * 100;
  
  return Math.max(0, Math.min(100, progress));
};

// è®¡ç®—å¯åŠ¨æ­¢ç›ˆè¿›åº¦
// å…¬å¼ï¼š(æœªå®ç°ç›ˆäº / ä¿è¯é‡‘) / è®¾å®šç™¾åˆ†æ¯” Ã— 100%
const calcStartProfitProgress = (pos: any, robot: any) => {
  const unrealizedPL = pos.unrealizedPnl || 0;
  const margin = pos.margin || 0;
  const autoStartPercent = robot.autoStartProfitPercent || robot.takeProfitRetracePercent || 10; // é»˜è®¤10%
  
  if (margin <= 0 || autoStartPercent <= 0 || unrealizedPL <= 0) return 0;
  
  const currentProfitPercent = (unrealizedPL / margin) * 100;
  const progress = (currentProfitPercent / autoStartPercent) * 100;
  
  return Math.min(100, progress);
};

// æ ¼å¼åŒ–æ›´æ–°æ—¶é—´ï¼ˆç›¸å¯¹æ—¶é—´ï¼‰
const formatUpdateTime = (time: string | number | undefined) => {
  if (!time) return 'åˆšåˆš';
  const now = Date.now();
  const updateTime = typeof time === 'number' ? time : new Date(time).getTime();
  const diff = Math.floor((now - updateTime) / 1000); // ç§’
  
  if (diff < 5) return 'åˆšåˆš';
  if (diff < 60) return `${diff}ç§’å‰`;
  if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`;
  return new Date(updateTime).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
};

// åŠ è½½æ–¹å‘é¢„è­¦æ—¥å¿—ï¼ˆåªæ˜¾ç¤ºæœ‰ä»·å€¼çš„ä¿¡å·ï¼šlong/shortï¼‰
const loadSignalLogs = async (robotId: number) => {
  try {
    const res = await ToogoRobotApi.signalLogs({ robotId, limit: 10 });
    if (res?.list) {
      // APIå·²ç»è¿‡æ»¤åªè¿”å›æœ‰ä»·å€¼çš„ä¿¡å·ï¼ˆlong/shortï¼‰
      signalLogs.value[robotId] = res.list;
    }
  } catch (error: any) {
    console.debug('åŠ è½½æ–¹å‘é¢„è­¦æ—¥å¿—å¤±è´¥:', error);
    signalLogs.value[robotId] = [];
  }
};

// è®¡ç®—ä»·æ ¼æ›²çº¿è·¯å¾„
const getPriceChartPath = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return '';
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  // è®¡ç®—å›¾è¡¨è¾¹ç•Œ
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  const step = CHART_WIDTH / (priceWindow.length - 1);
  
  let path = '';
  priceWindow.forEach((point: any, index: number) => {
    const x = index * step;
    const y = CHART_HEIGHT - ((point.price - chartMin) / range) * CHART_HEIGHT;
    path += index === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`;
  });
  
  return path;
};

// è®¡ç®—ä»·æ ¼æ›²çº¿å¡«å……è·¯å¾„
const getPriceChartFillPath = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return '';
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  const step = CHART_WIDTH / (priceWindow.length - 1);
  const basePrice = priceWindow[0].price;
  const baseY = CHART_HEIGHT - ((basePrice - chartMin) / range) * CHART_HEIGHT;
  
  let path = '';
  priceWindow.forEach((point: any, index: number) => {
    const x = index * step;
    const y = CHART_HEIGHT - ((point.price - chartMin) / range) * CHART_HEIGHT;
    path += index === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`;
  });
  
  // é—­åˆè·¯å¾„
  const lastX = (priceWindow.length - 1) * step;
  path += ` L ${lastX} ${baseY} L 0 ${baseY} Z`;
  
  return path;
};

// è·å–åšå¤šé˜ˆå€¼çº¿Yåæ ‡
const getLongThresholdY = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return CHART_HEIGHT;
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  const buyThresholdPrice = minPrice + threshold;
  return CHART_HEIGHT - ((buyThresholdPrice - chartMin) / range) * CHART_HEIGHT;
};

// è·å–åšç©ºé˜ˆå€¼çº¿Yåæ ‡
const getShortThresholdY = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return 0;
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  const sellThresholdPrice = maxPrice - threshold;
  return CHART_HEIGHT - ((sellThresholdPrice - chartMin) / range) * CHART_HEIGHT;
};

// ==================== å‚ç›´å›¾è¡¨å‡½æ•°ï¼ˆä¸‰åˆ—å¸ƒå±€ç”¨ï¼‰ ====================
const VCHART_WIDTH = 200;
const VCHART_HEIGHT = 140;

// å‚ç›´å›¾è¡¨ï¼šä»·æ ¼æ›²çº¿è·¯å¾„
const getPriceChartPathVertical = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return '';
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  const step = VCHART_WIDTH / (priceWindow.length - 1);
  let path = '';
  priceWindow.forEach((point: any, index: number) => {
    const x = index * step;
    const y = VCHART_HEIGHT - ((point.price - chartMin) / range) * VCHART_HEIGHT;
    path += index === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`;
  });
  return path;
};

// å‚ç›´å›¾è¡¨ï¼šä»·æ ¼æ›²çº¿å¡«å……è·¯å¾„
const getPriceChartFillPathVertical = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return '';
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  const step = VCHART_WIDTH / (priceWindow.length - 1);
  let path = '';
  priceWindow.forEach((point: any, index: number) => {
    const x = index * step;
    const y = VCHART_HEIGHT - ((point.price - chartMin) / range) * VCHART_HEIGHT;
    path += index === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`;
  });
  
  const lastX = (priceWindow.length - 1) * step;
  path += ` L ${lastX} ${VCHART_HEIGHT} L 0 ${VCHART_HEIGHT} Z`;
  return path;
};

// å‚ç›´å›¾è¡¨ï¼šåšå¤šé˜ˆå€¼çº¿Yåæ ‡
const getLongThresholdYVertical = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return VCHART_HEIGHT;
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  const buyThresholdPrice = minPrice + threshold;
  return VCHART_HEIGHT - ((buyThresholdPrice - chartMin) / range) * VCHART_HEIGHT;
};

// å‚ç›´å›¾è¡¨ï¼šåšç©ºé˜ˆå€¼çº¿Yåæ ‡
const getShortThresholdYVertical = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return 0;
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  const sellThresholdPrice = maxPrice - threshold;
  return VCHART_HEIGHT - ((sellThresholdPrice - chartMin) / range) * VCHART_HEIGHT;
};

// è·å–åšå¤šè§¦å‘ä»·æ ¼
const getLongTriggerPrice = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return 0;
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  return minPrice + threshold;
};

// è·å–åšç©ºè§¦å‘ä»·æ ¼
const getShortTriggerPrice = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return 0;
  
  const prices = priceWindow.map((p: any) => p.price);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  return maxPrice - threshold;
};

// è·å–æœ€ä½ä»·Xåæ ‡
const getMinPriceX = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return 0;
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const minIndex = prices.indexOf(minPrice);
  const step = CHART_WIDTH / (priceWindow.length - 1);
  return minIndex * step;
};

// è·å–æœ€ä½ä»·Yåæ ‡
const getMinPriceY = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return CHART_HEIGHT;
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  return CHART_HEIGHT - ((minPrice - chartMin) / range) * CHART_HEIGHT;
};

// è·å–æœ€é«˜ä»·Xåæ ‡
const getMaxPriceX = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return 0;
  
  const prices = priceWindow.map((p: any) => p.price);
  const maxPrice = Math.max(...prices);
  const maxIndex = prices.indexOf(maxPrice);
  const step = CHART_WIDTH / (priceWindow.length - 1);
  return maxIndex * step;
};

// è·å–æœ€é«˜ä»·Yåæ ‡
const getMaxPriceY = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return 0;
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  return CHART_HEIGHT - ((maxPrice - chartMin) / range) * CHART_HEIGHT;
};

// è·å–å½“å‰ä»·Yåæ ‡
const getCurrentPriceY = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return CHART_HEIGHT / 2;
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const currentPrice = prices[prices.length - 1];
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  return CHART_HEIGHT - ((currentPrice - chartMin) / range) * CHART_HEIGHT;
};

// è·å–å½“å‰ä»·Xåæ ‡
const getCurrentPriceX = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return CHART_WIDTH;
  
  const step = CHART_WIDTH / (priceWindow.length - 1);
  return (priceWindow.length - 1) * step;
};

// è·å–åŸºå‡†çº¿Yåæ ‡ï¼ˆèµ·å§‹ä»·ï¼‰
const getBaselineY = (analysis: any) => {
  const priceWindow = analysis?.priceWindow;
  if (!priceWindow || priceWindow.length < 2) return CHART_HEIGHT / 2;
  
  const prices = priceWindow.map((p: any) => p.price);
  const minPrice = Math.min(...prices);
  const maxPrice = Math.max(...prices);
  const basePrice = priceWindow[0].price;
  const threshold = analysis?.signal?.signalThreshold || 0;
  
  const chartMin = Math.min(minPrice, minPrice - threshold * 0.1);
  const chartMax = Math.max(maxPrice, maxPrice + threshold * 0.1);
  const range = chartMax - chartMin || 1;
  
  return CHART_HEIGHT - ((basePrice - chartMin) / range) * CHART_HEIGHT;
};


const loadData = async () => {
  loading.value = true;
  try {
    const res = await ToogoRobotApi.list(searchParams.value);
    robotList.value = res?.list || [];
    total.value = res?.totalCount || 0;

    // è®¡ç®—ç»Ÿè®¡æ•°æ®
    runningCount.value = robotList.value.filter((r: any) => r.status === 2).length;
    totalPnl.value = robotList.value.reduce((sum: number, r: any) => sum + (r.totalPnl || 0), 0);
    totalPower.value = robotList.value.reduce((sum: number, r: any) => sum + (r.consumedPower || 0), 0);

    // åŠ è½½è¿è¡Œä¸­æœºå™¨äººçš„å®æ—¶æ•°æ®
    await loadRealtimeData();
    
    // åˆå§‹åŠ è½½æŒä»“æ•°æ®
    await loadPositionData();
    
    // åŠ è½½ç®—åŠ›ä½™é¢
    await loadWalletPower();
    
    // åŠ è½½æ‰€æœ‰æœºå™¨äººçš„æ–¹å‘é¢„è­¦æ—¥å¿—
    for (const robot of robotList.value) {
      loadSignalLogs(robot.id);
    }
  } catch (error) {
    console.error('åŠ è½½æœºå™¨äººåˆ—è¡¨å¤±è´¥:', error);
  } finally {
    loading.value = false;
  }
};

// åŠ è½½ç”¨æˆ·ç®—åŠ›ä½™é¢
const loadWalletPower = async () => {
  try {
    // è·å–æ‰€æœ‰ä¸é‡å¤çš„ç”¨æˆ·ID
    const userIds = [...new Set(robotList.value.map((r: any) => r.userId))];
    
    for (const userId of userIds) {
      try {
        const res = await http.request({
          url: '/toogo/wallet/overview',
          method: 'get',
          params: { userId },
        });
        if (res && res.totalPower !== undefined) {
          walletPowerMap.value[userId] = res.totalPower;
        }
      } catch (e) {
        console.error('åŠ è½½ç”¨æˆ·ç®—åŠ›å¤±è´¥:', userId, e);
        // å•ä¸ªç”¨æˆ·åŠ è½½å¤±è´¥ä¸å½±å“å…¶ä»–
      }
    }
  } catch (error) {
    console.error('åŠ è½½ç®—åŠ›ä½™é¢å¤±è´¥:', error);
  }
};

// è®°å½•ä¸Šæ¬¡ä¿¡å·æ–¹å‘ï¼Œç”¨äºæ£€æµ‹æ–¹å‘å˜åŒ–
const lastSignalDirection = ref<Record<number, string>>({});

// åŠ è½½å®æ—¶æ•°æ®ï¼ˆè½»é‡åŒ–ï¼Œæ¯ç§’åˆ·æ–°ï¼‰
const loadRealtimeData = async () => {
  const runningRobots = robotList.value.filter((r: any) => r.status === 2);
  if (runningRobots.length === 0) return;

  // æ‰¹é‡è·å–æœºå™¨äººåˆ†ææ•°æ®ï¼ˆåŒ…å«å®æ—¶ä»·æ ¼ã€ä¿¡å·ã€å¸‚åœºåˆ†æç­‰ï¼‰
  const robotIds = runningRobots.map((r: any) => r.id).join(',');
  
  try {
    const batchRes = await ToogoExchangeApi.batchRobotAnalysis({ robotIds });
    if (batchRes?.list) {
      for (const item of batchRes.list) {
        const robotId = item.robotId;
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        robotStatusData.value[robotId] = {
          connected: item.connected,
          connectionError: item.connectionError,
          lastUpdate: new Date().toISOString()
        };
        
        if (item.connected && item.ticker) {
          // æ›´æ–°å®æ—¶è¡Œæƒ…æ•°æ®
          tickerData.value[robotId] = {
            symbol: item.ticker.symbol,
            lastPrice: item.ticker.lastPrice,
            high24h: item.ticker.high24h,
            low24h: item.ticker.low24h,
            volume24h: item.ticker.volume24h,
            change24h: item.ticker.change24h,
            changePercent: item.ticker.changePercent,
          };
          
          // æ£€æµ‹ä¿¡å·æ–¹å‘å˜åŒ–ï¼Œæœ‰æ–¹å‘ä¿¡å·æ—¶åˆ·æ–°æ—¥å¿—
          const currentDirection = item.signal?.direction?.toUpperCase();
          const prevDirection = lastSignalDirection.value[robotId];
          if (currentDirection && (currentDirection === 'LONG' || currentDirection === 'SHORT')) {
            // æœ‰æ–¹å‘ä¿¡å·ï¼Œä¸”æ–¹å‘å˜åŒ–æ—¶åˆ·æ–°æ—¥å¿—
            if (currentDirection !== prevDirection) {
              loadSignalLogs(robotId);
            }
          }
          lastSignalDirection.value[robotId] = currentDirection || '';
          
          // æ›´æ–°åˆ†ææ•°æ®ï¼ˆåŒ…å«ä»·æ ¼çª—å£ç”¨äºå®æ—¶å›¾è¡¨ï¼‰
          analysisData.value[robotId] = {
            market: item.market,
            risk: item.risk,
            signal: item.signal,
            account: item.account,
            config: item.config,
            priceWindow: item.priceWindow,
            signalHistory: item.signalHistory,
            lastUpdate: Date.now(), // è®°å½•æ›´æ–°æ—¶é—´
          };
        }
      }
    }
  } catch (error: any) {
    // é™é»˜å¤±è´¥ï¼Œé¿å…æ§åˆ¶å°åˆ·å±
    if (Math.random() < 0.1) {  // åªæ‰“å°10%çš„é”™è¯¯
      console.warn('å®æ—¶æ•°æ®åˆ·æ–°å¤±è´¥:', error.message);
    }
  }
};

const startRobot = async (robot: any) => {
  try {
    await ToogoRobotApi.start({ id: robot.id });
    message.success('æœºå™¨äººå·²å¯åŠ¨');
    loadData();
  } catch (error: any) {
    message.error(error.message || 'å¯åŠ¨å¤±è´¥');
  }
};

const stopRobot = async (robot: any) => {
  dialog.warning({
    title: 'ç¡®è®¤åœæ­¢',
    content: `ç¡®å®šè¦åœæ­¢æœºå™¨äºº "${robot.robotName}" å—ï¼Ÿæœªå¹³ä»“çš„è®¢å•éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼`,
    positiveText: 'ç¡®å®š',
    negativeText: 'å–æ¶ˆ',
    onPositiveClick: async () => {
      try {
        await ToogoRobotApi.stop({ id: robot.id });
        message.success('æœºå™¨äººå·²åœæ­¢');
        loadData();
      } catch (error: any) {
        message.error(error.message || 'åœæ­¢å¤±è´¥');
      }
    },
  });
};

// å¿«é€Ÿåˆ‡æ¢è‡ªåŠ¨ä¸‹å•å¼€å…³
const toggleAutoTrade = async (robot: any) => {
  const currentStatus = analysisData.value[robot.id]?.config?.autoTradeEnabled;
  const newStatus = currentStatus ? 0 : 1;
  try {
    await ToogoRobotApi.update({
      id: robot.id,
      autoTradeEnabled: newStatus,
    });
    // æ›´æ–°æœ¬åœ°çŠ¶æ€
    if (analysisData.value[robot.id]?.config) {
      analysisData.value[robot.id].config.autoTradeEnabled = newStatus === 1;
    }
    message.success(newStatus ? 'å·²å¼€å¯å…¨è‡ªåŠ¨ä¸‹å•' : 'å·²å…³é—­å…¨è‡ªåŠ¨ä¸‹å•');
  } catch (error: any) {
    message.error(error.message || 'åˆ‡æ¢å¤±è´¥');
  }
};

// å¿«é€Ÿåˆ‡æ¢è‡ªåŠ¨å¹³ä»“å¼€å…³
const toggleAutoClose = async (robot: any) => {
  const currentStatus = analysisData.value[robot.id]?.config?.autoCloseEnabled;
  const newStatus = currentStatus ? 0 : 1;
  try {
    await ToogoRobotApi.update({
      id: robot.id,
      autoCloseEnabled: newStatus,
    });
    // æ›´æ–°æœ¬åœ°çŠ¶æ€
    if (analysisData.value[robot.id]?.config) {
      analysisData.value[robot.id].config.autoCloseEnabled = newStatus === 1;
    }
    message.success(newStatus ? 'å·²å¼€å¯å…¨è‡ªåŠ¨å¹³ä»“' : 'å·²å…³é—­å…¨è‡ªåŠ¨å¹³ä»“');
  } catch (error: any) {
    message.error(error.message || 'åˆ‡æ¢å¤±è´¥');
  }
};

const deleteRobot = (robot: any) => {
  dialog.error({
    title: 'ç¡®è®¤åˆ é™¤',
    content: `ç¡®å®šè¦åˆ é™¤æœºå™¨äºº "${robot.robotName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,
    positiveText: 'ç¡®å®šåˆ é™¤',
    negativeText: 'å–æ¶ˆ',
    onPositiveClick: async () => {
      try {
        await ToogoRobotApi.delete({ id: robot.id });
        message.success('æœºå™¨äººå·²åˆ é™¤');
        loadData();
      } catch (error: any) {
        message.error(error.message || 'åˆ é™¤å¤±è´¥');
      }
    },
  });
};

// æ‰‹åŠ¨å¹³ä»“ (åˆ—è¡¨ä¸­)
const closePosition = async (robot: any, position: any) => {
  dialog.warning({
    title: 'ç¡®è®¤å¹³ä»“',
    content: `ç¡®å®šè¦å¹³ä»“ ${position.positionSide === 'LONG' ? 'å¤š' : 'ç©º'} ${Math.abs(position.positionAmt).toFixed(4)} å—ï¼Ÿ`,
    positiveText: 'ç¡®å®šå¹³ä»“',
    negativeText: 'å–æ¶ˆ',
    onPositiveClick: async () => {
      try {
        await ToogoRobotApi.closePosition({
          robotId: robot.id,
          symbol: position.symbol,
          positionSide: position.positionSide,
          quantity: Math.abs(position.positionAmt),
        });
        message.success('å¹³ä»“æˆåŠŸ');
        loadRealtimeData();
      } catch (error: any) {
        message.error(error.message || 'å¹³ä»“å¤±è´¥');
      }
    },
  });
};

// æ‰‹åŠ¨å¹³ä»“ (è¯¦æƒ…å¼¹çª—ä¸­)
const closePositionInModal = async (position: any) => {
  if (!currentRobot.value) return;
  await closePosition(currentRobot.value, position);
  loadDetailData(currentRobot.value);
};

// æ’¤é”€æŒ‚å•
const cancelOrder = async (orderId: string) => {
  if (!currentRobot.value) {
    message.error('è¯·å…ˆé€‰æ‹©æœºå™¨äºº');
    return;
  }
  try {
    await ToogoRobotApi.cancelOrder({ robotId: currentRobot.value.id, orderId });
    message.success('æ’¤å•æˆåŠŸ');
    // åˆ·æ–°æŒ‚å•åˆ—è¡¨
    loadDetailData(currentRobot.value);
  } catch (error: any) {
    message.error('æ’¤å•å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
  }
};

// æŸ¥çœ‹è¯¦æƒ…
const viewDetail = async (robot: any) => {
  currentRobot.value = robot;
  showDetailModal.value = true;
  
  // åŠ è½½æœºå™¨äººè¯¦æƒ…æ•°æ®
  loadDetailData(robot);
  
  // å°è¯•è§£æå¹¶åŠ è½½ç­–ç•¥ç»„ä¿¡æ¯
  if (robot.currentStrategy) {
    try {
      const strategyData = typeof robot.currentStrategy === 'string' 
        ? JSON.parse(robot.currentStrategy) 
        : robot.currentStrategy;
      
      // å¦‚æœæœ‰group_idï¼ŒåŠ è½½ç­–ç•¥ç»„ä¿¡æ¯å’Œå¯¹åº”çš„ç­–ç•¥æ¨¡æ¿
      if (strategyData.group_id) {
        try {
          const groupList = await ToogoStrategyApi.groupList({ page: 1, pageSize: 1, id: strategyData.group_id });
          if (groupList?.list && groupList.list.length > 0) {
            currentRobotStrategy.value = groupList.list[0];
            
            // åŠ è½½ç­–ç•¥ç»„å¯¹åº”çš„ç­–ç•¥æ¨¡æ¿ï¼ˆæ ¹æ®æœºå™¨äººçš„å¸‚åœºçŠ¶æ€å’Œé£é™©åå¥½ï¼‰
            try {
              const marketState = robot.marketState || 'trend';
              const riskPreference = robot.riskPreference || 'balanced';
              const templateRes = await ToogoStrategyApi.templateList({ 
                groupId: strategyData.group_id, 
                marketState: marketState,
                riskPreference: riskPreference,
                pageSize: 1 
              });
              if (templateRes?.list && templateRes.list.length > 0) {
                currentStrategyTemplate.value = templateRes.list[0];
              }
            } catch (err) {
              console.debug('åŠ è½½ç­–ç•¥æ¨¡æ¿å¤±è´¥:', err);
            }
          }
        } catch (err) {
          console.debug('åŠ è½½ç­–ç•¥ç»„ä¿¡æ¯å¤±è´¥:', err);
        }
      } else {
        // å¦‚æœæ²¡æœ‰group_idï¼Œå°è¯•æŸ¥æ‰¾æˆ‘çš„ç­–ç•¥åˆ—è¡¨é‡Œçš„é»˜è®¤ç­–ç•¥ç»„
        try {
          const myGroupList = await ToogoStrategyApi.groupList({ page: 1, pageSize: 100, isOfficial: 0 });
          const defaultGroup = myGroupList?.list?.find((g: any) => g.isDefault === 1);
          if (defaultGroup) {
            currentRobotStrategy.value = defaultGroup;
          }
        } catch (err) {
          console.debug('æŸ¥æ‰¾æˆ‘çš„é»˜è®¤ç­–ç•¥ç»„å¤±è´¥:', err);
        }
      }
    } catch (err) {
      console.debug('è§£æç­–ç•¥é…ç½®å¤±è´¥:', err);
    }
  } else {
    // å¦‚æœæ²¡æœ‰currentStrategyï¼Œä¹Ÿå°è¯•æŸ¥æ‰¾æˆ‘çš„ç­–ç•¥åˆ—è¡¨é‡Œçš„é»˜è®¤ç­–ç•¥ç»„
    try {
      const myGroupList = await ToogoStrategyApi.groupList({ page: 1, pageSize: 100, isOfficial: 0 });
      const defaultGroup = myGroupList?.list?.find((g: any) => g.isDefault === 1);
      if (defaultGroup) {
        currentRobotStrategy.value = defaultGroup;
      }
    } catch (err) {
      console.debug('æŸ¥æ‰¾æˆ‘çš„é»˜è®¤ç­–ç•¥ç»„å¤±è´¥:', err);
    }
  }
};


// æ‰“å¼€é£é™©é…ç½®
const openRiskConfig = (robot: any) => {
  riskConfigRobotId.value = robot.id;
  riskConfigRobotName.value = robot.robotName || `æœºå™¨äºº#${robot.id}`;
  riskConfigRef.value?.open();
};

// åŠ è½½è¯¦æƒ…æ•°æ®
const loadDetailData = async (robot: any) => {
  // åŠ è½½æŒä»“
  positionLoading.value = true;
  try {
    const posRes = await ToogoRobotApi.positions({ robotId: robot.id });
    currentPositions.value = posRes?.list || [];
  } catch (error) {
    console.error('åŠ è½½æŒä»“å¤±è´¥:', error);
  } finally {
    positionLoading.value = false;
  }

  // åŠ è½½å½“å‰æŒ‚å•
  orderLoading.value = true;
  try {
    const orderRes = await ToogoRobotApi.orders({ robotId: robot.id });
    currentOpenOrders.value = orderRes?.list || [];
  } catch (error) {
    console.error('åŠ è½½æŒ‚å•å¤±è´¥:', error);
  } finally {
    orderLoading.value = false;
  }

  // åŠ è½½æˆäº¤æ˜ç»†
  historyLoading.value = true;
  try {
    const historyRes = await ToogoRobotApi.orderHistory({ robotId: robot.id, limit: 50 });
    orderHistory.value = historyRes?.list || [];
  } catch (error) {
    console.error('åŠ è½½æˆäº¤æ˜ç»†å¤±è´¥:', error);
  } finally {
    historyLoading.value = false;
  }

  // åŠ è½½ç®—åŠ›æ¶ˆè€—
  try {
    const powerRes = await ToogoStrategyApi.powerConsumeList({ robotId: robot.id, page: 1, perPage: 20 });
    powerConsumeList.value = powerRes?.list || [];
  } catch (error) {
    console.error('åŠ è½½ç®—åŠ›æ¶ˆè€—å¤±è´¥:', error);
  }
};

// å¼€å§‹å®šæ—¶åˆ·æ–°
const startRefresh = () => {
  // å¿«é€Ÿåˆ·æ–°ï¼šæ¯1ç§’æ›´æ–°ä»·æ ¼å’Œä¿¡å·æ•°æ®
  fastRefreshTimer = setInterval(() => {
    loadRealtimeData();
  }, 1000);
  
  // æ…¢é€Ÿåˆ·æ–°ï¼šæ¯30ç§’æ›´æ–°æŒä»“å’Œæ—¥å¿—æ•°æ®
  refreshTimer = setInterval(() => {
    loadPositionData();
    // åˆ·æ–°æ‰€æœ‰æœºå™¨äººçš„æ–¹å‘é¢„è­¦æ—¥å¿—
    for (const robot of robotList.value) {
      loadSignalLogs(robot.id);
    }
  }, 30000);
};

// åœæ­¢å®šæ—¶åˆ·æ–°
const stopRefresh = () => {
  if (refreshTimer) {
    clearInterval(refreshTimer);
    refreshTimer = null;
  }
  if (fastRefreshTimer) {
    clearInterval(fastRefreshTimer);
    fastRefreshTimer = null;
  }
};

// åŠ è½½æŒä»“æ•°æ®ï¼ˆå•ç‹¬æå–ï¼Œé¿å…å½±å“å®æ—¶ä»·æ ¼åˆ·æ–°ï¼‰
const loadPositionData = async () => {
  const runningRobots = robotList.value.filter((r: any) => r.status === 2);
  for (const robot of runningRobots) {
    try {
      const posRes = await ToogoRobotApi.positions({ robotId: robot.id });
      if (posRes?.list) {
        positionData.value[robot.id] = posRes.list;
      }
    } catch (error: any) {
      console.warn(`åŠ è½½æœºå™¨äºº ${robot.id} æŒä»“å¤±è´¥:`, error);
    }
  }
};

// æ‰“å¼€ç­–ç•¥æ¨¡æ¿é€‰æ‹©å™¨
const openStrategySelector = async () => {
  selectedGroupId.value = currentRobot.value?.strategyGroupId || null;
  selectedIsOfficial.value = false;
  await loadStrategyGroups();
  showStrategySelector.value = true;
};

// åŠ è½½ç­–ç•¥æ¨¡æ¿ç»„
const loadStrategyGroups = async () => {
  loadingStrategyGroups.value = true;
  try {
    // åŠ è½½æˆ‘çš„ç­–ç•¥æ¨¡æ¿
    const myRes = await ToogoStrategyApi.groupList({ page: 1, pageSize: 100, isOfficial: 0 });
    myStrategyGroups.value = myRes?.list || [];
    
    // åŠ è½½å®˜æ–¹ç­–ç•¥æ¨¡æ¿
    const officialRes = await ToogoStrategyApi.groupList({ page: 1, pageSize: 100, isOfficial: 1 });
    officialStrategyGroups.value = officialRes?.list || [];
  } catch (error) {
    console.error('åŠ è½½ç­–ç•¥æ¨¡æ¿å¤±è´¥:', error);
  } finally {
    loadingStrategyGroups.value = false;
  }
};

// é€‰æ‹©å®˜æ–¹ç­–ç•¥æ¨¡æ¿ï¼ˆæ ‡è®°ä¸ºå®˜æ–¹ï¼‰
const selectOfficialGroup = (group: any) => {
  selectedGroupId.value = group.id;
  selectedIsOfficial.value = true;
};

// åº”ç”¨ç­–ç•¥æ¨¡æ¿
const applyStrategyGroup = async () => {
  if (!selectedGroupId.value || !currentRobot.value) return;
  
  applyingStrategy.value = true;
  try {
    let groupIdToApply = selectedGroupId.value;
    
    // å¦‚æœé€‰æ‹©çš„æ˜¯å®˜æ–¹ç­–ç•¥ï¼Œå…ˆå¤åˆ¶åˆ°æˆ‘çš„ç­–ç•¥
    if (selectedIsOfficial.value) {
      try {
        const copyRes = await ToogoStrategyApi.copyFromOfficial({ officialGroupId: selectedGroupId.value });
        groupIdToApply = copyRes?.id || selectedGroupId.value;
      } catch (copyError: any) {
        const errorMsg = copyError?.message || copyError?.data?.message || '';
        if (errorMsg.includes('å·²å­˜åœ¨')) {
          const myGroup = myStrategyGroups.value.find((g: any) => g.fromOfficialId === selectedGroupId.value);
          if (myGroup) groupIdToApply = myGroup.id;
        } else {
          throw copyError;
        }
      }
    }
    
    // è·å–ç­–ç•¥æ¨¡æ¿ä¸­çš„ç¬¬ä¸€ä¸ªç­–ç•¥ä½œä¸ºé»˜è®¤é…ç½®åº”ç”¨åˆ°æœºå™¨äºº
    try {
      const templateRes = await ToogoStrategyApi.templateList({ groupId: groupIdToApply, pageSize: 1 });
      const firstStrategy = templateRes?.list?.[0];
      
      if (firstStrategy) {
        let configData: any = {};
        try {
          configData = typeof firstStrategy.configJson === 'string' 
            ? JSON.parse(firstStrategy.configJson || '{}') 
            : (firstStrategy.configJson || {});
        } catch {
          configData = {};
        }
        
        const updateData = {
          id: currentRobot.value.id,
          robotName: currentRobot.value.robotName,
          exchange: configData.exchange || firstStrategy.exchange || 'bitget',
          symbol: configData.symbol || firstStrategy.symbol || 'BTC-USDT',
          tradeType: configData.tradeType || firstStrategy.tradeType || 'perpetual',
          orderType: configData.orderType || firstStrategy.orderType || 'market',
          marginMode: configData.marginMode || firstStrategy.marginMode || 'isolated',
          maxProfitTarget: currentRobot.value.maxProfitTarget || 100,
          maxLossAmount: currentRobot.value.maxLossAmount || 50,
          maxRuntime: currentRobot.value.maxRuntime || 0,
          riskPreference: firstStrategy.riskPreference || 'balanced',
          autoRiskPreference: 1,
          marketState: firstStrategy.marketState || 'trend',
          autoMarketState: 1,
          leverage: configData.leverage || firstStrategy.leverageMin || 10,
          marginPercent: configData.marginPercent || firstStrategy.marginPercentMin || 10,
          useMonitorSignal: 1,
          enableReverseOrder: configData.reverseEnabled !== false ? 1 : 0,
          stopLossPercent: configData.stopLossPercent || firstStrategy.stopLossPercent || 5,
          profitRetreatPercent: configData.profitRetreatPercent || firstStrategy.profitRetreatPercent || 30,
          autoStartRetreatPercent: configData.autoStartRetreatPercent || firstStrategy.autoStartRetreatPercent || 3,
          remark: `ç­–ç•¥æ¨¡æ¿: ${groupIdToApply}`,
        };
        
        await ToogoRobotApi.update(updateData);
        
        // å¦‚æœæœºå™¨äººæ­£åœ¨è¿è¡Œï¼Œé€šçŸ¥åç«¯é‡æ–°åŠ è½½ç­–ç•¥é…ç½®
        if (currentRobot.value.status === 2) {
          try {
            await ToogoRobotApi.reloadStrategy({ id: currentRobot.value.id });
            message.success('ç­–ç•¥æ¨¡æ¿å·²åº”ç”¨ï¼è¿è¡Œä¸­çš„æœºå™¨äººé…ç½®å·²æ›´æ–°');
          } catch (reloadErr: any) {
            message.warning('ç­–ç•¥å·²æ›´æ–°ï¼Œä½†è¿è¡Œä¸­é…ç½®åˆ·æ–°å¤±è´¥ï¼Œå»ºè®®é‡å¯æœºå™¨äºº');
          }
        } else {
          message.success('ç­–ç•¥æ¨¡æ¿å·²åº”ç”¨ï¼é…ç½®å·²æ›´æ–°');
        }
        
        // ç«‹å³æ›´æ–°æœ¬åœ°æ˜¾ç¤ºæ•°æ®
        Object.assign(currentRobot.value, {
          platform: updateData.exchange,
          exchange: updateData.exchange,
          tradingPair: updateData.symbol,
          symbol: updateData.symbol,
          tradeType: updateData.tradeType,
          orderType: updateData.orderType,
          marginMode: updateData.marginMode,
          riskPreference: updateData.riskPreference,
          marketState: updateData.marketState,
          leverage: updateData.leverage,
          marginPercent: updateData.marginPercent,
          marginRatio: updateData.marginPercent,
          stopLossPercent: updateData.stopLossPercent,
          takeProfitRetracePercent: updateData.profitRetreatPercent,
          autoRiskPreference: updateData.autoRiskPreference,
          autoMarketState: updateData.autoMarketState,
          useMonitorSignal: updateData.useMonitorSignal,
          enableReverseOrder: updateData.enableReverseOrder,
        });
        
      } else {
        message.warning('ç­–ç•¥æ¨¡æ¿ä¸­æ²¡æœ‰å¯ç”¨ç­–ç•¥');
      }
    } catch (updateError: any) {
      throw new Error(updateError?.message || 'æ›´æ–°æœºå™¨äººé…ç½®å¤±è´¥');
    }
    
    showStrategySelector.value = false;
    loadData();
  } catch (error: any) {
    const errorMsg = error?.message || error?.data?.message || 'åº”ç”¨å¤±è´¥';
    message.error(errorMsg);
  } finally {
    applyingStrategy.value = false;
  }
};

// è·³è½¬åˆ°ç­–ç•¥ç®¡ç†é¡µ
const goToStrategy = () => {
  showStrategySelector.value = false;
  router.push('/toogo/strategy/my');
};


onMounted(() => {
  loadData();
  loadStrategyGroups();
  startRefresh();
});

onUnmounted(() => {
  stopRefresh();
});
</script>

<style lang="less" scoped>
.robot-page {
  padding: 16px;
  
  /* ========== å¤œé—´æ¨¡å¼é€‚é…å˜é‡ ========== */
  --robot-bg: #ffffff;
  --robot-border: rgba(0, 0, 0, 0.08);
  --robot-text-primary: rgba(0, 0, 0, 0.88);
  --robot-text-secondary: #666666;
  --robot-text-tertiary: #888888;
  --robot-hover-bg: rgba(0, 0, 0, 0.02);
  --robot-panel-bg: rgba(0, 0, 0, 0.02);
  --robot-chart-bg: rgba(255, 255, 255, 0.6);
  --robot-chart-line: #3b82f6;
  --robot-chart-grid: rgba(0, 0, 0, 0.1);
  
  /* è‡ªåŠ¨é€‚é…æ·±è‰²æ¨¡å¼ */
  html.dark & {
    --robot-bg: rgba(255, 255, 255, 0.05);
    --robot-border: rgba(255, 255, 255, 0.12);
    --robot-text-primary: rgba(255, 255, 255, 0.9);
    --robot-text-secondary: rgba(255, 255, 255, 0.65);
    --robot-text-tertiary: rgba(255, 255, 255, 0.45);
    --robot-hover-bg: rgba(255, 255, 255, 0.05);
    --robot-panel-bg: rgba(255, 255, 255, 0.03);
    --robot-chart-bg: rgba(0, 0, 0, 0.3);
    --robot-chart-line: #60a5fa;
    --robot-chart-grid: rgba(255, 255, 255, 0.1);
  }
}

.mb-3 {
  margin-bottom: 12px;
}

.robot-card {
  transition: all 0.3s;

  &.running {
    border: 1px solid var(--success-color);
  }
}

/* ==================== å¤´éƒ¨è¿æ¥çŠ¶æ€æ ·å¼ ==================== */
.header-connection {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 10px;
  font-weight: 500;
  
  .conn-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }
  
  &.connected {
    background: rgba(87, 202, 34, 0.15);
    color: rgb(87, 202, 34);
    .conn-dot {
      background: rgb(87, 202, 34);
      box-shadow: 0 0 4px rgba(87, 202, 34, 0.6);
      animation: pulse-green 2s infinite;
    }
  }
  
  &.connecting {
    background: rgba(245, 158, 11, 0.15);
    color: rgb(245, 158, 11);
    .conn-dot {
      background: rgb(245, 158, 11);
      animation: pulse-yellow 1s infinite;
    }
  }
  
  &.disconnected {
    background: rgba(239, 68, 68, 0.15);
    color: rgb(239, 68, 68);
    .conn-dot {
      background: rgb(239, 68, 68);
    }
  }
}

/* ==================== ä¸‰åˆ—å¸ƒå±€ä¿¡å·é¢æ¿ ==================== */
.signal-three-column {
  display: grid;
  grid-template-columns: 130px auto 1fr;
  gap: 16px;
  padding: 12px;
  background: var(--card-color);
  border: 1px solid rgba(0,0,0,0.05);
  border-radius: 8px;
  min-height: 150px;
  align-items: center;
}

/* ç¬¬ä¸€åˆ—ï¼šæœºå™¨äººåŠ¨ç”» */
.column-robot {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
}

/* ç¬¬äºŒåˆ—ï¼šæ–¹å‘é¢„è­¦æŒ‰é’® */
.column-signal {
  display: flex;
  flex-direction: column;
  gap: 8px;
  justify-content: center;
  height: 100%;
  min-width: 130px;
  
  .signal-block {
    padding: 8px 12px;
    border-radius: 6px;
    transition: all 0.2s ease;
    background: rgba(0,0,0,0.02);
    border: 1px solid transparent;
    
    &.long {
      .signal-header { color: #059669; }
      .signal-trigger { color: #10b981; }
      
      &.active {
        background: rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.2);
      }
    }
    
    &.short {
      .signal-header { color: #dc2626; }
      .signal-trigger { color: #ef4444; }
      
      &.active {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.2);
      }
    }
    
    .signal-header {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 2px;
      
      .signal-icon { font-size: 14px; }
    }
    
    .signal-trigger {
      font-size: 13px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }
    
    .signal-distance {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }
  }
  
  .current-price-block {
    display: flex;
    align-items: baseline;
    gap: 6px;
    padding: 6px 12px;
    background: rgba(0, 0, 0, 0.02);
    border-radius: 6px;
    
    .price-value {
      font-size: 16px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      
      &.up { color: #10b981; }
      &.down { color: #ef4444; }
    }
    
    .price-change {
      font-size: 11px;
      font-weight: 500;
      
      &.up { color: #10b981; }
      &.down { color: #ef4444; }
    }
  }
}

/* ç¬¬ä¸‰åˆ—ï¼šä»·æ ¼å›¾è¡¨ */
.column-chart {
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 6px;
  height: 100%;
  min-width: 200px;
  
  .chart-svg {
    width: 100%;
    height: 120px;
    display: block;
  }
  
  .chart-svg-vertical {
     width: 100%;
     height: 100%;
     min-height: 100px;
     display: block;
  }
  
  .chart-line { fill: none; stroke: #3b82f6; stroke-width: 1.5; }
  .chart-fill { fill: #3b82f6; fill-opacity: 0.15; }
  .chart-baseline { stroke: #3b82f6; stroke-width: 1; stroke-dasharray: 3,3; opacity: 0.3; }
  .chart-upper { stroke: #ef4444; stroke-width: 1; stroke-dasharray: 2,2; }
  .chart-lower { stroke: #10b981; stroke-width: 1; stroke-dasharray: 2,2; }
  
  .chart-labels {
    display: flex;
    justify-content: space-between;
    font-size: 9px;
    margin-top: 4px;
    
    .label-high { color: #ef4444; }
    .label-low { color: #10b981; }
  }
}

.mini-robot-scene {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  
  .mini-robot {
    width: 120px;
    height: 120px;
    transition: all 0.3s ease;
  }
  
  .robot-mood-text {
    font-size: 11px;
    color: var(--robot-text-secondary);
    font-weight: 500;
    text-align: center;
    max-width: 120px;
    line-height: 1.2;
  }
  
  .robot-shadow {
    transition: all 0.3s ease;
  }
  
  .tail-group {
    transition: all 0.3s ease;
  }
  
  .head-group {
    transition: all 0.3s ease;
  }
  
  .body-screen {
    transition: all 0.5s ease;
  }
  
  /* åŠ¨ç”»çŠ¶æ€æ ·å¼ */
  &.mood-happy {
    .mini-robot { animation: mini-jump 0.6s infinite alternate ease-in-out; }
    .tail-group { animation: mini-wag 0.3s infinite ease-in-out; }
    .eye { display: none; }
  }
  
  &.mood-thinking {
    .head-group { transform: rotate(8deg); transform-origin: center bottom; }
    .left-eyebrow { transform: rotate(-8deg) translateY(-1px); }
    .right-eyebrow { transform: rotate(8deg) translateY(1px); }
  }
  
  &.mood-confused {
    .head-group { animation: mini-shake 1.5s infinite ease-in-out; }
    .right-ear { transform: rotate(15deg) translate(2px, -2px); }
  }
  
  &.mood-tired {
    .mini-robot { filter: grayscale(0.4); animation: mini-float 4s ease-in-out infinite; }
    .head-group { transform: translateY(3px) rotate(-3deg); }
  }
  
  &.mood-excited {
    .mini-robot { animation: mini-vibrate 0.15s infinite; }
    .tail-group { animation: mini-wag 0.15s infinite; }
    .body-screen { animation: mini-rainbow 1s infinite; }
  }
  
  &.mood-focused {
    .eye { fill: #ff3333 !important; }
    .eyebrow { transform: rotate(10deg) translateY(2px); }
  }
  
  &.mood-sad {
    .mini-robot { transform: scale(0.95); }
    .head-group { transform: translateY(5px) rotate(-5deg); }
    .tail-group { transform: rotate(20deg); }
  }
  
  &.mood-conservative {
    .eye { fill: #4cd137 !important; }
    .mini-robot { animation: mini-float 3s ease-in-out infinite; }
  }
  
  &.mood-balanced {
    .eye { fill: #00a8ff !important; }
    .head-group { animation: mini-balance 3s infinite ease-in-out; }
  }
  
  &.mood-aggressive {
    .mini-robot { animation: mini-vibrate 0.1s infinite; transform: translateY(-3px); }
    .eye { fill: #e84118 !important; filter: drop-shadow(0 0 3px #e84118) !important; }
    .eyebrow { transform: rotate(15deg) translateY(3px); }
  }
}

/* æœºå™¨äººåŠ¨ç”»å…³é”®å¸§ */
@keyframes mini-jump {
  0% { transform: translateY(0); }
  100% { transform: translateY(-5px); }
}

@keyframes mini-wag {
  0%, 100% { transform: rotate(-5deg); }
  50% { transform: rotate(5deg); }
}

@keyframes mini-shake {
  0%, 100% { transform: rotate(0); }
  25% { transform: rotate(-5deg); }
  75% { transform: rotate(5deg); }
}

@keyframes mini-float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-3px); }
}

@keyframes mini-vibrate {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-1px); }
  75% { transform: translateX(1px); }
}

@keyframes mini-rainbow {
  0% { fill: #111; }
  25% { fill: #1a1a3e; }
  50% { fill: #111; }
  75% { fill: #1e1e3e; }
  100% { fill: #111; }
}

@keyframes mini-balance {
  0%, 100% { transform: rotate(0); }
  25% { transform: rotate(-3deg); }
  75% { transform: rotate(3deg); }
}

.status-section {
  background: linear-gradient(135deg, var(--card-color) 0%, var(--hover-color) 100%);
  padding: 10px 16px;
  border-radius: 8px;
  margin-bottom: 12px;
  border: 1px solid var(--border-color);

  .status-indicator-item {
    display: flex;
    align-items: center;
    gap: 6px;

    .indicator-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      
      &.connected {
        background-color: rgb(87, 202, 34);
        box-shadow: 0 0 8px rgba(87, 202, 34, 0.6);
        animation: pulse-green 2s infinite;
      }
      
      &.connecting {
        background-color: rgb(240, 160, 32);
        animation: pulse-yellow 1s infinite;
      }
      
      &.disconnected {
        background-color: rgb(208, 48, 80);
      }
    }

    .indicator-label {
      font-size: 12px;
      color: var(--text-color-2);
    }
  }
}

@keyframes pulse-green {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

@keyframes pulse-yellow {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

/* ==================== æ–¹å‘ä¿¡å·é¢„è­¦é¢æ¿ ==================== */
// å¸‚åœºçŠ¶æ€åˆ†æå—
.market-analysis-panel {
  background: var(--robot-bg);
  border: 1px solid var(--robot-border);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
  
  .market-analysis-header {
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  
  .strategy-params-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px 12px;
    margin-bottom: 8px;
    
    &.expanded {
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .param-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      
      .param-label {
        font-size: 11px;
        color: var(--robot-text-tertiary);
        font-weight: 500;
      }
      
      .param-value {
        font-size: 13px;
        font-weight: 600;
        color: var(--robot-text-primary);
        font-family: 'JetBrains Mono', 'Consolas', monospace;
        
        &.error {
          color: #ef4444;
        }
        
        &.success {
          color: #10b981;
        }
        
        &.warning {
          color: #f59e0b;
        }
        
        &.primary {
          color: #6366f1;
        }
      }
      
      &.highlight {
        background: rgba(0,0,0,0.02);
        border-radius: 6px;
        padding: 6px 8px;
        
        .param-label {
          color: #6366f1;
        }
        
        .param-value {
          color: #6366f1;
          font-size: 14px;
        }
      }
    }
  }
  
  .strategy-update-time {
    text-align: center;
    padding-top: 6px;
    border-top: 1px solid rgba(0,0,0,0.05);
  }
}

.market-analysis-collapse {
  margin-bottom: 8px;
  
  :deep(.n-collapse-item__header) {
    padding: 8px 12px;
    background: linear-gradient(135deg, #e8f4fd 0%, #f0f9ff 100%);
    border-radius: 8px;
  }
  
  :deep(.n-collapse-item__content-inner) {
    padding: 12px;
    background: rgba(99, 102, 241, 0.03);
    border-radius: 0 0 8px 8px;
  }
}

.signal-alert-panel {
  background: var(--robot-bg);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
  border: 1px solid var(--robot-border);
  
  .signal-alert-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .signal-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 16px;
    font-weight: 600;
    
    &.badge-long {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 2px 6px rgba(16, 185, 129, 0.35);
    }
    
    &.badge-short {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.35);
    }
    
    &.badge-neutral {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
    }
    
    .badge-icon { font-size: 16px; }
    .badge-text { font-size: 13px; }
    .badge-strength {
      background: rgba(255, 255, 255, 0.2);
      padding: 1px 6px;
      border-radius: 8px;
      font-size: 11px;
    }
  }
  
  .signal-tags {
    display: flex;
    gap: 5px;
  }
  
  .signal-price-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    padding: 8px;
    background: var(--robot-panel-bg);
    border-radius: 8px;
    
    .price-current {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px 12px;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 6px;
      min-width: 90px;
      
      .price-label { font-size: 10px; color: #888; }
      .price-value {
        font-size: 16px;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        &.up { color: #10b981; }
        &.down { color: #ef4444; }
      }
      .price-change {
        font-size: 10px;
        &.up { color: #10b981; }
        &.down { color: #ef4444; }
      }
    }
    
    .price-window {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      
      .window-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 10px;
        color: var(--robot-text-secondary);
        
        strong {
          font-size: 11px;
          font-family: 'JetBrains Mono', monospace;
          color: var(--robot-text-primary);
        }
        
        &.low strong { color: #10b981; }
        &.high strong { color: #ef4444; }
        &.highlight strong { color: #6366f1; }
      }
    }
  }
  
  .signal-triggers {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
    
    .trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      
      &.long {
        background: rgba(16, 185, 129, 0.12);
        border: 1px solid rgba(16, 185, 129, 0.25);
        .trigger-name { color: #059669; }
        .trigger-price { color: #10b981; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .trigger-dist { color: #10b981; font-size: 9px; opacity: 0.8; }
      }
      
      &.short {
        background: rgba(239, 68, 68, 0.12);
        border: 1px solid rgba(239, 68, 68, 0.25);
        .trigger-name { color: #dc2626; }
        .trigger-price { color: #ef4444; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .trigger-dist { color: #ef4444; font-size: 9px; opacity: 0.8; }
      }
    }
  }
  
  .signal-chart {
    background: var(--robot-chart-bg);
    backdrop-filter: blur(8px);
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 6px;
    border: 1px solid var(--robot-border);
    
    .chart-svg {
      width: 100%;
      height: 120px;
      display: block;
    }
    
    .chart-line { fill: none; stroke: var(--robot-chart-line); stroke-width: 2; filter: drop-shadow(0 1px 2px rgba(59, 130, 246, 0.3)); }
    .chart-fill { fill: var(--robot-chart-line); opacity: 0.15; }
    .chart-baseline { stroke: var(--robot-chart-line); stroke-width: 1.5; stroke-dasharray: 4,4; opacity: 0.5; }
    .chart-upper { stroke: #ef4444; stroke-width: 1.5; stroke-dasharray: 4,3; opacity: 0.7; }
    .chart-lower { stroke: #10b981; stroke-width: 1.5; stroke-dasharray: 4,3; opacity: 0.7; }
    .point-min { fill: var(--robot-chart-line); stroke: var(--robot-bg); stroke-width: 2; }
    .point-max { fill: #ef4444; stroke: var(--robot-bg); stroke-width: 2; }
    .point-current { fill: #10b981; stroke: var(--robot-bg); stroke-width: 2.5; }
    
    /* ä»·æ ¼æ ‡ç­¾æ ·å¼ */
    .price-label {
      font-size: 10px;
      font-weight: 600;
      text-anchor: middle;
    }
    .price-label-min { fill: var(--robot-chart-line); }
    .price-label-max { fill: #ef4444; }
    .price-label-current { 
      fill: #10b981; 
      font-weight: 700;
      text-anchor: start;
    }
    
    /* å›¾ä¾‹è¯´æ˜ */
    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 4px;
      font-size: 10px;
      
      .legend-item {
        display: flex;
        align-items: center;
        gap: 2px;
      }
      .legend-max { color: #ef4444; }
      .legend-current { color: #10b981; }
      .legend-min { color: #3b82f6; }
    }
  }
  
  .signal-reason {
    padding: 6px 10px;
    background: rgba(99, 102, 241, 0.08);
    border-radius: 5px;
    font-size: 11px;
    color: var(--robot-text-secondary);
    line-height: 1.4;
    margin-bottom: 6px;
  }
  
  .signal-logs-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    
    .log-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 8px;
      background: var(--robot-panel-bg);
      border-radius: 4px;
      font-size: 11px;
      border-left: 2px solid var(--robot-text-tertiary);
      
      &.long { border-left-color: #10b981; }
      &.short { border-left-color: #ef4444; }
      
      .log-time { color: #888; font-family: 'JetBrains Mono', monospace; font-size: 10px; }
      .log-pct { font-weight: 600; color: #6366f1; }
      .log-price { font-family: 'JetBrains Mono', monospace; color: #333; margin-left: auto; }
    }
    
    .log-row-detail {
      padding: 8px 10px;
      background: var(--robot-panel-bg);
      border-radius: 6px;
      border-left: 3px solid var(--robot-text-tertiary);
      
      &.long { border-left-color: #10b981; background: rgba(16, 185, 129, 0.05); }
      &.short { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
      
      &.not-executed {
        background: rgba(251, 191, 36, 0.08);
        border-left-color: #f59e0b;
      }
      
      .log-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
        
        .log-time { 
          color: #666; 
          font-family: 'JetBrains Mono', monospace; 
          font-size: 11px; 
        }
        .log-price { 
          font-family: 'JetBrains Mono', monospace; 
          color: #333; 
          font-weight: 600;
          font-size: 12px;
        }
      }
      
      .log-reason {
        padding: 6px 8px;
        background: rgba(251, 191, 36, 0.15);
        border-radius: 4px;
        margin-top: 6px;
      }
      
      .log-success {
        padding: 4px 0;
        margin-top: 4px;
      }
      
      .log-params {
        display: flex;
        gap: 8px;
        margin-top: 6px;
        
        .param-badge {
          font-size: 10px;
          color: #666;
          background: rgba(0, 0, 0, 0.05);
          padding: 2px 6px;
          border-radius: 4px;
        }
      }
    }
  }
}

.analysis-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background-color: var(--card-color);
  border-radius: 8px;
  margin-bottom: 12px;
}

/* è´¦æˆ·+ç­–ç•¥å‚æ•°æ•´åˆé¢æ¿ */
.account-strategy-panel {
  background: var(--robot-bg);
  border-radius: 8px;
  margin-bottom: 12px;
  padding: 12px;
  border: 1px solid var(--robot-border);
  
  .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: 14px;
      
      &.primary { color: var(--primary-color); }
      &.warning { color: #f59e0b; }
  }

  .param-box {
    text-align: center;
    padding: 6px 4px;
    background: var(--robot-panel-bg);
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    
    &:hover {
        background: var(--robot-hover-bg);
    }
    
    .label {
      font-size: 10px;
      color: var(--robot-text-tertiary);
      margin-bottom: 2px;
      transform: scale(0.9);
    }
    
    .value {
      font-size: 12px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
      color: var(--robot-text-primary);
    }
    
    /* Variations */
    &.highlight {
        background: rgba(99, 102, 241, 0.08);
        .value { color: #6366f1; }
    }
    &.error {
        background: rgba(239, 68, 68, 0.08);
        .value { color: #ef4444; }
    }
    &.success {
        background: rgba(16, 185, 129, 0.08);
        .value { color: #10b981; }
    }
    &.warning {
        background: rgba(245, 158, 11, 0.08);
        .value { color: #f59e0b; }
    }
  }
  
  .switch-item {
      cursor: pointer;
      transition: all 0.2s;
      &:hover { 
          transform: translateY(-1px);
      }
  }
}

.account-section {
  background: linear-gradient(135deg, rgba(32, 128, 240, 0.08) 0%, rgba(24, 160, 88, 0.08) 100%);
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 12px;
  border: 1px solid var(--border-color);

  .account-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
}

.config-section {
  background-color: var(--card-color);
  padding: 8px 12px;
  border-radius: 6px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  
  .quick-switch {
    cursor: pointer;
    transition: all 0.2s ease;
    
    &:hover {
      transform: scale(1.05);
    }
    
    &:active {
      transform: scale(0.98);
    }
    
    .clickable-tag {
      cursor: pointer;
      transition: all 0.2s ease;
      
      &:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
    }
  }
  
  :deep(.n-tag) {
    &:not(.clickable-tag) {
      cursor: default;
    }
  }
}

.ticker-section {
  background-color: var(--card-color);
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 12px;

  .ticker-item {
    text-align: center;
  }

  .price {
    font-size: 18px;
    font-weight: bold;

    &.up { color: var(--success-color); }
    &.down { color: var(--error-color); }
  }
}

.position-section {
  background-color: var(--card-color);
  padding: 12px;
  border-radius: 8px;

  .position-item {
    padding: 10px 12px;
    background-color: var(--body-color);
    border-radius: 6px;
    margin-bottom: 8px;

    &:last-child {
      margin-bottom: 0;
    }
  }
}

/* å®æ—¶æŒä»“è®¢å•åˆ—è¡¨æ ·å¼ - å‚è€ƒ toogo é¡¹ç›® */
.positions-section {
  margin-bottom: 16px;
}

.positions-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--divider-color);
}

.positions-title {
  font-size: 14px;
  font-weight: 600;
  margin: 0;
  color: var(--text-color-1);
}

.positions-count {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 24px;
  height: 20px;
  padding: 0 6px;
  background: linear-gradient(135deg, var(--primary-color), var(--primary-color-hover));
  color: white;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 600;
}

.positions-table-wrapper {
  border-radius: 8px;
  overflow-x: auto;
  border: 1px solid var(--divider-color);
  background: var(--body-color);
}

.positions-table-wrapper::-webkit-scrollbar {
  height: 8px;
}

.positions-table-wrapper::-webkit-scrollbar-track {
  background: var(--body-color);
  border-radius: 4px;
}

.positions-table-wrapper::-webkit-scrollbar-thumb {
  background: var(--primary-color-suppl);
  border-radius: 4px;
}

.positions-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  min-width: 800px;
}

.positions-table thead {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05));
}

.positions-table th {
  padding: 10px 8px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-color-3);
  white-space: nowrap;
  text-align: left;
  border-bottom: 2px solid var(--divider-color);
}

.positions-table td {
  padding: 10px 8px;
  vertical-align: middle;
  border-bottom: 1px solid var(--divider-color);
  white-space: nowrap;
  color: var(--text-color-2);
}

.position-row {
  transition: background-color 0.2s ease;
}

.position-row.row-even {
  background: var(--card-color);
}

.position-row.row-odd {
  background: var(--body-color);
}

.position-row:hover {
  background: rgba(99, 102, 241, 0.08) !important;
}

/* åˆ—å®½å®šä¹‰ */
.col-time { width: 110px; min-width: 110px; }
.col-symbol { width: 80px; min-width: 80px; }
.col-side { width: 60px; min-width: 60px; }
.col-quantity { width: 80px; min-width: 80px; }
.col-price { width: 90px; min-width: 90px; }
.col-pl { width: 100px; min-width: 100px; }
.col-margin { width: 80px; min-width: 80px; }
.col-leverage { width: 50px; min-width: 50px; text-align: center; }
.col-monitor { width: 180px; min-width: 180px; max-width: 180px; }
.col-action { width: 60px; min-width: 60px; text-align: center; }

/* ç›‘æ§åˆ—æ ·å¼ */
.monitor-cell {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 4px 0;
}

.monitor-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.monitor-label {
  width: 50px;
  min-width: 50px;
  max-width: 50px;
  font-size: 0.75rem;
  color: var(--text-color-3);
  white-space: nowrap;
}

.progress-bar-container {
  flex: 1;
  height: 5px;
  min-width: 40px;
  background: rgba(148, 163, 184, 0.15);
  border-radius: 3px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  border-radius: 3px;
  transition: width 0.3s ease;
}

.progress-bar-danger {
  background: linear-gradient(90deg, #ef4444, #dc2626);
}

.progress-bar-success {
  background: linear-gradient(90deg, #22c55e, #16a34a);
}

.progress-bar-warning {
  background: linear-gradient(90deg, #f59e0b, #d97706);
}

.monitor-value {
  width: 35px;
  min-width: 35px;
  max-width: 35px;
  font-size: 0.7rem;
  text-align: right;
  color: var(--text-color-2);
  white-space: nowrap;
}

.monitor-value.text-danger {
  color: #ef4444;
  font-weight: bold;
}

.monitor-value.text-success {
  color: #22c55e;
  font-weight: bold;
}

.monitor-max-profit {
  border-top: 1px solid rgba(148, 163, 184, 0.2);
  padding-top: 4px;
  margin-top: 2px;
}

/* æ–¹å‘æ ‡ç­¾ */
.side-tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}

.side-tag.long {
  background: rgba(16, 185, 129, 0.15);
  color: #10b981;
}

.side-tag.short {
  background: rgba(239, 68, 68, 0.15);
  color: #ef4444;
}

/* ç›ˆäºæ˜¾ç¤º */
.pnl-value {
  font-weight: 600;
}

.pnl-value.profit {
  color: #10b981;
}

.pnl-value.loss {
  color: #ef4444;
}

/* ç©ºçŠ¶æ€ */
.positions-table-wrapper .empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  color: var(--text-color-3);
}

.empty-icon {
  font-size: 32px;
  margin-bottom: 12px;
  opacity: 0.6;
}

.empty-text {
  font-size: 13px;
}

/* ç®—æ³•é€»è¾‘è¯´æ˜é¢æ¿æ ·å¼ */
.algorithm-collapse {
  background: var(--robot-bg);
  border-radius: 8px;
  
  .algo-section {
    background: rgba(99, 102, 241, 0.05);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    border: 1px solid rgba(99, 102, 241, 0.15);
    
    &:last-child { margin-bottom: 0; }
    
    .algo-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--robot-text-primary);
      margin-bottom: 6px;
    }
    
    .algo-desc {
      font-size: 11px;
      color: var(--robot-text-secondary);
      margin-bottom: 10px;
      line-height: 1.4;
    }
    
    .algo-warning {
      font-size: 10px;
      color: #f59e0b;
      text-align: center;
      margin-top: 8px;
      padding: 4px 8px;
      background: rgba(245, 158, 11, 0.1);
      border-radius: 4px;
    }
    
    .algo-rules {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      
      .rule-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 10px;
        border-radius: 6px;
        
        &.long {
          background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(16, 185, 129, 0.02) 100%);
          border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        &.short {
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.02) 100%);
          border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .rule-icon {
          font-size: 18px;
        }
        
        .rule-content {
          display: flex;
          flex-direction: column;
          gap: 2px;
          
          .rule-name {
            font-size: 12px;
            font-weight: 600;
          }
          
          .rule-formula {
            font-size: 11px;
            color: var(--robot-text-primary);
            font-family: 'JetBrains Mono', monospace;
            background: var(--robot-panel-bg);
            padding: 2px 6px;
            border-radius: 3px;
          }
          
          .rule-note {
            font-size: 10px;
            color: var(--robot-text-tertiary);
          }
        }
      }
    }
    
    .algo-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      
      .algo-item {
        font-size: 11px;
        color: var(--robot-text-secondary);
        padding: 6px 8px;
        background: var(--robot-panel-bg);
        border-radius: 4px;
        line-height: 1.5;
        
        strong {
          color: #6366f1;
        }
        
        &.formula {
          display: flex;
          flex-wrap: wrap;
          align-items: center;
          gap: 4px;
          
          .item-label {
            font-weight: 500;
            color: #333;
            min-width: 70px;
          }
          
          .item-formula {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            background: rgba(99, 102, 241, 0.08);
            padding: 2px 6px;
            border-radius: 3px;
            color: #6366f1;
          }
          
          .item-action {
            font-weight: 500;
            color: #059669;
          }
          
          .item-note {
            font-size: 10px;
            color: #888;
            width: 100%;
            padding-left: 70px;
            margin-top: 2px;
          }
        }
      }
    }
  }
}

.selected-strategy {
  border-color: var(--primary-color) !important;
}

.strategy-tag {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 12px;
  background-color: var(--card-color);
  border-radius: 6px;
}
</style>


