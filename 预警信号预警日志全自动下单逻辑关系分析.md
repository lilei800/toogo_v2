# 预警信号、预警日志、全自动下单三者之间的逻辑关系分析

## 一、三者定义

### 1.1 预警信号（RobotSignal）

**定义：** 由窗口价格分析生成的交易信号

**数据结构：**
```go
type RobotSignal struct {
    Timestamp       time.Time  // 时间戳
    Direction       string     // 方向：LONG/SHORT/NEUTRAL
    SignalType      string     // 信号类型：window/analysis
    Action          string     // 操作：OPEN_LONG/OPEN_SHORT/HOLD
    Strength        float64    // 信号强度：0-100
    Confidence      float64    // 置信度：0-100
    CurrentPrice    float64    // 当前价格
    WindowMinPrice  float64    // 窗口最低价
    WindowMaxPrice  float64    // 窗口最高价
    DistanceFromMin float64    // 距离最低价的距离
    DistanceFromMax float64    // 距离最高价的距离
    SignalThreshold float64    // 信号阈值
    SignalProgress  float64    // 信号进度：0-100
    Reason          string     // 信号原因
}
```

**生成位置：** `EvaluateWindowSignal()` - `robot_engine.go:1128`

**生成时机：** 每1秒评估一次窗口价格

---

### 1.2 预警日志（Signal Log）

**定义：** 保存到数据库 `hg_trading_signal_log` 表的预警记录

**数据库表：** `hg_trading_signal_log`

**关键字段：**
```sql
- robot_id          -- 机器人ID
- signal_type        -- 信号方向（LONG/SHORT）
- signal_source      -- 信号来源（window_weighted）
- signal_strength    -- 信号强度
- current_price      -- 当前价格
- window_min_price   -- 窗口最低价
- window_max_price   -- 窗口最高价
- threshold          -- 波动阈值
- market_state       -- 市场状态
- risk_preference    -- 风险偏好
- executed           -- 执行状态（0=未执行, 1=已执行）
- execute_result     -- 执行结果（"准备下单"、"自动下单未开启"、"该方向已有持仓"等）
- reason             -- 信号原因
```

**保存位置：** `saveSignalAlert()` - `robot_engine.go:1316`

**保存时机：** 信号生成时（当 `newSignal != "neutral"`）

---

### 1.3 全自动下单（Auto Trade）

**定义：** 根据预警信号自动执行开仓操作

**执行位置：** `TryAutoTradeAndUpdate()` - `robot_engine.go:2238`

**执行时机：** 信号生成后异步执行

**执行流程：**
```
检查信号条件 → 检查下单条件 → 执行开仓 → 更新预警日志
```

---

## 二、三者之间的逻辑关系

### 2.1 整体流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    信号生成（每1秒）                         │
│              EvaluateWindowSignal()                         │
└─────────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────┴───────────────────┐
        ↓                                       ↓
┌───────────────────┐                  ┌───────────────────┐
│  检测到开仓信号   │                  │  信号为NEUTRAL     │
│  (LONG/SHORT)     │                  │  不保存预警日志    │
└───────────────────┘                  └───────────────────┘
        ↓
┌───────────────────┐
│  保存预警日志      │
│  saveSignalAlert() │
│  (hg_trading_signal_log)│
└───────────────────┘
        ↓
┌───────────────────┐
│  检查信号条件      │
│  checkSignalConditions()│
│  返回执行结果      │
│  ("准备下单"等)    │
└───────────────────┘
        ↓
┌───────────────────┐
│  异步尝试下单      │
│  TryAutoTradeAndUpdate()│
└───────────────────┘
        ↓
        ├───────────────────┬───────────────────┐
        ↓                   ↓                   ↓
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│  检查下单条件  │  │  执行开仓      │  │  更新预警日志  │
│  checkTradingConditions│  │  executeOpen()│  │  updateSignalLog()│
└───────────────┘  └───────────────┘  └───────────────┘
        ↓                   ↓                   ↓
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│  条件不满足    │  │  下单成功      │  │  executed=1    │
│  更新预警日志  │  │  更新预警日志  │  │  execute_result│
│  execute_result│  │  execute_result│  │  = "下单成功"  │
│  = 失败原因    │  │  = "下单成功"  │  └───────────────┘
└───────────────┘  └───────────────┘
```

---

### 2.2 详细逻辑关系

#### 步骤1：预警信号生成

**位置：** `EvaluateWindowSignal()` - `robot_engine.go:1128`

**触发条件：**
- 窗口内价格数据充足（`dataCount >= 2`）
- 距离计算满足触发条件：
  - 做多：`distanceFromMin >= threshold`
  - 做空：`distanceFromMax >= threshold`

**生成结果：**
```go
signal := &RobotSignal{
    Direction: "LONG" or "SHORT",
    Action: "OPEN_LONG" or "OPEN_SHORT",
    Strength: 100,
    Confidence: 100,
    Reason: "📈 做多信号 | 实时97000 - 低96000 = 1000 ≥ 阈值50",
    // ... 其他字段
}
```

**关键点：**
- ✅ 每1秒评估一次
- ✅ 只有 `LONG` 或 `SHORT` 信号才会触发后续流程
- ✅ `NEUTRAL` 信号不会触发后续流程

---

#### 步骤2：保存预警日志

**位置：** `saveSignalAlert()` - `robot_engine.go:1316`

**触发条件：**
- 信号不是 `NEUTRAL`（`newSignal != "neutral"`）
- 如果是新方向信号，必须保存
- 如果不是新方向信号，检查30秒内是否已有记录（避免重复）

**执行流程：**

```
1. 检查是否是新方向信号
   - 如果是新方向 → 必须保存
   - 如果不是新方向 → 检查30秒内是否已有记录

2. 检查信号条件
   - 调用 checkSignalConditions()
   - 返回执行结果（"准备下单"、"自动下单未开启"、"该方向已有持仓"等）

3. 保存预警日志到数据库
   - 保存到 hg_trading_signal_log 表
   - 包含信号信息、价格信息、执行结果等

4. 返回记录ID（logId）
   - 用于后续更新执行状态
```

**保存的数据：**
```go
{
    "robot_id":         e.Robot.Id,
    "signal_type":      signal.Direction,        // LONG/SHORT
    "signal_source":    "window_weighted",
    "signal_strength":  signal.Strength,         // 100
    "current_price":    signal.CurrentPrice,
    "window_min_price": signal.WindowMinPrice,
    "window_max_price": signal.WindowMaxPrice,
    "threshold":        signal.SignalThreshold,
    "market_state":     marketState,
    "risk_preference":  e.Robot.RiskPreference,
    "executed":         0,                       // 0=未执行
    "execute_result":   executeResult,           // "准备下单"等
    "reason":           signal.Reason,
}
```

**关键点：**
- ✅ 预警日志在信号生成时立即保存
- ✅ 保存时已经检查了信号条件，返回执行结果
- ✅ 返回 `logId` 用于后续更新

---

#### 步骤3：检查信号条件

**位置：** `checkSignalConditions()` - `robot_engine.go:1379`

**检查项：**

```
1. ✅ 自动交易开关
   - 条件：robot.AutoTradeEnabled == 1
   - 失败：返回 "自动下单未开启"

2. ✅ 信号操作类型
   - 条件：signal.Action == "OPEN_LONG" || signal.Action == "OPEN_SHORT"
   - 失败：返回 "信号类型为{Action}，不是开仓信号"

3. ✅ 本方向持仓检查
   - 条件：该方向没有持仓
   - 失败：返回 "该方向已有持仓"

4. ✅ 算力检查
   - 条件：用户算力 ≥ 1点
   - 失败：返回 "算力不足，请充值"

✅ 所有条件满足 → 返回 "准备下单"
```

**关键点：**
- ✅ 在保存预警日志时调用
- ✅ 返回执行结果，保存到 `execute_result` 字段
- ✅ 如果条件不满足，预警日志的 `execute_result` 会记录失败原因

---

#### 步骤4：异步尝试下单

**位置：** `TryAutoTradeAndUpdate()` - `robot_engine.go:2238`

**触发时机：** 信号生成后异步执行（`go func()`）

**执行流程：**

```
1. 提前过滤：只处理开仓信号
   - 如果不是 OPEN_LONG 或 OPEN_SHORT → 直接返回

2. 检查自动交易开关
   - 如果未开启 → 更新预警日志为 "自动下单未开启"

3. 检查下单条件
   - 调用 checkTradingConditions()
   - 如果条件不满足 → 更新预警日志为失败原因

4. 执行开仓
   - 调用 executeOpen()
   - 如果成功 → 更新预警日志为 "下单成功: order_12345"
   - 如果失败 → 更新预警日志为 "下单失败: {错误信息}"
```

**关键点：**
- ✅ 异步执行，不阻塞信号生成
- ✅ 使用 `logId` 更新预警日志的执行状态
- ✅ 下单成功或失败都会更新预警日志

---

#### 步骤5：检查下单条件

**位置：** `checkTradingConditions()` - `robot_engine.go:2298`

**检查项：**

```
1. ✅ 自动交易开关
   - 条件：robot.AutoTradeEnabled == 1
   - 失败：返回 false, "自动下单未开启"

2. ✅ 本方向持仓检查
   - 条件：该方向没有持仓
   - 失败：返回 false, "该方向已有持仓"

3. ✅ 算力检查
   - 条件：用户算力 ≥ 1点
   - 失败：返回 false, "算力不足，请充值"

✅ 所有条件满足 → 返回 true, ""
```

**关键点：**
- ✅ 在 `TryAutoTradeAndUpdate()` 中调用
- ✅ 如果条件不满足，会更新预警日志为失败原因
- ✅ 如果条件满足，会继续执行开仓

---

#### 步骤6：执行开仓

**位置：** `executeOpen()` - `robot_engine.go:2485`

**执行流程：**

```
1. 检查余额
   - 如果余额不足 → 返回错误

2. 获取策略参数
   - 从策略模板加载参数
   - 计算杠杆、保证金比例等

3. 计算下单数量
   - 根据余额、杠杆、价格计算数量

4. 设置杠杆
   - 调用交易所API设置杠杆

5. 下单
   - 调用交易所API创建订单

6. 记录订单
   - 保存订单到数据库

7. 更新内存持仓
   - 更新 CurrentPositions

8. 返回成功或失败
```

**关键点：**
- ✅ 如果成功，返回 `nil`
- ✅ 如果失败，返回错误信息
- ✅ 成功或失败都会更新预警日志

---

#### 步骤7：更新预警日志

**位置：** `updateSignalLog()` - `robot_engine.go:2298`

**更新字段：**
```go
{
    "executed": 1,                    // 1=已执行
    "execute_result": "下单成功: order_12345",  // 或 "下单失败: {错误}"
}
```

**更新时机：**
- ✅ 下单成功时：`execute_result = "下单成功: order_12345"`
- ✅ 下单失败时：`execute_result = "下单失败: {错误信息}"`
- ✅ 条件不满足时：`execute_result = "该方向已有持仓"` 等

**关键点：**
- ✅ 使用 `logId` 更新对应的预警日志
- ✅ 更新 `executed` 字段为 1（已执行）
- ✅ 更新 `execute_result` 字段为最终结果

---

## 三、三者之间的数据流

### 3.1 数据流向

```
预警信号（RobotSignal）
  ↓
保存预警日志（hg_trading_signal_log）
  ↓
返回 logId
  ↓
异步尝试下单（TryAutoTradeAndUpdate）
  ↓
检查下单条件（checkTradingConditions）
  ↓
执行开仓（executeOpen）
  ↓
更新预警日志（updateSignalLog）
```

---

### 3.2 数据传递

**预警信号 → 预警日志：**
- `signal.Direction` → `signal_type`
- `signal.Strength` → `signal_strength`
- `signal.CurrentPrice` → `current_price`
- `signal.WindowMinPrice` → `window_min_price`
- `signal.WindowMaxPrice` → `window_max_price`
- `signal.SignalThreshold` → `threshold`
- `signal.Reason` → `reason`
- `checkSignalConditions()` 返回结果 → `execute_result`

**预警日志 → 全自动下单：**
- `logId` → 用于更新预警日志
- `signal` → 用于检查下单条件和执行开仓

**全自动下单 → 预警日志：**
- 下单成功 → `executed = 1`, `execute_result = "下单成功: order_12345"`
- 下单失败 → `executed = 1`, `execute_result = "下单失败: {错误信息}"`
- 条件不满足 → `executed = 1`, `execute_result = "该方向已有持仓"` 等

---

## 四、关键时间点

### 4.1 时间线示例

```
T=0.0s:  信号生成 → LONG信号
T=0.0s:  保存预警日志 → logId=123, executed=0, execute_result="准备下单"
T=0.0s:  异步尝试下单 → TryAutoTradeAndUpdate(logId=123)
T=0.1s:  检查下单条件 → 通过
T=0.2s:  执行开仓 → 成功
T=0.3s:  更新预警日志 → executed=1, execute_result="下单成功: order_12345"
```

---

### 4.2 失败场景时间线

```
T=0.0s:  信号生成 → LONG信号
T=0.0s:  保存预警日志 → logId=123, executed=0, execute_result="准备下单"
T=0.0s:  异步尝试下单 → TryAutoTradeAndUpdate(logId=123)
T=0.1s:  检查下单条件 → 失败（该方向已有持仓）
T=0.1s:  更新预警日志 → executed=1, execute_result="该方向已有持仓"
```

---

## 五、三者之间的依赖关系

### 5.1 预警信号 → 预警日志

**依赖关系：** 一对一（一个信号对应一条预警日志）

**依赖条件：**
- ✅ 信号必须是 `LONG` 或 `SHORT`（不是 `NEUTRAL`）
- ✅ 如果是新方向信号，必须保存
- ✅ 如果不是新方向信号，30秒内没有相同方向的记录

**数据传递：**
- ✅ 信号的所有信息都会保存到预警日志
- ✅ 信号条件检查结果会保存到 `execute_result`

---

### 5.2 预警日志 → 全自动下单

**依赖关系：** 一对一（一条预警日志对应一次下单尝试）

**依赖条件：**
- ✅ 预警日志必须存在（`logId > 0`）
- ✅ 信号必须是 `OPEN_LONG` 或 `OPEN_SHORT`

**数据传递：**
- ✅ `logId` 用于更新预警日志
- ✅ `signal` 用于检查下单条件和执行开仓

---

### 5.3 全自动下单 → 预警日志

**依赖关系：** 更新关系（下单结果更新预警日志）

**依赖条件：**
- ✅ 预警日志必须存在（`logId > 0`）

**数据传递：**
- ✅ 下单成功 → `executed = 1`, `execute_result = "下单成功: order_12345"`
- ✅ 下单失败 → `executed = 1`, `execute_result = "下单失败: {错误信息}"`
- ✅ 条件不满足 → `executed = 1`, `execute_result = "该方向已有持仓"` 等

---

## 六、关键代码位置

### 6.1 预警信号生成

**文件：** `server/internal/logic/toogo/robot_engine.go`

**方法：**
- `EvaluateWindowSignal()` - 评估窗口信号（行1128）
- `doSignalGeneration()` - 信号生成（行1029）

**调用位置：** `robot_engine.go:1280-1308`

```go
// 有信号时立即保存预警记录
if newSignal != "neutral" {
    // 立即保存预警记录并尝试下单（同步执行确保保存）
    logId := e.saveSignalAlert(&signalCopy, isNewDirection)

    // 异步尝试下单，并更新预警记录
    go func() {
        checkCtx := context.Background()
        e.Trader.TryAutoTradeAndUpdate(checkCtx, &signalCopy, logId)
    }()
}
```

---

### 6.2 预警日志保存

**文件：** `server/internal/logic/toogo/robot_engine.go`

**方法：**
- `saveSignalAlert()` - 保存预警记录（行1316）
- `checkSignalConditions()` - 检查信号条件（行1379）

**调用位置：** `robot_engine.go:1301`

```go
logId := e.saveSignalAlert(&signalCopy, isNewDirection)
```

---

### 6.3 全自动下单

**文件：** `server/internal/logic/toogo/robot_engine.go`

**方法：**
- `TryAutoTradeAndUpdate()` - 尝试自动下单并更新预警记录（行2238）
- `checkTradingConditions()` - 检查下单条件（行2298）
- `executeOpen()` - 执行开仓（行2485）
- `updateSignalLog()` - 更新预警日志（行2298）

**调用位置：** `robot_engine.go:1305-1308`

```go
go func() {
    checkCtx := context.Background()
    e.Trader.TryAutoTradeAndUpdate(checkCtx, &signalCopy, logId)
}()
```

---

## 七、总结

### 7.1 三者之间的逻辑关系

**预警信号 → 预警日志 → 全自动下单**

1. ✅ **预警信号生成**（每1秒）
   - 评估窗口价格
   - 生成 `LONG` 或 `SHORT` 信号

2. ✅ **预警日志保存**（信号生成时）
   - 检查信号条件
   - 保存预警日志到数据库
   - 返回 `logId`

3. ✅ **全自动下单**（异步执行）
   - 检查下单条件
   - 执行开仓
   - 更新预警日志

---

### 7.2 关键特点

- ✅ **一对一关系**：一个信号对应一条预警日志，一条预警日志对应一次下单尝试
- ✅ **实时保存**：预警日志在信号生成时立即保存，不等待下单结果
- ✅ **异步执行**：下单是异步执行的，不阻塞信号生成
- ✅ **状态更新**：下单成功或失败都会更新预警日志的执行状态
- ✅ **完整记录**：预警日志记录了从信号生成到下单执行的全过程

---

### 7.3 数据流总结

```
预警信号（内存对象）
  ↓ 保存
预警日志（数据库记录）
  ↓ 传递 logId
全自动下单（异步执行）
  ↓ 更新
预警日志（更新执行状态）
```

---

### 7.4 关键字段对应关系

| 预警信号字段 | 预警日志字段 | 说明 |
|------------|------------|------|
| `Direction` | `signal_type` | 信号方向（LONG/SHORT） |
| `Strength` | `signal_strength` | 信号强度（100） |
| `CurrentPrice` | `current_price` | 当前价格 |
| `WindowMinPrice` | `window_min_price` | 窗口最低价 |
| `WindowMaxPrice` | `window_max_price` | 窗口最高价 |
| `SignalThreshold` | `threshold` | 波动阈值 |
| `Reason` | `reason` | 信号原因 |
| - | `executed` | 执行状态（0=未执行, 1=已执行） |
| - | `execute_result` | 执行结果（"准备下单"、"下单成功"等） |

