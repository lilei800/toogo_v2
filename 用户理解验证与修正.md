# 用户理解验证与修正

## 用户的理解

1. 根据全局引擎计算实时市场状态的值
2. 根据机器人创建时候选择的静态映射关系
3. 根据创建机器人时候绑定的策略组对应实时市场状态和映射关系关联的具体的策略
4. 使用策略值下单并且将值写入到此订单（持仓订单、平仓后变成历史订单）

---

## 验证结果

### ✅ 第1点：根据全局引擎计算实时市场状态的值

**用户理解**：✅ **基本正确，但需要澄清**

**实际情况**：
- **市场状态计算**：在**机器人引擎**中计算，不是全局引擎
- **计算位置**：`RobotEngine.Analyzer.AnalyzeMarketState()` 
- **计算频率**：每次市场分析时计算（通常每1-2秒）
- **数据来源**：基于K线数据和技术指标（RSI、MACD、布林带等）

**代码位置**：
- `robot_engine.go:AnalyzeMarket()` (line 500-526)
- `robot_analyzer.go:AnalyzeMarketState()` (具体计算逻辑)

**修正**：
- ❌ 不是"全局引擎计算"
- ✅ 是"**机器人引擎**根据实时K线数据和技术指标计算"

---

### ✅ 第2点：根据机器人创建时候选择的静态映射关系

**用户理解**：✅ **正确，但需要澄清"静态"的含义**

**实际情况**：
- **映射关系来源**：创建机器人时保存到 `CurrentStrategy` JSON 中
- **存储位置**：`Robot.CurrentStrategy.riskConfig.marketRiskMapping`
- **是否静态**：
  - ✅ **创建时保存**：映射关系在创建时确定并保存
  - ✅ **可以修改**：用户在机器人页面修改映射关系后，会实时更新 `CurrentStrategy`
  - ✅ **实时生效**：修改后的映射关系会立即生效（通过 `UpdateRobot` 更新）

**代码位置**：
- `robot_engine.go:loadRiskConfigFromRobot()` (line 247-289)
- 加载逻辑：从 `CurrentStrategy` JSON 中读取 `marketRiskMapping`

**映射关系格式**：
```json
{
  "riskConfig": {
    "marketRiskMapping": {
      "low_vol": "conservative",
      "high_vol": "aggressive",
      "trend": "balanced",
      "volatile": "balanced"
    }
  }
}
```

**修正**：
- ✅ 映射关系在**创建时保存**
- ✅ 映射关系**可以修改**（用户修改后实时生效）
- ✅ 映射关系**不是完全静态**的，而是"创建时确定，可修改"

---

### ✅ 第3点：根据创建机器人时候绑定的策略组对应实时市场状态和映射关系关联的具体的策略

**用户理解**：✅ **完全正确**

**实际情况**：
- **策略组ID**：`Robot.StrategyGroupId`（创建时绑定）
- **查询条件**：
  1. `group_id` = 策略组ID
  2. `market_state` = 实时市场状态（规范化后）
  3. `risk_preference` = 从映射关系获取的风险偏好
- **查询表**：`hg_trading_strategy_template`
- **查询SQL**：
  ```sql
  SELECT * FROM hg_trading_strategy_template 
  WHERE group_id = ? 
    AND market_state = ? 
    AND risk_preference = ?
  ```

**代码位置**：
- `robot_engine.go:loadFullStrategyParams()` (line 747-862)
- `robot_engine.go:executeOpen()` (line 3314)

**流程**：
1. 实时市场状态 → `"low_vol"`
2. 映射关系查询 → `MarketRiskMapping["low_vol"]` → `"conservative"`
3. 策略模板查询 → `group_id=24 AND market_state='low_vol' AND risk_preference='conservative'`
4. 返回策略参数

**修正**：
- ✅ 完全正确，无需修正

---

### ✅ 第4点：使用策略值下单并且将值写入到此订单（持仓订单、平仓后变成历史订单）

**用户理解**：✅ **完全正确**

**实际情况**：
- **下单时使用**：
  - 杠杆：`strategyParams.Leverage`（或范围中值）
  - 保证金比例：`strategyParams.MarginPercent`（或范围中值）
  - 订单数量：`quantity = margin * leverage / price`
- **保存到订单记录**：
  - `stop_loss_percent`：止损百分比
  - `auto_start_retreat_percent`：启动止盈百分比
  - `profit_retreat_percent`：止盈回撤百分比
  - `market_state`：下单时的市场状态
  - `risk_level`：下单时的风险偏好
- **订单状态**：
  - `status = 1`：持仓中（使用订单中的策略参数进行平仓判断）
  - `status = 2`：已平仓（历史订单，策略参数保留用于记录）

**代码位置**：
- `robot_engine.go:executeOpen()` (line 3363-3411) - 使用策略参数
- `robot_engine.go:recordOrder()` (line 4014-4024) - 保存策略参数

**修正**：
- ✅ 完全正确，无需修正

---

## 总结

### ✅ 正确的理解

1. ✅ **第3点**：完全正确
   - 根据创建时绑定的策略组 + 实时市场状态 + 映射关系 → 查询策略模板

2. ✅ **第4点**：完全正确
   - 使用策略值下单并保存到订单记录

### ⚠️ 需要澄清的理解

1. ⚠️ **第1点**：需要修正
   - ❌ 不是"全局引擎计算"
   - ✅ 是"**机器人引擎**根据实时K线数据和技术指标计算市场状态"

2. ⚠️ **第2点**：需要澄清"静态"的含义
   - ✅ 映射关系在**创建时保存**
   - ✅ 映射关系**可以修改**（用户修改后实时生效）
   - ⚠️ 不是完全"静态"的，而是"创建时确定，可修改"

---

## 修正后的完整流程

```
┌─────────────────────────────────────────────────────────────┐
│                   全自动下单完整流程（修正版）                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤1: 机器人引擎计算实时市场状态  │
        │  - 基于K线数据和技术指标           │
        │  - AnalyzeMarketState()          │
        │  - 结果: "low_vol" / "high_vol"  │
        │    / "trend" / "volatile"        │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤2: 从映射关系获取风险偏好      │
        │  - CurrentStrategy.marketRiskMapping│
        │  - 创建时保存，可修改（实时生效）   │
        │  - MarketRiskMapping["low_vol"]   │
        │  - 结果: "conservative" / "balanced"│
        │    / "aggressive"                  │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤3: 查询策略模板                │
        │  - group_id = StrategyGroupId      │
        │  - market_state = 实时市场状态      │
        │  - risk_preference = 映射的风险偏好│
        │  - 结果: 策略参数（杠杆、保证金等）│
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤4: 使用策略参数下单            │
        │  - leverage = 策略模板中的杠杆     │
        │  - margin_percent = 策略模板中的保证金比例│
        │  - quantity = margin*leverage/price│
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤5: 保存策略参数到订单记录      │
        │  - stop_loss_percent              │
        │  - auto_start_retreat_percent     │
        │  - profit_retreat_percent         │
        │  - market_state                   │
        │  - risk_level                     │
        │  - 订单状态: status=1 (持仓中)    │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤6: 后续平仓判断                │
        │  - 从订单记录读取策略参数          │
        │  - 使用订单创建时的参数            │
        │  - 确保策略一致性                 │
        └───────────────────────────────────┘
```

---

## 关键修正点

### 1. 市场状态计算位置

**用户理解**：全局引擎计算
**实际情况**：**机器人引擎**计算（每个机器人独立计算）

**原因**：
- 每个机器人可能有不同的K线数据源
- 每个机器人可能有不同的分析配置
- 市场状态计算是机器人引擎的核心功能之一

### 2. 映射关系的"静态"性

**用户理解**：静态映射关系
**实际情况**：**创建时保存，可修改（实时生效）**

**说明**：
- ✅ 映射关系在创建时确定并保存
- ✅ 用户可以修改映射关系（在机器人页面）
- ✅ 修改后立即生效（通过 `UpdateRobot` 更新 `CurrentStrategy`）
- ⚠️ 不是完全"静态"的，而是"创建时确定，可修改"

---

## 最终确认

### ✅ 正确的理解（3/4）

1. ✅ **第3点**：完全正确
2. ✅ **第4点**：完全正确

### ⚠️ 需要修正的理解（2/4）

1. ⚠️ **第1点**：市场状态在**机器人引擎**中计算，不是全局引擎
2. ⚠️ **第2点**：映射关系是"创建时保存，可修改（实时生效）"，不是完全静态

### 📝 修正后的完整流程

1. **机器人引擎**根据实时K线数据和技术指标计算市场状态
2. 根据**创建时保存的映射关系**（可修改，实时生效）获取风险偏好
3. 根据创建时绑定的策略组 + 实时市场状态 + 映射关系 → 查询策略模板
4. 使用策略值下单并保存到订单记录（持仓订单，平仓后变成历史订单）

