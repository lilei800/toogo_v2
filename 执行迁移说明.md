# 数据库迁移执行说明

## SQL文件位置
`server/storage/data/create_volatility_config.sql`

## 执行方式

### 方式1：MySQL命令行执行（推荐）

```bash
# 在项目根目录执行
mysql -u用户名 -p数据库名 < server\storage\data\create_volatility_config.sql

# 示例（请替换为实际值）
mysql -uroot -p123456 hotgo_v2 < server\storage\data\create_volatility_config.sql
```

### 方式2：MySQL客户端执行

1. 打开MySQL客户端（命令行或工具）
2. 连接到数据库：`use 数据库名;`
3. 执行SQL文件：
   ```sql
   source server/storage/data/create_volatility_config.sql;
   ```

### 方式3：数据库管理工具（Navicat/phpMyAdmin/DBeaver）

1. 打开数据库管理工具
2. 连接到数据库
3. 选择目标数据库
4. 打开SQL文件：`server/storage/data/create_volatility_config.sql`
5. 执行SQL

### 方式4：直接复制SQL内容执行

复制以下SQL内容，在MySQL客户端中执行：

```sql
-- 创建波动率配置表
CREATE TABLE IF NOT EXISTS `hg_toogo_volatility_config` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `symbol` varchar(50) DEFAULT NULL COMMENT '交易对（NULL表示全局配置，如：BTCUSDT表示BTCUSDT特定配置）',
  `high_volatility_threshold` decimal(10,4) DEFAULT 2.0000 COMMENT '高波动阈值',
  `low_volatility_threshold` decimal(10,4) DEFAULT 0.5000 COMMENT '低波动阈值',
  `default_volatility_threshold` decimal(10,4) DEFAULT 1.0000 COMMENT '默认波动阈值',
  `is_active` tinyint(1) DEFAULT 1 COMMENT '是否启用: 0=否, 1=是',
  `created_at` datetime DEFAULT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_symbol` (`symbol`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='量化管理波动率配置表（支持每个货币对独立配置）';

-- 插入默认全局配置
INSERT INTO `hg_toogo_volatility_config` 
(`symbol`, `high_volatility_threshold`, `low_volatility_threshold`, `default_volatility_threshold`, `is_active`, `created_at`, `updated_at`) 
SELECT NULL, 2.0000, 0.5000, 1.0000, 1, NOW(), NOW()
WHERE NOT EXISTS (
    SELECT 1 FROM `hg_toogo_volatility_config` WHERE `symbol` IS NULL
);
```

## 验证迁移成功

执行以下SQL验证：

```sql
-- 1. 检查表是否存在
SHOW TABLES LIKE 'hg_toogo_volatility_config';

-- 2. 查看表结构
DESC hg_toogo_volatility_config;

-- 3. 查看默认数据
SELECT * FROM hg_toogo_volatility_config;

-- 4. 验证字段
SELECT 
    COLUMN_NAME,
    COLUMN_TYPE,
    IS_NULLABLE,
    COLUMN_DEFAULT,
    COLUMN_COMMENT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = DATABASE()
  AND TABLE_NAME = 'hg_toogo_volatility_config'
ORDER BY ORDINAL_POSITION;
```

**预期结果**：
- ✅ 表 `hg_toogo_volatility_config` 存在
- ✅ 表有8个字段
- ✅ 至少有1条全局配置记录（symbol为NULL）

## 注意事项

1. **备份数据库**：执行迁移前建议备份数据库
2. **权限检查**：确保数据库用户有CREATE TABLE和INSERT权限
3. **字符集**：表使用utf8mb4字符集，确保数据库支持
4. **唯一索引**：`symbol`字段有唯一索引，不能重复

## 常见错误

### 错误1：Table already exists
**原因**：表已存在
**解决**：这是正常的，`IF NOT EXISTS` 会跳过创建

### 错误2：Duplicate entry for key 'uk_symbol'
**原因**：全局配置已存在
**解决**：使用 `WHERE NOT EXISTS` 的INSERT语句，不会重复插入

### 错误3：Access denied
**原因**：数据库用户权限不足
**解决**：使用有CREATE TABLE权限的用户

---

**执行完成后，请重启后端服务以使配置生效！**

