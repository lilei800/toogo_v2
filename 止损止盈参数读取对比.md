# 止损和止盈参数读取逻辑对比

## 一、创建订单时保存

### 1.1 止损参数保存（robot_engine.go:3933-3935）
```go
if strategyParams.StopLossPercent > 0 {
    orderData["stop_loss_percent"] = strategyParams.StopLossPercent
}
```

### 1.2 启动止盈参数保存（robot_engine.go:3936-3938）
```go
if strategyParams.AutoStartRetreatPercent > 0 {
    orderData["auto_start_retreat_percent"] = strategyParams.AutoStartRetreatPercent
}
```

### 1.3 止盈回撤参数保存（robot_engine.go:3939-3941）
```go
if strategyParams.ProfitRetreatPercent > 0 {
    orderData["profit_retreat_percent"] = strategyParams.ProfitRetreatPercent
}
```

**结论**: ✅ **完全一致** - 三个参数都在创建订单时保存到订单表

## 二、后端判断时读取

### 2.1 止损参数读取（robot_engine.go:3560-3570）
```go
orderData, err := dao.TradingOrder.Ctx(ctx).
    Fields("stop_loss_percent", "auto_start_retreat_percent", "profit_retreat_percent").
    WherePri(order.Id).
    One()

if val := orderData["stop_loss_percent"]; val != nil {
    if v := val.Float64(); v > 0 {
        stopLossPercent = v
    }
}
```

### 2.2 启动止盈参数读取（robot_engine.go:3572-3576）
```go
if val := orderData["auto_start_retreat_percent"]; val != nil {
    if v := val.Float64(); v > 0 {
        autoStartRetreatPercent = v
    }
}
```

### 2.3 止盈回撤参数读取（robot_engine.go:3577-3581）
```go
if val := orderData["profit_retreat_percent"]; val != nil {
    if v := val.Float64(); v > 0 {
        profitRetreatPercent = v
    }
}
```

**结论**: ✅ **完全一致** - 三个参数都从订单表读取，使用相同的查询和提取逻辑

## 三、后端返回持仓数据时

### 3.1 查询订单参数（robot.go:276-310）
```go
orderData, err := dao.TradingOrder.Ctx(ctx).
    Fields("stop_loss_percent", "auto_start_retreat_percent", "profit_retreat_percent", "margin_percent", "profit_retreat_started", "highest_profit").
    Where("robot_id", robotId).
    Where("symbol", pos.Symbol).
    Where("direction", ...).
    Where("status", 1).
    One()

// 提取止损参数
if val := orderData["stop_loss_percent"]; val != nil {
    if v := val.Float64(); v > 0 {
        stopLossPercent = &v
    }
}

// 提取启动止盈参数
if val := orderData["auto_start_retreat_percent"]; val != nil {
    if v := val.Float64(); v > 0 {
        autoStartRetreatPercent = &v
    }
}

// 提取止盈回撤参数
if val := orderData["profit_retreat_percent"]; val != nil {
    if v := val.Float64(); v > 0 {
        profitRetreatPercent = &v
    }
}
```

### 3.2 返回给前端（robot.go:400-402）
```go
result = append(result, &toogoin.PositionModel{
    // ...
    StopLossPercent:         stopLossPercent,
    AutoStartRetreatPercent: autoStartRetreatPercent,
    ProfitRetreatPercent:    profitRetreatPercent,
    // ...
})
```

**结论**: ✅ **完全一致** - 三个参数都从订单表读取并返回给前端

## 四、前端显示时

### 4.1 止损参数读取（index.vue:1804）
```javascript
const stopLossPercent = getOrderStrategyParam(pos, 'stopLossPercent', robot.id, getRobotStopLossPercent);
```

### 4.2 启动止盈参数读取（index.vue:1900）
```javascript
const autoStartPercent = getOrderStrategyParam(pos, 'autoStartRetreatPercent', robot.id, getRobotAutoStartRetreat);
```

### 4.3 止盈回撤参数读取（index.vue:1868）
```javascript
const profitRetreatPercent = getOrderStrategyParam(pos, 'profitRetreatPercent', robot.id, getRobotProfitRetreat);
```

**结论**: ✅ **完全一致** - 三个参数都使用 `getOrderStrategyParam()` 函数，优先从订单中读取

## 五、兜底机制

### 5.1 后端兜底（robot_engine.go:3589-3597）
```go
if stopLossPercent <= 0 {
    stopLossPercent = 10 // 默认止损10%
}
if autoStartRetreatPercent <= 0 {
    autoStartRetreatPercent = 5 // 默认启动止盈5%
}
if profitRetreatPercent <= 0 {
    profitRetreatPercent = 30 // 默认止盈回撤30%
}
```

### 5.2 前端兜底（index.vue:1773-1793）
```javascript
// 如果订单中没有参数，返回 null（不使用数据库静态值）
return null;
```

**结论**: ⚠️ **略有不同**
- **后端**: 如果订单中没有参数，使用默认值（10%, 5%, 30%）
- **前端**: 如果订单中没有参数，返回 `null`，不显示进度

## 六、对比总结

| 对比项 | 止损 | 启动止盈 | 止盈回撤 | 一致性 |
|--------|------|---------|---------|--------|
| **创建订单时保存** | ✅ | ✅ | ✅ | ✅ 完全一致 |
| **后端判断时读取** | ✅ | ✅ | ✅ | ✅ 完全一致 |
| **后端返回持仓数据** | ✅ | ✅ | ✅ | ✅ 完全一致 |
| **前端显示时读取** | ✅ | ✅ | ✅ | ✅ 完全一致 |
| **兜底机制** | 默认10% | 默认5% | 默认30% | ⚠️ 后端有默认值，前端返回null |

## 七、结论

**是的，止损的值调取逻辑和止盈的完全一致！**

### 7.1 完全一致的方面

1. ✅ **创建订单时保存**: 三个参数都保存到订单表
2. ✅ **后端判断时读取**: 都从订单表读取，使用相同的查询逻辑
3. ✅ **后端返回持仓数据**: 都从订单表读取并返回给前端
4. ✅ **前端显示时读取**: 都使用 `getOrderStrategyParam()` 函数，优先从订单中读取

### 7.2 略有不同的方面

- **兜底机制**: 
  - 后端：如果订单中没有参数，使用默认值（确保判断逻辑能正常运行）
  - 前端：如果订单中没有参数，返回 `null`（不显示进度，避免误导）

### 7.3 设计优势

1. **参数一致性**: 每个订单使用创建时的策略参数，不受后续策略变更影响
2. **逻辑统一性**: 止损、启动止盈、止盈回撤使用相同的读取逻辑
3. **状态持久化**: 参数保存在订单表中，重启后仍可使用

**总结**: 止损和止盈的参数读取逻辑完全一致，都优先使用订单创建时保存的值。

