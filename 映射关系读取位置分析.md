# "ä½æ³¢åŠ¨--å¹³è¡¡"æ˜ å°„å…³ç³»è¯»å–ä½ç½®åˆ†æ

## ä¸€ã€æ•°æ®å­˜å‚¨ä½ç½®

### 1.1 æ•°æ®åº“å­˜å‚¨

**è¡¨å**ï¼š`hg_trading_robot`
**å­—æ®µ**ï¼š`current_strategy` (JSONæ ¼å¼)

**å­˜å‚¨ç»“æ„**ï¼š
```json
{
  "riskConfig": {
    "marketRiskMapping": {
      "trend": "balanced",
      "volatile": "balanced",
      "high_vol": "aggressive",
      "low_vol": "conservative"  // ä½æ³¢åŠ¨--ä¿å®ˆ
    }
  },
  "strategyGroupId": 1
}
```

---

## äºŒã€åç«¯è¯»å–ä½ç½®

### 2.1 æœºå™¨äººå¼•æ“è¯»å–ï¼ˆ`robot_engine.go`ï¼‰

**å‡½æ•°**ï¼š`loadRiskConfigFromRobot`

**è¯»å–è·¯å¾„**ï¼š
```go
// 1. ä» Robot.CurrentStrategy å­—æ®µè¯»å–JSONå­—ç¬¦ä¸²
e.Robot.CurrentStrategy

// 2. è§£æJSON
configData["riskConfig"].(map[string]interface{})

// 3. è·å–æ˜ å°„å…³ç³»
riskConfig["marketRiskMapping"].(map[string]interface{})

// 4. å­˜å‚¨åˆ°å¼•æ“å†…å­˜
e.MarketRiskMapping["low_vol"] = "conservative"
```

**ä»£ç ä½ç½®**ï¼š`robot_engine.go:250-289`

---

### 2.2 ç­–ç•¥å‚æ•°åŠ è½½æ—¶ä½¿ç”¨ï¼ˆ`robot_engine.go`ï¼‰

**å‡½æ•°**ï¼š`checkAndUpdateStrategyConfig`

**ä½¿ç”¨æ–¹å¼**ï¼š
```go
// ä»æ˜ å°„å…³ç³»ä¸­è·å–é£é™©åå¥½
riskPreference := e.MarketRiskMapping[currentMarketState]
// ä¾‹å¦‚ï¼šMarketRiskMapping["low_vol"] â†’ "conservative"
```

**ä»£ç ä½ç½®**ï¼š`robot_engine.go:549-550`

---

### 2.3 APIè¿”å›ç»™å‰ç«¯ï¼ˆ`robot.go`ï¼‰

**å‡½æ•°**ï¼š`RobotList`

**è¿”å›æ•°æ®**ï¼š
```go
result[i] = &toogoin.RobotListModel{
    TradingRobot:  robot,  // åŒ…å« CurrentStrategy å­—æ®µ
    // ...
}
```

**ä»£ç ä½ç½®**ï¼š`robot.go:190`

---

## ä¸‰ã€å‰ç«¯è¯»å–ä½ç½®

### 3.1 è§£ææ˜ å°„å…³ç³»ï¼ˆ`index.vue`ï¼‰

**å‡½æ•°**ï¼š`getMarketRiskMapping`

**è¯»å–è·¯å¾„**ï¼š
```javascript
// 1. ä» robot.currentStrategy è¯»å–ï¼ˆåç«¯è¿”å›çš„å­—æ®µåï¼‰
robot.currentStrategy

// 2. è§£æJSONï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–å¯¹è±¡ï¼‰
const strategy = typeof robot.currentStrategy === 'string' 
  ? JSON.parse(robot.currentStrategy) 
  : robot.currentStrategy;

// 3. è·å–æ˜ å°„å…³ç³»
return strategy?.marketRiskMapping || null;
```

**ä»£ç ä½ç½®**ï¼š`index.vue:1500-1510`

---

### 3.2 æ˜¾ç¤ºæ˜ å°„å…³ç³»ï¼ˆ`index.vue`ï¼‰

**æ¨¡æ¿ä½ç½®**ï¼š
```vue
<div v-if="getMarketRiskMapping(currentRobot)">
  <n-tag v-for="(risk, market) in getMarketRiskMapping(currentRobot)">
    {{ formatMarketState(market) }} â†’ {{ formatRiskPref(risk) }}
  </n-tag>
</div>
```

**æ ¼å¼åŒ–å‡½æ•°**ï¼š
- `formatMarketState("low_vol")` â†’ "ä½æ³¢åŠ¨"
- `formatRiskPref("conservative")` â†’ "ğŸ›¡ï¸ ä¿å®ˆ"

**ä»£ç ä½ç½®**ï¼š
- æ¨¡æ¿ï¼š`index.vue:858-865`
- æ ¼å¼åŒ–ï¼š`index.vue:1655-1682`

---

## å››ã€é—®é¢˜å‘ç° âš ï¸

### 4.1 è·¯å¾„ä¸ä¸€è‡´

**åç«¯å­˜å‚¨è·¯å¾„**ï¼š
```
CurrentStrategy.riskConfig.marketRiskMapping
```

**å‰ç«¯è¯»å–è·¯å¾„**ï¼š
```
currentStrategy.marketRiskMapping  âŒ é”™è¯¯ï¼
```

**æ­£ç¡®çš„å‰ç«¯è¯»å–è·¯å¾„åº”è¯¥æ˜¯**ï¼š
```
currentStrategy.riskConfig.marketRiskMapping  âœ…
```

---

### 4.2 å½±å“

- å‰ç«¯æ— æ³•æ­£ç¡®è¯»å–æ˜ å°„å…³ç³»
- æ˜¾ç¤º"ä½æ³¢åŠ¨--å¹³è¡¡"å¯èƒ½æ˜¯é»˜è®¤å€¼ï¼Œè€Œä¸æ˜¯å®é™…é…ç½®
- éœ€è¦ä¿®å¤å‰ç«¯ä»£ç 

---

## äº”ã€ä¿®å¤æ–¹æ¡ˆ

### 5.1 ä¿®å¤å‰ç«¯ä»£ç 

**ä¿®æ”¹ `getMarketRiskMapping` å‡½æ•°**ï¼š

```javascript
// ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰
const getMarketRiskMapping = (robot: any): Record<string, string> | null => {
  if (!robot.currentStrategy) return null;
  try {
    const strategy = typeof robot.currentStrategy === 'string' 
      ? JSON.parse(robot.currentStrategy) 
      : robot.currentStrategy;
    return strategy?.marketRiskMapping || null;  // âŒ é”™è¯¯è·¯å¾„
  } catch (e) {
    return null;
  }
};

// ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
const getMarketRiskMapping = (robot: any): Record<string, string> | null => {
  if (!robot.currentStrategy) return null;
  try {
    const strategy = typeof robot.currentStrategy === 'string' 
      ? JSON.parse(robot.currentStrategy) 
      : robot.currentStrategy;
    // âœ… æ­£ç¡®è·¯å¾„ï¼šriskConfig.marketRiskMapping
    return strategy?.riskConfig?.marketRiskMapping || null;
  } catch (e) {
    return null;
  }
};
```

---

## å…­ã€å®Œæ•´æ•°æ®æµ

```
1. æ•°æ®åº“å­˜å‚¨
   â””â”€> hg_trading_robot.current_strategy (JSON)
       â””â”€> {"riskConfig": {"marketRiskMapping": {"low_vol": "conservative"}}}

2. åç«¯è¯»å–ï¼ˆrobot_engine.goï¼‰
   â””â”€> loadRiskConfigFromRobot()
       â””â”€> è§£æ CurrentStrategy JSON
           â””â”€> æå– riskConfig.marketRiskMapping
               â””â”€> å­˜å‚¨åˆ° e.MarketRiskMapping["low_vol"] = "conservative"

3. åç«¯ä½¿ç”¨ï¼ˆrobot_engine.goï¼‰
   â””â”€> checkAndUpdateStrategyConfig()
       â””â”€> e.MarketRiskMapping["low_vol"] â†’ "conservative"
           â””â”€> åŠ è½½ç­–ç•¥å‚æ•°

4. APIè¿”å›ï¼ˆrobot.goï¼‰
   â””â”€> RobotList()
       â””â”€> è¿”å› TradingRobotï¼ˆåŒ…å« CurrentStrategy å­—æ®µï¼‰

5. å‰ç«¯è¯»å–ï¼ˆindex.vueï¼‰
   â””â”€> getMarketRiskMapping(robot)
       â””â”€> è§£æ robot.currentStrategy
           â””â”€> æå– riskConfig.marketRiskMapping  âš ï¸ å½“å‰ä»£ç é”™è¯¯
               â””â”€> è¿”å›æ˜ å°„å…³ç³»

6. å‰ç«¯æ˜¾ç¤ºï¼ˆindex.vueï¼‰
   â””â”€> formatMarketState("low_vol") â†’ "ä½æ³¢åŠ¨"
   â””â”€> formatRiskPref("conservative") â†’ "ğŸ›¡ï¸ ä¿å®ˆ"
   â””â”€> æ˜¾ç¤ºï¼š"ä½æ³¢åŠ¨ â†’ ğŸ›¡ï¸ ä¿å®ˆ"
```

---

## ä¸ƒã€æ€»ç»“

### 7.1 è¯»å–ä½ç½®

1. **æ•°æ®åº“**ï¼š`hg_trading_robot.current_strategy` å­—æ®µ
2. **åç«¯å¼•æ“**ï¼š`robot_engine.go:loadRiskConfigFromRobot()` â†’ `e.MarketRiskMapping`
3. **åç«¯ä½¿ç”¨**ï¼š`robot_engine.go:checkAndUpdateStrategyConfig()` â†’ `e.MarketRiskMapping[currentMarketState]`
4. **APIè¿”å›**ï¼š`robot.go:RobotList()` â†’ `TradingRobot.CurrentStrategy`
5. **å‰ç«¯è¯»å–**ï¼š`index.vue:getMarketRiskMapping()` â†’ `strategy.riskConfig.marketRiskMapping` âš ï¸ éœ€è¦ä¿®å¤

### 7.2 é—®é¢˜

å‰ç«¯ä»£ç è¯»å–è·¯å¾„é”™è¯¯ï¼Œåº”è¯¥è¯»å– `riskConfig.marketRiskMapping` è€Œä¸æ˜¯ `marketRiskMapping`ã€‚

