# 开仓检查完整流程

## 一、检查入口

开仓检查有两个主要入口：

1. **`checkTradingConditions()`** - 下单条件检查（返回 bool 和原因字符串）
2. **`CheckAndOpenPositionWithSignal()`** - 信号驱动开仓检查（直接执行或返回）

---

## 二、完整检查流程

### 2.1 checkTradingConditions() 方法

**位置：** `robot_engine.go:2968+`

**当前检查顺序：**

```
1) 自动交易开关：robot.AutoTradeEnabled == 1
   失败原因："自动下单未开启"

2) 本方向持仓检查：查询订单表 status=1 是否已有同方向单
   失败原因："多头方向已有持仓" / "空头方向已有持仓"

3) 算力检查：用户算力（Power + GiftPower）≥ 1点
   失败原因："算力不足，请充值"

✅ 通过后返回 true, ""
```

**已移除/调整**：
- 信号类型校验在 `TryAutoTradeAndUpdate` 入口完成，不在此方法检查
- 余额检查已移除（余额校验在 `executeOpen` 内部）
- 持仓检查改为直接查数据库订单（依赖订单同步服务保证实时性）

---

### 2.2 CheckAndOpenPositionWithSignal() 方法（兼容接口）

**位置：** `robot_engine.go:3008+`

**现状**：仍保留兼容，但主流程已由 `TryAutoTradeAndUpdate` 驱动。其检查逻辑与 `checkTradingConditions` 类似：
- 校验信号非空且为开仓动作
- 检查自动交易开关
- 检查本方向持仓（查订单表）
- 检查算力
- 余额检查已移除

**注意**：主循环不再调用定时开仓，此方法主要用于兼容入口/测试。

---

## 三、详细检查项说明

### 3.1 ✅ 自动交易开关

**检查代码：**
```go
if robot.AutoTradeEnabled != 1 {
    return false, "自动下单未开启"
}
```

**字段：** `Robot.AutoTradeEnabled`

**值：**
- `1` = 开启自动交易
- `0` = 关闭自动交易

**作用：** 控制是否允许自动下单

---

### 3.2 ✅ 信号类型

**检查代码：**
```go
if signal.Action != "OPEN_LONG" && signal.Action != "OPEN_SHORT" {
    return false, fmt.Sprintf("信号类型为%s，不是开仓信号", signal.Action)
}
```

**字段：** `Signal.Action`

**有效值：**
- `OPEN_LONG` = 开多仓
- `OPEN_SHORT` = 开空仓

**其他值（会被拒绝）：**
- `CLOSE_LONG` = 平多仓（不是开仓信号）
- `CLOSE_SHORT` = 平空仓（不是开仓信号）
- `NEUTRAL` = 中性信号（不是开仓信号）

---

### 3.3 ✅ 本方向持仓检查

**检查代码：**
```go
positionSide := "LONG"
if signal.Direction == "SHORT" {
    positionSide = "SHORT"
}

hasCurrentPosition := t.engine.HasActivePosition(positionSide)

if hasCurrentPosition {
    return false, "该方向已有持仓"
}
```

**检查方法：** `HasActivePosition(positionSide)`

**逻辑：**
```go
func (e *RobotEngine) HasActivePosition(positionSide string) bool {
    for _, pos := range e.CurrentPositions {
        if pos.PositionSide == positionSide && pos.PositionAmt != 0 {
            return true
        }
    }
    return false
}
```

**规则：**
- ✅ 每方向最多1单
- ✅ 如果该方向已有持仓，不允许再开同方向单

**同步机制：**
- ✅ 开仓前强制同步持仓（`syncAccountDataIfNeeded(ctx, "before_open")`）
- ✅ 确保持仓状态最新，避免误判

---

### 3.4 ✅ 算力检查

**检查代码：**
```go
if !t.checkPower(ctx) {
    return false, "算力不足，请充值"
}
```

**checkPower 方法：**
```go
func (t *RobotTrader) checkPower(ctx context.Context) bool {
    robot := t.engine.Robot
    
    // 查询用户算力
    var wallet struct {
        Power     float64 `json:"power"`
        GiftPower float64 `json:"giftPower"`
    }
    err := g.DB().Model("hg_toogo_wallet").Ctx(ctx).
        Where("user_id", robot.UserId).
        Scan(&wallet)
    
    if err != nil {
        return false
    }
    
    totalPower := wallet.Power + wallet.GiftPower
    
    // 至少需要1点算力
    return totalPower >= 1
}
```

**查询表：** `hg_toogo_wallet`

**字段：**
- `power` = 用户算力
- `giftPower` = 赠送算力

**条件：**
- ✅ `power + giftPower ≥ 1`

**失败处理：**
- ❌ 返回错误："算力不足，请充值"

---

### 3.5 ✅ 余额检查

**检查代码：**
```go
balance := t.engine.AccountBalance
if balance == nil || balance.AvailableBalance <= 0 {
    return false, "保证金余额不足"
}
```

**数据来源：** `RobotEngine.AccountBalance`

**字段：**
- `AvailableBalance` = 可用余额

**条件：**
- ✅ `balance != nil`
- ✅ `AvailableBalance > 0`

**失败处理：**
- ❌ 返回错误："保证金余额不足"

---

## 四、检查顺序总结

**按优先级顺序检查：**

1. **自动交易开关**（最高优先级）
   - 如果未开启，直接返回，不检查其他条件

2. **信号类型**
   - 如果不是开仓信号，直接返回

3. **本方向持仓检查**
   - 如果该方向已有持仓，直接返回
   - 开仓前强制同步持仓，确保状态最新

4. **算力检查**
   - 检查用户算力是否充足

5. **余额检查**
   - 检查账户余额是否充足

**如果任何条件不满足，立即返回失败原因，不继续检查后续条件。**

---

## 五、检查流程图

```
开仓检查开始
  ↓
1. 检查自动交易开关
   ❌ AutoTradeEnabled != 1 → 返回 "自动下单未开启"
   ✅ 继续
  ↓
2. 检查信号类型
   ❌ Action != OPEN_LONG && Action != OPEN_SHORT → 返回 "信号类型为{Action}，不是开仓信号"
   ✅ 继续
  ↓
3. 持仓状态同步（开仓前强制同步）
   syncAccountDataIfNeeded(ctx, "before_open")
  ↓
4. 检查本方向持仓
   ❌ hasCurrentPosition → 返回 "该方向已有持仓"
   ✅ 继续
  ↓
5. 检查算力
   ❌ totalPower < 1 → 返回 "算力不足，请充值"
   ✅ 继续
  ↓
6. 检查余额
   ❌ balance == nil || AvailableBalance <= 0 → 返回 "保证金余额不足"
   ✅ 继续
  ↓
✅ 返回 true, ""（可以下单）
```

---

## 六、关键代码位置

### 6.1 核心方法

1. **checkTradingConditions()** - 下单条件检查
   - 位置：`robot_engine.go:2295`
   - 返回：`(bool, string)` - 是否可以下单及原因

2. **CheckAndOpenPositionWithSignal()** - 信号驱动开仓检查
   - 位置：`robot_engine.go:2345`
   - 作用：检查条件并执行开仓

3. **checkPower()** - 算力检查
   - 位置：`robot_engine.go:2574`
   - 作用：检查用户算力是否充足

4. **HasActivePosition()** - 持仓检查
   - 位置：`robot_engine.go`（RobotEngine 方法）
   - 作用：检查指定方向是否已有持仓

---

## 七、总结

### 7.1 检查项列表

1. ✅ **自动交易开关**：`AutoTradeEnabled == 1`
2. ✅ **信号类型**：`Action == OPEN_LONG || Action == OPEN_SHORT`
3. ✅ **本方向持仓**：该方向没有持仓
4. ✅ **算力**：`totalPower >= 1`
5. ✅ **余额**：`AvailableBalance > 0`

### 7.2 关键特点

- ✅ **按优先级顺序检查**：如果任何条件不满足，立即返回失败原因
- ✅ **开仓前强制同步**：确保持仓状态最新
- ✅ **每方向最多1单**：避免重复开仓
- ✅ **算力和余额验证**：确保有足够资源下单

### 7.3 检查顺序

**按优先级顺序检查：**
1. 自动交易开关（最高优先级）
2. 信号类型
3. 持仓状态同步
4. 本方向持仓检查
5. 算力检查
6. 余额检查

**如果任何条件不满足，立即返回失败原因，不继续检查后续条件。**

