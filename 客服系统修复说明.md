# 客服系统修复说明

## 问题描述
前端页面右上角客服图标点击后显示不出来页面，报错 404。

## 问题原因
1. **路由配置问题**：原来的客服路由没有包含 Layout 布局组件
2. **后端接口未初始化**：数据库表可能未创建，导致接口 404

## 已修复内容

### 1. 前端路由修复
**文件：`web/src/router/index.ts`**
- 重构了 `SupportChatClientRoute`，添加 Layout 布局
- 现在客服页面会显示完整的导航栏和侧边栏

**文件：`web/src/layout/components/Header/RightItem.vue`**
**文件：`web/src/layout/components/Header/SystemMessage.vue`**
**文件：`web/src/layout/components/Header/index.vue`**
- 简化了跳转逻辑，使用 `router.push({ name: 'SupportChatClient' })`

### 2. 前端 UI 优化
**文件：`web/src/views/supportChat/client.vue`**

#### 新增功能：
- ✅ 友好的错误提示界面
- ✅ 自动滚动到最新消息
- ✅ 消息发送状态提示
- ✅ 客服接线状态实时提醒
- ✅ 优化的聊天气泡样式
- ✅ 空状态提示
- ✅ 快捷键支持（Ctrl+Enter 发送）
- ✅ 加载动画优化

#### UI 改进：
- 更现代化的卡片设计
- 渐变色消息气泡
- 消息滑入动画
- 圆角和阴影优化
- 响应式布局

## 后端配置步骤

### 步骤 1：创建数据库表

使用 Navicat 或 psql 执行以下 SQL 文件：

```bash
# 文件位置
server/storage/data/support_chat_tables_pg.sql
```

该文件会创建以下表：
- `hg_support_session` - 客服会话表
- `hg_support_message` - 客服消息表
- `hg_support_agent_presence` - 客服在线状态表
- `hg_support_canned_reply` - 客服常用语表

### 步骤 2：创建菜单（可选）

如果需要在后台管理中显示客服管理菜单：

```bash
# 文件位置
server/storage/data/support_chat_menu_pg.sql
```

### 步骤 3：验证后端服务

1. 确保后端服务已启动
2. 检查路由是否注册：
   - 文件：`server/internal/router/api.go`
   - 应该包含：`support_chat.NewV1()`

3. 测试接口是否可访问：
   ```bash
   # 替换为你的实际地址
   curl -X POST http://192.168.1.4:8009/api/supportChat/start \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

## 使用说明

### 用户端（前台）
1. 登录系统后，点击右上角的客服图标
2. 系统会自动创建或复用一个未关闭的会话
3. 输入消息后点击"发送"或按 Ctrl+Enter
4. 等待客服接线后即可开始对话

### 客服端（后台）
1. 进入"客服管理" -> "实时对话"
2. 查看待接线会话列表
3. 点击"接线"开始服务
4. 可以转接、关闭会话等操作

## 错误排查

### 错误 1：404 Not Found
**原因**：数据库表未创建或后端服务未启动

**解决**：
1. 执行 `support_chat_tables_pg.sql` 创建表
2. 重启后端服务
3. 检查后端日志

### 错误 2：401 Unauthorized
**原因**：未登录或登录已过期

**解决**：
1. 重新登录系统
2. 检查 token 是否有效

### 错误 3：页面空白
**原因**：路由配置问题

**解决**：
1. 清除浏览器缓存
2. 刷新页面（Ctrl+F5）
3. 检查浏览器控制台错误

## 技术栈

### 前端
- Vue 3 + TypeScript
- Naive UI 组件库
- WebSocket 实时通信

### 后端
- GoFrame v2
- PostgreSQL 数据库
- WebSocket 推送

## 联系支持

如果遇到问题，请检查：
1. 浏览器控制台错误信息
2. 后端服务日志
3. 数据库连接状态
4. WebSocket 连接状态

---

**修复时间**：2026-01-02
**修复版本**：hotgo_v2

