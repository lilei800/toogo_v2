# 机器人自动平仓需求对比分析报告

## 需求对比表

| 需求项 | 需求描述 | 当前实现状态 | 实现位置 | 备注 |
|--------|---------|------------|---------|------|
| ① | 单个订单最大止损百分比：当 \|未实现盈亏\| / (保证金 × 设置的百分比) ≥ 100% 时，自动执行平仓（止损） | ✅ **已实现** | `robot_engine.go:2984-2992` | 公式等价，实现正确 |
| ② | 单个订单止盈回撤百分比：当止盈按钮开启后，如果 (实时最高盈利金额 - 实时未实现盈亏) / 最高盈利金额 ≥ 设置的百分比，则自动执行平仓（止盈） | ✅ **已实现** | `robot_engine.go:3004-3012` | 实现正确 |
| ③ | 启动止盈回撤按钮的百分比：当未实现盈亏 / 保证金 ≥ 设置的百分比时，自动开启止盈按钮（一旦开启后无法关闭，直到平仓） | ✅ **已实现** | `robot_engine.go:2994-3002` | 实现正确 |
| ④ | 机器人控制的所有订单达到设置的最大盈利和亏损额后，全部平仓 | ❌ **未实现** | - | **需要新增功能** |
| ⑤ | 机器人状态运行中时开启自动平仓功能 | ✅ **已实现** | `robot_engine.go:2585-2588` | 通过 `autoCloseEnabled` 开关控制 |
| ⑥ | 机器人停止运行前要对订单全部平仓 | ❌ **未实现** | `robot.go:622-624` | 当前只是检查并报错，需要改为自动平仓 |
| ⑦ | 最高盈利的定义，是指本订单的未实现盈亏的盈利最高点位，只增加不减少，平仓后自动清零 | ✅ **已实现** | `robot_engine.go:2885-2888, 3039-3040` | 实现正确 |
| ⑧ | 支持手动平仓 | ✅ **已实现** | `robot.go:487-592` | `CloseRobotPosition` 方法 |

---

## 详细分析

### ✅ 已实现的需求

#### ① 单个订单最大止损百分比

**需求公式**：`|未实现盈亏| / (保证金 × 设置的百分比) ≥ 100%`

**当前实现**（2984-2992行）：
```go
// 止损检查
if margin > 0 && pos.UnrealizedPnl < 0 {
    lossPercent := math.Abs(pos.UnrealizedPnl) / margin * 100
    if lossPercent >= stopLossPercent {
        return true // 触发止损
    }
}
```

**公式等价性验证**：
- 需求：`|未实现盈亏| / (保证金 × 止损百分比) ≥ 100%`
- 即：`|未实现盈亏| / 保证金 ≥ 止损百分比 × 100%`
- 即：`|未实现盈亏| / 保证金 × 100% ≥ 止损百分比`
- 当前实现：`lossPercent = |未实现盈亏| / 保证金 × 100%`，当 `lossPercent >= stopLossPercent` 时触发
- ✅ **公式等价，实现正确**

#### ② 单个订单止盈回撤百分比

**需求公式**：`(实时最高盈利金额 - 实时未实现盈亏) / 最高盈利金额 ≥ 设置的百分比`

**当前实现**（3004-3012行）：
```go
// 止盈回撤触发
if tracker.TakeProfitEnabled && tracker.HighestProfit > 0 {
    retreat := (tracker.HighestProfit - pos.UnrealizedPnl) / tracker.HighestProfit * 100
    if retreat >= profitRetreatPercent {
        return true // 触发止盈回撤
    }
}
```

**公式对比**：
- 需求：`(最高盈利 - 当前盈亏) / 最高盈利 ≥ 百分比`
- 当前：`retreat = (HighestProfit - UnrealizedPnl) / HighestProfit * 100`，当 `retreat >= profitRetreatPercent` 时触发
- ✅ **实现完全一致**

#### ③ 启动止盈回撤按钮的百分比

**需求**：当 `未实现盈亏 / 保证金 ≥ 设置的百分比` 时，自动开启止盈按钮（一旦开启后无法关闭，直到平仓）

**当前实现**（2994-3002行）：
```go
// 启动止盈回撤
if !tracker.TakeProfitEnabled && margin > 0 {
    profitPercent := pos.UnrealizedPnl / margin * 100
    if profitPercent >= takeProfitStart {
        tracker.TakeProfitEnabled = true // 启动止盈监控
        // 一旦设置为 true，后续不会再设置为 false，直到平仓
    }
}
```

**验证**：
- ✅ 公式正确：`profitPercent = UnrealizedPnl / margin * 100`
- ✅ 条件正确：`profitPercent >= takeProfitStart`
- ✅ 一旦开启不可关闭：`TakeProfitEnabled` 只会在平仓时清除（3039行）

#### ⑤ 机器人状态运行中时开启自动平仓功能

**当前实现**（2585-2588行）：
```go
// 检查是否开启自动平仓（使用最新的开关状态，独立于自动下单）
if robot == nil || autoCloseEnabled != 1 {
    return
}
```

**验证**：
- ✅ 通过 `robot.AutoCloseEnabled` 字段控制（0=否，1=是）
- ✅ 独立于自动下单开关（`AutoTradeEnabled`）
- ✅ 在主循环中每500ms检查一次

#### ⑦ 最高盈利的定义

**需求**：最高盈利是指本订单的未实现盈亏的盈利最高点位，只增加不减少，平仓后自动清零

**当前实现**：
- **更新逻辑**（2885-2888行）：
```go
// 【重要】只有正盈利才更新最高盈利
if pos.UnrealizedPnl > 0 && pos.UnrealizedPnl > tracker.HighestProfit {
    tracker.HighestProfit = pos.UnrealizedPnl
}
```

- **清零逻辑**（3039-3040行）：
```go
// 清除持仓跟踪器
delete(t.engine.PositionTrackers, pos.PositionSide)
```

**验证**：
- ✅ 只有正盈利才更新：`pos.UnrealizedPnl > 0 && pos.UnrealizedPnl > tracker.HighestProfit`
- ✅ 只增加不减少：条件 `pos.UnrealizedPnl > tracker.HighestProfit` 确保只增加
- ✅ 平仓后清零：删除 `PositionTrackers[pos.PositionSide]`，下次开仓会重新创建

#### ⑧ 支持手动平仓

**当前实现**（`robot.go:487-592`）：
```go
// CloseRobotPosition 手动平仓
func (s *sToogoRobot) CloseRobotPosition(ctx context.Context, in *toogoin.ClosePositionInp) error {
    // ... 实现手动平仓逻辑
}
```

**验证**：
- ✅ 有独立的手动平仓接口
- ✅ 支持指定平仓数量和方向
- ✅ 平仓后更新机器人盈亏统计

---

### ❌ 未实现的需求

#### ④ 机器人控制的所有订单达到设置的最大盈利和亏损额后，全部平仓

**需求分析**：
- 需要监控机器人所有订单的累计盈亏（`TotalProfit`）
- 当 `TotalProfit >= MaxProfitTarget` 时，平仓所有订单
- 当 `TotalProfit <= -MaxLossAmount` 时，平仓所有订单

**当前状态**：
- ✅ 数据库字段已存在：`MaxProfitTarget`、`MaxLossAmount`、`TotalProfit`
- ❌ **平仓逻辑中未检查这些全局限制**
- ❌ **没有全部平仓的方法**

**需要实现的位置**：
- 在 `CheckAndClosePosition()` 方法中，检查全局盈利/亏损限制
- 如果达到限制，调用 `CloseAllPositions()` 方法平仓所有订单

**建议实现代码**：
```go
// 在 CheckAndClosePosition() 方法开头添加全局限制检查
func (t *RobotTrader) CheckAndClosePosition(ctx context.Context) {
    // ... 现有代码 ...
    
    // 【新增】检查全局盈利/亏损限制
    if robot.MaxProfitTarget > 0 && robot.TotalProfit >= robot.MaxProfitTarget {
        g.Log().Infof(ctx, "[RobotTrader] 达到最大盈利目标: robotId=%d, 总盈亏=%.4f >= %.4f，平仓所有订单",
            robot.Id, robot.TotalProfit, robot.MaxProfitTarget)
        t.closeAllPositions(ctx, "达到最大盈利目标")
        return
    }
    
    if robot.MaxLossAmount > 0 && robot.TotalProfit <= -robot.MaxLossAmount {
        g.Log().Infof(ctx, "[RobotTrader] 达到最大亏损额: robotId=%d, 总盈亏=%.4f <= -%.4f，平仓所有订单",
            robot.Id, robot.TotalProfit, robot.MaxLossAmount)
        t.closeAllPositions(ctx, "达到最大亏损额")
        return
    }
    
    // ... 继续现有的单个订单检查逻辑 ...
}

// 【新增】平仓所有订单的方法
func (t *RobotTrader) closeAllPositions(ctx context.Context, reason string) {
    positions := t.engine.CurrentPositions
    if positions == nil {
        return
    }
    
    for _, pos := range positions {
        if pos.PositionAmt == 0 {
            continue
        }
        t.executeClose(ctx, pos, reason)
    }
}
```

#### ⑥ 机器人停止运行前要对订单全部平仓

**需求分析**：
- 当用户停止机器人时，应该自动平仓所有订单
- 而不是仅仅检查并报错

**当前实现**（`robot.go:622-624`）：
```go
if count > 0 {
    return gerror.Newf("该机器人有%d笔持仓订单，请先平仓", count)
}
```

**问题**：
- ❌ 只是检查并返回错误，要求用户手动平仓
- ❌ 没有自动平仓逻辑

**需要实现的位置**：
- 在 `Stop()` 方法中，停止引擎前先平仓所有订单

**建议实现代码**：
```go
// 修改 robot.go 的 Stop 方法
func (s *robotImpl) Stop(ctx context.Context, in *input.TradingRobotStopInp) error {
    // ... 现有代码 ...
    
    // 【新增】停止前平仓所有订单
    if count > 0 {
        g.Log().Infof(ctx, "[Robot] 机器人停止前平仓所有订单: robotId=%d, 持仓数=%d", in.Id, count)
        
        // 获取机器人引擎实例
        engine := service.RobotTaskManager().GetEngine(in.Id)
        if engine != nil {
            // 强制开启自动平仓（如果未开启）
            originalAutoClose := engine.Robot.AutoCloseEnabled
            engine.Robot.AutoCloseEnabled = 1
            
            // 平仓所有订单
            trader := engine.Trader
            positions := engine.CurrentPositions
            for _, pos := range positions {
                if pos.PositionAmt != 0 {
                    trader.executeClose(ctx, pos, "机器人停止")
                }
            }
            
            // 恢复原设置
            engine.Robot.AutoCloseEnabled = originalAutoClose
            
            // 等待平仓完成（可选，给交易所一些时间）
            time.Sleep(2 * time.Second)
        } else {
            // 如果没有引擎实例，直接调用交易所API平仓
            // ... 实现直接平仓逻辑 ...
        }
    }
    
    // ... 继续停止逻辑 ...
}
```

---

## 实现优先级建议

### 高优先级（必须实现）

1. **需求④：全局盈利/亏损限制平仓**
   - 影响：风险控制的核心功能
   - 实现难度：中等
   - 建议：在 `CheckAndClosePosition()` 中添加全局检查

2. **需求⑥：停止前自动平仓**
   - 影响：用户体验和资金安全
   - 实现难度：中等
   - 建议：修改 `Stop()` 方法，添加平仓逻辑

### 中优先级（建议实现）

- 优化全局限制检查的性能（避免频繁查询数据库）
- 添加平仓进度提示（用户可以看到平仓进度）

---

## 总结

**已实现需求**：6/8 (75%)
- ✅ ① 单个订单止损
- ✅ ② 单个订单止盈回撤
- ✅ ③ 启动止盈回撤
- ✅ ⑤ 运行中开启自动平仓
- ✅ ⑦ 最高盈利定义
- ✅ ⑧ 手动平仓

**未实现需求**：2/8 (25%)
- ❌ ④ 全局盈利/亏损限制平仓
- ❌ ⑥ 停止前自动平仓

**建议**：
1. 优先实现需求④（全局限制平仓），这是风险控制的重要功能
2. 然后实现需求⑥（停止前平仓），提升用户体验
3. 两个功能实现后，需求完成度将达到 100%

