# 启动止盈按钮和止盈回撤举例说明

## 假设条件

- **保证金**：100 USDT
- **启动止盈百分比**：5%（来自订单创建时的策略参数）
- **止盈回撤百分比**：30%（来自订单创建时的策略参数）

## 完整流程示例

### 阶段0：开仓

```
时间：T0
保证金：100 USDT
未实现盈亏：0 USDT
盈利比例：0%
最高盈利：0 USDT
止盈状态：未启动
```

---

### 阶段1：开始盈利

```
时间：T1
保证金：100 USDT
未实现盈亏：+3 USDT（盈利）
盈利比例：3 / 100 × 100% = 3%
最高盈利：3 USDT（更新）
止盈状态：未启动（3% < 5%，未达到启动阈值）

判断：3% < 5% → 不启动止盈
```

---

### 阶段2：达到启动止盈条件

```
时间：T2
保证金：100 USDT
未实现盈亏：+6 USDT（盈利）
盈利比例：6 / 100 × 100% = 6%
最高盈利：6 USDT（更新）
止盈状态：✅ 启动（6% >= 5%，达到启动阈值）

判断：6% >= 5% → ✅ 启动止盈按钮
结果：tracker.TakeProfitEnabled = true
```

**关键点**：
- 盈利比例 6% >= 启动阈值 5%
- 自动开启止盈按钮（一旦开启无法关闭）
- 此时最高盈利 = 6 USDT

---

### 阶段3：继续盈利，最高盈利更新

```
时间：T3
保证金：100 USDT
未实现盈亏：+10 USDT（盈利增加）
盈利比例：10 / 100 × 100% = 10%
最高盈利：10 USDT（更新，只增不减）
止盈状态：✅ 已启动

判断：10 > 6 → 最高盈利更新为 10 USDT
回撤检查：(10 - 10) / 10 × 100% = 0% < 30% → 不平仓
```

---

### 阶段4：继续盈利到更高点

```
时间：T4
保证金：100 USDT
未实现盈亏：+15 USDT（盈利继续增加）
盈利比例：15 / 100 × 100% = 15%
最高盈利：15 USDT（更新）
止盈状态：✅ 已启动

判断：15 > 10 → 最高盈利更新为 15 USDT
回撤检查：(15 - 15) / 15 × 100% = 0% < 30% → 不平仓
```

---

### 阶段5：开始回撤（未达到回撤阈值）

```
时间：T5
保证金：100 USDT
未实现盈亏：+12 USDT（从15回撤到12）
盈利比例：12 / 100 × 100% = 12%
最高盈利：15 USDT（不变，只增不减）
止盈状态：✅ 已启动

回撤计算：
  回撤比例 = (15 - 12) / 15 × 100% = 20%
  判断：20% < 30% → ❌ 不平仓，继续监控
```

**关键点**：
- 最高盈利保持 15 USDT（不会减少）
- 当前盈利回撤到 12 USDT
- 回撤比例 20% < 30%，不平仓

---

### 阶段6：回撤达到阈值，触发平仓

```
时间：T6
保证金：100 USDT
未实现盈亏：+10.5 USDT（继续回撤）
盈利比例：10.5 / 100 × 100% = 10.5%
最高盈利：15 USDT（不变）
止盈状态：✅ 已启动

回撤计算：
  回撤比例 = (15 - 10.5) / 15 × 100% = 30%
  判断：30% >= 30% → ✅ 触发止盈回撤平仓

结果：自动平仓
```

**关键点**：
- 最高盈利：15 USDT（历史最高点）
- 当前盈利：10.5 USDT
- 回撤比例：30% >= 30%（止盈回撤阈值）
- **触发平仓**

---

## 关键概念说明

### 1. 启动止盈按钮

**触发条件**：
```
未实现盈亏 / 保证金 × 100% ≥ 启动止盈百分比
```

**示例**：
- 保证金：100 USDT
- 启动止盈百分比：5%
- 当盈利达到：100 × 5% = 5 USDT 时启动
- 实际：盈利 6 USDT（6%）时启动 ✅

**特点**：
- 一旦启动，无法关闭
- 直到平仓为止
- 启动后开始监控回撤

---

### 2. 最高盈利（HighestProfit）

**定义**：
- 记录订单历史最高盈利金额
- **只增不减**（即使当前盈利回撤，最高盈利也不变）

**更新规则**：
```go
// 只有正盈利且大于当前最高盈利时才更新
if pos.UnrealizedPnl > 0 && pos.UnrealizedPnl > tracker.HighestProfit {
    tracker.HighestProfit = pos.UnrealizedPnl
}
```

**示例时间线**：
- T1: 盈利 3 USDT → 最高盈利 = 3 USDT
- T2: 盈利 6 USDT → 最高盈利 = 6 USDT ✅
- T3: 盈利 10 USDT → 最高盈利 = 10 USDT ✅
- T4: 盈利 15 USDT → 最高盈利 = 15 USDT ✅
- T5: 盈利 12 USDT → 最高盈利 = 15 USDT（不变）
- T6: 盈利 10.5 USDT → 最高盈利 = 15 USDT（不变）

---

### 3. 止盈回撤触发

**触发条件**：
```
(最高盈利 - 当前盈亏) / 最高盈利 × 100% ≥ 止盈回撤百分比
```

**示例**：
- 最高盈利：15 USDT（T4时达到）
- 止盈回撤百分比：30%
- 当前盈利：10.5 USDT（T6时）

**计算**：
```
回撤比例 = (15 - 10.5) / 15 × 100% = 30%
判断：30% >= 30% → ✅ 触发平仓
```

**含义**：
- 从最高盈利点（15 USDT）回撤了 30%
- 当前盈利（10.5 USDT）仍然盈利，但回撤幅度达到阈值
- 触发平仓，锁定剩余利润

---

## 完整示例总结

| 时间 | 未实现盈亏 | 盈利比例 | 最高盈利 | 止盈状态 | 回撤比例 | 操作 |
|------|-----------|---------|---------|---------|---------|------|
| T0 | 0 USDT | 0% | 0 USDT | 未启动 | - | 开仓 |
| T1 | +3 USDT | 3% | 3 USDT | 未启动 | - | 监控中 |
| T2 | +6 USDT | 6% | 6 USDT | ✅ 启动 | - | **启动止盈** |
| T3 | +10 USDT | 10% | 10 USDT | ✅ 已启动 | 0% | 监控中 |
| T4 | +15 USDT | 15% | 15 USDT | ✅ 已启动 | 0% | 监控中（最高点） |
| T5 | +12 USDT | 12% | 15 USDT | ✅ 已启动 | 20% | 监控中（回撤中） |
| T6 | +10.5 USDT | 10.5% | 15 USDT | ✅ 已启动 | 30% | **触发平仓** ✅ |

---

## 代码逻辑对应

### 启动止盈（阶段2）

```go
// 条件：未实现盈亏 / 保证金 × 100% ≥ 启动止盈百分比
profitPercent := pos.UnrealizedPnl / margin * 100  // 6%
if profitPercent >= takeProfitStart {  // 6% >= 5%
    tracker.TakeProfitEnabled = true  // ✅ 启动
}
```

### 最高盈利更新（阶段3、4）

```go
// 只有正盈利且大于当前最高盈利时才更新
if pos.UnrealizedPnl > 0 && pos.UnrealizedPnl > tracker.HighestProfit {
    tracker.HighestProfit = pos.UnrealizedPnl  // 更新为 15 USDT
}
```

### 止盈回撤触发（阶段6）

```go
// 条件：(最高盈利 - 当前盈亏) / 最高盈利 × 100% ≥ 止盈回撤百分比
retreat := (tracker.HighestProfit - pos.UnrealizedPnl) / tracker.HighestProfit * 100
// retreat = (15 - 10.5) / 15 × 100% = 30%
if retreat >= profitRetreatPercent {  // 30% >= 30%
    return true  // ✅ 触发平仓
}
```

---

## 关键要点

1. **启动止盈**：盈利达到启动阈值（如5%）时自动开启，无法关闭
2. **最高盈利**：记录历史最高盈利点，只增不减
3. **止盈回撤**：从最高盈利点回撤达到阈值（如30%）时平仓
4. **参数来源**：所有百分比参数都来自订单创建时的策略参数，确保策略一致性

