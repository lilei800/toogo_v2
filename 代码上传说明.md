# HotGo_v2 代码上传说明

## 📋 一键部署脚本的工作方式

**重要说明：一键部署脚本不会自动上传代码！**

一键部署脚本 (`一键部署脚本.sh`) 只负责：
- ✅ 安装系统依赖（Go、PostgreSQL、Redis、Nginx）
- ✅ 配置数据库和Redis
- ✅ 编译和部署应用
- ✅ 配置Systemd服务
- ✅ 配置Nginx反向代理

**不负责：**
- ❌ 上传代码到服务器
- ❌ 从本地传输文件

---

## 🚀 代码上传的三种方法

### 方法1：使用Git（推荐，最方便）

**前提条件：**
- 代码已提交到Git仓库（GitHub、GitLab、Gitee等）

**步骤：**

1. **在服务器上执行：**
```bash
# 进入项目目录
cd /opt/hotgo

# 克隆代码
git clone https://github.com/你的用户名/hotgo_v2.git

# 或者使用SSH方式（更安全）
git clone git@github.com:你的用户名/hotgo_v2.git

# 进入server目录
cd hotgo_v2/server
```

2. **然后运行一键部署脚本：**
```bash
bash /opt/hotgo/hotgo_v2/一键部署脚本.sh
```

**优点：**
- ✅ 版本控制
- ✅ 可以回滚
- ✅ 更新方便（git pull）
- ✅ 不需要手动上传文件

---

### 方法2：使用SCP上传（适合没有Git仓库的情况）

**步骤：**

1. **在本地电脑上执行（Windows PowerShell）：**
```powershell
# 上传整个项目目录
scp -r D:\go\src\hotgo_v2 你的用户名@服务器IP:/opt/hotgo/

# 或者只上传server目录（更节省时间）
scp -r D:\go\src\hotgo_v2\server 你的用户名@服务器IP:/opt/hotgo/hotgo_v2/
```

**Mac/Linux：**
```bash
scp -r /path/to/hotgo_v2 你的用户名@服务器IP:/opt/hotgo/
```

2. **在服务器上验证：**
```bash
# 检查文件是否上传成功
ls -la /opt/hotgo/hotgo_v2/server
```

3. **然后运行一键部署脚本：**
```bash
cd /opt/hotgo/hotgo_v2
bash 一键部署脚本.sh
```

**注意事项：**
- ⚠️ 上传可能需要较长时间（取决于项目大小）
- ⚠️ 确保网络连接稳定
- ⚠️ 建议先压缩再上传（见方法3）

---

### 方法3：压缩后上传（推荐，最快）

**步骤：**

1. **在本地电脑上压缩项目：**
```powershell
# Windows PowerShell
cd D:\go\src
Compress-Archive -Path hotgo_v2 -DestinationPath hotgo_v2.zip

# 或者使用7-Zip（如果安装了）
7z a -tzip hotgo_v2.zip hotgo_v2
```

**Mac/Linux：**
```bash
cd /path/to
tar -czf hotgo_v2.tar.gz hotgo_v2
```

2. **上传压缩包：**
```powershell
# Windows PowerShell
scp hotgo_v2.zip 你的用户名@服务器IP:/tmp/
```

**Mac/Linux：**
```bash
scp hotgo_v2.tar.gz 你的用户名@服务器IP:/tmp/
```

3. **在服务器上解压：**
```bash
# 创建目录
sudo mkdir -p /opt/hotgo
sudo chown -R $USER:$USER /opt/hotgo

# 解压
cd /tmp
unzip hotgo_v2.zip -d /opt/hotgo/
# 或者
tar -xzf hotgo_v2.tar.gz -C /opt/hotgo/

# 验证
ls -la /opt/hotgo/hotgo_v2/server
```

4. **清理压缩包（可选）：**
```bash
rm /tmp/hotgo_v2.zip
```

5. **运行一键部署脚本：**
```bash
cd /opt/hotgo/hotgo_v2
bash 一键部署脚本.sh
```

**优点：**
- ✅ 上传速度快（压缩后文件更小）
- ✅ 减少网络传输时间
- ✅ 适合大项目

---

## 📦 推荐的上传文件清单

如果项目很大，可以只上传必要的文件：

### 必须上传的文件/目录：

```
hotgo_v2/
├── server/                    # ✅ 必须
│   ├── main.go
│   ├── go.mod
│   ├── go.sum
│   ├── internal/              # ✅ 必须
│   ├── api/                   # ✅ 必须
│   ├── manifest/              # ✅ 必须
│   ├── resource/              # ✅ 必须
│   └── storage/               # ✅ 必须（SQL文件）
├── web/                       # ⚠️ 可选（如果有前端）
└── 一键部署脚本.sh            # ✅ 必须
```

### 不需要上传的文件/目录：

```
hotgo_v2/
├── .git/                      # ❌ 不需要（如果使用方法1）
├── node_modules/              # ❌ 不需要（前端依赖）
├── logs/                      # ❌ 不需要
├── *.exe                      # ❌ 不需要（Windows可执行文件）
├── *.log                      # ❌ 不需要
└── temp/                      # ❌ 不需要
```

---

## 🔄 更新代码的方法

### 如果使用Git：

```bash
# 在服务器上执行
cd /opt/hotgo/hotgo_v2
git pull

# 重新编译
cd server
go build -o main main.go

# 重启服务
sudo systemctl restart hotgo
```

### 如果使用SCP：

```bash
# 在本地重新上传
scp -r D:\go\src\hotgo_v2\server 你的用户名@服务器IP:/opt/hotgo/hotgo_v2/

# 在服务器上重新编译和重启
cd /opt/hotgo/hotgo_v2/server
go build -o main main.go
sudo systemctl restart hotgo
```

---

## 🛠️ 自动化上传脚本（Windows）

创建 `upload_to_server.ps1`：

```powershell
# HotGo 代码上传脚本
param(
    [Parameter(Mandatory=$true)]
    [string]$ServerIP,
    
    [Parameter(Mandatory=$true)]
    [string]$Username,
    
    [string]$ProjectPath = "D:\go\src\hotgo_v2",
    [string]$RemotePath = "/opt/hotgo"
)

Write-Host "=========================================="
Write-Host "  HotGo 代码上传工具"
Write-Host "=========================================="
Write-Host ""

# 检查项目目录
if (-not (Test-Path $ProjectPath)) {
    Write-Host "错误: 项目目录不存在: $ProjectPath" -ForegroundColor Red
    exit 1
}

Write-Host "项目路径: $ProjectPath"
Write-Host "服务器: $Username@$ServerIP"
Write-Host "目标路径: $RemotePath"
Write-Host ""

# 确认
$confirm = Read-Host "确认上传? (y/n)"
if ($confirm -ne "y") {
    exit 0
}

# 压缩项目（排除不必要的文件）
Write-Host "正在压缩项目..."
$tempZip = "$env:TEMP\hotgo_v2_$(Get-Date -Format 'yyyyMMdd_HHmmss').zip"
Compress-Archive -Path "$ProjectPath\server" -DestinationPath $tempZip -Force
Write-Host "压缩完成: $tempZip"

# 上传
Write-Host "正在上传到服务器..."
scp $tempZip "${Username}@${ServerIP}:/tmp/"

# 清理本地压缩包
Remove-Item $tempZip

Write-Host ""
Write-Host "✅ 上传完成！"
Write-Host ""
Write-Host "请在服务器上执行："
Write-Host "  cd /tmp"
Write-Host "  unzip hotgo_v2_*.zip -d $RemotePath/"
Write-Host "  cd $RemotePath/hotgo_v2/server"
Write-Host "  bash ../一键部署脚本.sh"
```

**使用方法：**
```powershell
.\upload_to_server.ps1 -ServerIP "你的服务器IP" -Username "你的用户名"
```

---

## 📋 完整部署流程总结

### 第一次部署：

1. **上传代码到服务器**（选择一种方法）
   - 方法1：Git克隆
   - 方法2：SCP上传
   - 方法3：压缩上传

2. **运行一键部署脚本**
   ```bash
   cd /opt/hotgo/hotgo_v2
   bash 一键部署脚本.sh
   ```

3. **配置密码和密钥**
   ```bash
   bash server/scripts/change_passwords.sh
   ```

4. **启动服务**
   ```bash
   sudo systemctl start hotgo
   sudo systemctl status hotgo
   ```

### 更新代码：

1. **上传新代码**（使用相同方法）
2. **重新编译**
   ```bash
   cd /opt/hotgo/hotgo_v2/server
   go build -o main main.go
   ```
3. **重启服务**
   ```bash
   sudo systemctl restart hotgo
   ```

---

## ❓ 常见问题

### Q1: 一键部署脚本在哪里运行？

**A:** 在服务器上运行，不是在本地电脑上。

### Q2: 代码需要先上传吗？

**A:** 是的，需要先上传代码到服务器，然后才能运行部署脚本。

### Q3: 上传整个项目还是只上传server目录？

**A:** 
- 如果使用Git：上传整个项目（Git会自动处理）
- 如果使用SCP：可以只上传server目录（更快）

### Q4: 上传后需要做什么？

**A:** 
1. 确保代码在 `/opt/hotgo/hotgo_v2/` 目录
2. 运行一键部署脚本
3. 配置密码
4. 启动服务

---

**总结：一键部署脚本不会自动上传代码，需要先手动上传代码到服务器！**
