# 策略参数显示错误问题排查说明

## 问题描述

机器人详情显示：
- 策略模板：BTC-USDT 官方策略 V5.0 (我的副本)
- 市场状态: 震荡（volatile）
- 风险偏好: 平衡（balanced）
- **杠杆: 7x**（应该是 10x）
- **保证金: 11.5%**（应该是 10%）

## 排查步骤

### 1. 执行 SQL 查询检查数据库

已创建 `检查策略模板数据.sql` 文件，请执行以下查询：

#### 查询1：查找策略组
```sql
SELECT 
    id,
    group_name,
    is_official,
    is_active
FROM hg_trading_strategy_group
WHERE group_name LIKE '%BTC-USDT 官方策略 V5.0%'
   OR group_name LIKE '%V5.0%我的副本%';
```

#### 查询2：检查 volatile + balanced 的策略模板
```sql
SELECT 
    t.id,
    t.group_id,
    g.group_name,
    t.market_state AS 市场状态,
    t.risk_preference AS 风险偏好,
    t.monitor_window AS 时间窗口秒,
    t.volatility_threshold AS 波动值USDT,
    t.leverage AS 杠杆,
    t.margin_percent AS 保证金百分比,
    t.stop_loss_percent AS 止损百分比,
    t.auto_start_retreat_percent AS 启动止盈百分比,
    t.profit_retreat_percent AS 止盈回撤百分比,
    t.is_active AS 是否激活
FROM hg_trading_strategy_template t
LEFT JOIN hg_trading_strategy_group g ON t.group_id = g.id
WHERE (g.group_name LIKE '%BTC-USDT 官方策略 V5.0%' OR g.group_name LIKE '%V5.0%我的副本%')
  AND t.market_state = 'volatile'
  AND t.risk_preference = 'balanced'
  AND t.is_active = 1;
```

**预期结果：**
- `leverage` 应该是 `10`
- `margin_percent` 应该是 `10.0`
- `monitor_window` 应该是 `60`
- `volatility_threshold` 应该是 `50.0`
- `stop_loss_percent` 应该是 `10.0`
- `auto_start_retreat_percent` 应该是 `5.0`
- `profit_retreat_percent` 应该是 `10.0`

#### 查询3：检查机器人的策略组ID
```sql
SELECT 
    r.id AS 机器人ID,
    r.robot_name AS 机器人名称,
    r.strategy_group_id AS 策略组ID,
    g.group_name AS 策略组名称,
    r.risk_preference AS 机器人风险偏好,
    r.market_state AS 机器人市场状态
FROM hg_trading_robot r
LEFT JOIN hg_trading_strategy_group g ON r.strategy_group_id = g.id
WHERE g.group_name LIKE '%BTC-USDT 官方策略 V5.0%'
   OR g.group_name LIKE '%V5.0%我的副本%'
ORDER BY r.id DESC
LIMIT 10;
```

### 2. 可能的问题原因

#### 问题1：数据库中的策略模板数据不正确
- **现象**：查询结果中 `leverage = 7`, `margin_percent = 11.5`
- **原因**：策略模板数据被错误修改或初始化时使用了错误的值
- **解决**：更新策略模板数据

#### 问题2：查询到了错误的策略模板
- **现象**：存在多个策略组，查询到了错误的策略组
- **原因**：机器人的 `strategy_group_id` 指向了错误的策略组
- **解决**：检查并修正机器人的 `strategy_group_id`

#### 问题3：市场状态名称不匹配
- **现象**：数据库中使用的是 `range` 而不是 `volatile`
- **原因**：市场状态名称不一致
- **解决**：检查 `market_state` 字段的值，可能需要统一为 `volatile`

#### 问题4：有多个匹配的策略模板
- **现象**：查询返回了多条记录
- **原因**：存在重复的策略模板
- **解决**：检查是否有重复数据，确保只有一个激活的模板

### 3. 修复 SQL（如果需要更新数据）

如果发现数据不正确，可以使用以下 SQL 更新：

```sql
-- 更新 volatile + balanced 的策略模板参数
UPDATE hg_trading_strategy_template t
LEFT JOIN hg_trading_strategy_group g ON t.group_id = g.id
SET 
    t.monitor_window = 60,
    t.volatility_threshold = 50.0,
    t.leverage = 10,
    t.margin_percent = 10.0,
    t.stop_loss_percent = 10.0,
    t.auto_start_retreat_percent = 5.0,
    t.profit_retreat_percent = 10.0
WHERE (g.group_name LIKE '%BTC-USDT 官方策略 V5.0%' OR g.group_name LIKE '%V5.0%我的副本%')
  AND t.market_state = 'volatile'
  AND t.risk_preference = 'balanced'
  AND t.is_active = 1;
```

### 4. 检查代码逻辑

代码中查询策略模板的逻辑（`robot_engine.go:619-625`）：
```go
err := dao.TradingStrategyTemplate.Ctx(ctx).
    Where("group_id", groupId).
    Where(dao.TradingStrategyTemplate.Columns().MarketState, ms).
    Where(dao.TradingStrategyTemplate.Columns().RiskPreference, riskPreference).
    Where(dao.TradingStrategyTemplate.Columns().IsActive, 1).
    Scan(&strategy)
```

**注意：**
- 查询条件包括：`group_id` + `market_state` + `risk_preference` + `is_active = 1`
- 如果查询到多条记录，`Scan()` 只会返回第一条
- 如果查询不到记录，会使用默认参数

### 5. 调试建议

#### 查看日志
检查服务器日志，查找以下关键词：
- `[RobotEngine] robotId=X 从策略模板加载参数`
- `[RobotEngine] robotId=X 策略模板未找到`
- `[Monitor] robotId=X 策略参数已重新加载`

#### 添加调试日志
如果需要更详细的调试信息，可以在 `loadFullStrategyParams` 函数中添加日志：

```go
g.Log().Infof(ctx, "[RobotEngine] robotId=%d 查询策略模板: groupId=%d, marketState=%s, riskPreference=%s",
    e.Robot.Id, groupId, ms, riskPreference)
```

### 6. 验证修复

修复后，检查以下内容：

1. **数据库数据正确**
   - 执行查询2，确认参数值正确

2. **机器人配置正确**
   - 执行查询3，确认 `strategy_group_id` 正确

3. **前端显示正确**
   - 刷新机器人详情页面
   - 确认显示的参数与数据库一致

4. **日志输出正确**
   - 查看日志，确认加载了正确的策略模板
   - 确认参数值与数据库一致

## 下一步操作

1. **执行 SQL 查询**：运行 `检查策略模板数据.sql` 中的查询
2. **检查结果**：对比查询结果与预期值
3. **修复数据**：如果数据不正确，执行更新 SQL
4. **重启机器人**：如果修改了数据，需要重启机器人或重新加载策略配置
5. **验证显示**：刷新前端页面，确认参数显示正确

## 相关文件

- `检查策略模板数据.sql` - SQL 查询脚本
- `server/internal/logic/toogo/robot_engine.go:584-685` - 策略参数加载逻辑
- `server/internal/logic/trading/monitor.go:476-540` - 前端数据组装逻辑

