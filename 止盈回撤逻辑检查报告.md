# 启动止盈和止盈回撤逻辑检查报告

## 一、启动止盈逻辑

### 1.1 后端逻辑（robot_engine.go:3629-3650）

**触发条件**:
```go
if !tracker.TakeProfitEnabled && margin > 0 && autoStartRetreatPercent > 0 {
    profitPercent := unrealizedPnl / margin * 100
    if profitPercent >= autoStartRetreatPercent {
        tracker.TakeProfitEnabled = true
        // 持久化到数据库
        dao.TradingOrder.Update("profit_retreat_started", 1)
    }
}
```

**公式**: `盈利比例 = 未实现盈亏 / 保证金 × 100%`

**状态持久化**: ✅ 已实现
- 当启动止盈时，会更新数据库 `profit_retreat_started = 1`
- 同时更新 `highest_profit` 字段

### 1.2 前端显示（index.vue:1890-1916）

**函数**: `calcStartProfitProgress()`

**逻辑**:
```javascript
// 如果已启动止盈，永远返回100%
if (pos.takeProfitEnabled) {
    return 100;
}

// 计算进度：(当前盈利百分比 / 设定百分比) × 100%
const currentProfitPercent = (unrealizedPL / margin) * 100;
const progress = (currentProfitPercent / autoStartPercent) * 100;
return Math.min(100, progress);
```

**显示效果**:
- 达到100%时显示 "✓已启动"
- 启动后血条永远保持100%，不再后退

**状态**: ✅ 正确

## 二、止盈回撤逻辑

### 2.1 后端逻辑（robot_engine.go:3652-3674）

**触发条件**:
```go
if tracker.TakeProfitEnabled && tracker.HighestProfit > 0 {
    retreat := (tracker.HighestProfit - unrealizedPnl) / tracker.HighestProfit * 100
    if retreat >= profitRetreatPercent {
        return true  // 触发平仓
    }
}
```

**公式**: `回撤比例 = (最高盈利 - 当前盈亏) / 最高盈利 × 100%`

**平仓条件**: `回撤比例 >= 设定的止盈回撤百分比`

**状态**: ✅ 正确

### 2.2 前端显示（index.vue:1858-1884）

**函数**: `calcProfitRetreatProgress()`

**逻辑**:
```javascript
// 未启动止盈时，返回100%（满条）
if (!pos.takeProfitEnabled) {
    return 100;
}

// 计算当前回撤百分比
const currentRetreatPercent = ((maxProfitReached - unrealizedPL) / maxProfitReached) * 100;

// 血条进度 = 100% - (当前回撤百分比 / 设定回撤百分比) × 100%
const progress = 100 - (currentRetreatPercent / profitRetreatPercent) * 100;

return Math.max(0, Math.min(100, progress));
```

**显示效果**:
- 启动止盈达到100%后，止盈回撤血条才会显示
- 血条从100%开始，随着回撤增加而减少
- 当回撤达到设定值时，血条为0%，触发平仓

**状态**: ✅ 正确

## 三、前端显示逻辑（index.vue:517-543）

**条件渲染**:
```vue
<div class="monitor-item" :class="{ 'monitor-disabled': calcStartProfitProgress(pos, robot) < 100 }">
    <!-- 只有启动止盈达到100%后，止盈回撤才会生效 -->
    <div class="progress-bar" 
         :style="{ 
           width: calcStartProfitProgress(pos, robot) >= 100 ? calcProfitRetreatProgress(pos, robot).toFixed(1) + '%' : '0%',
           backgroundColor: calcStartProfitProgress(pos, robot) < 100 ? '#9ca3af' : (calcProfitRetreatProgress(pos, robot) <= 20 ? '#ef4444' : '#22c55e')
         }">
    </div>
    <div class="monitor-value">
        <template v-if="calcStartProfitProgress(pos, robot) < 100">未启动</template>
        <template v-else>
            <span>{{ calcProfitRetreatProgress(pos, robot) <= 0 ? '⚠️0%' : calcProfitRetreatProgress(pos, robot).toFixed(1) + '%' }}</span>
        </template>
    </div>
</div>
```

**状态**: ✅ 正确

## 四、发现的问题和修复

### 4.1 问题：重启后状态丢失

**问题描述**:
- 在 `GetRobotPositions` 函数中，如果机器人引擎不存在或 tracker 不存在，`takeProfitEnabled` 会是 `false`
- 即使订单已经启动了止盈（`profit_retreat_started = 1`），也无法正确显示

**修复方案**:
```go
// 【修复】从数据库读取止盈启动状态和最高盈利（用于重启后状态恢复）
if val := orderData["profit_retreat_started"]; val != nil {
    dbProfitRetreatStarted = val.Int()
}
if val := orderData["highest_profit"]; val != nil {
    dbHighestProfit = val.Float64()
}

// 【修复】如果引擎中不存在 tracker，使用数据库中的状态
if !takeProfitEnabled && dbProfitRetreatStarted == 1 {
    takeProfitEnabled = true
}
if dbHighestProfit > maxProfitReached {
    maxProfitReached = dbHighestProfit
}
```

**状态**: ✅ 已修复

## 五、完整流程验证

### 5.1 启动止盈流程

1. **盈利达到启动阈值**:
   - 当前盈利 = 10 USDT，保证金 = 100 USDT
   - 盈利比例 = 10 / 100 × 100% = 10%
   - 启动阈值 = 5%
   - ✅ 10% >= 5%，触发启动止盈

2. **状态更新**:
   - `tracker.TakeProfitEnabled = true`
   - 数据库更新：`profit_retreat_started = 1`
   - 前端显示：启动止盈血条 = 100%，显示 "✓已启动"

3. **止盈回撤血条激活**:
   - 前端：`calcStartProfitProgress() >= 100`，止盈回撤血条开始显示
   - 初始状态：`calcProfitRetreatProgress() = 100%`（满条）

### 5.2 止盈回撤流程

1. **最高盈利记录**:
   - 盈利继续增长到 15 USDT
   - `tracker.HighestProfit = 15`
   - 数据库更新：`highest_profit = 15`

2. **回撤计算**:
   - 当前盈利回落到 12 USDT
   - 回撤比例 = (15 - 12) / 15 × 100% = 20%
   - 设定回撤阈值 = 30%
   - ✅ 20% < 30%，未触发平仓

3. **血条显示**:
   - 前端：`currentRetreatPercent = 20%`
   - 血条进度 = 100 - (20 / 30) × 100% = 33.33%
   - 显示：33.3%

4. **触发平仓**:
   - 当前盈利继续回落到 10.5 USDT
   - 回撤比例 = (15 - 10.5) / 15 × 100% = 30%
   - ✅ 30% >= 30%，触发平仓
   - 前端：血条进度 = 100 - (30 / 30) × 100% = 0%
   - 显示：⚠️0%

## 六、总结

### 6.1 逻辑正确性

✅ **启动止盈逻辑**: 正确
- 达到阈值后启动，状态持久化到数据库
- 前端正确显示100%并保持

✅ **止盈回撤逻辑**: 正确
- 从100%开始，随着回撤增加而减少
- 达到0%时触发平仓
- 前后端计算公式一致

✅ **状态恢复**: 已修复
- 重启后能从数据库恢复止盈状态和最高盈利

### 6.2 血条显示

✅ **启动止盈血条**: 
- 0% → 100%：逐步增长
- 达到100%后：永远保持100%，显示 "✓已启动"

✅ **止盈回撤血条**:
- 启动止盈达到100%后：开始显示
- 100% → 0%：随着回撤增加而减少
- 达到0%时：显示 "⚠️0%"，触发平仓

### 6.3 建议

1. ✅ 所有逻辑已正确实现
2. ✅ 状态持久化已实现
3. ✅ 重启后状态恢复已修复
4. ✅ 前后端计算逻辑一致

**结论**: 启动止盈和止盈回撤逻辑完全正确，血条显示符合预期。

