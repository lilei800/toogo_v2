# 机器人自动平仓逻辑分析

## 一、概述

机器人自动平仓功能是 hotgo_v2 项目中的核心风险控制机制，通过监控持仓的未实现盈亏，在达到止损或止盈条件时自动执行平仓操作，保护用户资金安全并锁定利润。

## 二、执行流程

### 2.1 触发机制

**入口位置**：`robot_engine.go` 的 `runMainLoop()` 方法

```go
// 每500ms执行一次交易检查（仅平仓）
func (e *RobotEngine) doTradingCheck(ctx context.Context) {
  go e.checkClosePosition(ctx)
}
```

**执行频率**：每 500 毫秒检查一次（未区分有无持仓）。

### 2.2 检查流程

**核心方法**：`CheckAndClosePosition()`（基于订单表 + 交易所持仓）

要点：
- 只检查自动平仓开关 `autoCloseEnabled`，独立于自动下单开关
- 从数据库查询持仓订单（status=1），再匹配交易所当前持仓
- 使用 `shouldCloseFromOrder()` 判定，`executeClose()` 通过交易所持仓执行
- 不再调用 `syncAccountDataIfNeeded`，依赖订单同步服务保证数据库最新

## 三、平仓判断逻辑

### 3.1 核心判断方法：`shouldCloseFromOrder()`

#### 前置保护与跟踪
- **最小持仓时间保护：已移除**，当前可立即根据止损/止盈条件平仓。
- 每个方向维护 `PositionTracker`，记录最高盈利、开仓保证金（EntryMargin）、止盈是否已启动。

#### 策略参数获取（当前优先级）
1) 持仓订单表字段：`stop_loss_percent`、`auto_start_retreat_percent`、`profit_retreat_percent`
2) 若缺失，使用默认值：止损10%、启动止盈5%、止盈回撤30%（并记录错误日志）

#### 平仓条件
- **止损**：`|未实现盈亏| / 保证金 × 100% >= stop_loss_percent`
- **启动止盈回撤**：盈利比例达到 `auto_start_retreat_percent` 时，标记 `TakeProfitEnabled=true`
- **止盈回撤**：`(最高盈利 - 当前盈利) / 最高盈利 × 100% >= profit_retreat_percent`

#### 数据来源
- 盈亏、保证金优先使用订单同步后的数据库值；保证金缺失时兜底用交易所逐仓保证金或记录的 EntryMargin。

#### 3.1.3 平仓条件判断

**条件1：止损触发** (2984-2992行)

```
触发条件：亏损比例 >= 止损百分比
计算公式：lossPercent = |未实现盈亏| / 保证金 × 100%
```

**示例**：
- 保证金：100 USDT
- 止损百分比：10%
- 触发条件：未实现盈亏 <= -10 USDT（亏损比例 >= 10%）

```go
if margin > 0 && pos.UnrealizedPnl < 0 {
    lossPercent := math.Abs(pos.UnrealizedPnl) / margin * 100
    if lossPercent >= stopLossPercent {
        return true // 触发止损，执行平仓
    }
}
```

**条件2：止盈回撤触发** (2994-3012行)

**阶段1：启动止盈** (2994-3002行)
```
触发条件：盈利比例 >= 启动止盈百分比
计算公式：profitPercent = 未实现盈亏 / 保证金 × 100%
```

**示例**：
- 保证金：100 USDT
- 启动止盈百分比：5%
- 触发条件：未实现盈亏 >= 5 USDT（盈利比例 >= 5%）
- **效果**：设置 `tracker.TakeProfitEnabled = true`，开始监控回撤

**阶段2：止盈回撤检查** (3004-3012行)
```
触发条件：回撤比例 >= 止盈回撤百分比
计算公式：retreat = (最高盈利 - 当前盈亏) / 最高盈利 × 100%
```

**示例**：
- 最高盈利：20 USDT（曾经达到的最高盈利）
- 当前盈亏：10 USDT
- 止盈回撤百分比：30%
- 回撤比例：(20 - 10) / 20 × 100% = 50% >= 30%
- **结果**：触发止盈回撤，执行平仓

```go
// 启动止盈
if !tracker.TakeProfitEnabled && margin > 0 {
    profitPercent := pos.UnrealizedPnl / margin * 100
    if profitPercent >= takeProfitStart {
        tracker.TakeProfitEnabled = true // 启动止盈监控
    }
}

// 止盈回撤触发
if tracker.TakeProfitEnabled && tracker.HighestProfit > 0 {
    retreat := (tracker.HighestProfit - pos.UnrealizedPnl) / tracker.HighestProfit * 100
    if retreat >= profitRetreatPercent {
        return true // 触发止盈回撤，执行平仓
    }
}
```

**重要特性**：
- 只有**正盈利**才会更新最高盈利（2886行）
- 一旦启动止盈（`TakeProfitEnabled = true`），会持续监控直到平仓
- 回撤计算基于历史最高盈利，而不是当前盈利

## 四、平仓执行逻辑

### 4.1 执行方法：`executeClose()` (3020-3059行)

```go
func (t *RobotTrader) executeClose(ctx context.Context, pos *exchange.Position, reason string) {
    // 1. 计算平仓数量
    quantity := math.Abs(pos.PositionAmt)
    
    // 2. 调用交易所API平仓
    order, err := t.engine.Exchange.ClosePosition(ctx, robot.Symbol, pos.PositionSide, quantity)
    
    // 3. 更新机器人盈亏统计
    dao.TradingRobot.Ctx(ctx).
        WherePri(robot.Id).
        Increment("total_profit", pos.UnrealizedPnl)
    
    // 4. 清除持仓跟踪器和内存状态
    delete(t.engine.PositionTrackers, pos.PositionSide)
    // 将持仓数量设为0，表示已平仓
    
    // 5. 延迟同步持仓数据（1秒后）
    go func() {
        time.Sleep(1 * time.Second)
        t.engine.syncAccountDataIfNeeded(ctx, "after_trade")
    }()
}
```

### 4.2 状态清理

- **清除持仓跟踪器**：删除 `PositionTrackers[pos.PositionSide]`
- **更新内存持仓**：将 `CurrentPositions` 中对应方向的 `PositionAmt` 设为 0
- **延迟同步**：1秒后从交易所同步最新持仓数据，确保状态一致性

## 五、数据同步策略

### 5.1 同步时机

**平仓检查前同步** (`syncAccountDataIfNeeded`，类型：`before_close_check`)
- **有持仓时**：3秒内不重复同步（未实现盈亏需要更新，但不能太频繁）
- **无持仓时**：5秒内不重复同步（持仓状态变化不频繁）

**平仓后同步** (`syncAccountDataIfNeeded`，类型：`after_trade`)
- 延迟1秒后同步，确保交易所订单已确认

### 5.2 同步内容

- **账户余额**：`GetBalance()`
- **持仓信息**：`GetPositions()`（包括未实现盈亏）

## 六、关键配置参数

### 6.1 机器人配置

| 字段 | 说明 | 默认值 |
|------|------|--------|
| `AutoCloseEnabled` | 自动平仓开关（0=否，1=是） | 0 |
| `StopLossPercent` | 止损百分比（降级方案） | 10% |
| `AutoStartRetreatPercent` | 启动止盈百分比（降级方案） | 5% |
| `ProfitRetreatPercent` | 止盈回撤百分比（降级方案） | 30% |

### 6.2 策略模板参数

策略参数存储在 `hg_trading_strategy_template` 表中，根据市场状态和风险偏好动态加载：

- `stop_loss_percent`：止损百分比
- `auto_start_retreat_percent`：启动止盈百分比
- `profit_retreat_percent`：止盈回撤百分比

### 6.3 订单记录参数

开仓时会将策略参数保存到订单表 `hg_trading_order` 中，平仓时优先使用这些参数，确保平仓条件与开仓时的策略一致。

## 七、设计特点

### 7.1 优势

1. **参数优先级机制**：确保使用开仓时的策略参数，避免策略变更影响已开仓订单
2. **最小持仓时间保护**：防止频繁开平仓，减少手续费损失
3. **智能数据同步**：平衡准确性和API调用频率
4. **止盈回撤机制**：锁定利润，避免利润回吐
5. **独立开关控制**：自动平仓开关独立于自动下单开关

### 7.2 注意事项

1. **最小持仓时间**：开仓后30秒内不会平仓，即使触发止损/止盈条件
2. **最高盈利记录**：只有正盈利才会更新最高盈利，亏损时不会记录
3. **止盈启动后不可逆**：一旦启动止盈监控，会持续监控直到平仓
4. **参数来源优先级**：订单参数 > 策略模板 > 机器人静态值 > 默认值

## 八、流程图

```
开始
  ↓
检查自动平仓开关 (autoCloseEnabled == 1?)
  ↓ 否
结束
  ↓ 是
同步账户数据（智能同步策略）
  ↓
遍历所有持仓
  ↓
检查持仓数量 (PositionAmt != 0?)
  ↓ 否
下一个持仓
  ↓ 是
调用 shouldClose() 判断
  ↓
检查最小持仓时间 (>= 30秒?)
  ↓ 否
暂不平仓
  ↓ 是
获取策略参数（优先级：订单 > 模板 > 静态值 > 默认值）
  ↓
检查止损条件 (亏损比例 >= 止损%?)
  ↓ 是
执行平仓
  ↓ 否
检查止盈启动条件 (盈利比例 >= 启动止盈%?)
  ↓ 是
启动止盈监控 (TakeProfitEnabled = true)
  ↓
检查止盈回撤条件 (回撤比例 >= 止盈回撤%?)
  ↓ 是
执行平仓
  ↓ 否
继续监控
  ↓
执行平仓 (executeClose)
  ↓
更新机器人盈亏统计
  ↓
清除持仓跟踪器和内存状态
  ↓
延迟同步持仓数据（1秒后）
  ↓
结束
```

## 九、代码位置总结

| 功能 | 文件位置 | 方法名 | 行号 |
|------|---------|--------|------|
| 主循环触发 | `robot_engine.go` | `doTradingCheck()` | 981-989 |
| 平仓检查入口 | `robot_engine.go` | `checkClosePosition()` | 1001-1009 |
| 平仓检查逻辑 | `robot_engine.go` | `CheckAndClosePosition()` | 2577-2608 |
| 平仓判断 | `robot_engine.go` | `shouldClose()` | 2855-3018 |
| 平仓执行 | `robot_engine.go` | `executeClose()` | 3020-3059 |
| 数据同步 | `robot_engine.go` | `syncAccountDataIfNeeded()` | 884-963 |

## 十、总结

机器人自动平仓逻辑是一个完善的风险控制机制，通过止损和止盈回撤两种机制保护用户资金。其设计考虑了参数一致性、执行效率、状态同步等多个方面，确保平仓操作的准确性和可靠性。

关键要点：
- **止损机制**：亏损达到设定比例时自动平仓，控制风险
- **止盈回撤机制**：盈利达到启动阈值后监控回撤，锁定利润
- **参数优先级**：优先使用开仓时的策略参数，确保策略一致性
- **保护机制**：最小持仓时间保护，防止频繁交易

