# 全自动下单策略参数获取流程全面分析

## 一、整体流程概述

全自动下单时，系统需要获取以下策略参数：
- **杠杆** (leverage)
- **保证金比例** (margin_percent)
- **止损百分比** (stop_loss_percent)
- **启动止盈百分比** (auto_start_retreat_percent)
- **止盈回撤百分比** (profit_retreat_percent)

这些参数通过以下流程获取：

```
实时市场状态 → 映射关系 → 风险偏好 → 策略模板查询 → 策略参数
```

---

## 二、详细流程分析

### 2.1 市场状态获取（第一步）

**位置**: `robot_engine.go:executeOpen()` (line 3268-3281)

**获取顺序**：
1. **优先使用** `LastMarketState`（实时市场状态，由市场分析更新）
2. **其次使用** `LastAnalysis.MarketState`（最近一次分析的市场状态）
3. **默认值** 如果都为空，使用 `"trend"`（趋势市场）

**代码逻辑**：
```go
var marketState string
t.engine.mu.RLock()
strategyParams = t.engine.CurrentStrategyParams
marketState = t.engine.LastMarketState
// 如果 LastMarketState 为空，尝试从 LastAnalysis 获取实时市场状态
if marketState == "" && t.engine.LastAnalysis != nil {
    marketState = t.engine.LastAnalysis.MarketState
}
t.engine.mu.RUnlock()

// 规范化市场状态，确保格式一致
if marketState != "" {
    marketState = normalizeMarketState(marketState)
}
```

**市场状态规范化**：
- `"high-volatility"` → `"high_vol"`
- `"low-volatility"` → `"low_vol"`
- `"range"` → `"volatile"`
- 其他保持不变

---

### 2.2 风险偏好获取（第二步）

**位置**: `robot_engine.go:executeOpen()` (line 3294-3306)

**获取顺序**：
1. **优先使用** `MarketRiskMapping[marketState]`（从映射关系获取）
2. **其次使用** `Robot.RiskPreference`（创建机器人时保存的默认风险偏好）
3. **默认值** 如果都为空，使用 `"balanced"`（平衡型）

**映射关系来源**：
- 存储在 `Robot.CurrentStrategy` JSON 字段中
- 路径：`riskConfig.marketRiskMapping`
- 格式示例：
```json
{
  "riskConfig": {
    "marketRiskMapping": {
      "low_vol": "conservative",
      "high_vol": "aggressive",
      "trend": "balanced",
      "volatile": "balanced"
    }
  }
}
```

**代码逻辑**：
```go
// 从映射关系获取风险偏好（根据实时市场状态匹配）
t.engine.mu.RLock()
riskPref := t.engine.MarketRiskMapping[marketState]
t.engine.mu.RUnlock()

// 降级策略：如果映射关系中没有，使用机器人配置的风险偏好
if riskPref == "" {
    riskPref = robot.RiskPreference
    if riskPref == "" {
        riskPref = "balanced" // 默认平衡型
    }
}
```

**重要说明**：
- 映射关系在机器人创建时保存到 `CurrentStrategy` 中
- 如果用户在机器人页面修改了映射关系，会实时更新 `CurrentStrategy`
- 系统始终使用 `CurrentStrategy` 中的映射关系，不使用默认值

---

### 2.3 策略参数加载（第三步）

**位置**: `robot_engine.go:loadFullStrategyParams()` (line 747-862)

**查询条件**：
1. **策略组ID** (`group_id`)
   - 优先使用：`Robot.StrategyGroupId`
   - 其次使用：`CurrentStrategy.groupId` 或 `CurrentStrategy.group_id`（兼容旧数据）

2. **市场状态** (`market_state`)
   - 使用规范化后的市场状态
   - 支持多种格式兼容（如 `low_vol`、`low-volatility`）

3. **风险偏好** (`risk_preference`)
   - 使用从映射关系获取的风险偏好

**查询SQL**：
```sql
SELECT * FROM hg_trading_strategy_template 
WHERE group_id = ? 
  AND market_state = ? 
  AND risk_preference = ?
```

**策略参数字段**：
- `monitor_window` → `Window`（监控窗口，秒）
- `volatility_threshold` → `Threshold`（波动阈值，USDT）
- `leverage` → `LeverageMin` 和 `LeverageMax`（杠杆）
- `margin_percent` → `MarginPercentMin` 和 `MarginPercentMax`（保证金比例）
- `stop_loss_percent` → `StopLossPercent`（止损百分比）
- `auto_start_retreat_percent` → `AutoStartRetreatPercent`（启动止盈百分比）
- `profit_retreat_percent` → `ProfitRetreatPercent`（止盈回撤百分比）

**代码逻辑**：
```go
var strategy *entity.TradingStrategyTemplate
err := dao.TradingStrategyTemplate.Ctx(ctx).
    Where("group_id", groupId).
    Where(dao.TradingStrategyTemplate.Columns().MarketState, ms).
    Where(dao.TradingStrategyTemplate.Columns().RiskPreference, riskPreference).
    Scan(&strategy)

if err == nil && strategy != nil {
    params.LeverageMin = strategy.Leverage
    params.LeverageMax = strategy.Leverage
    params.MarginPercentMin = strategy.MarginPercent
    params.MarginPercentMax = strategy.MarginPercent
    params.StopLossPercent = strategy.StopLossPercent
    params.AutoStartRetreatPercent = strategy.AutoStartRetreatPercent
    params.ProfitRetreatPercent = strategy.ProfitRetreatPercent
    return params, nil
}
```

---

### 2.4 下单时使用策略参数（第四步）

**位置**: `robot_engine.go:executeOpen()` (line 3363-3411)

**参数使用**：

1. **杠杆计算**：
```go
leverage := (strategyParams.LeverageMin + strategyParams.LeverageMax) / 2
if leverage <= 0 {
    leverage = 10  // 默认值
}
```

2. **保证金比例计算**：
```go
marginPercent := (strategyParams.MarginPercentMin + strategyParams.MarginPercentMax) / 2
if marginPercent <= 0 {
    marginPercent = 10  // 默认值
}
```

3. **订单数量计算**：
```go
margin := balance.AvailableBalance * marginPercent / 100
quantity := margin * float64(leverage) / ticker.LastPrice
```

4. **保存到订单记录**：
```go
orderData["stop_loss_percent"] = strategyParams.StopLossPercent
orderData["auto_start_retreat_percent"] = strategyParams.AutoStartRetreatPercent
orderData["profit_retreat_percent"] = strategyParams.ProfitRetreatPercent
```

---

## 三、数据来源总结

### 3.1 市场状态来源

| 来源 | 优先级 | 说明 |
|------|--------|------|
| `LastMarketState` | 1 | 实时市场状态（由市场分析更新） |
| `LastAnalysis.MarketState` | 2 | 最近一次分析的市场状态 |
| `"trend"` | 3 | 默认值（趋势市场） |

### 3.2 风险偏好来源

| 来源 | 优先级 | 说明 |
|------|--------|------|
| `MarketRiskMapping[marketState]` | 1 | 从映射关系获取（存储在 `CurrentStrategy` 中） |
| `Robot.RiskPreference` | 2 | 创建机器人时保存的默认风险偏好 |
| `"balanced"` | 3 | 默认值（平衡型） |

### 3.3 策略参数来源

| 参数 | 来源表 | 查询条件 |
|------|--------|----------|
| 杠杆 | `hg_trading_strategy_template` | `group_id` + `market_state` + `risk_preference` |
| 保证金比例 | `hg_trading_strategy_template` | `group_id` + `market_state` + `risk_preference` |
| 止损百分比 | `hg_trading_strategy_template` | `group_id` + `market_state` + `risk_preference` |
| 启动止盈百分比 | `hg_trading_strategy_template` | `group_id` + `market_state` + `risk_preference` |
| 止盈回撤百分比 | `hg_trading_strategy_template` | `group_id` + `market_state` + `risk_preference` |

---

## 四、关键代码位置

### 4.1 下单入口
- **文件**: `robot_engine.go`
- **函数**: `executeOpen()` (line 3252)
- **关键逻辑**: line 3266-3356

### 4.2 策略参数加载
- **文件**: `robot_engine.go`
- **函数**: `loadFullStrategyParams()` (line 747)
- **关键逻辑**: line 755-862

### 4.3 映射关系加载
- **文件**: `robot_engine.go`
- **函数**: `loadRiskMapping()` (line 233)
- **关键逻辑**: line 233-287

### 4.4 市场状态更新
- **文件**: `robot_engine.go`
- **函数**: `UpdateMarketState()` (line 520)
- **关键逻辑**: line 520-600

---

## 五、常见问题分析

### 5.1 "订单缺少策略参数"错误

**错误日志**：
```
[RobotTrader] 订单缺少策略参数: robotId=17, side=SHORT, stopLoss=0.00, takeProfitStart=0.00, profitRetreat=0.00，使用默认值
```

**可能原因**：
1. **策略模板不存在**：查询条件（`group_id` + `market_state` + `risk_preference`）在数据库中找不到匹配的记录
2. **市场状态不匹配**：实时市场状态与策略模板中的市场状态格式不一致
3. **风险偏好不匹配**：映射关系中的风险偏好与策略模板中的风险偏好不一致
4. **策略组ID为空**：机器人未绑定策略组

**排查步骤**：
1. 检查 `Robot.StrategyGroupId` 是否 > 0
2. 检查 `CurrentStrategy` JSON 中的 `marketRiskMapping` 是否正确
3. 检查策略模板表中是否存在对应的记录：
   ```sql
   SELECT * FROM hg_trading_strategy_template 
   WHERE group_id = ? 
     AND market_state = ? 
     AND risk_preference = ?
   ```
4. 检查市场状态规范化是否正确（`normalizeMarketState`）

---

## 六、数据流程图

```
┌─────────────────────────────────────────────────────────────┐
│                   全自动下单流程                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  1. 获取实时市场状态               │
        │     - LastMarketState (优先)      │
        │     - LastAnalysis.MarketState    │
        │     - normalizeMarketState()      │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  2. 获取风险偏好                   │
        │     - MarketRiskMapping[state]    │
        │     - Robot.RiskPreference        │
        │     - "balanced" (默认)           │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  3. 查询策略模板                   │
        │     WHERE group_id = ?            │
        │       AND market_state = ?        │
        │       AND risk_preference = ?     │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  4. 提取策略参数                   │
        │     - leverage                    │
        │     - margin_percent              │
        │     - stop_loss_percent           │
        │     - auto_start_retreat_percent  │
        │     - profit_retreat_percent      │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  5. 计算订单参数                   │
        │     - leverage = (min+max)/2      │
        │     - marginPercent = (min+max)/2│
        │     - quantity = margin*leverage/price│
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  6. 执行下单                       │
        │     - 调用交易所API               │
        │     - 保存订单记录（含策略参数）   │
        └───────────────────────────────────┘
```

---

## 七、关键数据表

### 7.1 `hg_trading_robot`
- `strategy_group_id`: 策略组ID（用于查询策略模板）
- `risk_preference`: 默认风险偏好（降级策略）
- `current_strategy`: JSON字段，包含映射关系

### 7.2 `hg_trading_strategy_template`
- `group_id`: 策略组ID
- `market_state`: 市场状态（low_vol/high_vol/trend/volatile）
- `risk_preference`: 风险偏好（conservative/balanced/aggressive）
- `leverage`: 杠杆
- `margin_percent`: 保证金比例
- `stop_loss_percent`: 止损百分比
- `auto_start_retreat_percent`: 启动止盈百分比
- `profit_retreat_percent`: 止盈回撤百分比

---

## 八、优化建议

### 8.1 参数缓存机制
- 策略参数缓存在 `CurrentStrategyParams` 中
- 市场状态变化时自动刷新
- 避免频繁查询数据库

### 8.2 错误处理
- 如果找不到策略模板，返回详细错误信息
- 列出策略组中所有可用的市场状态和风险偏好组合
- 帮助用户快速定位问题

### 8.3 数据一致性
- 确保策略组中存在所有市场状态和风险偏好的组合
- 创建机器人时验证策略组完整性
- 提供策略组完整性检查工具

---

## 九、总结

全自动下单时，策略参数的获取遵循以下原则：

1. **市场状态**：使用实时分析的市场状态（`LastMarketState` 或 `LastAnalysis.MarketState`）
2. **风险偏好**：通过映射关系（`MarketRiskMapping`）根据市场状态获取，映射关系存储在 `CurrentStrategy` 中
3. **策略参数**：从策略模板表（`hg_trading_strategy_template`）查询，查询条件为：`group_id` + `market_state` + `risk_preference`
4. **参数使用**：杠杆和保证金比例使用范围的中值，止损和止盈参数直接使用策略模板中的值

**关键点**：
- ✅ 市场状态是**实时计算**的（基于K线数据和技术指标）
- ✅ 风险偏好通过**映射关系**获取（创建时保存，用户修改后实时生效）
- ✅ 策略参数从**策略模板表**查询（确保数据一致性）
- ✅ 所有参数都**保存到订单记录**中（用于后续平仓判断）

---

## 十、日志中的错误分析

### 10.1 "订单缺少策略参数"错误

**错误日志**：
```
[RobotTrader] 订单缺少策略参数: robotId=17, side=SHORT, stopLoss=0.00, takeProfitStart=0.00, profitRetreat=0.00，使用默认值
```

**错误位置**：
- 这个错误出现在**平仓判断**时，不是下单时
- 位置：`robot_engine.go:shouldCloseFromOrder()` (line 3777-3817)

**错误原因**：
1. **订单记录中没有策略参数**：下单时 `strategyParams` 为 `nil` 或参数值为 0
2. **订单记录未正确保存**：`recordOrder()` 函数中策略参数保存失败
3. **订单记录被清空**：订单记录中的策略参数字段被意外清空

**解决方案**：
1. **检查下单时策略参数是否正确加载**：
   - 查看日志中是否有 `[RobotEngine] robotId=17 从策略模板加载参数` 的记录
   - 确认策略参数是否成功加载

2. **检查订单记录是否正确保存**：
   ```sql
   SELECT stop_loss_percent, auto_start_retreat_percent, profit_retreat_percent 
   FROM hg_trading_order 
   WHERE robot_id = 17 AND status = 1 
   ORDER BY created_at DESC LIMIT 1;
   ```

3. **检查策略模板是否存在**：
   ```sql
   SELECT * FROM hg_trading_strategy_template 
   WHERE group_id = 24 
     AND market_state = 'low_vol' 
     AND risk_preference = 'conservative';
   ```

### 10.2 策略参数加载成功但订单记录为空

**可能原因**：
- `recordOrder()` 函数中 `strategyParams` 为 `nil`
- 策略参数的值 <= 0，导致未保存到数据库

**代码检查**：
```go
// robot_engine.go:recordOrder() (line 4014-4024)
if strategyParams != nil {
    if strategyParams.StopLossPercent > 0 {
        orderData["stop_loss_percent"] = strategyParams.StopLossPercent
    }
    if strategyParams.AutoStartRetreatPercent > 0 {
        orderData["auto_start_retreat_percent"] = strategyParams.AutoStartRetreatPercent
    }
    if strategyParams.ProfitRetreatPercent > 0 {
        orderData["profit_retreat_percent"] = strategyParams.ProfitRetreatPercent
    }
}
```

**注意**：如果策略参数值 <= 0，不会保存到数据库，这可能导致后续平仓判断时找不到参数。

---

## 十一、完整数据流图

```
┌─────────────────────────────────────────────────────────────┐
│                   全自动下单完整流程                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤1: 获取实时市场状态            │
        │  - LastMarketState (优先)          │
        │  - LastAnalysis.MarketState        │
        │  - normalizeMarketState()          │
        │  结果: marketState = "low_vol"    │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤2: 获取风险偏好                │
        │  - MarketRiskMapping[marketState] │
        │  - Robot.RiskPreference           │
        │  - "balanced" (默认)              │
        │  结果: riskPreference = "conservative"│
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤3: 查询策略模板                │
        │  SELECT * FROM                    │
        │    hg_trading_strategy_template   │
        │  WHERE group_id = 24              │
        │    AND market_state = 'low_vol'   │
        │    AND risk_preference = 'conservative'│
        │  结果: 策略模板记录                │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤4: 提取策略参数                │
        │  - leverage = 15                  │
        │  - margin_percent = 12.0%         │
        │  - stop_loss_percent = 4.0%      │
        │  - auto_start_retreat_percent = 7.0%│
        │  - profit_retreat_percent = 3.5%  │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤5: 计算订单参数                │
        │  - leverage = 15 (使用中值)       │
        │  - marginPercent = 12.0% (使用中值)│
        │  - quantity = margin*leverage/price│
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤6: 执行下单                   │
        │  - 调用交易所API                 │
        │  - 获取订单ID                    │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤7: 保存订单记录                │
        │  - 保存策略参数到订单表            │
        │  - stop_loss_percent             │
        │  - auto_start_retreat_percent   │
        │  - profit_retreat_percent        │
        │  - market_state                  │
        │  - risk_level                    │
        └───────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────┐
        │  步骤8: 后续平仓判断                │
        │  - 从订单记录读取策略参数          │
        │  - 使用订单创建时的参数            │
        │  - 确保策略一致性                 │
        └───────────────────────────────────┘
```

---

## 十二、关键代码位置索引

| 功能 | 文件 | 函数 | 行号 |
|------|------|------|------|
| 下单入口 | `robot_engine.go` | `executeOpen()` | 3252 |
| 市场状态获取 | `robot_engine.go` | `executeOpen()` | 3268-3281 |
| 风险偏好获取 | `robot_engine.go` | `executeOpen()` | 3294-3306 |
| 策略参数加载 | `robot_engine.go` | `loadFullStrategyParams()` | 747 |
| 策略模板查询 | `robot_engine.go` | `loadFullStrategyParams()` | 807-834 |
| 订单参数计算 | `robot_engine.go` | `executeOpen()` | 3363-3411 |
| 订单记录保存 | `robot_engine.go` | `recordOrder()` | 3931 |
| 策略参数保存 | `robot_engine.go` | `recordOrder()` | 4014-4024 |
| 映射关系加载 | `robot_engine.go` | `loadRiskMapping()` | 233 |
| 市场状态更新 | `robot_engine.go` | `UpdateMarketState()` | 520 |

---

## 十三、验证检查清单

### ✅ 下单前检查
- [ ] 机器人已绑定策略组（`strategy_group_id > 0`）
- [ ] `CurrentStrategy` JSON 中包含 `marketRiskMapping`
- [ ] 策略模板表中存在对应的记录
- [ ] 市场状态已正确计算（`LastMarketState` 不为空）
- [ ] 风险偏好映射关系正确

### ✅ 下单时检查
- [ ] 策略参数成功加载（日志中有 `从策略模板加载参数`）
- [ ] 策略参数值 > 0（止损、止盈等）
- [ ] 订单记录成功保存（包含策略参数字段）

### ✅ 平仓时检查
- [ ] 订单记录中存在策略参数
- [ ] 策略参数值 > 0
- [ ] 使用订单创建时的参数（不是实时参数）

---

## 十四、常见问题排查

### Q1: 为什么会出现"订单缺少策略参数"错误？

**A**: 可能原因：
1. 下单时策略参数未正确保存到订单记录
2. 策略模板查询失败（`group_id`、`market_state`、`risk_preference` 不匹配）
3. 策略参数值为 0 或负数，未保存到数据库

**排查步骤**：
1. 检查订单记录：`SELECT stop_loss_percent, auto_start_retreat_percent, profit_retreat_percent FROM hg_trading_order WHERE robot_id = ? AND status = 1`
2. 检查策略模板：`SELECT * FROM hg_trading_strategy_template WHERE group_id = ? AND market_state = ? AND risk_preference = ?`
3. 检查日志：查看下单时是否有 `从策略模板加载参数` 的记录

### Q2: 市场状态和风险偏好从哪里获取？

**A**: 
- **市场状态**：实时计算（`LastMarketState` 或 `LastAnalysis.MarketState`）
- **风险偏好**：从映射关系获取（`MarketRiskMapping[marketState]`），映射关系存储在 `CurrentStrategy` JSON 中

### Q3: 策略参数是实时获取还是使用缓存？

**A**: 
- 优先使用缓存（`CurrentStrategyParams`）
- 如果缓存为空或市场状态变化，重新加载
- 下单时如果缓存为空，会立即加载

### Q4: 如果找不到策略模板怎么办？

**A**: 
- 系统会返回详细错误信息
- 列出策略组中所有可用的市场状态和风险偏好组合
- 不会使用默认值，确保数据一致性

