# 方向信号无预警记录问题分析

## 问题描述

**现象**：有方向信号，但是没有预警记录

---

## 一、信号生成流程

### 1.1 信号生成位置 (`robot_engine.go:1334-1367`)

```go
// 有信号时立即保存预警记录
if newSignal != "neutral" {
    // 复制信号副本
    signalCopy := *signal
    
    // 先保存预警记录（简化检查，只做基本验证）
    logId := e.saveSignalAlertSimple(&signalCopy)
    
    // 如果有记录ID，立即尝试下单
    if logId > 0 {
        e.Trader.TryAutoTradeAndUpdate(logCtx, &signalCopy, logId)
    } else {
        // logId = 0，说明未保存预警记录
        g.Log().Debugf(logCtx, "[RobotEngine] 未保存预警记录: robotId=%d, direction=%s, action=%s（可能自动下单未开启）",
            e.Robot.Id, signalCopy.Direction, signalCopy.Action)
    }
}
```

**关键点**：
- 当 `newSignal != "neutral"` 时，会尝试保存预警记录
- 如果 `logId = 0`，说明保存失败

---

## 二、预警记录保存条件 (`saveSignalAlertSimple`)

### 2.1 保存条件检查（已更新）

```go
if robot == nil {
    return 0  // 仅当机器人为空才不保存
}

// 不再依赖 autoTradeEnabled，始终写预警表
```

**当前保存条件**：
1. ✅ `robot != nil` - 机器人对象存在
2. ❌ 不再依赖 `autoTradeEnabled`，即使自动下单关闭也会记录信号

**说明**：
- 预警日志现在只记录信号本身，执行结果写入交易日志
- 因此“自动下单未开启导致不记录”已不成立

---

## 三、可能的原因

### 原因1：机器人对象为空（当前最可能）

**问题**：
- `robot == nil`
- 机器人引擎未正确初始化

**检查方法**：
- 查看日志：是否有 `robot为nil，无法保存预警记录`
- 确认机器人引擎是否正常启动

**解决方案**：
- 重启机器人引擎
- 检查机器人状态和配置

---

### 原因2：机器人对象为空

**问题**：
- `robot == nil`
- 机器人引擎未正确初始化

**检查方法**：
- 查看日志：是否有 `"robot == nil"` 的错误
- 检查机器人引擎是否正常启动

**解决方案**：
- 重启机器人引擎
- 检查机器人状态

---

### 原因3：信号方向未变化（已排除）

**注意**：代码中即使信号方向未变化，也会保存预警记录（`isNewDirection` 只用于日志记录）

---

### 原因4：数据库插入失败

**问题**：
- 数据库连接失败
- 插入语句执行失败

**检查方法**：
- 查看日志：是否有数据库错误
- 检查数据库连接状态

**代码位置** (`robot_engine.go:1436-1455`)：
```go
result, err := g.DB().Model("hg_trading_signal_log").Ctx(ctx).Insert(g.Map{
    "robot_id": e.Robot.Id,
    ...
})
if err != nil {
    g.Log().Warningf(ctx, "[RobotEngine] 保存信号预警失败: robotId=%d, err=%v", e.Robot.Id, err)
    return 0  // 返回0，保存失败
}
```

---

## 四、排查步骤

### 步骤1：检查自动下单开关

**SQL查询**：
```sql
SELECT id, robot_name, auto_trade_enabled, status 
FROM hg_trading_robot 
WHERE id = ?;
```

**检查点**：
- `auto_trade_enabled` 是否为 `1`
- `status` 是否为 `2`（运行中）

---

### 步骤2：查看日志

**查找关键字**：
- `"[RobotEngine] 自动下单未开启，跳过保存预警记录"`
- `"[RobotEngine] 未保存预警记录: robotId=%d, direction=%s, action=%s（可能自动下单未开启）"`
- `"[RobotEngine] 保存信号预警失败"`
- `"[RobotEngine] 检测到信号: newSignal=%s"`

**分析**：
- 如果有 `"自动下单未开启"` → 原因1
- 如果有 `"保存信号预警失败"` → 原因4
- 如果有 `"检测到信号"` 但没有保存 → 原因1或4

---

### 步骤3：检查信号生成

**查找日志**：
- `"[RobotEngine] robotId=%d 检测到信号: newSignal=%s"`
- `"[RobotEngine] robotId=%d 新方向信号: %s"`

**确认**：
- 信号是否真的生成了
- 信号方向是什么（`long`/`short`）

---

### 步骤4：检查数据库

**查询预警记录**：
```sql
SELECT * FROM hg_trading_signal_log 
WHERE robot_id = ? 
ORDER BY created_at DESC 
LIMIT 10;
```

**检查点**：
- 是否有最近的预警记录
- 如果没有，说明确实没有保存

---

## 五、解决方案

### 方案1：开启自动下单（推荐）

**前端操作**：
1. 打开机器人详情页面
2. 找到"自动下单"开关
3. 开启开关（确保显示为"开"状态）

**后端操作**：
```sql
UPDATE hg_trading_robot 
SET auto_trade_enabled = 1 
WHERE id = ?;
```

---

### 方案2：检查机器人状态

**确保机器人运行中**：
```sql
UPDATE hg_trading_robot 
SET status = 2  -- 运行中
WHERE id = ?;
```

---

### 方案3：重启机器人引擎

如果机器人状态正常，但仍有问题：
1. 停止机器人
2. 重新启动机器人
3. 观察日志输出

---

## 六、代码逻辑总结

### 6.1 信号生成 → 预警记录保存流程

```
信号生成 (doSignalGeneration)
  ↓
newSignal != "neutral"?
  ├─ 是 → saveSignalAlertSimple()
  │   ├─ 检查: robot != nil && autoTradeEnabled == 1?
  │   │   ├─ 是 → 保存预警记录 → 返回 logId > 0
  │   │   └─ 否 → 返回 0（不保存）
  │   └─ logId > 0?
  │       ├─ 是 → TryAutoTradeAndUpdate()（尝试下单）
  │       └─ 否 → 记录日志（未保存预警记录）
  │
  └─ 否 → 不保存预警记录
```

### 6.2 关键检查点

| 检查点 | 位置 | 条件 | 失败结果 |
|--------|------|------|---------|
| **自动下单开关** | `saveSignalAlertSimple:1388` | `autoTradeEnabled == 1` | 返回0，不保存 |
| **机器人对象** | `saveSignalAlertSimple:1388` | `robot != nil` | 返回0，不保存 |
| **数据库插入** | `saveSignalAlertSimple:1436` | 插入成功 | 返回0，保存失败 |

---

## 七、常见问题

### Q1: 为什么有信号但没有预警记录？

**A**: 最可能的原因是**自动下单未开启**。系统设计为：只有开启自动下单时，才会保存预警记录。

### Q2: 如何确认自动下单是否开启？

**A**: 
1. 查看数据库：`SELECT auto_trade_enabled FROM hg_trading_robot WHERE id = ?;`
2. 查看前端：机器人卡片上是否有"自动下单"开关，是否显示为"开"
3. 查看日志：是否有 `"自动下单未开启，跳过保存预警记录"` 的日志

### Q3: 开启自动下单后，之前的信号会补保存吗？

**A**: 不会。只有开启自动下单后，新生成的信号才会保存预警记录。

### Q4: 信号生成但未保存预警记录，会影响下单吗？

**A**: 不会。因为预警记录是下单的前提条件，如果没有预警记录，就不会尝试下单。

---

## 八、总结

### 8.1 主要原因

**自动下单未开启**是导致有方向信号但没有预警记录的最主要原因。

### 8.2 检查清单

- [ ] 检查 `robot.auto_trade_enabled` 是否为 `1`
- [ ] 检查机器人状态是否为运行中（`status = 2`）
- [ ] 查看日志确认信号是否生成
- [ ] 查看日志确认是否有保存失败的记录
- [ ] 检查数据库连接是否正常

### 8.3 快速修复

```sql
-- 开启自动下单
UPDATE hg_trading_robot 
SET auto_trade_enabled = 1 
WHERE id = ?;
```

---

## 九、代码位置索引

- **信号生成**：`robot_engine.go:1334-1367`
- **保存预警记录**：`robot_engine.go:1377-1465` (`saveSignalAlertSimple`)
- **自动下单检查**：`robot_engine.go:1388-1391`

