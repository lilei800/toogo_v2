# æ˜ å°„å…³ç³»é—®é¢˜æ’æŸ¥å’Œä¿®å¤æ€»ç»“

## ä¸€ã€é—®é¢˜æè¿°

### é—®é¢˜1ï¼šåˆ›å»ºæœºå™¨äººæ—¶æ˜ å°„å…³ç³»ä¿å­˜é”™è¯¯
- **ç°è±¡**ï¼šç”¨æˆ·é€‰æ‹©"ä½æ³¢åŠ¨--ä¿å®ˆ"ï¼Œä½†æ•°æ®åº“ä¸­å­˜å‚¨çš„æ˜¯ `balanced`
- **åŸå› **ï¼šéœ€è¦æ’æŸ¥å‰ç«¯ä¼ é€’çš„æ•°æ®å’Œåç«¯ä¿å­˜é€»è¾‘

### é—®é¢˜2ï¼šæœºå™¨äººæ ‡é¢˜æ˜¾ç¤º"ä½æ³¢åŠ¨--å¹³è¡¡"ä¸æ­£ç¡®
- **ç°è±¡**ï¼šæœºå™¨äººæ ‡é¢˜åé¢æ˜¾ç¤º"ä½æ³¢åŠ¨--å¹³è¡¡"ï¼Œè€Œä¸æ˜¯"ä½æ³¢åŠ¨--ä¿å®ˆ"
- **åŸå› **ï¼šæ˜¾ç¤ºçš„é£é™©åå¥½æ¥è‡ªæ•°æ®åº“çš„ `RiskPreference` å­—æ®µï¼Œè€Œä¸æ˜¯ä»æ˜ å°„å…³ç³»ä¸­æ ¹æ®å½“å‰å¸‚åœºçŠ¶æ€è·å–

---

## äºŒã€æ•°æ®æµåˆ†æ

### 2.1 åˆ›å»ºæœºå™¨äººæ—¶çš„æ•°æ®æµ

```
å‰ç«¯åˆ›å»ºé¡µé¢ (create.vue)
  â†“ formData.marketRiskMapping = { low_vol: 'conservative' }
  â†“ æäº¤åˆ°åç«¯
åç«¯ Create å‡½æ•° (robot.go)
  â†“ in.MarketRiskMapping
  â†“ æ£€æŸ¥ if in.MarketRiskMapping != nil && len > 0
  â†“ ä¿å­˜åˆ° CurrentStrategy.riskConfig.marketRiskMapping
  â†“ å­˜å‚¨åˆ°æ•°æ®åº“ current_strategy å­—æ®µ
```

**é—®é¢˜ç‚¹**ï¼š
- å¦‚æœå‰ç«¯ä¼ é€’çš„æ˜ å°„å…³ç³»ä¸ºç©ºæˆ–nilï¼Œå°±ä¸ä¼šä¿å­˜æ˜ å°„å…³ç³»
- éœ€è¦æ·»åŠ æ—¥å¿—è°ƒè¯•å‰ç«¯ä¼ é€’çš„æ•°æ®

---

### 2.2 æœºå™¨äººæ ‡é¢˜æ˜¾ç¤ºçš„æ•°æ®æµ

```
å‰ç«¯æ˜¾ç¤º (index.vue:91-96)
  â†“ analysisData[robot.id]?.config?.marketState
  â†“ analysisData[robot.id]?.config?.riskPreference
  â†“ æ¥è‡ªåç«¯ batchRobotAnalysis æ¥å£
åç«¯ buildConfigInfo (monitor.go)
  â†“ config.RiskPreference = robot.RiskPreference âŒ é”™è¯¯ï¼
  â†“ åº”è¯¥ä»æ˜ å°„å…³ç³»è·å–
```

**é—®é¢˜ç‚¹**ï¼š
- `monitor.go:483` ç›´æ¥ä½¿ç”¨ `robot.RiskPreference`
- åº”è¯¥æ ¹æ®å½“å‰å¸‚åœºçŠ¶æ€ï¼Œä»æ˜ å°„å…³ç³»ä¸­è·å–å¯¹åº”çš„é£é™©åå¥½

---

## ä¸‰ã€ä¿®å¤æ–¹æ¡ˆ

### 3.1 ä¿®å¤åˆ›å»ºæœºå™¨äººæ—¶çš„ä¿å­˜é€»è¾‘

**æ–‡ä»¶**ï¼š`server/internal/logic/trading/robot.go`

**ä¿®æ”¹**ï¼š
```go
// é£é™©é…ç½®ï¼ˆåŒ…å«æ˜ å°„å…³ç³»ï¼‰
// ã€é‡è¦ã€‘å§‹ç»ˆä¿å­˜æ˜ å°„å…³ç³»ï¼Œå³ä½¿ä¸ºç©ºä¹Ÿè¦ä¿å­˜ï¼ˆå‰ç«¯å¿…é¡»ä¼ é€’ï¼‰
if in.MarketRiskMapping != nil && len(in.MarketRiskMapping) > 0 {
    strategyConfig["riskConfig"] = map[string]interface{}{
        "marketRiskMapping": in.MarketRiskMapping,
    }
    g.Log().Infof(ctx, "[Robot] åˆ›å»ºæœºå™¨äººæ—¶ä¿å­˜æ˜ å°„å…³ç³»: robotId=%d, mapping=%v", 0, in.MarketRiskMapping)
} else {
    // å¦‚æœå‰ç«¯æ²¡æœ‰ä¼ é€’æ˜ å°„å…³ç³»ï¼Œè®°å½•è­¦å‘Šå¹¶ä½¿ç”¨é»˜è®¤æ˜ å°„
    g.Log().Warningf(ctx, "[Robot] åˆ›å»ºæœºå™¨äººæ—¶æœªä¼ é€’æ˜ å°„å…³ç³»ï¼Œä½¿ç”¨é»˜è®¤æ˜ å°„")
    // ä½¿ç”¨é»˜è®¤æ˜ å°„å…³ç³»
    defaultMapping := map[string]string{
        "trend":    "balanced",
        "volatile": "balanced",
        "high_vol": "aggressive",
        "low_vol":  "conservative",
    }
    strategyConfig["riskConfig"] = map[string]interface{}{
        "marketRiskMapping": defaultMapping,
    }
}
```

**æ”¹è¿›**ï¼š
- âœ… æ·»åŠ æ—¥å¿—è®°å½•æ˜ å°„å…³ç³»
- âœ… å¦‚æœå‰ç«¯æœªä¼ é€’ï¼Œä½¿ç”¨é»˜è®¤æ˜ å°„å¹¶è®°å½•è­¦å‘Š
- âœ… ç¡®ä¿æ˜ å°„å…³ç³»å§‹ç»ˆè¢«ä¿å­˜

---

### 3.2 ä¿®å¤æœºå™¨äººæ ‡é¢˜æ˜¾ç¤ºé€»è¾‘

**æ–‡ä»¶**ï¼š`server/internal/logic/trading/monitor.go`

**ä¿®æ”¹å‰**ï¼š
```go
config.RiskPreference = robot.RiskPreference  // âŒ é”™è¯¯ï¼šä½¿ç”¨æ•°æ®åº“å­—æ®µ
```

**ä¿®æ”¹å**ï¼š
```go
// ã€é‡è¦ã€‘ä½¿ç”¨ GetStatus() æ–¹æ³•è·å–å¼•æ“çŠ¶æ€ï¼ŒåŒ…å«ä»æ˜ å°„å…³ç³»è·å–çš„é£é™©åå¥½
engineStatus := engine.GetStatus()

// ã€é‡è¦ã€‘ä½¿ç”¨ä»æ˜ å°„å…³ç³»è·å–çš„é£é™©åå¥½ï¼ˆåˆ›å»ºæ—¶ä¿å­˜çš„æ˜ å°„å…³ç³»ï¼‰
// è€Œä¸æ˜¯ä½¿ç”¨æ•°æ®åº“çš„ RiskPreference å­—æ®µ
if engineStatus.CurrentRiskPref != "" {
    config.RiskPreference = engineStatus.CurrentRiskPref
}
```

**æœªå¯åŠ¨çš„æœºå™¨äºº**ï¼š
```go
// ä» CurrentStrategy ä¸­è§£ææ˜ å°„å…³ç³»
if robot.CurrentStrategy != "" {
    var strategyData map[string]interface{}
    if err := json.Unmarshal([]byte(robot.CurrentStrategy), &strategyData); err == nil {
        if riskConfig, ok := strategyData["riskConfig"].(map[string]interface{}); ok {
            if mapping, ok := riskConfig["marketRiskMapping"].(map[string]interface{}); ok {
                if pref, ok := mapping[marketState].(string); ok && pref != "" {
                    riskPref = pref  // âœ… ä»æ˜ å°„å…³ç³»è·å–
                }
            }
        }
    }
}
```

**æ”¹è¿›**ï¼š
- âœ… è¿è¡Œä¸­çš„æœºå™¨äººï¼šä½¿ç”¨ `GetStatus()` æ–¹æ³•è·å–ä»æ˜ å°„å…³ç³»è·å–çš„é£é™©åå¥½
- âœ… æœªå¯åŠ¨çš„æœºå™¨äººï¼šä» `CurrentStrategy` ä¸­è§£ææ˜ å°„å…³ç³»
- âœ… ç¡®ä¿æ˜¾ç¤ºçš„é£é™©åå¥½æ¥è‡ªåˆ›å»ºæ—¶ä¿å­˜çš„æ˜ å°„å…³ç³»

---

## å››ã€éªŒè¯æ–¹æ³•

### 4.1 éªŒè¯åˆ›å»ºæ—¶ä¿å­˜çš„æ˜ å°„å…³ç³»

**æ£€æŸ¥æ•°æ®åº“**ï¼š
```sql
SELECT id, robot_name, current_strategy 
FROM hg_trading_robot 
WHERE id = <æœºå™¨äººID>;
```

**æ£€æŸ¥JSONç»“æ„**ï¼š
```json
{
  "groupId": 1,
  "riskConfig": {
    "marketRiskMapping": {
      "low_vol": "conservative"  // âœ… åº”è¯¥æ˜¯ conservative
    }
  }
}
```

---

### 4.2 éªŒè¯å‰ç«¯æ˜¾ç¤º

**æ£€æŸ¥æ—¥å¿—**ï¼š
- åˆ›å»ºæ—¶ï¼š`[Robot] åˆ›å»ºæœºå™¨äººæ—¶ä¿å­˜æ˜ å°„å…³ç³»: mapping={low_vol: conservative}`
- è¿è¡Œæ—¶ï¼š`[Monitor] robotId=X ä»æ˜ å°„å…³ç³»è·å–é£é™©åå¥½: å¸‚åœºçŠ¶æ€=low_vol â†’ é£é™©åå¥½=conservative`

**æ£€æŸ¥å‰ç«¯æ˜¾ç¤º**ï¼š
- æœºå™¨äººæ ‡é¢˜åº”è¯¥æ˜¾ç¤ºï¼š"ä½æ³¢åŠ¨ â†’ ğŸ›¡ï¸ ä¿å®ˆ"
- è€Œä¸æ˜¯ï¼š"ä½æ³¢åŠ¨ â†’ âš–ï¸ å¹³è¡¡"

---

## äº”ã€æ€»ç»“

### 5.1 ä¿®å¤å†…å®¹

1. **åˆ›å»ºæœºå™¨äººæ—¶**ï¼š
   - âœ… æ·»åŠ æ—¥å¿—è®°å½•æ˜ å°„å…³ç³»
   - âœ… å¦‚æœå‰ç«¯æœªä¼ é€’ï¼Œä½¿ç”¨é»˜è®¤æ˜ å°„

2. **æœºå™¨äººæ ‡é¢˜æ˜¾ç¤º**ï¼š
   - âœ… è¿è¡Œä¸­çš„æœºå™¨äººï¼šä½¿ç”¨ `GetStatus()` æ–¹æ³•è·å–ä»æ˜ å°„å…³ç³»è·å–çš„é£é™©åå¥½
   - âœ… æœªå¯åŠ¨çš„æœºå™¨äººï¼šä» `CurrentStrategy` ä¸­è§£ææ˜ å°„å…³ç³»

### 5.2 å…³é”®æ”¹è¿›

- âœ… **å§‹ç»ˆä½¿ç”¨åˆ›å»ºæ—¶çš„æ˜ å°„å…³ç³»**ï¼šä» `CurrentStrategy.riskConfig.marketRiskMapping` è¯»å–
- âœ… **å®æ—¶ç”Ÿæ•ˆ**ï¼šç”¨æˆ·ä¿®æ”¹æ˜ å°„å…³ç³»åï¼Œç«‹å³æ›´æ–°å¼•æ“å¹¶ç”Ÿæ•ˆ
- âœ… **æ­£ç¡®æ˜¾ç¤º**ï¼šæœºå™¨äººæ ‡é¢˜æ˜¾ç¤ºçš„é£é™©åå¥½æ¥è‡ªæ˜ å°„å…³ç³»ï¼Œè€Œä¸æ˜¯æ•°æ®åº“å­—æ®µ

### 5.3 æ•°æ®ä¸€è‡´æ€§

- **åˆ›å»ºæ—¶**ï¼šæ˜ å°„å…³ç³»ä¿å­˜åœ¨ `CurrentStrategy.riskConfig.marketRiskMapping`
- **è¿è¡Œæ—¶**ï¼šå¼•æ“ä» `CurrentStrategy` åŠ è½½æ˜ å°„å…³ç³»åˆ° `MarketRiskMapping`
- **æ˜¾ç¤ºæ—¶**ï¼šå‰ç«¯ä» `analysisData.config.riskPreference` è·å–ï¼ˆæ¥è‡ªæ˜ å°„å…³ç³»ï¼‰

ä¿®å¤å®Œæˆï¼ç°åœ¨ç³»ç»Ÿä¼šæ­£ç¡®ä½¿ç”¨åˆ›å»ºæ—¶ä¿å­˜çš„æ˜ å°„å…³ç³»ï¼Œå¹¶åœ¨æœºå™¨äººæ ‡é¢˜ä¸­æ­£ç¡®æ˜¾ç¤ºã€‚

