# 修复映射关系后血条显示处理方案

## 一、当前血条显示逻辑

### 1.1 血条参数获取方式

**前端实现：** `getOrderStrategyParam()`

**优先级顺序：**
1. **订单记录中的参数**（下单时保存的）
   - `pos.stopLossPercent` 或 `pos.stop_loss_percent`
   - `pos.autoStartRetreatPercent` 或 `pos.auto_start_retreat_percent`
   - `pos.profitRetreatPercent` 或 `pos.profit_retreat_percent`
   - `pos.marginPercent` 或 `pos.margin_percent`
2. **如果订单中没有，返回 null**（不使用数据库静态值）

**关键原则：**
- ✅ **只使用订单创建时的参数**
- ✅ **永远不使用数据库静态值**
- ✅ **如果订单中没有参数时返回 null**

### 1.2 血条计算函数

#### 止损血条（calcStopLossProgress）
- **参数来源：** 订单记录中的 `stopLossPercent`
- **计算公式：** `|未实现盈亏| / (保证金 × 止损百分比) × 100%`
- **显示逻辑：** 只有亏损时才显示，达到100%时触发止损

#### 启动止盈血条（calcStartProfitProgress）
- **参数来源：** 订单记录中的 `autoStartRetreatPercent`
- **计算公式：** `(未实现盈亏 / 保证金) / 设定百分比 × 100%`
- **显示逻辑：** 只有盈利时才显示，达到100%时启动止盈，启动后永远保持100%

#### 止盈回撤血条（calcProfitRetreatProgress）
- **参数来源：** 订单记录中的 `profitRetreatPercent`
- **计算公式：** `100% - (当前回撤百分比 / 设定回撤百分比) × 100%`
- **显示逻辑：** 只有启动止盈后才计算，从100%开始减少，达到0%时触发止盈

---

## 二、修复映射关系后的影响分析

### 2.1 下单时的变化

**修复前：**
- 直接使用 `Robot.RiskPreference`（机器人配置的风险偏好）
- 忽略映射关系

**修复后：**
- 根据实时市场状态，通过映射关系自动选择风险偏好
- 根据市场状态 + 风险偏好查找策略模板
- 加载策略参数并保存到订单记录

**关键点：**
- ✅ 下单时会保存**正确的策略参数**到订单记录
- ✅ 策略参数来自**下单时的市场状态和映射关系**

### 2.2 血条显示的变化

**修复前：**
- 如果订单记录中有参数，使用订单记录中的参数 ✅
- 如果订单记录中没有参数，返回 null，血条显示0或100 ✅

**修复后：**
- ✅ **逻辑不变**：仍然优先使用订单记录中的参数
- ✅ **数据更准确**：下单时会保存正确的策略参数（基于映射关系）

**结论：** 血条显示逻辑**不需要改变**，因为：
1. 血条已经优先使用订单记录中的参数
2. 修复后，订单记录中的参数会更准确（基于映射关系）
3. 订单记录中的参数是固定的，不会因为市场状态变化而变化

---

## 三、处理方案

### 3.1 血条显示逻辑（无需修改）✅

**当前实现已经符合要求：**

```typescript
// 获取订单创建时的策略参数（只使用订单创建时的参数）
const getOrderStrategyParam = (pos: any, paramName: string, robotId: number, fallbackGetter: (id: number) => number | null): number | null => {
  // 优先使用订单记录中的参数
  let value = pos[camelCaseName] || pos[snakeCaseName];
  
  // 如果订单中有参数且有效，返回参数
  if (value !== undefined && value !== null && typeof value === 'number' && value > 0) {
    return value;
  }
  
  // 如果订单中没有参数，返回 null（不使用数据库静态值）
  return null;
};
```

**优点：**
- ✅ 只使用订单创建时的参数，确保一致性
- ✅ 不依赖实时市场状态，避免参数变化
- ✅ 符合用户理解：平仓时使用订单自带的参数

### 3.2 下单时保存策略参数（需要确保）✅

**当前实现：** `recordOrder()` 函数已经保存策略参数

**需要确保：**
1. ✅ 下单时调用 `recordOrder()` 保存策略参数
2. ✅ 策略参数来自 `CurrentStrategyParams`（基于映射关系）
3. ✅ 保存的字段包括：
   - `stop_loss_percent`
   - `auto_start_retreat_percent`
   - `profit_retreat_percent`
   - `margin_percent`

**修复映射关系后的改进：**
- ✅ 策略参数会更准确（基于实时市场状态和映射关系）
- ✅ 订单记录中的参数会反映下单时的实际策略

### 3.3 后端返回订单参数（需要确保）✅

**当前实现：** `GetRobotPositions()` 函数已经返回订单参数

**需要确保：**
1. ✅ 查询订单记录时，包含策略参数字段
2. ✅ 如果订单记录中没有参数，尝试从策略模板获取（降级策略）
3. ✅ 返回给前端的字段名使用驼峰命名（`stopLossPercent`）

**修复映射关系后的改进：**
- ✅ 订单记录中的参数会更准确
- ✅ 降级策略仍然有效（如果订单中没有参数）

---

## 四、修复映射关系后的完整流程

### 4.1 下单流程

```
1. 市场分析（doAnalysis）
   ↓
2. 检测市场状态变化（checkAndUpdateStrategyConfig）
   ↓
3. 根据映射关系获取风险偏好（MarketRiskMapping[marketState]）
   ↓
4. 加载策略参数（loadFullStrategyParams）
   - 根据策略组ID + 市场状态 + 风险偏好查找策略模板
   ↓
5. 信号生成（doSignalGeneration）
   ↓
6. 下单预警触发（saveSignalAlert）
   ↓
7. 执行下单（executeOpen）
   - 使用 CurrentStrategyParams（基于映射关系）
   ↓
8. 保存订单记录（recordOrder）
   - 保存策略参数到订单表：
     * stop_loss_percent
     * auto_start_retreat_percent
     * profit_retreat_percent
     * margin_percent
```

### 4.2 血条显示流程

```
1. 前端获取订单列表（GetRobotPositions）
   ↓
2. 订单记录包含策略参数（下单时保存的）
   ↓
3. 血条计算函数（calcStopLossProgress等）
   - 调用 getOrderStrategyParam()
   - 优先使用订单记录中的参数
   ↓
4. 显示血条进度
   - 基于订单记录中的参数计算
   - 不受实时市场状态影响
```

---

## 五、关键原则

### 5.1 血条显示原则

1. **只使用订单创建时的参数**
   - ✅ 确保血条显示的是下单时使用的实际参数
   - ✅ 不受市场状态变化影响

2. **不使用数据库静态值**
   - ✅ 如果订单中没有参数，返回 null
   - ✅ 血条显示0或100（表示参数无效）

3. **不依赖实时策略参数**
   - ✅ 血条不依赖 `CurrentStrategyParams`
   - ✅ 血条不依赖实时市场状态
   - ✅ 血条不依赖映射关系

### 5.2 下单时保存参数原则

1. **保存实际使用的参数**
   - ✅ 保存 `CurrentStrategyParams` 中的参数
   - ✅ 这些参数基于实时市场状态和映射关系

2. **确保参数完整性**
   - ✅ 保存所有必要的策略参数
   - ✅ 包括：止损、启动止盈、止盈回撤、保证金比例

3. **参数格式统一**
   - ✅ 使用数据库字段名（下划线命名）
   - ✅ 返回前端时转换为驼峰命名

---

## 六、修复映射关系后的优势

### 6.1 数据准确性提升

**修复前：**
- 下单时可能使用错误的策略参数（忽略映射关系）
- 订单记录中的参数可能不准确

**修复后：**
- ✅ 下单时使用正确的策略参数（基于映射关系）
- ✅ 订单记录中的参数更准确
- ✅ 血条显示更准确

### 6.2 一致性保证

**修复前：**
- 下单时使用的参数和订单记录中的参数可能不一致

**修复后：**
- ✅ 下单时使用的参数和订单记录中的参数一致
- ✅ 血条显示和实际平仓逻辑一致

### 6.3 用户体验提升

**修复前：**
- 用户配置的映射关系无效
- 血条可能显示不准确

**修复后：**
- ✅ 用户配置的映射关系生效
- ✅ 血条显示准确反映订单状态

---

## 七、总结

### 7.1 血条显示逻辑

**结论：** ✅ **无需修改**

**原因：**
1. 当前实现已经优先使用订单记录中的参数
2. 修复映射关系后，订单记录中的参数会更准确
3. 血条显示逻辑符合用户理解：使用订单自带的参数

### 7.2 需要确保的事项

1. ✅ **下单时保存策略参数**
   - 确保 `recordOrder()` 函数正确保存策略参数
   - 策略参数来自 `CurrentStrategyParams`（基于映射关系）

2. ✅ **后端返回订单参数**
   - 确保订单记录中包含所有必要的策略参数字段
   - 字段名使用下划线命名（数据库格式）

3. ✅ **后端返回订单参数**
   - 确保 `GetRobotPositions()` 返回订单参数
   - 字段名使用驼峰命名（前端格式）

### 7.3 修复映射关系后的效果

1. ✅ **下单时：** 根据实时市场状态和映射关系选择策略模板，保存正确的策略参数
2. ✅ **血条显示：** 使用订单记录中的参数，准确反映订单状态
3. ✅ **平仓时：** 使用订单记录中的参数，确保一致性

---

## 八、实施建议

### 8.1 无需修改的部分

1. ✅ 前端血条计算函数（`calcStopLossProgress` 等）
2. ✅ 前端参数获取函数（`getOrderStrategyParam`）
3. ✅ 后端订单记录保存函数（`recordOrder`）
4. ✅ 后端订单查询函数（`GetRobotPositions`）

### 8.2 需要修复的部分

1. ⚠️ **实现映射关系加载**（`loadRiskConfigFromRobot`）
2. ⚠️ **修改市场状态更新逻辑**（`checkAndUpdateStrategyConfig`）
3. ⚠️ **修改下单逻辑**（`executeOpen`）

### 8.3 验证事项

修复后需要验证：
1. ✅ 下单时策略参数是否正确保存到订单记录
2. ✅ 血条显示是否使用订单记录中的参数
3. ✅ 市场状态变化时，新订单是否使用新的策略参数
4. ✅ 已开仓订单的血条是否不受市场状态变化影响

---

## 九、结论

**血条显示逻辑不需要修改**，因为：

1. ✅ 当前实现已经符合要求（优先使用订单记录中的参数）
2. ✅ 修复映射关系后，订单记录中的参数会更准确
3. ✅ 血条显示逻辑与用户理解一致（使用订单自带的参数）

**只需要确保：**
- ✅ 下单时正确保存策略参数（基于映射关系）
- ✅ 后端正确返回订单参数
- ✅ 前端正确使用订单参数

**修复映射关系后，血条显示会更准确，但逻辑不需要改变。**

