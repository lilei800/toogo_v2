# æ­¢ç›ˆå›æ’¤é—®é¢˜åˆ†æ

## é—®é¢˜æè¿°
**å¯åŠ¨æ­¢ç›ˆå›æ’¤æŒ‰é’®å·²ç»å¼€å¯ï¼Œæ­¢ç›ˆå›æ’¤è¡€æ¡å·²ç»å›æ’¤åˆ°0%ï¼Œæ­¢ç›ˆå›æ’¤çš„å€¼å·²ç»å’Œè®¾ç½®çš„ä¸€è‡´ï¼Œä¸ºä»€ä¹ˆä¸æ­¢ç›ˆï¼Ÿ**

## ä»£ç ä½ç½®
`server/internal/logic/toogo/robot_engine.go` - `checkTakeProfitAndClose` å‡½æ•°ï¼ˆç¬¬1876-2066è¡Œï¼‰

---

## ğŸ” é—®é¢˜åˆ†æ

### 1. **å›æ’¤ç™¾åˆ†æ¯”è®¡ç®—**ï¼ˆç¬¬2019è¡Œï¼‰

```go
currentRetreatPercent := ((tracker.HighestProfit - realTimeUnrealizedPnl) / tracker.HighestProfit) * 100.0
```

**å…¬å¼**ï¼š`(æœ€é«˜ç›ˆåˆ© - å½“å‰ç›ˆåˆ©) / æœ€é«˜ç›ˆåˆ© Ã— 100%`

### 2. **è¡€æ¡ç™¾åˆ†æ¯”è®¡ç®—**ï¼ˆç¬¬2022è¡Œï¼‰

```go
bloodBarPercent := 100.0 - (currentRetreatPercent/profitRetreatPercent)*100.0
if bloodBarPercent < 0 {
    bloodBarPercent = 0
}
```

**å…¬å¼**ï¼š`100% - (å›æ’¤ç™¾åˆ†æ¯” / è®¾å®šé˜ˆå€¼) Ã— 100%`

**å½“è¡€æ¡ä¸º0%æ—¶**ï¼š
- `bloodBarPercent = 0`
- `100.0 - (currentRetreatPercent/profitRetreatPercent)*100.0 = 0`
- `currentRetreatPercent/profitRetreatPercent = 1`
- `currentRetreatPercent >= profitRetreatPercent` âœ…

### 3. **è§¦å‘æ¡ä»¶**ï¼ˆç¬¬2053è¡Œï¼‰

```go
if currentRetreatPercent >= profitRetreatPercent {
    // æ‰§è¡Œå¹³ä»“
    e.executeTakeProfitCloseByPosition(ctx, pos, "take_profit")
}
```

---

## ğŸ› å¯èƒ½çš„é—®é¢˜

### é—®é¢˜1ï¼šæµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ âš ï¸

**åœºæ™¯**ï¼š
- `currentRetreatPercent = 10.0000001%`
- `profitRetreatPercent = 10.0%`
- ç†è®ºä¸Šåº”è¯¥è§¦å‘ï¼Œä½†ç”±äºæµ®ç‚¹æ•°ç²¾åº¦ï¼Œå¯èƒ½ä¸æ»¡è¶³ `>=` æ¡ä»¶

**éªŒè¯**ï¼šä»£ç ä¸­ä½¿ç”¨äº† `>=`ï¼Œç†è®ºä¸Šåº”è¯¥æ²¡é—®é¢˜ï¼Œä½†å¯èƒ½å­˜åœ¨ç²¾åº¦è¯¯å·®

### é—®é¢˜2ï¼šå›æ’¤ç™¾åˆ†æ¯”å¼‚å¸¸å¤§è¢«è·³è¿‡ âš ï¸âš ï¸âš ï¸

**ç¬¬2044-2048è¡Œ**ï¼š
```go
if currentRetreatPercent > 200 {
    g.Log().Warningf(ctx, "[RobotEngine] robotId=%d å›æ’¤ç™¾åˆ†æ¯”å¼‚å¸¸å¤§: %.2f%%ï¼ˆå½“å‰ç›ˆäº=%.4f, æœ€é«˜ç›ˆåˆ©=%.4fï¼‰ï¼Œè·³è¿‡æ£€æŸ¥",
        e.Robot.Id, currentRetreatPercent, realTimeUnrealizedPnl, tracker.HighestProfit)
    continue  // âš ï¸ è·³è¿‡æ£€æŸ¥ï¼Œä¸ä¼šè§¦å‘æ­¢ç›ˆ
}
```

**é—®é¢˜**ï¼š
- å¦‚æœ `currentRetreatPercent > 200%`ï¼Œä¼šç›´æ¥è·³è¿‡ï¼Œä¸ä¼šè§¦å‘æ­¢ç›ˆ
- è¿™é€šå¸¸å‘ç”Ÿåœ¨ä»ç›ˆåˆ©å˜ä¸ºäºæŸçš„æƒ…å†µ
- **ä½†æ˜¯**ï¼Œå¦‚æœç”¨æˆ·è®¾ç½®çš„å›æ’¤é˜ˆå€¼å¾ˆå¤§ï¼ˆæ¯”å¦‚50%ï¼‰ï¼Œè€Œå®é™…å›æ’¤è¾¾åˆ°äº†200%ï¼Œå°±ä¼šè¢«è·³è¿‡

**ç¤ºä¾‹**ï¼š
- è®¾å®šå›æ’¤é˜ˆå€¼ï¼š`profitRetreatPercent = 50%`
- æœ€é«˜ç›ˆåˆ©ï¼š`HighestProfit = 100 USDT`
- å½“å‰ç›ˆåˆ©ï¼š`realTimeUnrealizedPnl = -100 USDT`ï¼ˆäºæŸï¼‰
- å›æ’¤ç™¾åˆ†æ¯”ï¼š`currentRetreatPercent = ((100 - (-100)) / 100) Ã— 100% = 200%`
- ç»“æœï¼š`200% > 50%`ï¼Œåº”è¯¥è§¦å‘ï¼Œä½†å› ä¸º `200% > 200`ï¼Œè¢«è·³è¿‡ âŒ

### é—®é¢˜3ï¼šæœ€é«˜ç›ˆåˆ©æœªåˆå§‹åŒ– âš ï¸

**ç¬¬2011-2015è¡Œ**ï¼š
```go
if tracker.HighestProfit <= 0.001 {
    g.Log().Warningf(ctx, "[RobotEngine] robotId=%d æ­¢ç›ˆå›æ’¤å·²å¯åŠ¨ä½†æœ€é«˜ç›ˆåˆ©æœªåˆå§‹åŒ–ï¼ˆ<=0.001ï¼‰ï¼Œç­‰å¾…ç›ˆåˆ©å‡ºç°: positionSide=%s, currentPnl=%.4f, highestProfit=%.4f",
        e.Robot.Id, pos.PositionSide, realTimeUnrealizedPnl, tracker.HighestProfit)
    continue  // âš ï¸ è·³è¿‡æ£€æŸ¥
}
```

**é—®é¢˜**ï¼š
- å¦‚æœ `HighestProfit <= 0.001`ï¼Œä¼šè·³è¿‡æ£€æŸ¥
- ä½†ç”¨æˆ·è¯´è¡€æ¡å·²ç»å›æ’¤åˆ°0%ï¼Œè¯´æ˜æœ€é«˜ç›ˆåˆ©åº”è¯¥æ˜¯æœ‰æ•ˆçš„

### é—®é¢˜4ï¼šå›æ’¤ç™¾åˆ†æ¯”ä¸ºè´Ÿæ•°è¢«è·³è¿‡ âš ï¸

**ç¬¬2034-2040è¡Œ**ï¼š
```go
if currentRetreatPercent < 0 {
    // å½“å‰ç›ˆåˆ©è¶…è¿‡äº†æœ€é«˜ç›ˆåˆ©ï¼Œæ›´æ–°æœ€é«˜ç›ˆåˆ©
    tracker.HighestProfit = realTimeUnrealizedPnl
    continue  // âš ï¸ è·³è¿‡æ£€æŸ¥
}
```

**é—®é¢˜**ï¼š
- å¦‚æœ `currentRetreatPercent < 0`ï¼ˆå½“å‰ç›ˆåˆ©è¶…è¿‡æœ€é«˜ç›ˆåˆ©ï¼‰ï¼Œä¼šæ›´æ–°æœ€é«˜ç›ˆåˆ©å¹¶è·³è¿‡
- è¿™æ˜¯æ­£å¸¸çš„é€»è¾‘ï¼Œä¸åº”è¯¥è§¦å‘æ­¢ç›ˆ

---

## ğŸ’¡ æœ€å¯èƒ½çš„åŸå› 

æ ¹æ®ç”¨æˆ·æè¿°ï¼š"æ­¢ç›ˆå›æ’¤è¡€æ¡å·²ç»å›æ’¤åˆ°0%ï¼Œæ­¢ç›ˆå›æ’¤çš„å€¼å·²ç»å’Œè®¾ç½®çš„ä¸€è‡´"

**æœ€å¯èƒ½çš„é—®é¢˜**ï¼š**å›æ’¤ç™¾åˆ†æ¯”å¼‚å¸¸å¤§è¢«è·³è¿‡**ï¼ˆé—®é¢˜2ï¼‰

**åœºæ™¯**ï¼š
1. ç”¨æˆ·æ‰‹åŠ¨å¯åŠ¨äº†æ­¢ç›ˆå›æ’¤
2. å½“æ—¶å¯èƒ½å¤„äºäºæŸçŠ¶æ€ï¼Œ`HighestProfit` è¢«è®¾ç½®ä¸ºä¸€ä¸ªå¾ˆå°çš„å€¼ï¼ˆæ¯”å¦‚0.0001ï¼‰
3. åæ¥ä»·æ ¼å›å‡ï¼Œ`realTimeUnrealizedPnl` å˜ä¸ºæ­£å€¼
4. ä½† `HighestProfit` æ²¡æœ‰åŠæ—¶æ›´æ–°ï¼ˆå› ä¸ºä»£ç é€»è¾‘é—®é¢˜ï¼‰
5. å½“å›æ’¤å‘ç”Ÿæ—¶ï¼Œ`currentRetreatPercent` è®¡ç®—å‡ºæ¥éå¸¸å¤§ï¼ˆ>200%ï¼‰
6. è¢«ç¬¬2044è¡Œçš„æ£€æŸ¥è·³è¿‡ï¼Œä¸ä¼šè§¦å‘æ­¢ç›ˆ

**æˆ–è€…**ï¼š
1. ç”¨æˆ·æ‰‹åŠ¨å¯åŠ¨äº†æ­¢ç›ˆå›æ’¤
2. `HighestProfit` è¢«æ­£ç¡®åˆå§‹åŒ–
3. ä½†åæ¥ä»·æ ¼å¤§å¹…æ³¢åŠ¨ï¼Œå¯¼è‡´ `currentRetreatPercent > 200%`
4. è¢«è·³è¿‡

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤å›æ’¤ç™¾åˆ†æ¯”å¼‚å¸¸å¤§çš„åˆ¤æ–­é€»è¾‘ï¼ˆæ¨èï¼‰

**é—®é¢˜**ï¼šå½“å›æ’¤ç™¾åˆ†æ¯” > 200% æ—¶ï¼Œåº”è¯¥è§¦å‘æ­¢ç›ˆï¼Œè€Œä¸æ˜¯è·³è¿‡

**ä¿®å¤**ï¼š
```go
// ã€ä¿®å¤ã€‘å¦‚æœå›æ’¤ç™¾åˆ†æ¯”å¼‚å¸¸å¤§ï¼ˆ>200%ï¼‰ï¼Œåº”è¯¥è§¦å‘æ­¢ç›ˆï¼Œè€Œä¸æ˜¯è·³è¿‡
if currentRetreatPercent > 200 {
    // å›æ’¤å¼‚å¸¸å¤§ï¼Œè¯´æ˜ä»ç›ˆåˆ©å¤§å¹…å›æ’¤åˆ°äºæŸï¼Œåº”è¯¥ç«‹å³æ­¢ç›ˆ
    g.Log().Warningf(ctx, "[RobotEngine] robotId=%d å›æ’¤ç™¾åˆ†æ¯”å¼‚å¸¸å¤§: %.2f%%ï¼ˆå½“å‰ç›ˆäº=%.4f, æœ€é«˜ç›ˆåˆ©=%.4fï¼‰ï¼Œç«‹å³è§¦å‘æ­¢ç›ˆ",
        e.Robot.Id, currentRetreatPercent, realTimeUnrealizedPnl, tracker.HighestProfit)
    e.executeTakeProfitCloseByPosition(ctx, pos, "take_profit")
    continue
}
```

### æ–¹æ¡ˆ2ï¼šæ”¹è¿›æœ€é«˜ç›ˆåˆ©çš„æ›´æ–°é€»è¾‘

**é—®é¢˜**ï¼šæ‰‹åŠ¨å¯åŠ¨æ­¢ç›ˆæ—¶ï¼Œ`HighestProfit` å¯èƒ½æ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–

**ä¿®å¤**ï¼š
```go
// ã€ä¿®å¤ã€‘å¦‚æœåˆšæ‰‹åŠ¨å¯åŠ¨æ­¢ç›ˆï¼ˆHighestProfitå¾ˆå°ï¼‰ï¼Œéœ€è¦ç”¨å½“å‰ç›ˆäºåˆå§‹åŒ–
if tracker.HighestProfit <= 0.001 {
    if realTimeUnrealizedPnl > 0 {
        // å½“å‰æœ‰ç›ˆåˆ©ï¼Œç”¨å½“å‰ç›ˆåˆ©åˆå§‹åŒ–
        tracker.HighestProfit = realTimeUnrealizedPnl
        g.Log().Infof(ctx, "[RobotEngine] robotId=%d åˆå§‹åŒ–æ­¢ç›ˆæœ€é«˜ç›ˆåˆ©: positionSide=%s, highestProfit=%.4f",
            e.Robot.Id, pos.PositionSide, tracker.HighestProfit)
    } else {
        // å½“å‰äºæŸï¼Œç­‰å¾…ç›ˆåˆ©å‡ºç°
        g.Log().Warningf(ctx, "[RobotEngine] robotId=%d æ­¢ç›ˆå›æ’¤å·²å¯åŠ¨ä½†å½“å‰äºæŸï¼Œç­‰å¾…ç›ˆåˆ©å‡ºç°: positionSide=%s, currentPnl=%.4f",
            e.Robot.Id, pos.PositionSide, realTimeUnrealizedPnl)
        continue
    }
}
```

### æ–¹æ¡ˆ3ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥

**ä¿®å¤**ï¼š
```go
// ã€è°ƒè¯•ã€‘è¾“å‡ºè¯¦ç»†çš„è§¦å‘æ¡ä»¶æ£€æŸ¥
g.Log().Infof(ctx, "[RobotEngine] robotId=%d ã€æ­¢ç›ˆè§¦å‘æ£€æŸ¥ã€‘positionSide=%s, currentRetreatPercent=%.6f%%, profitRetreatPercent=%.6f%%, æ˜¯å¦æ»¡è¶³æ¡ä»¶=%v, æ˜¯å¦è·³è¿‡å¼‚å¸¸å¤§=%v",
    e.Robot.Id, pos.PositionSide, currentRetreatPercent, profitRetreatPercent, 
    currentRetreatPercent >= profitRetreatPercent, currentRetreatPercent > 200)
```

---

## ğŸ“‹ å»ºè®®çš„ä¿®å¤ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§**ï¼šä¿®å¤å›æ’¤ç™¾åˆ†æ¯”å¼‚å¸¸å¤§çš„åˆ¤æ–­é€»è¾‘ï¼ˆæ–¹æ¡ˆ1ï¼‰
   - è¿™æ˜¯æœ€å¯èƒ½å¯¼è‡´ä¸æ­¢ç›ˆçš„åŸå› 
   - å½±å“æœ€ç›´æ¥

2. **ä¸­ä¼˜å…ˆçº§**ï¼šæ”¹è¿›æœ€é«˜ç›ˆåˆ©çš„æ›´æ–°é€»è¾‘ï¼ˆæ–¹æ¡ˆ2ï¼‰
   - ç¡®ä¿æ‰‹åŠ¨å¯åŠ¨æ—¶æ­£ç¡®åˆå§‹åŒ–

3. **ä½ä¼˜å…ˆçº§**ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—ï¼ˆæ–¹æ¡ˆ3ï¼‰
   - ä¾¿äºåç»­æ’æŸ¥é—®é¢˜

---

## ğŸ” æ’æŸ¥æ­¥éª¤

1. **æŸ¥çœ‹æ—¥å¿—**ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ "å›æ’¤ç™¾åˆ†æ¯”å¼‚å¸¸å¤§" çš„è­¦å‘Šæ—¥å¿—
2. **æ£€æŸ¥æ•°æ®**ï¼šç¡®è®¤ `HighestProfit` å’Œ `realTimeUnrealizedPnl` çš„å€¼
3. **éªŒè¯è®¡ç®—**ï¼šæ‰‹åŠ¨è®¡ç®— `currentRetreatPercent`ï¼Œçœ‹æ˜¯å¦ > 200%
4. **æ£€æŸ¥æ¡ä»¶**ï¼šç¡®è®¤ `currentRetreatPercent >= profitRetreatPercent` æ˜¯å¦æ»¡è¶³










