# 机器人策略调用流程说明（产品版）

## 一、机器人生命周期概览

```
创建机器人 → 启动机器人 → 运行交易 → 停止机器人
     ↓            ↓            ↓            ↓
  绑定策略组   初始化引擎   调用策略参数   清理资源
```

---

## 二、详细流程说明

### 2.1 创建机器人阶段

**时间点：** 用户在页面上点击"创建机器人"按钮

**流程：**

1. **选择策略组**
   - 用户从"我的策略"或"官方策略"中选择一个策略组
   - 系统保存策略组ID到机器人记录中
   - **作用：** 后续运行时，系统会根据这个策略组ID查找对应的策略模板

2. **配置市场状态与风险偏好映射关系**
   - 用户在"市场状态与风险偏好映射"中配置：
     - 趋势市场 → 平衡型
     - 震荡市场 → 平衡型
     - 高波动市场 → 激进型
     - 低波动市场 → 保守型
   - 系统将这些映射关系保存到机器人的配置中
   - **作用：** 运行时，系统会根据实时市场状态自动选择对应的风险偏好

3. **保存机器人配置**
   - 系统将机器人的所有配置保存到数据库
   - 包括：机器人名称、API配置、策略组ID、映射关系等

**关键数据：**
- **策略组ID：** 用于查找策略模板的唯一标识
- **映射关系：** 市场状态自动切换风险偏好的规则

---

### 2.2 启动机器人阶段

**时间点：** 用户点击"启动"按钮，或到达定时启动时间

**流程：**

1. **系统检测到机器人需要启动**
   - 系统每5秒检查一次数据库，查找所有"运行中"状态的机器人
   - 如果发现新机器人需要启动，开始初始化

2. **初始化机器人引擎**
   - 系统创建机器人的"大脑"（引擎）
   - 加载机器人的配置信息
   - 连接交易所API
   - 订阅市场行情数据

3. **启动主循环**
   - 系统开始每500毫秒执行一次循环任务：
     - 分析市场状态
     - 生成交易信号
     - 检查是否需要开仓或平仓

**关键功能：**
- **引擎：** 机器人的"大脑"，负责所有交易决策
- **主循环：** 持续运行的监控和交易检查机制

---

### 2.3 运行阶段 - 策略调用详解

#### 3.1 市场分析（每500毫秒执行一次）

**目的：** 分析当前市场是趋势、震荡、高波动还是低波动

**流程：**

1. **获取市场数据**
   - 系统从交易所获取最新的价格数据
   - 获取K线数据（5分钟、15分钟、1小时等）

2. **执行市场分析**
   - 系统分析价格走势、波动率等指标
   - 判断当前市场状态：
     - **趋势市场：** 价格有明显方向性
     - **震荡市场：** 价格在区间内波动
     - **高波动市场：** 价格剧烈波动
     - **低波动市场：** 价格变化缓慢

3. **检测市场状态变化**
   - 如果市场状态发生变化（例如：从趋势变为震荡）
   - 系统会触发策略参数更新

4. **加载策略参数**
   - 系统根据以下信息查找策略模板：
     - **策略组ID：** 创建时选择的策略组
     - **市场状态：** 当前分析出的市场状态（趋势/震荡/高波动/低波动）
     - **风险偏好：** 根据映射关系自动选择的风险偏好
   - 从策略模板中加载以下参数：
     - **时间窗口：** 监控价格的时间范围（秒）
     - **波动阈值：** 触发信号的波动幅度（USDT）
     - **杠杆倍数：** 使用的杠杆（例如：10倍）
     - **保证金比例：** 使用的保证金比例（例如：10%）
     - **止损百分比：** 亏损多少时平仓（例如：10%）
     - **启动止盈百分比：** 盈利多少时开启止盈（例如：5%）
     - **止盈回撤百分比：** 盈利回撤多少时平仓（例如：10%）

5. **更新策略参数缓存**
   - 系统将加载的策略参数保存到内存中
   - 后续下单时会直接使用这些参数

**关键点：**
- **策略模板：** 每个策略组包含12种策略模板（4种市场状态 × 3种风险偏好）
- **自动匹配：** 系统根据市场状态和风险偏好自动匹配对应的策略模板
- **实时更新：** 市场状态变化时，策略参数会自动更新

---

#### 3.2 信号生成（每500毫秒执行一次）

**目的：** 根据价格窗口判断是否应该开仓

**流程：**

1. **收集价格数据**
   - 系统持续收集实时价格数据
   - 维护一个"价格窗口"（例如：最近60秒的价格）

2. **计算窗口内最高价和最低价**
   - 系统找出价格窗口内的最高价和最低价
   - 计算当前价格与最高价、最低价的距离

3. **判断是否触发信号**
   - **做多信号：** 当前价格 - 最低价 ≥ 波动阈值
   - **做空信号：** 最高价 - 当前价格 ≥ 波动阈值
   - **使用参数：** 时间窗口和波动阈值来自策略模板

4. **保存信号记录**
   - 如果触发了信号，系统会保存一条信号记录
   - 记录包括：信号方向、触发价格、市场状态等

5. **尝试自动下单**
   - 如果开启了"自动下单"功能
   - 系统会检查是否满足下单条件，如果满足则执行下单

**关键点：**
- **价格窗口：** 使用策略模板中的"时间窗口"参数
- **波动阈值：** 使用策略模板中的"波动阈值"参数
- **信号触发：** 价格波动达到阈值时触发交易信号

---

#### 3.3 开仓执行（当信号触发且满足条件时）

**目的：** 根据策略参数执行开仓操作

**流程：**

1. **检查策略参数是否已加载**
   - 系统检查内存中是否有策略参数
   - 如果没有，会根据当前市场状态和风险偏好重新加载

2. **获取策略参数**
   - 系统从内存中获取已加载的策略参数：
     - **杠杆倍数：** 例如10倍
     - **保证金比例：** 例如10%
     - **止损百分比：** 例如10%
     - **启动止盈百分比：** 例如5%
     - **止盈回撤百分比：** 例如10%

3. **计算下单数量**
   - 系统根据以下公式计算：
     - 可用保证金 = 账户余额 × 保证金比例
     - 下单数量 = (可用保证金 × 杠杆倍数) ÷ 当前价格
   - 例如：账户余额100 USDT，保证金比例10%，杠杆10倍，BTC价格100000 USDT
     - 可用保证金 = 100 × 10% = 10 USDT
     - 下单数量 = (10 × 10) ÷ 100000 = 0.001 BTC

4. **执行下单**
   - 系统向交易所发送下单请求
   - 订单包括：交易对、方向（做多/做空）、数量、杠杆等

5. **保存订单记录**
   - 系统将订单信息保存到数据库
   - **重要：** 同时保存策略参数到订单记录中：
     - 止损百分比
     - 启动止盈百分比
     - 止盈回撤百分比
     - 保证金比例
   - **作用：** 后续平仓时，优先使用订单记录中的策略参数

6. **更新内存持仓信息**
   - 系统立即更新内存中的持仓信息
   - 避免下次检查时误判为没有持仓

**关键点：**
- **策略参数来源：** 从策略模板中加载，根据市场状态和风险偏好自动匹配
- **参数保存：** 下单时保存策略参数到订单记录，确保后续平仓时使用正确的参数
- **实时更新：** 开仓后立即更新内存持仓，避免重复下单

---

#### 3.4 平仓执行（持续检查持仓盈亏）

**目的：** 根据策略参数判断是否应该平仓

**流程：**

1. **持续监控持仓盈亏**
   - 系统每500毫秒检查一次持仓的盈亏情况
   - 获取当前持仓的未实现盈亏

2. **获取策略参数（优先级顺序）**
   - **优先级1：** 从订单记录中获取（下单时保存的策略参数）
   - **优先级2：** 从策略模板中获取（如果订单记录中没有）
   - **优先级3：** 从机器人配置中获取（如果策略模板中没有）
   - **作用：** 确保使用下单时的策略参数，而不是最新的策略参数

3. **判断是否应该平仓**
   - **止损判断：** 
     - 计算：|亏损金额| ÷ (保证金 × 止损百分比) ≥ 100%
     - 如果满足条件，执行平仓
   - **启动止盈判断：**
     - 计算：盈利金额 ÷ 保证金 ≥ 启动止盈百分比
     - 如果满足条件，开启止盈功能
   - **止盈回撤判断：**
     - 计算：(最高盈利 - 当前盈利) ÷ 最高盈利 ≥ 止盈回撤百分比
     - 如果满足条件，执行平仓

4. **执行平仓**
   - 如果满足平仓条件，系统向交易所发送平仓请求
   - 平仓后更新内存持仓信息（清空持仓）

5. **清理资源**
   - 平仓后清理价格窗口数据
   - 清理持仓跟踪器

**关键点：**
- **参数优先级：** 优先使用订单记录中的策略参数，确保平仓时使用下单时的参数
- **止损止盈：** 根据策略参数自动判断是否应该平仓
- **最高盈利：** 系统会跟踪持仓的最高盈利，用于止盈回撤判断

---

### 2.4 停止机器人阶段

**时间点：** 用户点击"停止"按钮，或到达定时停止时间，或达到最大盈利/亏损目标

**流程：**

1. **系统检测到机器人需要停止**
   - 系统每5秒检查一次数据库
   - 如果发现机器人状态变为"已停止"，开始清理

2. **停止机器人引擎**
   - 系统停止主循环
   - 取消订阅市场行情
   - 清理内存中的数据

3. **保存最终状态**
   - 系统保存机器人的最终状态
   - 包括：总盈亏、运行时长、交易次数等

**关键点：**
- **资源清理：** 停止时清理所有资源，避免内存泄漏
- **状态保存：** 保存机器人的最终状态，方便后续查看

---

## 三、策略调用路径总结

### 3.1 策略参数加载路径

```
用户创建机器人
  ↓
选择策略组（保存策略组ID）
  ↓
系统启动机器人
  ↓
市场分析（每500毫秒）
  ↓
检测市场状态（趋势/震荡/高波动/低波动）
  ↓
根据映射关系选择风险偏好（保守/平衡/激进）
  ↓
根据策略组ID + 市场状态 + 风险偏好查找策略模板
  ↓
加载策略参数（杠杆、保证金、止损、止盈等）
  ↓
保存到内存缓存（供后续使用）
```

### 3.2 下单时策略参数使用路径

```
信号生成（价格窗口触发）
  ↓
检查是否满足下单条件
  ↓
从内存缓存获取策略参数
  ↓
使用策略参数计算下单数量：
  - 杠杆倍数 → 计算可用资金
  - 保证金比例 → 计算保证金
  - 当前价格 → 计算下单数量
  ↓
执行下单
  ↓
保存订单记录（同时保存策略参数）
```

### 3.3 平仓时策略参数使用路径

```
持续监控持仓盈亏（每500毫秒）
  ↓
获取策略参数（优先级）：
  1. 订单记录中的策略参数（下单时保存的）
  2. 策略模板中的策略参数（如果订单中没有）
  3. 机器人配置中的策略参数（如果模板中没有）
  ↓
使用策略参数判断是否平仓：
  - 止损百分比 → 判断是否止损
  - 启动止盈百分比 → 判断是否开启止盈
  - 止盈回撤百分比 → 判断是否止盈回撤
  ↓
执行平仓（如果满足条件）
```

---

## 四、关键数据说明

### 4.1 策略组

**说明：** 一组策略模板的集合，包含12种策略模板

**包含内容：**
- 策略组名称（例如："BTC-USDT 官方策略 V5.0"）
- 交易平台（例如：Bitget）
- 交易对（例如：BTCUSDT）
- 订单类型（例如：市价单）
- 保证金模式（例如：逐仓）

**作用：** 机器人绑定策略组后，会根据市场状态自动从策略组中选择对应的策略模板

---

### 4.2 策略模板

**说明：** 针对特定市场状态和风险偏好的交易参数配置

**包含内容：**
- **市场状态：** 趋势/震荡/高波动/低波动
- **风险偏好：** 保守/平衡/激进
- **时间窗口：** 监控价格的时间范围（秒）
- **波动阈值：** 触发信号的波动幅度（USDT）
- **杠杆倍数：** 使用的杠杆（例如：10倍）
- **保证金比例：** 使用的保证金比例（例如：10%）
- **止损百分比：** 亏损多少时平仓（例如：10%）
- **启动止盈百分比：** 盈利多少时开启止盈（例如：5%）
- **止盈回撤百分比：** 盈利回撤多少时平仓（例如：10%）
- **反向策略：** 亏损回撤百分比、盈利回撤百分比

**数量：** 每个策略组包含12种策略模板（4种市场状态 × 3种风险偏好）

**作用：** 提供具体的交易参数，供机器人下单时使用

---

### 4.3 映射关系

**说明：** 市场状态与风险偏好的对应关系

**示例：**
- 趋势市场 → 平衡型
- 震荡市场 → 平衡型
- 高波动市场 → 激进型
- 低波动市场 → 保守型

**作用：** 当市场状态变化时，系统自动选择对应的风险偏好，然后从策略组中查找对应的策略模板

---

### 4.4 订单记录

**说明：** 每次下单时保存的订单信息

**包含内容：**
- 订单基本信息（订单ID、交易对、方向、数量、价格等）
- **策略参数（重要）：**
  - 止损百分比
  - 启动止盈百分比
  - 止盈回撤百分比
  - 保证金比例

**作用：** 平仓时优先使用订单记录中的策略参数，确保使用下单时的参数，而不是最新的策略参数

---

## 五、策略调用流程图（简化版）

```
┌─────────────────────────────────────────┐
│         用户创建机器人                   │
│  1. 选择策略组                          │
│  2. 配置映射关系                        │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         系统启动机器人                   │
│  1. 初始化引擎                          │
│  2. 启动主循环                          │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         市场分析（每500毫秒）            │
│  1. 分析市场状态                        │
│  2. 根据映射关系选择风险偏好            │
│  3. 查找策略模板                        │
│  4. 加载策略参数                        │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         信号生成（每500毫秒）            │
│  1. 收集价格数据                        │
│  2. 计算窗口最高价和最低价               │
│  3. 判断是否触发信号                    │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         开仓执行（信号触发时）           │
│  1. 获取策略参数                        │
│  2. 计算下单数量                        │
│  3. 执行下单                            │
│  4. 保存订单记录（含策略参数）          │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         平仓检查（每500毫秒）            │
│  1. 监控持仓盈亏                        │
│  2. 获取策略参数（订单→模板→配置）       │
│  3. 判断是否平仓                        │
│  4. 执行平仓（如果满足条件）             │
└─────────────────────────────────────────┘
```

---

## 六、常见问题解答

### Q1: 策略参数什么时候加载？

**A:** 策略参数在以下情况加载：
1. **市场状态变化时：** 当市场从趋势变为震荡时，系统会自动加载新的策略参数
2. **首次分析时：** 机器人启动后第一次分析市场时，会加载策略参数
3. **下单前：** 如果策略参数未加载，下单前会重新加载

### Q2: 策略参数从哪里来？

**A:** 策略参数来自策略模板，系统根据以下信息查找策略模板：
- **策略组ID：** 创建机器人时选择的策略组
- **市场状态：** 当前分析出的市场状态（趋势/震荡/高波动/低波动）
- **风险偏好：** 根据映射关系自动选择的风险偏好（保守/平衡/激进）

### Q3: 下单时使用哪些策略参数？

**A:** 下单时使用以下策略参数：
- **杠杆倍数：** 用于计算可用资金
- **保证金比例：** 用于计算保证金
- **止损百分比：** 保存到订单记录，用于后续止损判断
- **启动止盈百分比：** 保存到订单记录，用于后续止盈判断
- **止盈回撤百分比：** 保存到订单记录，用于后续止盈回撤判断

### Q4: 平仓时使用哪些策略参数？

**A:** 平仓时使用以下策略参数（优先级顺序）：
1. **订单记录中的策略参数：** 下单时保存的策略参数（优先级最高）
2. **策略模板中的策略参数：** 如果订单记录中没有，从策略模板获取
3. **机器人配置中的策略参数：** 如果策略模板中没有，使用机器人配置

**原因：** 确保使用下单时的策略参数，而不是最新的策略参数，避免策略参数变化影响已开仓的订单

### Q5: 市场状态变化时会发生什么？

**A:** 当市场状态变化时：
1. **系统检测到变化：** 系统会检测到市场状态从一种状态变为另一种状态
2. **选择新的风险偏好：** 根据映射关系，自动选择新的风险偏好
3. **加载新的策略参数：** 根据新的市场状态和风险偏好，加载新的策略参数
4. **更新参数缓存：** 将新的策略参数保存到内存缓存中
5. **后续下单使用新参数：** 后续下单时会使用新的策略参数

**注意：** 已开仓的订单不受影响，仍然使用下单时的策略参数

---

## 七、总结

### 7.1 核心流程

1. **创建时：** 用户选择策略组，配置映射关系
2. **启动时：** 系统初始化引擎，开始监控市场
3. **运行时：** 系统持续分析市场，根据市场状态和映射关系自动匹配策略模板，加载策略参数
4. **下单时：** 使用策略参数计算下单数量，执行下单，保存策略参数到订单记录
5. **平仓时：** 使用订单记录中的策略参数判断是否平仓，执行平仓

### 7.2 关键特点

- **自动化：** 市场状态变化时，自动切换风险偏好和策略参数
- **实时性：** 每500毫秒检查一次市场状态和持仓盈亏
- **一致性：** 平仓时使用下单时的策略参数，确保参数一致性
- **灵活性：** 支持用户自定义映射关系，灵活配置策略

### 7.3 数据流向

```
策略组（用户选择）
  ↓
策略模板（系统查找）
  ↓
策略参数（系统加载）
  ↓
订单记录（系统保存）
  ↓
平仓判断（系统使用）
```

