# Hotgo_v2 自动下单流程简化说明

## 一、自动下单流程简化版

```
信号生成 → 保存预警记录 → 触发下单检查 → 执行下单
```

## 二、多重验证详解

### 1. 基础验证层（信号有效性检查）

**位置**: `robot_engine.go:3241-3270`

#### 1.1 机器人存在性检查
```go
if robot == nil {
    return // 机器人不存在，记录日志并返回
}
```

#### 1.2 信号有效性检查
```go
// 检查1: 信号是否为空
if signal == nil {
    return // 信号为空，记录日志并返回
}

// 检查2: 信号方向是否为中性
if signal.Direction == "NEUTRAL" {
    return // 中性信号不执行下单
}

// 检查3: 信号类型是否为开仓信号
if signal.Action != "OPEN_LONG" && signal.Action != "OPEN_SHORT" {
    return // 不是开仓信号，跳过
}
```

**验证项**:
- ✅ 信号非空
- ✅ 信号方向非 `NEUTRAL`
- ✅ 信号类型为 `OPEN_LONG` 或 `OPEN_SHORT`

---

### 2. 防重复下单层

**位置**: `robot_engine.go:3272-3283`

#### 2.1 预警记录级别防重复
```go
// 检查该预警记录是否已经下过单
existingOrderCount, err := dao.TradingExecutionLog.Ctx(ctx).
    Where("signal_log_id", logId).
    Where("event_type IN (?)", []string{"order_submit", "order_success"}).
    Count()
if existingOrderCount > 0 {
    return // 已下过单，跳过重复下单
}
```

**验证项**:
- ✅ 该预警记录未下过单（通过查询 `hg_trading_execution_log` 表）

---

### 3. 自动交易开关检查层

**位置**: `robot_engine.go:3285-3298`

```go
autoTradeEnabled := robot.AutoTradeEnabled
if autoTradeEnabled != 1 {
    return // 自动交易未开启，记录日志并返回
}
```

**验证项**:
- ✅ `robot.AutoTradeEnabled == 1`（自动交易已开启）

---

### 4. 持仓检查层（防止重复开仓）

**位置**: `robot_engine.go:3300-3351`

#### 4.1 交易所实例检查
```go
if t.engine.Exchange == nil {
    return // 交易所实例不存在，无法检查持仓
}
```

#### 4.2 实时持仓检查
```go
// 从交易所平台实时获取持仓信息
positions, err := t.engine.Exchange.GetPositions(ctx, robot.Symbol)

// 检查该方向是否有持仓（持仓数量 > 0.0001 视为有持仓）
hasPosition := false
for _, pos := range positions {
    if pos.PositionSide == positionSide && math.Abs(pos.PositionAmt) > 0.0001 {
        hasPosition = true
        break
    }
}
if hasPosition {
    return // 该方向已有持仓，每个方向只能一单
}
```

**验证项**:
- ✅ 交易所实例存在
- ✅ 该方向无持仓（从交易所API实时获取）

**注意**: 持仓检查采用**实时查询**，确保数据准确性

---

### 5. 锁机制层（防止并发下单）

**位置**: `robot_engine.go:3353-3371`

```go
// 获取锁，防止并发下单
locked := false
for i := 0; i < 5; i++ {
    if t.engine.orderLock.TryLock() {
        locked = true
        break
    }
    time.Sleep(10 * time.Millisecond) // 每次重试间隔10ms
}
if !locked {
    return // 获取锁失败，系统繁忙
}
defer t.engine.orderLock.Unlock() // 确保释放锁
```

**验证项**:
- ✅ 成功获取 `orderLock`（最多重试5次，每次间隔10ms）

---

### 6. 余额和行情检查层

**位置**: `robot_engine.go:4108-4127`

```go
// 检查余额
if balance == nil || balance.AvailableBalance <= 0 {
    return gerror.New("余额不足")
}

// 检查行情
if ticker == nil {
    return gerror.New("获取行情失败")
}
```

**验证项**:
- ✅ 账户余额 > 0
- ✅ 行情数据存在

---

### 7. 算力检查层（可选，在 CheckAndOpenPositionWithSignal 中）

**位置**: `robot_engine.go:3651-3656`

```go
// 检查算力是否充足
if !t.checkPower(ctx) {
    return // 算力不足，记录日志并返回
}
```

**算力检查实现** (`robot_engine.go:3987-4007`):
```go
func (t *RobotTrader) checkPower(ctx context.Context) bool {
    // 查询用户算力
    totalPower := wallet.Power + wallet.GiftPower
    // 至少需要1点算力
    return totalPower >= 1
}
```

**验证项**:
- ✅ 用户算力 ≥ 1（`Power + GiftPower >= 1`）

---

### 8. 订单金额检查层

**位置**: `robot_engine.go:4160-4175`

```go
// 检查最小订单金额：订单金额 = margin * leverage，应该至少 5 USDT
minOrderValue := 5.0 // 最小订单价值 5 USDT
orderValue := margin * float64(leverage)
if orderValue < minOrderValue {
    return gerror.New("订单金额不足")
}
```

**验证项**:
- ✅ 订单金额 ≥ 5 USDT（`margin × leverage >= 5`）

---

### 9. 策略参数检查层

**位置**: `robot_engine.go:4131-4141`

```go
// 获取策略参数
marketState, riskPreference, strategyParams, err := t.getStrategyParamsForTrade(ctx)
if err != nil {
    return gerror.Wrap(err, "获取策略参数失败")
}
```

**验证项**:
- ✅ 市场状态获取成功
- ✅ 风险偏好映射成功
- ✅ 策略参数加载成功

---

## 三、动态参数详解

### 1. 市场状态（Market State）

**获取方式**: `robot_engine.go:4067-4074`
```go
globalAnalysis := market.GetMarketAnalyzer().GetAnalysis(t.engine.Platform, robot.Symbol)
marketState = normalizeMarketState(string(globalAnalysis.MarketState))
```

**可能的值**:
- `bullish` - 牛市
- `bearish` - 熊市
- `sideways` - 震荡市

**特点**: 
- ✅ **实时获取**：从全局市场分析器实时获取
- ✅ **动态变化**：根据市场行情动态变化

---

### 2. 风险偏好（Risk Preference）

**获取方式**: `robot_engine.go:4076-4093`
```go
// 从机器人的 CurrentStrategy JSON 中解析映射关系
riskConfig["marketRiskMapping"].(map[string]interface{})

// 根据市场状态获取对应的风险偏好
riskPreference = mapping[marketState].(string)
```

**映射关系示例**:
```json
{
  "riskConfig": {
    "marketRiskMapping": {
      "bullish": "aggressive",      // 牛市 → 激进
      "bearish": "conservative",    // 熊市 → 保守
      "sideways": "moderate"        // 震荡 → 中等
    }
  }
}
```

**可能的值**:
- `conservative` - 保守
- `moderate` - 中等
- `aggressive` - 激进

**特点**:
- ✅ **动态映射**：根据市场状态从配置中动态获取
- ✅ **可配置**：在创建机器人时配置映射关系

---

### 3. 策略参数（StrategyParams）

**获取方式**: `robot_engine.go:4095-4099`
```go
strategyParams, err = t.engine.loadFullStrategyParams(ctx, marketState, riskPreference)
```

**结构定义** (`robot_engine.go:751-765`):
```go
type StrategyParams struct {
    LeverageMin             int     // 杠杆最小值
    LeverageMax             int     // 杠杆最大值
    MarginPercentMin        float64 // 保证金比例最小值
    MarginPercentMax        float64 // 保证金比例最大值
    StopLossPercent         float64 // 止损百分比
    AutoStartRetreatPercent float64 // 启动止盈百分比
    ProfitRetreatPercent    float64 // 止盈回撤百分比
    Window                  int     // 时间窗口（秒）
    Threshold               float64 // 波动阈值（USDT）
}
```

**获取逻辑**:
- 根据 `市场状态` + `风险偏好` 从策略组中查找匹配的策略
- 匹配条件: `market_state = marketState AND risk_preference = riskPreference`

**特点**:
- ✅ **动态匹配**：根据市场状态和风险偏好动态匹配策略
- ✅ **实时更新**：每次下单时重新获取，确保使用最新策略

---

### 4. 下单参数计算

**位置**: `robot_engine.go:4143-4183`

#### 4.1 杠杆（Leverage）
```go
leverage := strategyParams.LeverageMin
if leverage <= 0 {
    leverage = 10 // 默认值
}
```
**来源**: 策略参数中的 `LeverageMin`

#### 4.2 保证金比例（Margin Percent）
```go
marginPercent := strategyParams.MarginPercentMin
if marginPercent <= 0 {
    marginPercent = 10 // 默认值
}
```
**来源**: 策略参数中的 `MarginPercentMin`

#### 4.3 保证金金额（Margin）
```go
margin := balance.AvailableBalance * marginPercent / 100
```
**计算**: `可用余额 × 保证金比例`

#### 4.4 下单数量（Quantity）
```go
quantity := margin * float64(leverage) / ticker.LastPrice

// 最小下单数量为0.0001
minQuantity := 0.0001
if quantity < minQuantity {
    quantity = minQuantity
}
```
**计算**: `保证金 × 杠杆 / 当前价格`

#### 4.5 订单金额（Order Value）
```go
orderValue := margin * float64(leverage)
// 最小订单金额: 5 USDT
```
**计算**: `保证金 × 杠杆`

---

### 5. 止损止盈参数

**来源**: 策略参数

```go
StopLossPercent         // 止损百分比
AutoStartRetreatPercent // 启动止盈百分比
ProfitRetreatPercent    // 止盈回撤百分比
```

**特点**:
- ✅ **动态获取**：从策略参数中获取
- ✅ **随策略变化**：不同市场状态和风险偏好对应不同的止损止盈参数

---

## 四、验证和参数总结表

### 多重验证总结

| 验证层 | 验证项 | 位置 | 失败处理 |
|--------|--------|------|----------|
| **基础验证** | 信号非空、非NEUTRAL、是开仓信号 | `3241-3270` | 记录日志并返回 |
| **防重复下单** | 预警记录未下过单 | `3272-3283` | 跳过重复下单 |
| **自动交易开关** | `AutoTradeEnabled == 1` | `3285-3298` | 记录日志并返回 |
| **持仓检查** | 该方向无持仓（实时查询） | `3300-3351` | 记录日志并返回 |
| **锁机制** | 成功获取 `orderLock` | `3353-3371` | 记录日志并返回 |
| **余额检查** | `AvailableBalance > 0` | `4108-4116` | 返回错误 |
| **行情检查** | `ticker != nil` | `4118-4127` | 返回错误 |
| **算力检查** | `Power + GiftPower >= 1` | `3651-3656` | 记录日志并返回 |
| **订单金额检查** | `orderValue >= 5 USDT` | `4160-4175` | 返回错误 |
| **策略参数检查** | 策略参数获取成功 | `4131-4141` | 返回错误 |

### 动态参数总结

| 参数类型 | 获取方式 | 来源 | 特点 |
|---------|---------|------|------|
| **市场状态** | `market.GetMarketAnalyzer().GetAnalysis()` | 全局市场分析器 | 实时获取，动态变化 |
| **风险偏好** | 从 `robot.CurrentStrategy` JSON解析 | 机器人配置的映射关系 | 根据市场状态动态映射 |
| **策略参数** | `loadFullStrategyParams(marketState, riskPreference)` | 策略组数据库 | 根据市场状态+风险偏好匹配 |
| **杠杆** | `strategyParams.LeverageMin` | 策略参数 | 动态获取，默认10 |
| **保证金比例** | `strategyParams.MarginPercentMin` | 策略参数 | 动态获取，默认10% |
| **保证金金额** | `余额 × 保证金比例` | 计算得出 | 实时计算 |
| **下单数量** | `保证金 × 杠杆 / 当前价格` | 计算得出 | 实时计算 |
| **止损百分比** | `strategyParams.StopLossPercent` | 策略参数 | 动态获取 |
| **启动止盈百分比** | `strategyParams.AutoStartRetreatPercent` | 策略参数 | 动态获取 |
| **止盈回撤百分比** | `strategyParams.ProfitRetreatPercent` | 策略参数 | 动态获取 |

---

## 五、完整验证流程

```
下单请求
    │
    ├─→ [验证1] 基础验证
    │   ├─→ 机器人存在？
    │   ├─→ 信号非空？
    │   ├─→ 信号非NEUTRAL？
    │   └─→ 信号是开仓信号？
    │
    ├─→ [验证2] 防重复下单
    │   └─→ 预警记录已下过单？
    │
    ├─→ [验证3] 自动交易开关
    │   └─→ AutoTradeEnabled == 1？
    │
    ├─→ [验证4] 持仓检查
    │   ├─→ 交易所实例存在？
    │   └─→ 该方向无持仓？
    │
    ├─→ [验证5] 锁机制
    │   └─→ 成功获取锁？
    │
    ├─→ [验证6] 余额和行情检查
    │   ├─→ 余额 > 0？
    │   └─→ 行情数据存在？
    │
    ├─→ [验证7] 算力检查（可选）
    │   └─→ 算力 >= 1？
    │
    ├─→ [验证8] 策略参数检查
    │   ├─→ 市场状态获取成功？
    │   ├─→ 风险偏好映射成功？
    │   └─→ 策略参数加载成功？
    │
    ├─→ [验证9] 订单金额检查
    │   └─→ 订单金额 >= 5 USDT？
    │
    └─→ 所有验证通过 → 执行下单
```

---

## 六、动态参数获取流程

```
获取策略参数
    │
    ├─→ [步骤1] 获取市场状态
    │   └─→ market.GetMarketAnalyzer().GetAnalysis()
    │       └─→ 返回: bullish / bearish / sideways
    │
    ├─→ [步骤2] 选择风险偏好
    │   └─→ 从 robot.CurrentStrategy JSON 解析
    │       └─→ marketRiskMapping[marketState]
    │           └─→ 返回: conservative / moderate / aggressive
    │
    ├─→ [步骤3] 获取策略参数
    │   └─→ loadFullStrategyParams(marketState, riskPreference)
    │       └─→ 从策略组数据库查询匹配的策略
    │           └─→ WHERE market_state = ? AND risk_preference = ?
    │               └─→ 返回: StrategyParams
    │
    └─→ [步骤4] 计算下单参数
        ├─→ leverage = StrategyParams.LeverageMin
        ├─→ marginPercent = StrategyParams.MarginPercentMin
        ├─→ margin = balance × marginPercent / 100
        ├─→ quantity = margin × leverage / currentPrice
        └─→ orderValue = margin × leverage
```

---

## 七、关键代码位置索引

| 功能 | 文件 | 行号范围 |
|------|------|----------|
| 自动下单主入口 | `robot_engine.go` | `3230-3384` |
| 基础验证 | `robot_engine.go` | `3241-3270` |
| 防重复检查 | `robot_engine.go` | `3272-3283` |
| 自动交易开关检查 | `robot_engine.go` | `3285-3298` |
| 持仓检查 | `robot_engine.go` | `3300-3351` |
| 锁机制 | `robot_engine.go` | `3353-3371` |
| 执行下单 | `robot_engine.go` | `4104-4390` |
| 余额和行情检查 | `robot_engine.go` | `4108-4127` |
| 策略参数获取 | `robot_engine.go` | `4063-4102` |
| 参数计算 | `robot_engine.go` | `4143-4183` |
| 订单金额检查 | `robot_engine.go` | `4160-4175` |
| 算力检查 | `robot_engine.go` | `3987-4007` |

---

## 八、总结

### 多重验证特点
1. **分层验证**：9层验证，层层递进
2. **实时检查**：持仓检查从交易所API实时获取
3. **防重复**：预警记录级别、持仓级别、锁机制多重防护
4. **容错处理**：每层验证失败都有明确的错误处理和日志记录

### 动态参数特点
1. **实时获取**：市场状态、余额、行情都是实时获取
2. **动态匹配**：根据市场状态和风险偏好动态匹配策略
3. **可配置**：风险偏好映射关系可在创建机器人时配置
4. **灵活计算**：下单参数根据实时余额和策略参数动态计算

