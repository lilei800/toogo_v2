# 机器人市场状态和风险偏好更新逻辑分析

## 一、更新流程概述

### 1.1 市场状态更新流程

市场状态的更新发生在机器人引擎的主循环中，具体流程如下：

```
主循环 (runMainLoop)
  └─> doAnalysis() [每1秒执行一次]
      └─> Analyzer.Analyze() [市场分析]
          └─> determineMarketState() [判断市场状态]
      └─> checkAndUpdateStrategyConfig() [检测市场状态变化]
          └─> loadFullStrategyParams() [加载策略参数]
```

**关键代码位置：**
- `server/internal/logic/toogo/robot_engine.go:388-427` - `doAnalysis()` 方法
- `server/internal/logic/toogo/robot_engine.go:429-465` - `checkAndUpdateStrategyConfig()` 方法
- `server/internal/logic/toogo/robot_engine.go:1873-1945` - `determineMarketState()` 方法

### 1.2 风险偏好更新逻辑

**重要变化：** 风险偏好逻辑已简化，不再根据市场状态自动切换。

**当前实现：**
- 风险偏好直接使用机器人配置的 `Robot.RiskPreference` 字段
- 不再从 `CurrentStrategy` JSON 中的 `marketRiskMapping` 自动映射

**关键代码位置：**
- `server/internal/logic/toogo/robot_engine.go:439-443` - 直接使用机器人配置的风险偏好
- `server/internal/logic/toogo/robot_engine.go:264-268` - `loadRiskConfigFromRobot()` 方法（已简化）

**注意：** 在 `server/internal/logic/toogo/engine/core.go` 中仍保留旧的映射逻辑（可能未使用）

## 二、核心更新函数详解

### 2.1 checkAndUpdateStrategyConfig()

**功能：** 检测市场状态变化并更新策略配置

**触发条件：**
- 市场状态发生变化（`currentMarketState != LastMarketState`）
- 每次市场分析完成后调用

**执行流程：**
```go
1. 检查市场状态是否变化
2. 更新 LastMarketState
3. 获取风险偏好（从 Robot.RiskPreference）
4. 调用 loadFullStrategyParams() 加载策略参数
5. 更新 CurrentStrategyParams
6. 更新监控配置（MonitorConfig）
```

**代码位置：** `server/internal/logic/toogo/robot_engine.go:429-465`

### 2.2 loadFullStrategyParams()

**功能：** 从策略模板加载完整参数

**参数来源优先级：**
1. **策略模板数据库**（优先级最高）
   - 根据 `StrategyGroupId` + `MarketState` + `RiskPreference` 查询
   - 支持市场状态名称映射（`range` → `volatile`）
   
2. **默认策略参数**（降级方案）
   - 根据市场状态和风险偏好使用预设默认值

**加载的参数包括：**
- `Window` - 时间窗口（秒）
- `Threshold` - 波动阈值（USDT）
- `LeverageMin/Max` - 杠杆范围
- `MarginPercentMin/Max` - 保证金比例范围
- `StopLossPercent` - 止损百分比
- `ProfitRetreatPercent` - 止盈回撤百分比
- `AutoStartRetreatPercent` - 启动止盈百分比
- `ReverseLossRetreat` - 亏损单反向回撤百分比
- `ReverseProfitRetreat` - 盈利单反向回撤百分比

**代码位置：** `server/internal/logic/toogo/robot_engine.go:567-685`

## 三、影响范围分析

### 3.1 交易执行模块

**影响位置：** `server/internal/logic/toogo/robot_engine.go:2413-2521` - `executeOpen()`

**影响内容：**
- 开仓时使用的杠杆倍数（从 `CurrentStrategyParams` 获取）
- 保证金比例（从 `CurrentStrategyParams` 获取）
- 止损百分比（从 `CurrentStrategyParams` 获取）

**关键代码：**
```go
// 获取策略参数（优先使用已缓存的，否则重新加载）
strategyParams := t.engine.CurrentStrategyParams
if strategyParams == nil {
    // 重新加载
    strategyParams = t.engine.loadFullStrategyParams(ctx, marketState, riskPref)
}
```

### 3.2 反向下单逻辑

**影响位置：** `server/internal/logic/toogo/robot_engine.go:2263-2319` - `checkReverseCondition()`

**影响内容：**
- 反向下单的回撤阈值根据市场状态确定
- 使用 `GetReverseThresholds()` 函数获取阈值

**阈值规则：**
- `trend`（趋势）：亏损50%回撤，盈利100%回撤
- `volatile/range`（震荡）：0%，0%（立即允许）
- `high_vol`（高波动）：100%，100%（完全回撤才允许）
- `low_vol`（低波动）：0%，0%（立即允许）

**代码位置：** `server/internal/logic/toogo/robot_engine.go:151-169`

### 3.3 前端显示

**影响位置：** `web/src/views/toogo/robot/index.vue`

**影响内容：**
1. **市场状态显示**（第707行）
   ```vue
   <span>市场状态: {{ formatMarketState(getDetailMarketState()) }}</span>
   ```

2. **风险偏好显示**（第709行）
   ```vue
   <span>风险偏好: {{ formatRiskPref(getDetailRiskPreference()) }}</span>
   ```

3. **实时数据获取**（第1250-1269行）
   - `getDetailMarketState()` - 优先使用实时分析数据
   - `getDetailRiskPreference()` - 优先使用实时分析数据

4. **策略参数显示**（第1271-1323行）
   - 杠杆、保证金、止损、止盈等参数从实时数据获取

**数据来源优先级：**
```
实时分析数据 (analysisData[robotId]?.config)
  ↓
机器人静态配置 (robot.riskPreference / robot.marketState)
  ↓
默认值
```

### 3.4 状态查询接口

**影响位置：** `server/internal/logic/toogo/robot_engine.go:1406-1534` - `GetStatus()`

**返回的状态信息：**
- `CurrentMarketState` - 当前市场状态
- `CurrentRiskPref` - 当前风险偏好
- `MarketState` - 市场状态（从 LastAnalysis）
- `RiskPreference` - 风险偏好（从 Robot 配置）

**风险偏好获取逻辑：**
```go
// 1. 优先从风险配置映射中获取
if e.Robot.CurrentStrategy != "" {
    // 从 JSON 中解析 marketRiskMapping
}
// 2. 降级到机器人配置
if currentRiskPref == "" {
    currentRiskPref = e.Robot.RiskPreference
}
```

### 3.5 监控模块

**影响位置：** `server/internal/logic/trading/monitor.go`

**影响内容：**
- 监控模块会从引擎获取当前策略参数
- 用于显示和记录交易监控信息

**关键代码：** `server/internal/logic/trading/monitor.go:496-503`

### 3.6 策略重新加载

**影响位置：** `server/internal/logic/toogo/robot_task_manager.go:251-287` - `ReloadRobotStrategy()`

**功能：** 手动触发策略配置重新加载

**触发场景：**
- 机器人配置更新后
- 策略模板修改后
- 需要立即应用新配置时

**执行流程：**
```go
1. 更新引擎的机器人配置
2. 重新加载风险配置映射
3. 清除上次市场状态，强制触发策略更新
4. 调用 checkAndUpdateStrategyConfig() 重新加载策略参数
```

## 四、数据流向图

```
┌─────────────────────────────────────────────────────────────┐
│                    市场分析模块 (Analyzer)                    │
│  - 每1秒执行一次                                              │
│  - 分析K线数据                                                │
│  - 判断市场状态 (trend/volatile/high_vol/low_vol)           │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│          checkAndUpdateStrategyConfig()                      │
│  - 检测市场状态变化                                           │
│  - 获取风险偏好 (Robot.RiskPreference)                       │
│  - 调用 loadFullStrategyParams()                            │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│            loadFullStrategyParams()                          │
│  1. 查询策略模板数据库                                        │
│     (StrategyGroupId + MarketState + RiskPreference)         │
│  2. 如果找不到，使用默认参数                                  │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│          CurrentStrategyParams (缓存)                         │
│  - Window, Threshold                                         │
│  - LeverageMin/Max                                          │
│  - MarginPercentMin/Max                                     │
│  - StopLossPercent, ProfitRetreatPercent                    │
│  - ReverseLossRetreat, ReverseProfitRetreat                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        ▼              ▼              ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 交易执行模块 │ │ 前端显示     │ │ 状态查询接口 │
│ executeOpen │ │ index.vue    │ │ GetStatus() │
└─────────────┘ └─────────────┘ └─────────────┘
```

## 五、关键配置项

### 5.1 市场状态类型

- `trend` - 趋势市场
- `volatile` / `range` - 震荡市场（range 为旧格式，已映射为 volatile）
- `high_vol` - 高波动市场
- `low_vol` - 低波动市场

### 5.2 风险偏好类型

- `aggressive` - 激进型
- `balanced` - 平衡型（默认）
- `conservative` - 保守型

### 5.3 策略参数来源

1. **策略模板表** (`hg_trading_strategy_template`)
   - 根据策略组ID、市场状态、风险偏好查询
   - 包含完整的交易参数配置

2. **默认参数** (`defaultStrategyParams`)
   - 当策略模板不存在时使用
   - 按市场状态和风险偏好预设

## 六、注意事项

### 6.1 风险偏好不再自动切换

**重要：** 当前实现中，风险偏好直接使用机器人配置的 `RiskPreference` 字段，不再根据市场状态自动切换。

**旧逻辑（已废弃）：**
- 从 `CurrentStrategy` JSON 中的 `marketRiskMapping` 映射获取
- 根据市场状态自动选择风险偏好

**新逻辑（当前）：**
- 直接使用 `Robot.RiskPreference`
- 用户手动配置，运行时保持不变

### 6.2 市场状态映射

代码中支持市场状态名称映射：
- `range` → `volatile`（兼容旧格式）
- 数据库可能存储 `high-volatility` / `low-volatility`，代码内部使用 `high_vol` / `low_vol`

### 6.3 策略参数缓存

策略参数缓存在 `CurrentStrategyParams` 中，只在市场状态变化时更新。如果策略模板在运行时被修改，需要调用 `ReloadRobotStrategy()` 手动刷新。

### 6.4 前端实时数据

前端通过 WebSocket 或轮询获取实时分析数据（`analysisData`），优先显示实时数据，降级到静态配置。

## 七、相关文件清单

### 后端核心文件
- `server/internal/logic/toogo/robot_engine.go` - 机器人引擎核心逻辑
- `server/internal/logic/toogo/robot_task_manager.go` - 机器人任务管理器
- `server/internal/logic/toogo/engine/core.go` - 引擎核心（旧版本，可能未使用）
- `server/internal/logic/toogo/engine/analyzer.go` - 市场分析器
- `server/internal/logic/trading/monitor.go` - 交易监控模块

### 前端文件
- `web/src/views/toogo/robot/index.vue` - 机器人列表和详情页面
- `web/src/views/toogo/robot/create.vue` - 机器人创建页面

### 数据库表
- `hg_trading_robot` - 机器人表（存储 RiskPreference）
- `hg_trading_strategy_template` - 策略模板表
- `hg_trading_strategy_group` - 策略组表

## 八、总结

机器人市场状态和风险偏好的更新逻辑主要涉及：

1. **市场状态**：通过市场分析模块实时判断，每1秒更新一次
2. **风险偏好**：直接使用机器人配置，不再自动切换
3. **策略参数**：根据市场状态和风险偏好从策略模板加载
4. **影响范围**：交易执行、前端显示、状态查询、监控模块等多个模块

关键改进点：
- 简化了风险偏好逻辑，不再自动切换
- 策略参数统一从策略模板加载
- 支持市场状态变化时自动更新策略参数
- 提供了手动重新加载策略的接口

