# 双向开单功能测试指南

## 一、测试准备

### 1.1 环境检查

- ✅ 数据库字段已添加：`allow_bidirectional_order`
- ✅ 后端代码已编译通过
- ✅ 前端代码已更新

### 1.2 测试数据准备

1. **创建测试机器人**
   - 确保有至少一个运行中的机器人
   - 机器人状态：运行中（status = 2）

2. **准备持仓数据**
   - 场景1：无持仓
   - 场景2：有LONG持仓
   - 场景3：有SHORT持仓

---

## 二、功能测试

### 2.1 UI测试

#### 测试1：开关显示

**步骤**：
1. 打开机器人列表页
2. 查看每个机器人的开关区域

**预期结果**：
- ✅ "双向开单"开关显示在"自动下单"和"自动平仓"之间
- ✅ 开关默认状态为**开启**（绿色）
- ✅ 开关可以正常点击

#### 测试2：开关切换

**步骤**：
1. 点击"双向开单"开关，切换到关闭状态
2. 观察提示信息
3. 刷新页面，确认状态已保存

**预期结果**：
- ✅ 开关可以正常切换
- ✅ 提示信息："已关闭双向开单（同时只能有一个持仓）"
- ✅ 刷新后状态保持为关闭

#### 测试3：详情页显示

**步骤**：
1. 点击机器人卡片，打开详情弹窗
2. 查看"策略"标签页

**预期结果**：
- ✅ 显示"双向开单"标签
- ✅ 标签状态与开关状态一致

---

### 2.2 功能逻辑测试

#### 测试4：开启双向开单（默认）

**前置条件**：
- 双向开单开关：**开启**（默认）
- 机器人状态：运行中
- 自动下单开关：开启

**测试场景**：

**场景4.1：无持仓 → 开LONG单**
- 预期：✅ 允许下单

**场景4.2：有LONG持仓 → 开SHORT单**
- 预期：✅ 允许下单（双向开单开启）

**场景4.3：有SHORT持仓 → 开LONG单**
- 预期：✅ 允许下单（双向开单开启）

**场景4.4：有LONG持仓 → 再开LONG单**
- 预期：❌ 不允许下单（每方向只能一单）

**场景4.5：有SHORT持仓 → 再开SHORT单**
- 预期：❌ 不允许下单（每方向只能一单）

#### 测试5：关闭双向开单

**前置条件**：
- 双向开单开关：**关闭**
- 机器人状态：运行中
- 自动下单开关：开启

**测试场景**：

**场景5.1：无持仓 → 开LONG单**
- 预期：✅ 允许下单

**场景5.2：有LONG持仓 → 开SHORT单**
- 预期：❌ 不允许下单（双向开单已关闭）

**场景5.3：有SHORT持仓 → 开LONG单**
- 预期：❌ 不允许下单（双向开单已关闭）

**场景5.4：有LONG持仓 → 再开LONG单**
- 预期：❌ 不允许下单（每方向只能一单）

**场景5.5：有SHORT持仓 → 再开SHORT单**
- 预期：❌ 不允许下单（每方向只能一单）

---

## 三、日志验证

### 3.1 检查日志输出

**开启双向开单时的日志**：
- 正常下单日志，无特殊提示

**关闭双向开单时的日志**：
- 应该看到：`[RobotTrader] robotId=%d 双向开单已关闭，当前已有持仓，跳过下单`
- 或：`[RobotEngine] robotId=%d 双向开单已关闭，当前已有持仓，跳过下单`

### 3.2 日志位置

1. **下单前检查**：`robot_engine.go:2388`
2. **最终检查**：`robot_engine.go:3805`

---

## 四、数据库验证

### 4.1 验证字段值

```sql
-- 查看所有机器人的双向开单状态
SELECT 
    id,
    robot_name,
    auto_trade_enabled,
    allow_bidirectional_order,
    auto_close_enabled
FROM hg_trading_robot
WHERE deleted_at IS NULL
ORDER BY id DESC
LIMIT 10;
```

**预期结果**：
- ✅ 所有机器人的 `allow_bidirectional_order` 字段值为 `1`（默认开启）
- ✅ 手动关闭后，对应机器人的值为 `0`

### 4.2 验证更新操作

```sql
-- 测试更新操作
UPDATE hg_trading_robot 
SET allow_bidirectional_order = 0 
WHERE id = [测试机器人ID];

-- 验证更新
SELECT id, robot_name, allow_bidirectional_order 
FROM hg_trading_robot 
WHERE id = [测试机器人ID];
```

---

## 五、边界情况测试

### 5.1 并发测试

**场景**：多个信号同时触发下单

**预期**：
- ✅ 获取锁后检查持仓（防止并发问题）
- ✅ 双向开单限制在获取锁后检查

### 5.2 异常情况

**场景1：持仓数据为空**
- 预期：✅ 正常处理，不报错

**场景2：持仓数据获取失败**
- 预期：✅ 使用内存缓存数据，记录错误日志

**场景3：开关状态不一致**
- 预期：✅ 以后端数据库状态为准

---

## 六、测试检查清单

### UI测试
- [ ] 开关显示正确
- [ ] 开关默认状态为开启
- [ ] 开关可以正常切换
- [ ] 提示信息正确
- [ ] 详情页显示正确

### 功能测试
- [ ] 开启双向开单：允许同时持有不同方向的持仓
- [ ] 开启双向开单：不允许同一方向重复下单
- [ ] 关闭双向开单：不允许同时持有多个持仓
- [ ] 关闭双向开单：允许下单（无持仓时）

### 数据测试
- [ ] 数据库字段值正确
- [ ] 更新操作正常
- [ ] 状态同步正确

### 日志测试
- [ ] 日志输出正确
- [ ] 错误处理正确

---

## 七、测试步骤总结

### 快速测试流程

1. **UI测试**（5分钟）
   - 打开机器人列表页
   - 检查开关显示和切换

2. **功能测试**（15分钟）
   - 创建测试机器人
   - 测试开启状态的下单逻辑
   - 测试关闭状态的下单逻辑

3. **日志验证**（5分钟）
   - 查看日志输出
   - 确认限制逻辑生效

4. **数据库验证**（5分钟）
   - 验证字段值
   - 验证更新操作

---

## 八、常见问题

### Q1: 开关切换后不生效？

**A**: 检查：
1. 后端API是否正常返回
2. 数据库字段是否更新
3. 机器人引擎是否重新加载配置

### Q2: 关闭双向开单后仍能下单？

**A**: 检查：
1. 持仓检查逻辑是否正确执行
2. 日志中是否有跳过下单的记录
3. 持仓数据是否准确

### Q3: 开关状态显示不正确？

**A**: 检查：
1. 前端数据同步逻辑
2. 后端返回的数据格式
3. 默认值处理逻辑

---

## 九、测试报告模板

```
测试日期：2024-XX-XX
测试人员：XXX

测试结果：
✅ UI测试：通过
✅ 功能测试：通过
✅ 日志测试：通过
✅ 数据库测试：通过

发现问题：
1. [问题描述]
2. [问题描述]

建议：
1. [建议内容]
2. [建议内容]
```

