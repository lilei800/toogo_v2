# 算力不足不影响平仓修改说明

## 一、修改内容

### 1.1 核心原则

**需求**: 算力不足不能影响平仓操作

**原则**: 
- ✅ 平仓操作必须成功执行
- ✅ 算力扣除失败只记录日志，不影响平仓
- ✅ 允许算力扣除为负数

---

## 二、修改位置

### 2.1 `wallet.go:ConsumePower` (第276-278行)

**修改前**: 算力扣除失败时返回错误，可能影响调用方

**修改后**: 算力扣除失败时记录日志但不返回错误，确保不影响平仓

```go
// 扣除算力（允许负数，不影响平仓）
err = s.ChangeBalance(ctx, &toogoin.ChangeBalanceInp{...})
// 【重要】算力扣除失败不应该影响平仓，但由于已允许负数，理论上不应该失败
// 如果确实失败（如数据库错误），记录日志但不阻止后续操作
if err != nil {
    g.Log().Errorf(ctx, "[ConsumePower] 算力扣除失败（不影响平仓）: userId=%d, orderId=%d, err=%v", userId, orderId, err)
    // 不返回错误，确保不影响平仓操作
    return nil
}
```

### 2.2 `wallet.go:ConsumePower` (第280-315行)

**修改前**: 累计消耗、消耗明细、佣金结算失败时返回错误

**修改后**: 这些操作失败时只记录日志，不返回错误

```go
// 更新累计消耗（失败不影响平仓）
if err != nil {
    g.Log().Warningf(ctx, "[ConsumePower] 更新累计消耗失败（不影响平仓）: userId=%d, err=%v", userId, err)
    // 不返回错误，确保不影响平仓操作
}

// 记录算力消耗明细（失败不影响平仓）
if err != nil {
    g.Log().Warningf(ctx, "[ConsumePower] 记录算力消耗明细失败（不影响平仓）: userId=%d, orderId=%d, err=%v", userId, orderId, err)
    // 不返回错误，确保不影响平仓操作
}

// 触发佣金结算（失败不影响平仓）
if err != nil {
    g.Log().Warningf(ctx, "[ConsumePower] 算力佣金结算失败（不影响平仓）: userId=%d, err=%v", userId, err)
    // 不返回错误，确保不影响平仓操作
}
```

### 2.3 `order_sync.go:consumeOrderPower` (第103-110行)

**修改前**: 算力扣除失败时返回错误，影响补扣流程

**修改后**: 算力扣除失败时返回成功，确保不影响平仓

```go
if err != nil {
    // 【重要】算力扣除失败时记录日志，但不影响平仓操作
    g.Log().Warningf(ctx, "[OrderSync] 用户 %d 订单 %s 扣除算力失败: %v（不影响平仓）",
        order.UserId, order.OrderSn, err)
    // 返回成功，确保不影响平仓操作
    return powerAmount, nil
}
```

### 2.4 `order_sync.go:consumeOrderPower` (第114-126行)

**修改前**: 更新订单状态失败时返回错误

**修改后**: 更新订单状态失败时只记录日志，不返回错误

```go
// 更新订单状态（标记算力已扣除）
// 【重要】即使算力扣除失败，也尝试更新订单状态，不影响平仓操作
if err != nil {
    // 更新订单状态失败时记录日志，但不影响平仓操作
    g.Log().Errorf(ctx, "[OrderSync] 更新订单状态失败（不影响平仓）: %v", err)
    // 不返回错误，确保不影响平仓操作
    return powerAmount, nil
}
```

### 2.5 `order_status_sync.go:closeOrder` (第445-452行)

**修改前**: 算力扣除失败时只记录警告日志

**修改后**: 明确说明不影响平仓操作

```go
if err != nil {
    // 【重要】算力扣除失败时记录日志，但不影响平仓操作
    g.Log().Warningf(ctx, "[OrderStatusSync] 消耗算力失败（不影响平仓）: orderId=%d, err=%v", order.Id, err)
}
```

---

## 三、修改效果

### 3.1 修改前行为

1. **算力扣除失败**: 返回错误，可能影响调用方
2. **累计消耗失败**: 返回错误，影响整个流程
3. **消耗明细失败**: 返回错误，影响整个流程
4. **佣金结算失败**: 返回错误，影响整个流程
5. **订单状态更新失败**: 返回错误，影响整个流程

### 3.2 修改后行为

1. **算力扣除失败**: 记录日志，不返回错误，不影响平仓
2. **累计消耗失败**: 记录日志，不返回错误，不影响平仓
3. **消耗明细失败**: 记录日志，不返回错误，不影响平仓
4. **佣金结算失败**: 记录日志，不返回错误，不影响平仓
5. **订单状态更新失败**: 记录日志，不返回错误，不影响平仓

---

## 四、关键保证

### 4.1 平仓操作保证

- ✅ **平仓必须成功**: 无论算力扣除是否成功，平仓操作都会完成
- ✅ **订单状态更新**: 订单状态会更新为"已平仓"，不受算力扣除影响
- ✅ **机器人盈亏更新**: 机器人总盈亏会更新，不受算力扣除影响

### 4.2 算力扣除保证

- ✅ **允许负数**: 算力可以扣除为负数
- ✅ **失败不影响**: 算力扣除失败不影响平仓操作
- ✅ **日志完整**: 所有失败都会记录日志，便于排查

---

## 五、调用链分析

### 5.1 自动平仓流程

```
executeClose (robot_engine.go)
  ↓
订单状态同步 (order_status_sync.go)
  ↓
closeOrder
  ↓
ConsumePower (wallet.go)
  ↓
【修改后】即使失败也不影响平仓
```

### 5.2 手动平仓流程

```
手动平仓 (robot.go)
  ↓
订单状态同步 (order_status_sync.go)
  ↓
closeOrder
  ↓
ConsumePower (wallet.go)
  ↓
【修改后】即使失败也不影响平仓
```

### 5.3 补扣算力流程

```
SyncClosedOrders (order_sync.go)
  ↓
consumeOrderPower
  ↓
ConsumePower (wallet.go)
  ↓
【修改后】即使失败也不影响平仓
```

---

## 六、测试建议

### 6.1 功能测试

1. ✅ **算力不足平仓**: 验证算力不足时平仓是否成功
2. ✅ **负数算力平仓**: 验证算力已为负数时平仓是否成功
3. ✅ **数据库错误**: 验证数据库错误时平仓是否成功

### 6.2 数据验证

1. ✅ **订单状态**: 验证订单状态是否正确更新为"已平仓"
2. ✅ **机器人盈亏**: 验证机器人总盈亏是否正确更新
3. ✅ **算力扣除**: 验证算力是否正确扣除（包括负数）

### 6.3 错误场景

1. ✅ **算力扣除失败**: 验证算力扣除失败时平仓是否成功
2. ✅ **累计消耗失败**: 验证累计消耗失败时平仓是否成功
3. ✅ **消耗明细失败**: 验证消耗明细失败时平仓是否成功

---

## 七、总结

### 7.1 修改完成

✅ 所有相关代码已修改完成：
- `wallet.go:ConsumePower`: 所有错误都不返回，只记录日志
- `order_sync.go:consumeOrderPower`: 算力扣除失败返回成功
- `order_status_sync.go:closeOrder`: 明确说明不影响平仓

### 7.2 功能保证

- ✅ **平仓操作**: 无论算力扣除是否成功，平仓操作都会完成
- ✅ **订单状态**: 订单状态会正确更新为"已平仓"
- ✅ **机器人盈亏**: 机器人总盈亏会正确更新
- ✅ **算力扣除**: 算力会尝试扣除（允许负数），失败不影响平仓

### 7.3 日志记录

- ✅ **所有失败**: 所有算力相关的失败都会记录日志
- ✅ **不影响操作**: 日志记录不影响平仓操作
- ✅ **便于排查**: 日志包含足够的信息，便于排查问题

