# 每秒平台API访问次数分析

## 一、分析场景假设

### 1.1 基础假设
- **运行中的机器人数量**：N 个
- **订阅的交易对数量**：M 个（不同 platform:symbol 组合）
- **每个交易对的K线周期数**：6 个（1m, 5m, 15m, 30m, 1h, 1d）
- **前端页面数**：1 个（机器人列表页）

### 1.2 典型场景
- **小规模**：N=5个机器人，M=3个交易对
- **中规模**：N=20个机器人，M=10个交易对
- **大规模**：N=50个机器人，M=20个交易对

---

## 二、全局引擎API调用频率

### 2.1 MarketAnalyzer（市场分析引擎）

#### 调用频率
- **分析循环**：每秒1次
- **实际平台API调用**：**0次/秒**（使用缓存数据）

#### 说明
MarketAnalyzer 每秒执行一次分析循环，但**不直接调用平台API**，而是：
- 从 `MarketServiceManager` 或 `MarketDataService` 获取**已缓存的**Ticker和K线数据
- 只进行数据分析和计算，不发起新的API请求

**结论**：MarketAnalyzer **不产生平台API调用**

---

### 2.2 MarketDataService（全局行情数据服务）

#### Ticker更新
- **频率**：每秒1次（`runTickerUpdater`）
- **调用方式**：`ex.GetTicker(ctx, symbol)`
- **调用次数**：**M次/秒**（每个订阅的交易对1次）

#### K线更新
- **频率**：每5秒1次（`runKlineUpdater`）
- **调用方式**：`ex.GetKlines(ctx, symbol, interval, count)`
- **每个交易对**：6次调用（1m, 5m, 15m, 30m, 1h, 1d）
- **调用次数**：**M × 6 / 5 = 1.2M次/秒**（平均每秒）

#### 总计
- **每秒API调用**：`M + 1.2M = 2.2M次/秒`

---

### 2.3 ExchangeMarketService（交易所市场服务）

#### Ticker更新
- **频率**：每秒1次（`runTickerUpdater`）
- **调用方式**：`ex.GetTicker(ctx, symbol)`
- **调用次数**：**M次/秒**（每个订阅的交易对1次）

#### K线更新
- **频率**：每5秒1次（`runKlineUpdater`）
- **调用方式**：`ex.GetKlines(ctx, symbol, interval, count)`
- **每个交易对**：5次调用（1m, 5m, 15m, 30m, 1h）
- **调用次数**：**M × 5 / 5 = M次/秒**（平均每秒）

#### 总计
- **每秒API调用**：`M + M = 2M次/秒`

---

### 2.4 MarketServiceManager（市场服务管理器）

#### 说明
MarketServiceManager 是**统一入口**，实际调用的是：
- **优先WebSocket**（Bitget/Binance Ticker）：**0次API调用**（WebSocket推送）
- **降级HTTP**：调用 `ExchangeMarketService`（已统计）

**结论**：MarketServiceManager **不额外产生API调用**（WebSocket优先时）

---

### 2.5 全局引擎总计

#### 假设场景
- **MarketDataService** 和 **ExchangeMarketService** 可能**同时运行**（取决于配置）
- 保守估计：只统计 **MarketDataService**（更常用）

#### 每秒API调用
- **Ticker**：M次/秒
- **K线**：1.2M次/秒（平均）
- **总计**：**2.2M次/秒**

---

## 三、机器人引擎API调用频率

### 3.1 每个机器人的调用频率

#### GetPositions（获取持仓）
- **频率**：每10秒1次（`syncAccountData`）
- **调用次数**：**N / 10 = 0.1N次/秒**（平均每秒）

#### GetOrderHistory（获取订单历史）
- **频率**：每120秒1次（`syncAccountData`）
- **调用次数**：**N / 120 = 0.0083N次/秒**（平均每秒）

#### GetBalance（获取余额）
- **频率**：事件驱动（下单前）
- **假设**：每个机器人平均每60秒下单1次
- **调用次数**：**N / 60 = 0.0167N次/秒**（平均每秒）

#### CreateOrder（创建订单）
- **频率**：事件驱动（触发开仓时）
- **假设**：每个机器人平均每60秒下单1次
- **调用次数**：**N / 60 = 0.0167N次/秒**（平均每秒）

#### ClosePosition（平仓）
- **频率**：事件驱动（触发平仓时）
- **假设**：每个机器人平均每300秒平仓1次
- **调用次数**：**N / 300 = 0.0033N次/秒**（平均每秒）

#### SetLeverage（设置杠杆）
- **频率**：事件驱动（下单前）
- **假设**：每个机器人平均每60秒下单1次
- **调用次数**：**N / 60 = 0.0167N次/秒**（平均每秒）

#### GetTicker（获取行情）
- **频率**：事件驱动（检测手动平仓时）
- **假设**：每个机器人平均每600秒检测1次
- **调用次数**：**N / 600 = 0.0017N次/秒**（平均每秒）

#### 总计（每个机器人）
- **每秒API调用**：`0.1 + 0.0083 + 0.0167 + 0.0167 + 0.0033 + 0.0167 + 0.0017 = 0.1634次/秒`

#### N个机器人总计
- **每秒API调用**：**0.1634N次/秒**

---

### 3.2 OrderStatusSyncService（订单状态同步服务）

#### SyncAllOrders（同步订单）
- **频率**：每60秒1次
- **调用方式**：`engine.Exchange.GetOrderHistory(ctx, robot.Symbol, 50)`
- **调用次数**：**N / 60 = 0.0167N次/秒**（平均每秒）

**注意**：这个服务调用的是机器人引擎的Exchange，已包含在机器人引擎统计中，**不重复计算**

---

## 四、前端API调用频率

### 4.1 机器人列表页（index.vue）

#### loadPositionData（加载持仓数据）
- **频率**：每秒1次（`fastRefreshTimer`）
- **调用方式**：`ToogoRobotApi.positions({ robotId })`
- **后端处理**：调用 `engine.Exchange.GetPositions()`
- **调用次数**：**N次/秒**（每个机器人1次）

#### loadRealtimeData（加载实时分析数据）
- **频率**：每10秒1次（兜底，WebSocket为主）
- **调用方式**：`ToogoExchangeApi.batchRobotAnalysis({ robotIds })`
- **后端处理**：调用 `Monitor.GetBatchRobotAnalysis()`，内部调用：
  - `engine.Exchange.GetTicker()`：N次
  - `engine.Exchange.GetPositions()`：N次（可能使用缓存）
  - `engine.Exchange.GetBalance()`：N次（可能使用缓存）
- **调用次数**：**3N / 10 = 0.3N次/秒**（平均每秒）

#### 总计
- **每秒API调用**：`N + 0.3N = 1.3N次/秒`

---

## 五、综合统计

### 5.1 各模块每秒API调用汇总

| 模块 | API调用次数/秒 | 说明 |
|------|---------------|------|
| **MarketAnalyzer** | 0 | 使用缓存，不直接调用 |
| **MarketDataService** | 2.2M | Ticker + K线 |
| **ExchangeMarketService** | 2M | Ticker + K线（如果启用） |
| **机器人引擎（N个）** | 0.1634N | 持仓、订单、余额等 |
| **前端（机器人列表）** | 1.3N | 持仓 + 实时分析 |
| **总计** | **2.2M + 1.4634N** | 保守估计（只统计MarketDataService） |

---

### 5.2 典型场景分析

#### 场景1：小规模（N=5, M=3）
- **全局引擎**：2.2 × 3 = **6.6次/秒**
- **机器人引擎**：0.1634 × 5 = **0.82次/秒**
- **前端**：1.3 × 5 = **6.5次/秒**
- **总计**：**13.92次/秒**

#### 场景2：中规模（N=20, M=10）
- **全局引擎**：2.2 × 10 = **22次/秒**
- **机器人引擎**：0.1634 × 20 = **3.27次/秒**
- **前端**：1.3 × 20 = **26次/秒**
- **总计**：**51.27次/秒**

#### 场景3：大规模（N=50, M=20）
- **全局引擎**：2.2 × 20 = **44次/秒**
- **机器人引擎**：0.1634 × 50 = **8.17次/秒**
- **前端**：1.3 × 50 = **65次/秒**
- **总计**：**117.17次/秒**

---

## 六、优化建议

### 6.1 当前问题

1. **前端持仓数据高频轮询**
   - 每秒N次 `GetPositions` 调用
   - 建议：改为WebSocket推送

2. **全局引擎K线数据高频更新**
   - 每5秒更新6个周期的K线
   - 建议：优化更新策略，只更新变化的K线

3. **重复调用**
   - 前端和机器人引擎都调用 `GetPositions`
   - 建议：统一数据源，避免重复

### 6.2 优化后预期

#### 优化1：前端持仓数据WebSocket推送
- **优化前**：N次/秒
- **优化后**：0次/秒（WebSocket推送）
- **减少**：N次/秒

#### 优化2：前端实时分析WebSocket推送（已实现）
- **优化前**：3N / 10 = 0.3N次/秒
- **优化后**：3N / 100 = 0.03N次/秒（兜底降为每10秒）
- **减少**：0.27N次/秒

#### 优化后总计

| 场景 | 优化前 | 优化后 | 减少 |
|------|--------|--------|------|
| 小规模（N=5, M=3） | 13.92次/秒 | 7.15次/秒 | **48.6%** |
| 中规模（N=20, M=10） | 51.27次/秒 | 25.3次/秒 | **50.7%** |
| 大规模（N=50, M=20） | 117.17次/秒 | 57.17次/秒 | **51.2%** |

---

## 七、详细API调用清单

### 7.1 按API类型统计

| API类型 | 调用频率 | 调用来源 |
|---------|---------|---------|
| **GetTicker** | M次/秒 | MarketDataService |
| **GetKlines** | 1.2M次/秒 | MarketDataService（6周期/5秒） |
| **GetPositions** | N + 0.1N = 1.1N次/秒 | 前端(N) + 机器人引擎(0.1N) |
| **GetBalance** | 0.0167N次/秒 | 机器人引擎（事件驱动） |
| **GetOrderHistory** | 0.0083N次/秒 | 机器人引擎 |
| **CreateOrder** | 0.0167N次/秒 | 机器人引擎（事件驱动） |
| **ClosePosition** | 0.0033N次/秒 | 机器人引擎（事件驱动） |
| **SetLeverage** | 0.0167N次/秒 | 机器人引擎（事件驱动） |

### 7.2 按调用来源统计

| 调用来源 | 调用次数/秒 | 占比 |
|---------|------------|------|
| **全局引擎（MarketDataService）** | 2.2M | 主要来源 |
| **前端（机器人列表）** | 1.3N | 次要来源 |
| **机器人引擎** | 0.1634N | 较少 |
| **总计** | 2.2M + 1.4634N | 100% |

---

## 八、结论

### 8.1 主要API调用来源

1. **全局引擎K线更新**：占比较大（1.2M次/秒）
2. **前端持仓数据轮询**：占比较大（N次/秒）
3. **全局引擎Ticker更新**：中等（M次/秒）
4. **机器人引擎**：较少（0.1634N次/秒）

### 8.2 优化优先级

1. **高优先级**：前端持仓数据WebSocket推送（减少N次/秒）
2. **中优先级**：优化K线更新策略（减少重复更新）
3. **低优先级**：机器人引擎优化（调用量较少）

### 8.3 典型场景总结

- **小规模**：约14次/秒，优化后可降至7次/秒
- **中规模**：约51次/秒，优化后可降至25次/秒
- **大规模**：约117次/秒，优化后可降至57次/秒

---

**分析时间**：2025-01-XX  
**分析版本**：v1.0  
**假设条件**：基于当前代码实现和典型使用场景










