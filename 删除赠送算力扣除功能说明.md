# 删除赠送算力扣除功能 - 修改说明

## 修改时间
2025年12月5日

## 修改内容

### 一、核心逻辑修改

#### 1. 交易引擎算力消耗逻辑 (`server/internal/logic/toogo/engine.go`)

**修改前：**
- 优先从赠送算力（gift_power）扣除
- 赠送算力不足时再从购买算力（power）扣除
- 记录 `power_amount` 和 `gift_amount` 两个字段

**修改后：**
- 直接从购买算力（power）扣除
- 只记录 `power_amount` 字段
- 简化了扣费逻辑

#### 2. 钱包消耗接口 (`server/internal/logic/toogo/wallet.go`)

**修改前：**
```go
fromPower := consumePower
fromGiftPower := 0.0
// ... 复杂的分配逻辑
```

**修改后：**
```go
// 直接扣除算力
if consumePower > wallet.Power {
    return gerror.New("算力不足，请充值算力")
}
```

### 二、数据模型修改

#### 1. Entity 实体 (`server/internal/model/entity/toogo_power_consume.go`)
- 删除 `FromGiftPower` 字段

#### 2. DAO 数据访问层 (`server/internal/dao/internal/toogo_power_consume.go`)
- 删除 `FromGiftPower` 列定义

#### 3. 数据库表结构 (`server/storage/data/toogo_system.sql`)
- 删除 `from_gift_power` 字段定义

### 三、前端修改

#### 1. 机器人页面 (`web/src/views/toogo/robot/index-old-backup.vue`)
- 删除算力消耗列表中的"来自赠送"和"来自算力"两列
- 只保留总消耗算力显示

### 四、数据库迁移

创建了迁移脚本：`server/storage/data/remove_gift_power_consume.sql`

**执行方式：**
```bash
# 在数据库中执行
mysql -u用户名 -p密码 数据库名 < server/storage/data/remove_gift_power_consume.sql
```

**迁移内容：**
```sql
ALTER TABLE `hg_toogo_power_consume` DROP COLUMN IF EXISTS `from_gift_power`;
```

## 影响范围

### 1. 算力消耗计算
- ✅ 简化了算力扣除逻辑
- ✅ 提高了代码可维护性
- ✅ 所有消耗统一从 power 账户扣除

### 2. 数据完整性
- ⚠️ 历史数据中的 `from_gift_power` 字段将被删除
- ✅ 建议在删除字段前备份历史数据（如需要）

### 3. 功能变更
- **原功能：** 优先使用赠送算力，不足时使用购买算力
- **新功能：** 直接使用购买算力
- **积分账户：** gift_power 字段保留，但不再用于算力消耗

## 回滚方案

如需回滚此修改，执行以下SQL：

```sql
-- 恢复 from_gift_power 字段
ALTER TABLE `hg_toogo_power_consume` 
ADD COLUMN `from_gift_power` decimal(20,8) NOT NULL DEFAULT '0.00000000' 
COMMENT '从赠送算力扣除' AFTER `from_power`;
```

然后恢复相关代码文件的修改。

## 测试建议

1. **功能测试**
   - ✅ 测试机器人盈利订单算力扣除
   - ✅ 验证算力不足时的错误提示
   - ✅ 检查算力消耗记录是否正确保存

2. **数据测试**
   - ✅ 验证 `hg_toogo_power_consume` 表数据完整性
   - ✅ 检查前端算力消耗列表显示

3. **兼容性测试**
   - ✅ 确保现有机器人正常运行
   - ✅ 验证算力充值和转账功能

## 备注

- gift_power (积分账户) 功能保留，仅用于其他用途（如兑换、奖励等）
- 此修改不影响算力充值、转账等其他功能
- VIP折扣功能仍然有效
