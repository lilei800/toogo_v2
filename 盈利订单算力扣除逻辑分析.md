# 盈利订单算力扣除逻辑分析

## 一、问题回答

**问题**: 盈利订单会不会扣除算力？

**答案**: ✅ **会扣除算力**

**说明**: 
- **只有盈利订单才会扣除算力**
- **亏损订单不会扣除算力**
- 算力扣除发生在订单平仓后，根据**已实现盈亏（RealizedProfit）**计算

---

## 二、算力扣除逻辑

### 2.1 扣除时机

算力扣除发生在以下场景：

1. **自动平仓后** (`order_status_sync.go:436-448`)
   - 订单状态同步服务检测到订单已平仓
   - 如果 `realizedProfit > 0`，则扣除算力

2. **手动平仓后** (`order_sync.go:95-112`)
   - 用户手动平仓订单
   - 如果订单盈利，则扣除算力

### 2.2 扣除条件

```go
// 只有盈利订单才扣除算力
if realizedProfit > 0 {
    // 扣除算力
    service.ToogoWallet().ConsumePower(...)
}
```

**关键点**:
- ✅ `realizedProfit > 0`：盈利订单 → 扣除算力
- ❌ `realizedProfit <= 0`：亏损或平本订单 → **不扣除算力**

---

## 三、算力扣除计算方式

### 3.1 计算公式 (`wallet.go:239-327`)

```go
// 1. 获取消耗比例（默认10%）
consumeRate := 0.10  // 10%

// 2. 计算原始消耗算力
originalPower := profitAmount * consumeRate

// 3. 计算VIP折扣后的消耗
discountRate := toogoUser.PowerDiscount  // VIP折扣率
consumePower := originalPower * (1 - discountRate/100)
```

**示例**:
- 盈利金额：100 USDT
- 消耗比例：10%
- 原始算力：100 × 10% = 10 算力
- VIP折扣：5%
- 实际扣除：10 × (1 - 5%) = 9.5 算力

### 3.2 扣除流程

1. **检查算力是否足够**
   ```go
   if consumePower > wallet.Power {
       return gerror.New("算力不足，请充值算力")
   }
   ```

2. **扣除算力**（使用事务保证一致性）
   - 扣除用户算力账户
   - 更新累计消耗
   - 记录算力消耗明细
   - 触发佣金结算

3. **记录消耗明细** (`hg_toogo_power_consume` 表)
   - `profit_amount`: 盈利金额
   - `consume_rate`: 消耗比例（10%）
   - `consume_power`: 实际扣除算力
   - `original_power`: 原始算力（未折扣）
   - `discount_rate`: VIP折扣率

---

## 四、代码位置

### 4.1 算力扣除调用位置

1. **订单状态同步** (`order_status_sync.go:436-448`)
   ```go
   // 如果是盈利订单，消耗算力
   if realizedProfit > 0 {
       err = service.ToogoWallet().ConsumePower(ctx,
           order.UserId,
           order.RobotId,
           order.Id,
           order.OrderSn,
           realizedProfit,
       )
   }
   ```

2. **手动平仓同步** (`order_sync.go:95-112`)
   ```go
   // 调用钱包服务消耗算力
   err = service.ToogoWallet().ConsumePower(ctx,
       order.UserId,
       order.RobotId,
       order.Id,
       order.OrderSn,
       order.RealizedProfit,
   )
   ```

### 4.2 算力扣除实现 (`wallet.go:239-327`)

- **方法**: `ConsumePower`
- **功能**: 消耗算力（盈利订单扣除，只扣算力不扣积分）
- **参数**:
  - `userId`: 用户ID
  - `robotId`: 机器人ID
  - `orderId`: 订单ID
  - `orderSn`: 订单号
  - `profitAmount`: 盈利金额（USDT）

---

## 五、算力检查逻辑

### 5.1 下单前检查 (`robot_engine.go:3097-3117`)

```go
func (t *RobotTrader) checkPower(ctx context.Context) bool {
    // 检查用户算力
    totalPower := wallet.Power + wallet.GiftPower
    // 至少需要1点算力
    return totalPower >= 1
}
```

**说明**:
- 下单前检查算力是否充足（至少1点算力）
- 如果算力不足，无法下单
- **注意**: 下单前只检查算力是否充足，不扣除算力

### 5.2 算力扣除时机

- ✅ **下单前**: 只检查算力是否充足，不扣除
- ✅ **平仓后**: 如果订单盈利，扣除算力

---

## 六、特殊情况处理

### 6.1 算力不足处理

如果平仓后算力不足，系统会：

1. **记录警告日志**
   ```go
   g.Log().Warningf(ctx, "[OrderStatusSync] 消耗算力失败: orderId=%d, err=%v", order.Id, err)
   ```

2. **标记为欠费状态**（手动平仓场景）
   ```go
   s.recordDebt(ctx, order.UserId, order.Id, powerAmount, "手动平仓补扣算力不足")
   ```

### 6.2 订单状态标记

- `power_consumed`: 是否已扣除算力（1=已扣除，0=未扣除）
- `power_amount`: 应扣除的算力金额

---

## 七、总结

### 7.1 关键点

1. ✅ **只有盈利订单才扣除算力**
2. ✅ **亏损订单不扣除算力**
3. ✅ **算力扣除发生在平仓后**
4. ✅ **扣除比例**: 默认10%（可配置）
5. ✅ **VIP折扣**: 根据用户VIP等级享受折扣

### 7.2 扣除流程

```
订单平仓 → 计算已实现盈亏 → 如果盈利 > 0 → 扣除算力（盈利金额 × 10% × VIP折扣）
```

### 7.3 算力检查

```
下单前 → 检查算力是否充足（至少1点）→ 如果不足，无法下单
平仓后 → 如果盈利，扣除算力 → 如果算力不足，记录欠费
```

---

## 八、相关配置

### 8.1 消耗比例配置

- **默认值**: 10%
- **配置位置**: `wallet.go:249`
- **可配置**: 可通过配置表修改

### 8.2 VIP折扣配置

- **来源**: 用户VIP等级 (`toogo_user.power_discount`)
- **计算**: `consumePower = originalPower * (1 - discountRate/100)`

---

## 九、数据表

### 9.1 算力消耗记录表 (`hg_toogo_power_consume`)

| 字段 | 说明 |
|------|------|
| `profit_amount` | 盈利金额（USDT） |
| `consume_rate` | 消耗比例（默认10%） |
| `consume_power` | 实际扣除算力 |
| `original_power` | 原始算力（未折扣） |
| `discount_rate` | VIP折扣率 |
| `vip_level` | 用户VIP等级 |

---

## 十、结论

**盈利订单会扣除算力，亏损订单不会扣除算力。**

- ✅ 盈利订单：扣除算力（盈利金额 × 10% × VIP折扣）
- ❌ 亏损订单：不扣除算力
- ✅ 算力扣除发生在订单平仓后
- ✅ 下单前只检查算力是否充足，不扣除算力

