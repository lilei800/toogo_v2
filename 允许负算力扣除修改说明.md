# 允许负算力扣除修改说明

## 一、修改内容

### 1.1 核心修改

**需求**: 平仓后算力不足时，将算力扣除为负数（允许负算力），而不是阻止扣除或记录欠费。

### 1.2 修改位置

#### ✅ 1. `wallet.go:ConsumePower` (第267-268行)
- **修改前**: 检查算力是否足够，如果不足则返回错误
- **修改后**: 移除算力检查，允许扣除为负数
- **代码**:
  ```go
  // 【优化】允许算力扣除为负数，不检查算力是否足够
  // 平仓后即使算力不足，也会扣除算力（允许负算力）
  ```

#### ✅ 2. `wallet.go:ChangeBalance` (第103-109行)
- **修改前**: 算力账户扣除时检查 `afterAmount < 0`，如果为负数则返回错误
- **修改后**: 移除负数检查，允许算力为负数
- **代码**:
  ```go
  case "power":
      beforeAmount = wallet.Power
      afterAmount = beforeAmount + in.Amount
      // 【优化】允许算力为负数，不检查算力是否足够
      // 平仓后即使算力不足，也会扣除算力（允许负算力）
      updateField = dao.ToogoWallet.Columns().Power
  ```

#### ✅ 3. `order_sync.go` (第103-112行)
- **修改前**: 算力扣除失败时记录欠费状态
- **修改后**: 移除欠费记录逻辑，只记录警告日志
- **代码**:
  ```go
  if err != nil {
      // 【优化】算力扣除失败时记录日志，但不阻止扣除
      // 注意：由于已修改 ChangeBalance 允许负数，这里理论上不应该失败
      g.Log().Warningf(ctx, "[OrderSync] 用户 %d 订单 %s 扣除算力失败: %v",
          order.UserId, order.OrderSn, err)
      // 不再记录欠费，因为允许负算力
      return 0, err
  }
  ```

#### ✅ 4. `order_status_sync.go` (第445-448行)
- **修改前**: 算力扣除失败时只记录警告日志
- **修改后**: 增加成功日志，说明允许负数算力
- **代码**:
  ```go
  if err != nil {
      // 【优化】算力扣除失败时记录日志，但不阻止扣除
      // 注意：由于已修改 ChangeBalance 允许负数，这里理论上不应该失败
      g.Log().Warningf(ctx, "[OrderStatusSync] 消耗算力失败: orderId=%d, err=%v", order.Id, err)
  } else {
      // 记录扣除成功日志（包括负数算力的情况）
      g.Log().Infof(ctx, "[OrderStatusSync] 算力扣除成功: orderId=%d, profit=%.4f USDT", order.Id, realizedProfit)
  }
  ```

---

## 二、修改效果

### 2.1 修改前行为

1. **算力检查**: 扣除前检查算力是否足够
2. **不足处理**: 如果算力不足，返回错误，不扣除算力
3. **欠费记录**: 手动平仓场景下，记录欠费状态

### 2.2 修改后行为

1. **算力检查**: 不再检查算力是否足够
2. **负数允许**: 允许算力扣除为负数
3. **直接扣除**: 平仓后直接扣除算力，即使算力不足也会扣除

---

## 三、影响范围

### 3.1 受影响的功能

1. ✅ **盈利订单算力扣除**: 允许负算力扣除
2. ✅ **手动平仓算力扣除**: 允许负算力扣除
3. ✅ **自动平仓算力扣除**: 允许负算力扣除

### 3.2 不受影响的功能

1. ✅ **下单前算力检查**: 仍然检查算力是否充足（至少1点）
2. ✅ **其他账户类型**: 余额、积分、佣金等账户类型不受影响

---

## 四、注意事项

### 4.1 算力检查逻辑

- **下单前**: 仍然检查算力是否充足（至少1点），不足无法下单
- **平仓后**: 不再检查算力是否足够，允许扣除为负数

### 4.2 负数算力处理

- **允许负数**: 算力账户可以显示负数
- **后续充值**: 用户充值算力后，负数会逐渐减少
- **不影响功能**: 负数算力不影响其他功能（除了下单前的检查）

### 4.3 数据一致性

- **事务保证**: 算力扣除使用事务，保证数据一致性
- **记录完整**: 算力消耗明细仍然完整记录
- **累计消耗**: 累计消耗仍然正确更新

---

## 五、测试建议

### 5.1 功能测试

1. ✅ **盈利订单平仓**: 验证算力不足时能否扣除为负数
2. ✅ **手动平仓**: 验证手动平仓时算力不足能否扣除为负数
3. ✅ **自动平仓**: 验证自动平仓时算力不足能否扣除为负数

### 5.2 数据验证

1. ✅ **负数算力**: 验证算力账户可以显示负数
2. ✅ **算力扣除**: 验证扣除后的算力值是否正确
3. ✅ **消耗记录**: 验证算力消耗明细是否正确记录

### 5.3 边界测试

1. ✅ **算力为0**: 验证算力为0时扣除后是否为负数
2. ✅ **算力为负数**: 验证算力已为负数时继续扣除
3. ✅ **充值恢复**: 验证充值后负数算力是否正确恢复

---

## 六、总结

### 6.1 修改完成

✅ 所有相关代码已修改完成：
- `wallet.go:ConsumePower`: 移除算力检查
- `wallet.go:ChangeBalance`: 允许算力为负数
- `order_sync.go`: 移除欠费记录逻辑
- `order_status_sync.go`: 优化日志记录

### 6.2 功能说明

- ✅ **平仓后**: 允许算力扣除为负数
- ✅ **下单前**: 仍然检查算力是否充足
- ✅ **数据完整**: 算力消耗明细完整记录

### 6.3 后续建议

1. **前端显示**: 前端可以显示负数算力（红色显示）
2. **充值提醒**: 负数算力时可以提醒用户充值
3. **限制功能**: 可以考虑负数算力时限制某些功能

