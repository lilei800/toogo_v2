# Hotgo_v2 自动下单流程图

## 一、整体流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    定时任务触发 (每1-3秒)                        │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              1. 信号生成 (doSignalGeneration)                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  • 计算价格窗口 (WindowMinPrice, WindowMaxPrice)        │  │
│  │  • 计算当前价格与窗口极值的距离                          │  │
│  │  • 判断是否达到阈值 (SignalThreshold)                   │  │
│  │  • 生成信号: LONG / SHORT / NEUTRAL                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │ 信号方向变化? │
                    └───────┬───────┘
                            │ 是
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        2. 保存预警记录 (saveSignalAlertSimple)                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  • 保存信号信息到 hg_trading_signal_log                  │  │
│  │  • 返回 logId                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│    3. 触发自动下单检查 (TryAutoTradeAndUpdate) [异步执行]       │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │ 基础验证      │
                    └───────┬───────┘
                            │
                            ▼
                    ┌───────────────┐
                    │ 信号有效性?   │
                    │ • 非空        │
                    │ • 非NEUTRAL   │
                    │ • OPEN_LONG/  │
                    │   OPEN_SHORT  │
                    └───────┬───────┘
                            │ 通过
                            ▼
                    ┌───────────────┐
                    │ 防重复检查     │
                    │ • 预警记录已  │
                    │   下过单?     │
                    └───────┬───────┘
                            │ 未下单
                            ▼
                    ┌───────────────┐
                    │ 自动交易开关?  │
                    │ AutoTradeEnabled│
                    │ == 1?         │
                    └───────┬───────┘
                            │ 开启
                            ▼
                    ┌───────────────┐
                    │ 持仓检查       │
                    │ • 从交易所API │
                    │   获取持仓     │
                    │ • 该方向已有  │
                    │   持仓?       │
                    └───────┬───────┘
                            │ 无持仓
                            ▼
                    ┌───────────────┐
                    │ 获取锁         │
                    │ orderLock      │
                    └───────┬───────┘
                            │ 成功
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        4. 参数计算 (getStrategyParamsForTrade)                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 步骤1: 获取市场状态                                      │  │
│  │   • 从全局市场分析器获取                                │  │
│  │   • bullish / bearish / sideways                        │  │
│  │                                                          │  │
│  │ 步骤2: 选择风险偏好                                     │  │
│  │   • 根据市场状态从映射关系获取                          │  │
│  │   • conservative / moderate / aggressive                │  │
│  │                                                          │  │
│  │ 步骤3: 获取策略参数                                     │  │
│  │   • 根据市场状态+风险偏好从策略组获取                   │  │
│  │   • 杠杆、保证金比例、止损、止盈等                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        5. 执行下单 (executeOpen)                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 步骤1: 余额和行情检查                                    │  │
│  │   • AvailableBalance > 0                               │  │
│  │   • ticker != nil                                       │  │
│  │                                                          │  │
│  │ 步骤2: 计算下单参数                                      │  │
│  │   • margin = 余额 × 保证金比例                          │  │
│  │   • quantity = margin × 杠杆 / 当前价格                 │  │
│  │   • 检查最小订单金额 (≥ 5 USDT)                         │  │
│  │                                                          │  │
│  │ 步骤3: 预创建订单记录                                    │  │
│  │   • 在数据库中创建订单 (状态=PENDING)                   │  │
│  │   • 返回 localOrderId                                   │  │
│  │                                                          │  │
│  │ 步骤4: 设置杠杆                                          │  │
│  │   • Exchange.SetLeverage()                             │  │
│  │                                                          │  │
│  │ 步骤5: 调用交易所API下单                                 │  │
│  │   • Exchange.CreateOrder()                             │  │
│  │   • 类型: MARKET (市价单)                               │  │
│  │                                                          │  │
│  │ 步骤6: 更新订单状态                                      │  │
│  │   • 成功: OrderStatusOpen (持仓中)                      │  │
│  │   • 失败: OrderStatusFailed (下单失败)                  │  │
│  │                                                          │  │
│  │ 步骤7: 更新内存缓存                                      │  │
│  │   • PositionTrackers[positionSide]                      │  │
│  │   • CurrentPositions                                   │  │
│  │                                                          │  │
│  │ 步骤8: 记录执行日志                                      │  │
│  │   • order_submit / order_success / order_failed         │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │   下单完成    │
                    └───────────────┘
```

## 二、信号生成详细流程

```
价格数据流
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  计算价格窗口 (时间窗口内)                               │
│  • WindowMinPrice: 窗口最低价                           │
│  • WindowMaxPrice: 窗口最高价                           │
│  • CurrentPrice: 当前价格                               │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  计算距离                                                │
│  • distanceFromMin = CurrentPrice - WindowMinPrice     │
│  • distanceFromMax = WindowMaxPrice - CurrentPrice     │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │ 距离 ≥ 阈值?  │
                    └───────┬───────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                     │
        ▼                   ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ 做多信号      │   │ 做空信号      │   │ 中性信号      │
│ LONG          │   │ SHORT         │   │ NEUTRAL       │
│ distanceFrom  │   │ distanceFrom  │   │ 未达到阈值    │
│ Min ≥ 阈值    │   │ Max ≥ 阈值    │   │               │
└───────────────┘   └───────────────┘   └───────────────┘
```

## 三、下单检查详细流程

```
TryAutoTradeAndUpdate
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  基础验证                                                │
│  • robot != nil                                         │
│  • signal != nil                                        │
│  • signal.Direction != "NEUTRAL"                       │
│  • signal.Action == "OPEN_LONG" || "OPEN_SHORT"        │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  防重复检查                                              │
│  查询 hg_trading_execution_log                          │
│  WHERE signal_log_id = logId                            │
│  AND event_type IN ('order_submit', 'order_success')   │
│                                                          │
│  如果已存在 → 跳过                                       │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  自动交易开关检查                                        │
│  robot.AutoTradeEnabled == 1?                           │
│                                                          │
│  如果未开启 → 记录日志并返回                             │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  持仓检查 (实时)                                         │
│  Exchange.GetPositions(symbol)                         │
│                                                          │
│  遍历持仓:                                               │
│    if pos.PositionSide == positionSide                  │
│    && abs(pos.PositionAmt) > 0.0001                     │
│       → 已有持仓，跳过                                   │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  获取锁                                                  │
│  orderLock.TryLock()                                    │
│  最多重试5次，每次间隔10ms                               │
│                                                          │
│  如果获取失败 → 记录日志并返回                           │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
                    执行下单 (executeOpen)
```

## 四、参数计算详细流程

```
getStrategyParamsForTrade
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  步骤1: 获取市场状态                                     │
│  market.GetMarketAnalyzer().GetAnalysis()              │
│                                                          │
│  返回: bullish / bearish / sideways                     │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  步骤2: 选择风险偏好                                     │
│  从 robot.CurrentStrategy 中解析:                       │
│                                                          │
│  riskConfig.marketRiskMapping[marketState]              │
│                                                          │
│  返回: conservative / moderate / aggressive              │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  步骤3: 获取策略参数                                     │
│  loadFullStrategyParams(marketState, riskPreference)   │
│                                                          │
│  从策略组中查找匹配的策略:                               │
│    market_state = marketState                           │
│    AND risk_preference = riskPreference                 │
│                                                          │
│  返回策略参数:                                           │
│    • LeverageMin                                        │
│    • MarginPercentMin                                   │
│    • StopLossPercent                                    │
│    • AutoStartRetreatPercent                            │
│    • ProfitRetreatPercent                               │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
                    返回策略参数
```

## 五、执行下单详细流程

```
executeOpen
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  余额和行情检查                                          │
│  • balance.AvailableBalance > 0                        │
│  • ticker != nil                                        │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  计算下单参数                                            │
│  leverage = strategyParams.LeverageMin                 │
│  marginPercent = strategyParams.MarginPercentMin       │
│  margin = balance.AvailableBalance × marginPercent / 100│
│  quantity = margin × leverage / ticker.LastPrice      │
│                                                          │
│  检查:                                                   │
│    • orderValue = margin × leverage ≥ 5 USDT          │
│    • quantity ≥ 0.0001                                  │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  预创建订单记录                                          │
│  preCreateOrder()                                       │
│                                                          │
│  在数据库中创建订单:                                     │
│    • status = PENDING                                   │
│    • 保存所有订单信息                                    │
│                                                          │
│  返回: localOrderId                                      │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  设置杠杆                                                │
│  Exchange.SetLeverage(symbol, leverage)                │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│  调用交易所API下单                                       │
│  Exchange.CreateOrder({                                 │
│    Symbol: symbol,                                      │
│    Side: BUY/SELL,                                      │
│    PositionSide: LONG/SHORT,                            │
│    Type: MARKET,                                        │
│    Quantity: quantity                                   │
│  })                                                      │
└───────────────────────────┬─────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                     │
        ▼                   ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ API成功       │   │ API失败       │   │ API异常       │
│               │   │               │   │               │
│ 更新订单状态  │   │ 更新订单状态  │   │ 记录错误日志  │
│ → OPEN        │   │ → FAILED      │   │               │
│               │   │               │   │               │
│ 更新内存缓存  │   │ 记录失败日志  │   │ 返回错误      │
│               │   │               │   │               │
│ 记录成功日志  │   │ 返回错误      │   │               │
└───────────────┘   └───────────────┘   └───────────────┘
```

## 六、防重复下单机制

```
多层防护机制
    │
    ├─→ 预警记录级别
    │   └─→ 检查 hg_trading_execution_log
    │       WHERE signal_log_id = logId
    │       AND event_type IN ('order_submit', 'order_success')
    │
    ├─→ 持仓级别
    │   └─→ 从交易所API实时获取持仓
    │       IF 该方向已有持仓 → 跳过
    │
    ├─→ 信号时间戳级别
    │   └─→ 检查 signal.Timestamp > LastProcessedSignalTime
    │       IF 已处理 → 跳过
    │
    └─→ 锁机制级别
        └─→ orderLock.TryLock()
            IF 获取失败 → 跳过
```

## 七、订单状态流转

```
订单生命周期
    │
    ▼
┌──────────────┐
│  PENDING     │  预创建订单记录
│  (待成交)    │
└──────┬───────┘
       │
       ├──────────────────┐
       │                  │
       ▼                  ▼
┌──────────────┐  ┌──────────────┐
│  OPEN        │  │  FAILED      │
│  (持仓中)    │  │  (下单失败)   │
│              │  │              │
│ 交易所API成功│  │ 交易所API失败│
└──────┬───────┘  └──────────────┘
       │
       │ (平仓)
       ▼
┌──────────────┐
│  CLOSED      │
│  (已平仓)    │
└──────────────┘
```

## 八、关键时间点

```
T0: 定时任务触发
    │
    ├─→ T1: 信号生成 (doSignalGeneration)
    │       │
    │       ├─→ T2: 保存预警记录 (saveSignalAlertSimple)
    │       │       │
    │       │       └─→ T3: 触发自动下单检查 (TryAutoTradeAndUpdate) [异步]
    │       │               │
    │       │               ├─→ T4: 基础验证
    │       │               │
    │       │               ├─→ T5: 防重复检查
    │       │               │
    │       │               ├─→ T6: 自动交易开关检查
    │       │               │
    │       │               ├─→ T7: 持仓检查
    │       │               │
    │       │               ├─→ T8: 获取锁
    │       │               │
    │       │               └─→ T9: 执行下单 (executeOpen)
    │       │                       │
    │       │                       ├─→ T10: 参数计算 (getStrategyParamsForTrade)
    │       │                       │
    │       │                       ├─→ T11: 预创建订单记录
    │       │                       │
    │       │                       ├─→ T12: 设置杠杆
    │       │                       │
    │       │                       ├─→ T13: 调用交易所API
    │       │                       │
    │       │                       └─→ T14: 更新订单状态和内存缓存
    │       │
    │       └─→ (信号方向不变，不触发下单)
    │
    └─→ (等待下次定时任务)
```

## 九、错误处理流程

```
下单失败场景
    │
    ├─→ 余额不足
    │   └─→ 记录日志: "余额不足"
    │       └─→ 返回错误
    │
    ├─→ 订单金额不足 (< 5 USDT)
    │   └─→ 记录日志: "订单金额不足"
    │       └─→ 返回错误
    │
    ├─→ 策略参数获取失败
    │   └─→ 记录日志: "获取策略参数失败"
    │       └─→ 返回错误
    │
    ├─→ 预创建订单失败
    │   └─→ 记录日志: "预创建订单记录失败"
    │       └─→ 返回错误
    │
    ├─→ 交易所API失败
    │   └─→ 更新订单状态为 FAILED
    │       └─→ 记录日志: "交易所下单失败"
    │           └─→ 返回错误
    │
    └─→ 其他异常
        └─→ 记录错误日志
            └─→ 返回错误
```

## 十、数据流图

```
数据流向
    │
    ├─→ 输入数据
    │   ├─→ 价格数据 (ticker)
    │   ├─→ 账户余额 (balance)
    │   ├─→ 市场分析 (marketAnalysis)
    │   └─→ 机器人配置 (robot)
    │
    ├─→ 中间数据
    │   ├─→ 交易信号 (signal)
    │   ├─→ 策略参数 (strategyParams)
    │   ├─→ 下单参数 (quantity, margin, leverage)
    │   └─→ 订单记录 (order)
    │
    └─→ 输出数据
        ├─→ 预警记录 (hg_trading_signal_log)
        ├─→ 订单记录 (hg_trading_order)
        ├─→ 执行日志 (hg_trading_execution_log)
        └─→ 内存缓存 (CurrentPositions, PositionTrackers)
```

