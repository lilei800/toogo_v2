# 预警记录"准备下单"但未下单问题排查

## 问题描述

**现象**：
- 页面显示做空信号 ✅
- 预警记录显示"准备下单" ✅
- 持仓订单无数据 ❌

**说明**：预警记录已保存，但下单未成功。

---

## 可能原因分析

### 原因1：signal.Action 不是 OPEN_LONG 或 OPEN_SHORT

**问题**：
- 如果 `signal.Action` 不是 `OPEN_LONG` 或 `OPEN_SHORT`
- 之前会直接 `return`，**没有更新预警记录**
- 导致预警记录一直显示"准备下单"

**修复**：
```go
// 提前过滤：只处理开仓信号
if signal.Action != "OPEN_LONG" && signal.Action != "OPEN_SHORT" {
    if logId > 0 {
        t.updateSignalLog(ctx, logId, 0, fmt.Sprintf("信号类型为%s，不是开仓信号", signal.Action))
    }
    return
}
```

**状态**：✅ **已修复**

---

### 原因2：checkTradingConditions 检查失败

**可能失败的原因**：
1. 该方向已有持仓
2. 算力不足
3. 余额不足
4. 订单状态同步失败

**处理**：
- ✅ 会更新预警记录：`t.updateSignalLog(ctx, logId, 0, reason)`
- ✅ 预警记录会显示失败原因

**检查方法**：
- 查看预警记录的 `execute_result` 字段
- 应该显示具体的失败原因

---

### 原因3：获取锁失败

**问题**：
- 如果获取锁失败（50ms内未获取到）
- 会更新预警记录：`"系统繁忙，请稍后"`

**处理**：
- ✅ 会更新预警记录

**检查方法**：
- 查看预警记录的 `execute_result` 字段
- 应该显示"系统繁忙，请稍后"

---

### 原因4：下单执行失败

**问题**：
- `executeOpen()` 执行失败
- 会更新预警记录：`"下单失败: xxx"`

**处理**：
- ✅ 会更新预警记录

**检查方法**：
- 查看预警记录的 `execute_result` 字段
- 应该显示"下单失败: xxx"

---

## 排查步骤

### 步骤1：检查预警记录的 execute_result

**SQL查询**：
```sql
SELECT id, signal_type, execute_result, executed, created_at 
FROM hg_trading_signal_log 
WHERE robot_id = ? 
ORDER BY created_at DESC 
LIMIT 10;
```

**检查点**：
- 如果 `execute_result` 仍然是"准备下单" → 说明 `TryAutoTradeAndUpdate` 没有被调用或提前返回了
- 如果 `execute_result` 是其他值 → 说明下单失败，查看具体原因

---

### 步骤2：检查日志

**查看日志关键字**：
- `[RobotEngine] 准备尝试下单`
- `[RobotTrader] TryAutoTradeAndUpdate`
- `[RobotTrader] 条件变化，无法下单`
- `[RobotTrader] 下单失败`
- `[RobotTrader] 下单成功`

**分析**：
- 如果没有 `[RobotEngine] 准备尝试下单` → 说明 `logId = 0`，自动下单未开启
- 如果有 `[RobotTrader] TryAutoTradeAndUpdate` → 说明已调用下单方法
- 如果有 `[RobotTrader] 条件变化，无法下单` → 说明条件检查失败

---

### 步骤3：检查 signal.Action

**问题**：
- 如果 `signal.Action` 不是 `OPEN_LONG` 或 `OPEN_SHORT`
- 之前会直接返回，不更新预警记录

**修复后**：
- ✅ 现在会更新预警记录：`"信号类型为xxx，不是开仓信号"`

**检查方法**：
- 查看日志：`[RobotTrader] 信号类型不匹配: action=xxx`

---

## 修复内容

### 1. 修复 signal.Action 检查

**修改前**：
```go
if signal.Action != "OPEN_LONG" && signal.Action != "OPEN_SHORT" {
    return  // ❌ 没有更新预警记录
}
```

**修改后**：
```go
if signal.Action != "OPEN_LONG" && signal.Action != "OPEN_SHORT" {
    if logId > 0 {
        t.updateSignalLog(ctx, logId, 0, fmt.Sprintf("信号类型为%s，不是开仓信号", signal.Action))
    }
    g.Log().Warningf(ctx, "[RobotTrader] robotId=%d 信号类型不匹配: action=%s", robot.Id, signal.Action)
    return
}
```

### 2. 修复 signal 为空检查

**修改后**：
```go
if signal == nil || signal.Direction == "NEUTRAL" {
    if logId > 0 {
        t.updateSignalLog(ctx, logId, 0, "信号为空或中性")
    }
    return
}
```

### 3. 添加详细日志

**添加**：
```go
g.Log().Infof(ctx, "[RobotTrader] TryAutoTradeAndUpdate: robotId=%d, logId=%d, direction=%s, action=%s, autoTradeEnabled=%d",
    robot.Id, logId, signal.Direction, signal.Action, autoTradeEnabled)

g.Log().Infof(logCtx, "[RobotEngine] 准备尝试下单: robotId=%d, logId=%d, direction=%s, action=%s",
    e.Robot.Id, logId, signalCopy.Direction, signalCopy.Action)
```

---

## 下一步排查

### 1. 检查预警记录状态

查看最新的预警记录：
- `execute_result` 字段的值是什么？
- `executed` 字段的值是什么（0/1）？

### 2. 检查日志

查看服务器日志：
- 是否有 `[RobotEngine] 准备尝试下单`？
- 是否有 `[RobotTrader] TryAutoTradeAndUpdate`？
- 是否有 `[RobotTrader] 条件变化，无法下单`？
- 是否有 `[RobotTrader] 信号类型不匹配`？

### 3. 检查信号 Action

确认信号生成时 `Action` 是否正确设置：
- 做多信号：`Action = "OPEN_LONG"`
- 做空信号：`Action = "OPEN_SHORT"`

---

## 总结

**已修复的问题**：
- ✅ signal.Action 检查时未更新预警记录
- ✅ signal 为空时未更新预警记录
- ✅ 添加详细日志便于排查

**排查建议**：
1. 查看预警记录的 `execute_result` 字段
2. 查看服务器日志
3. 确认信号的 `Action` 是否正确

**如果预警记录仍然是"准备下单"**：
- 说明 `TryAutoTradeAndUpdate` 没有被调用或提前返回了
- 检查日志中的 `[RobotEngine] 准备尝试下单` 是否有输出
- 检查 `logId` 是否为 0（自动下单未开启）

