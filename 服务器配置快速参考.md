# 服务器配置快速参考

## 一、快速配置表

| 机器人数量 | CPU | 内存 | 磁盘 | 网络 | 成本/月 | 推荐度 |
|-----------|-----|------|------|------|--------|--------|
| 100-500 | 4核8线程 | 8GB | 50GB SSD | 10Mbps | $20-50 | ⭐⭐⭐ |
| 500-1500 | 8核16线程 | 16GB | 100GB SSD | 50Mbps | $50-150 | ⭐⭐⭐⭐⭐ |
| 1500-3000 | 16核32线程 | 32GB | 200GB SSD | 100Mbps | $150-400 | ⭐⭐⭐⭐ |
| 3000+ | 32核64线程 | 64GB | 500GB SSD | 200Mbps | $400-1000 | ⭐⭐⭐ |

---

## 二、资源消耗估算

### 单个机器人引擎

- **内存**：~810KB
- **Goroutine**：1个常驻 + 0-4个临时（平均1-2个）
- **CPU**：~0.5-1%单核
- **数据库QPS**：~0.1-0.3次/秒
- **API调用**：~0.1-0.3次/秒

---

### 1000个机器人

- **内存**：~810MB（机器人）+ 52MB（全局服务）= ~862MB
- **Goroutine**：~2000-3000个（平均）
- **CPU**：~5-10核（8核服务器，占用62.5-125%）
- **数据库QPS**：~100-300次/秒
- **API调用**：~100-300次/秒

---

## 三、关键限制

### 3.1 内存限制

- **单机最大支持**：~3000-5000个机器人（取决于内存）
- **推荐配置**：1500个机器人（预留50%余量）

---

### 3.2 CPU限制

- **单机最大支持**：~2000-3000个机器人（取决于CPU）
- **推荐配置**：1500个机器人（预留50%余量）

---

### 3.3 数据库限制

- **MySQL默认连接数**：151
- **推荐配置**：50-100个连接
- **优化**：使用连接池，批量查询

---

### 3.4 交易所API限制

- **Binance**：1200次/分钟 = 20次/秒
- **Bitget**：600次/分钟 = 10次/秒
- **优化**：全局行情服务（共享订阅），API频率限制器

---

## 四、推荐配置（最佳实践）

### 4.1 生产环境推荐

**配置**：8核16线程 + 16GB内存 + 100GB SSD + 50Mbps

**支持能力**：
- **推荐**：500-1500个机器人
- **最大**：2000个机器人（需要优化）

**资源使用**：
- CPU占用：~20-60%
- 内存占用：~550MB-1.6GB
- Goroutine数量：~1500-4500个

**成本**：$50-150/月

---

### 4.2 开发/测试环境

**配置**：4核8线程 + 8GB内存 + 50GB SSD + 10Mbps

**支持能力**：
- **推荐**：100-500个机器人
- **最大**：800个机器人

**资源使用**：
- CPU占用：~5-20%
- 内存占用：~250-550MB
- Goroutine数量：~200-1500个

**成本**：$20-50/月

---

## 五、监控指标

### 5.1 关键指标

| 指标 | 正常范围 | 警告阈值 | 严重阈值 |
|------|---------|---------|---------|
| CPU使用率 | < 60% | > 70% | > 90% |
| 内存使用率 | < 60% | > 70% | > 90% |
| Goroutine数量 | < 5000 | > 8000 | > 15000 |
| 数据库连接数 | < 80 | > 80 | > 120 |
| API请求速率 | < 15次/秒 | > 15次/秒 | > 18次/秒 |

---

## 六、优化建议

### 6.1 立即优化

1. ✅ **限制价格窗口大小**（已优化：10000个点）
2. ✅ **限制信号历史大小**（已优化：100条）
3. ✅ **统一主循环**（已优化：减少75% goroutine）
4. 🔄 **API调用频率限制器**（待实施）
5. 🔄 **数据库连接池配置**（待实施）

---

### 6.2 近期优化

1. 🔄 **批量数据库查询**
2. 🔄 **异步执行市场分析**
3. 🔄 **压缩历史数据**

---

### 6.3 长期规划

1. 🔄 **分布式架构**
2. 🔄 **负载均衡**
3. 🔄 **性能监控系统**

---

## 七、快速检查清单

### 7.1 部署前检查

- [ ] CPU：8核16线程（推荐）或更高
- [ ] 内存：16GB（推荐）或更高
- [ ] 磁盘：100GB SSD（推荐）或更高
- [ ] 网络：50Mbps（推荐）或更高
- [ ] 数据库：MySQL 5.7+，连接池配置50-100
- [ ] Go版本：1.18+

---

### 7.2 运行中检查

- [ ] CPU使用率 < 70%
- [ ] 内存使用率 < 70%
- [ ] Goroutine数量 < 8000
- [ ] 数据库连接数 < 80
- [ ] API请求速率 < 15次/秒

---

## 八、故障排查

### 8.1 CPU使用率过高

**可能原因**：
- 机器人数量过多
- 市场分析耗时过长
- 数据库查询频繁

**解决方案**：
- 减少机器人数量
- 优化市场分析算法
- 使用批量查询

---

### 8.2 内存使用率过高

**可能原因**：
- 价格窗口未限制
- 信号历史未限制
- 内存泄漏

**解决方案**：
- ✅ 已优化：限制价格窗口和信号历史
- 检查是否有内存泄漏
- 重启服务

---

### 8.3 Goroutine数量过多

**可能原因**：
- 临时goroutine未回收
- 并发操作过多

**解决方案**：
- ✅ 已优化：统一主循环
- 检查临时goroutine是否正常回收
- 限制并发数

---

### 8.4 数据库连接耗尽

**可能原因**：
- 连接池配置过小
- 连接未正确释放

**解决方案**：
- 增加连接池大小
- 检查连接是否正确释放
- 使用批量查询

---

## 九、总结

### 9.1 推荐配置

**生产环境**：8核16线程 + 16GB内存（支持500-1500个机器人）

**开发环境**：4核8线程 + 8GB内存（支持100-500个机器人）

### 9.2 关键指标

- **单个机器人**：~810KB内存，1-2个goroutine，~0.5-1%单核CPU
- **1000个机器人**：~862MB内存，~2000-3000个goroutine，~5-10核CPU
- **单机最大支持**：2000-3000个机器人（推荐1500个）

### 9.3 优化状态

- ✅ **已完成**：价格窗口限制、信号历史限制、统一主循环、panic恢复、健康检查
- 🔄 **待实施**：API频率限制、数据库连接池、批量查询、异步分析

