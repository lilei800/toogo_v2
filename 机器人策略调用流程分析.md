# 机器人策略调用流程分析

## 一、机器人生命周期概览

```
创建 → 启动 → 运行 → 停用
  ↓      ↓      ↓      ↓
策略绑定  引擎初始化  策略调用  资源清理
```

## 二、详细流程分析

### 2.1 创建阶段（Create）

**位置：** `server/internal/logic/trading/robot.go::Create()`

**流程：**

1. **验证API配置**
   ```go
   dao.TradingApiConfig.Ctx(ctx).WherePri(in.ApiConfigId).Scan(&apiConfig)
   ```

2. **获取推荐策略（已废弃，但仍保留）**
   ```go
   strategy, err := s.GetRecommendStrategy(ctx, in.RiskPreference, in.MarketState)
   ```
   - 注意：这个函数已不再使用，但代码仍保留

3. **保存策略组ID**
   ```go
   if in.StrategyGroupId > 0 {
       dataMap["strategy_group_id"] = in.StrategyGroupId
   }
   ```
   - **关键：** 策略组ID存储在 `hg_trading_robot.strategy_group_id` 字段
   - 这是后续加载策略模板的关键

4. **保存CurrentStrategy JSON**
   ```go
   CurrentStrategy: string(strategyJSON)
   ```
   - 存储映射关系（`riskConfig.marketRiskMapping`）
   - 存储其他配置信息

5. **插入数据库**
   ```go
   dao.TradingRobot.Ctx(ctx).Data(data).Data(dataMap).InsertAndGetId()
   ```

**关键数据：**
- `strategy_group_id`: 策略组ID（用于查询策略模板）
- `CurrentStrategy`: JSON格式的策略配置（包含映射关系）
- `RiskPreference`: 风险偏好（默认值，运行时会被映射关系覆盖）

---

### 2.2 启动阶段（Start）

**位置：** `server/internal/logic/toogo/robot_task_manager.go::syncRobots()`

**流程：**

1. **定时同步检查（每5秒）**
   ```go
   ticker := time.NewTicker(5 * time.Second)
   m.syncRobots(ctx)
   ```

2. **查询运行中的机器人**
   ```go
   dao.TradingRobot.Ctx(ctx).Where("status", 2).Scan(&robots)
   ```

3. **初始化引擎（新机器人）**
   ```go
   engine, err := m.initRobotEngine(ctx, robot)
   ```

4. **启动引擎**
   ```go
   engine.Start(ctx)
   ```

**初始化引擎（initRobotEngine）：**

**位置：** `server/internal/logic/toogo/robot_task_manager.go::initRobotEngine()`

**流程：**

1. **获取API配置**
   ```go
   dao.TradingApiConfig.Ctx(ctx).WherePri(robot.ApiConfigId).Scan(&apiConfig)
   ```

2. **获取交易所实例**
   ```go
   ex, err := GetExchangeManager().GetExchangeFromConfig(ctx, apiConfig)
   ```

3. **创建引擎**
   ```go
   engine := NewRobotEngine(ctx, robot, apiConfig, ex)
   ```

**创建引擎（NewRobotEngine）：**

**位置：** `server/internal/logic/toogo/robot_engine.go::NewRobotEngine()`

**流程：**

1. **初始化基础结构**
   ```go
   engine := &RobotEngine{
       Robot:            robot,
       APIConfig:        apiConfig,
       Platform:         apiConfig.Platform,
       Exchange:         ex,
       PositionTrackers: make(map[string]*PositionTracker),
       // ...
   }
   ```

2. **初始化监控配置（默认值）**
   ```go
   engine.MonitorConfig = &MonitorConfig{
       Symbol:    robot.Symbol,
       Window:    60,  // 默认60秒窗口
       Threshold: 10,  // 默认10 USDT阈值
   }
   ```

3. **加载风险映射（当前已废弃）**
   ```go
   engine.loadRiskConfigFromRobot(ctx)
   ```
   - **注意：** 当前这个函数只是打印日志，没有实际加载映射关系
   - **问题：** 映射关系没有被加载到引擎中

4. **初始化各模块**
   ```go
   engine.Analyzer = NewRobotAnalyzer(engine)
   engine.SignalGen = NewRobotSignalGen(engine)
   engine.Trader = NewRobotTrader(engine)
   ```

**启动引擎（Start）：**

**位置：** `server/internal/logic/toogo/robot_engine.go::Start()`

**流程：**

1. **订阅行情**
   ```go
   market.GetMarketServiceManager().Subscribe(ctx, e.Platform, e.Robot.Symbol, e.Exchange)
   ```

2. **启动主循环**
   ```go
   go e.runMainLoop(ctx)
   ```

**主循环（runMainLoop）：**

**位置：** `server/internal/logic/toogo/robot_engine.go::runMainLoop()`

**流程（每500ms执行一次）：**

1. **市场分析**
   ```go
   e.doAnalysis(ctx)
   ```

2. **信号生成**
   ```go
   e.doSignalGeneration(ctx)
   ```

3. **交易检查**
   ```go
   e.doTradingCheck(ctx)
   ```

4. **定期同步账户数据（每10秒）**
   ```go
   if tickCount % 20 == 0 {
       e.syncAccountDataIfNeeded(ctx, "periodic")
   }
   ```

---

### 2.3 运行阶段（策略调用）

#### 2.3.1 市场分析（doAnalysis）

**位置：** `server/internal/logic/toogo/robot_engine.go::doAnalysis()`

**流程：**

1. **获取行情数据**
   ```go
   ticker := market.GetMarketServiceManager().GetTicker(e.Platform, e.Robot.Symbol)
   ```

2. **获取K线数据**
   ```go
   klines := market.GetMarketServiceManager().GetMultiTimeframeKlines(e.Platform, e.Robot.Symbol)
   ```

3. **执行分析**
   ```go
   analysis := e.Analyzer.Analyze(ctx)
   ```

4. **检测市场状态变化并更新策略配置**
   ```go
   e.checkAndUpdateStrategyConfig(ctx, analysis.MarketState)
   ```

**关键函数：checkAndUpdateStrategyConfig**

**位置：** `server/internal/logic/toogo/robot_engine.go::checkAndUpdateStrategyConfig()`

**流程：**

1. **检查是否需要更新**
   ```go
   needUpdate := e.LastMarketState == "" || currentMarketState != e.LastMarketState
   ```

2. **获取风险偏好（当前问题：直接使用机器人配置）**
   ```go
   riskPreference := e.Robot.RiskPreference
   if riskPreference == "" {
       riskPreference = "balanced"
   }
   ```
   - **问题：** 没有使用映射关系，直接使用机器人配置的风险偏好
   - **应该：** 从 `MarketRiskMapping` 中根据市场状态获取风险偏好

3. **加载策略参数**
   ```go
   strategyParams, err := e.loadFullStrategyParams(ctx, currentMarketState, riskPreference)
   ```

4. **更新当前策略参数**
   ```go
   e.CurrentStrategyParams = strategyParams
   ```

5. **更新监控配置**
   ```go
   e.UpdateMonitorConfig(strategyParams.Window, strategyParams.Threshold)
   ```

**关键函数：loadFullStrategyParams**

**位置：** `server/internal/logic/toogo/robot_engine.go::loadFullStrategyParams()`

**流程：**

1. **获取策略组ID**
   ```go
   // 优先级1：机器人绑定的策略组ID
   if e.Robot.StrategyGroupId > 0 {
       groupId = e.Robot.StrategyGroupId
   }
   // 优先级2：从CurrentStrategy JSON中获取
   if groupId == 0 && e.Robot.CurrentStrategy != "" {
       // 解析JSON获取group_id
   }
   ```

2. **查询策略模板**
   ```go
   dao.TradingStrategyTemplate.Ctx(ctx).
       Where("group_id", groupId).
       Where("market_state", ms).  // 尝试多种格式
       Where("risk_preference", riskPreference).
       Scan(&strategy)
   ```

3. **加载策略参数**
   ```go
   params.Window = strategy.MonitorWindow
   params.Threshold = strategy.VolatilityThreshold
   params.LeverageMin = strategy.Leverage
   params.LeverageMax = strategy.Leverage
   params.MarginPercentMin = strategy.MarginPercent
   params.MarginPercentMax = strategy.MarginPercent
   params.StopLossPercent = strategy.StopLossPercent
   params.ProfitRetreatPercent = strategy.ProfitRetreatPercent
   params.AutoStartRetreatPercent = strategy.AutoStartRetreatPercent
   ```

4. **加载反向阈值（从config_json）**
   ```go
   reverseThresholds := e.loadReverseThresholdsFromStrategy(strategy, marketState)
   params.ReverseLossRetreat = reverseThresholds.LossRetreat
   params.ReverseProfitRetreat = reverseThresholds.ProfitRetreat
   ```

**数据来源：**
- **策略组ID：** `hg_trading_robot.strategy_group_id`
- **策略模板：** `hg_trading_strategy_template` 表
- **查询条件：** `group_id` + `market_state` + `risk_preference`

---

#### 2.3.2 信号生成（doSignalGeneration）

**位置：** `server/internal/logic/toogo/robot_engine.go::doSignalGeneration()`

**流程：**

1. **生成信号**
   ```go
   signal := e.SignalGen.Generate(ctx)
   ```

2. **评估窗口信号**
   ```go
   e.EvaluateWindowSignal()
   ```
   - 使用 `MonitorConfig.Window` 和 `MonitorConfig.Threshold`
   - 这些值来自策略模板的 `MonitorWindow` 和 `VolatilityThreshold`

3. **保存信号预警**
   ```go
   logId := e.saveSignalAlert(&signalCopy, isNewDirection)
   ```

4. **尝试自动交易**
   ```go
   e.Trader.TryAutoTradeAndUpdate(checkCtx, &signalCopy, logId)
   ```

---

#### 2.3.3 交易检查（doTradingCheck）

**位置：** `server/internal/logic/toogo/robot_engine.go::doTradingCheck()`

**流程：**

1. **检查平仓**
   ```go
   go e.checkClosePosition(ctx)
   e.Trader.CheckAndClosePosition(ctx)
   ```

2. **检查开仓**
   ```go
   go e.checkOpenPosition(ctx)
   e.Trader.CheckAndOpenPosition(ctx)
   ```

---

#### 2.3.4 开仓执行（executeOpen）

**位置：** `server/internal/logic/toogo/robot_engine.go::executeOpen()`

**流程：**

1. **获取策略参数**
   ```go
   e.mu.RLock()
   strategyParams := e.CurrentStrategyParams
   e.mu.RUnlock()
   
   // 如果策略参数为空，尝试重新加载
   if strategyParams == nil {
       // 重新加载策略参数
       strategyParams, err = e.loadFullStrategyParams(ctx, marketState, riskPreference)
   }
   ```

2. **检查策略参数**
   ```go
   if strategyParams == nil {
       return gerror.New("策略参数未加载，无法下单")
   }
   ```

3. **计算杠杆和保证金**
   ```go
   leverage := strategyParams.LeverageMin  // 使用策略模板的杠杆
   marginPercent := strategyParams.MarginPercentMin  // 使用策略模板的保证金比例
   ```

4. **计算下单数量**
   ```go
   margin := balance.AvailableBalance * (marginPercent / 100)
   quantity := (margin * leverage) / currentPrice
   ```

5. **下单**
   ```go
   order, err := e.Exchange.OpenPosition(ctx, &exchange.OpenPositionRequest{
       Symbol:       e.Robot.Symbol,
       Side:         side,
       OrderType:    e.Robot.OrderType,
       MarginMode:   e.Robot.MarginMode,
       Leverage:     leverage,
       Quantity:     quantity,
   })
   ```

6. **记录订单**
   ```go
   e.recordOrder(ctx, order, signal, strategyParams, leverage, marginPercent)
   ```
   - 保存策略参数到订单表：
     - `stop_loss_percent`
     - `auto_start_retreat_percent`
     - `profit_retreat_percent`
     - `margin_percent`

**关键数据来源：**
- **杠杆：** `strategyParams.LeverageMin`（来自策略模板）
- **保证金比例：** `strategyParams.MarginPercentMin`（来自策略模板）
- **止损：** `strategyParams.StopLossPercent`（来自策略模板）
- **启动止盈：** `strategyParams.AutoStartRetreatPercent`（来自策略模板）
- **止盈回撤：** `strategyParams.ProfitRetreatPercent`（来自策略模板）

---

#### 2.3.5 平仓执行（executeClose）

**位置：** `server/internal/logic/toogo/robot_engine.go::executeClose()`

**流程：**

1. **获取策略参数（用于止损止盈判断）**
   ```go
   // 从订单记录中获取策略参数（优先级最高）
   // 如果订单中没有，从策略模板获取
   // 如果策略模板中没有，使用机器人配置
   ```

2. **判断是否应该平仓**
   ```go
   shouldClose, reason := e.shouldClose(ctx, pos)
   ```

3. **执行平仓**
   ```go
   order, err := e.Exchange.ClosePosition(ctx, &exchange.ClosePositionRequest{
       Symbol: e.Robot.Symbol,
       Side:   pos.PositionSide,
   })
   ```

---

### 2.4 停用阶段（Stop）

**位置：** `server/internal/logic/toogo/robot_task_manager.go::syncRobots()`

**流程：**

1. **检测已停止的机器人**
   ```go
   for robotId, engine := range m.engines {
       if !activeIds[robotId] {
           engine.Stop()
           delete(m.engines, robotId)
       }
   }
   ```

2. **停止引擎**
   ```go
   e.Stop()
   ```

**停止引擎（Stop）：**

**位置：** `server/internal/logic/toogo/robot_engine.go::Stop()`

**流程：**

1. **设置运行状态**
   ```go
   e.running = false
   close(e.stopCh)
   ```

2. **取消订阅行情**
   ```go
   market.GetMarketServiceManager().Unsubscribe(e.Platform, e.Robot.Symbol)
   ```

3. **清理资源**
   - 主循环自动退出（检测到 `stopCh` 关闭）
   - 各模块自动停止

---

## 三、策略调用路径总结

### 3.1 策略参数加载路径

```
机器人创建
  ↓
保存 strategy_group_id 到数据库
  ↓
机器人启动
  ↓
引擎初始化（NewRobotEngine）
  ↓
市场分析（doAnalysis）
  ↓
检测市场状态变化（checkAndUpdateStrategyConfig）
  ↓
加载策略参数（loadFullStrategyParams）
  ↓
查询策略模板（hg_trading_strategy_template）
  ↓
更新 CurrentStrategyParams
```

### 3.2 下单时策略参数使用路径

```
信号生成（doSignalGeneration）
  ↓
交易检查（doTradingCheck）
  ↓
开仓检查（CheckAndOpenPosition）
  ↓
执行开仓（executeOpen）
  ↓
获取 CurrentStrategyParams
  ↓
使用策略参数：
  - LeverageMin → 杠杆
  - MarginPercentMin → 保证金比例
  - StopLossPercent → 止损
  - AutoStartRetreatPercent → 启动止盈
  - ProfitRetreatPercent → 止盈回撤
  ↓
下单并保存策略参数到订单表
```

### 3.3 平仓时策略参数使用路径

```
交易检查（doTradingCheck）
  ↓
平仓检查（CheckAndClosePosition）
  ↓
判断是否平仓（shouldClose）
  ↓
获取策略参数（优先级）：
  1. 订单记录中的策略参数（hg_trading_order）
  2. 策略模板参数（hg_trading_strategy_template）
  3. 机器人配置参数（hg_trading_robot）
  ↓
执行平仓（executeClose）
```

---

## 四、关键数据表

### 4.1 hg_trading_robot（机器人表）

**关键字段：**
- `strategy_group_id`: 策略组ID（用于查询策略模板）
- `CurrentStrategy`: JSON格式的策略配置（包含映射关系）
- `RiskPreference`: 风险偏好（默认值）

### 4.2 hg_trading_strategy_group（策略组表）

**关键字段：**
- `id`: 策略组ID
- `group_name`: 策略组名称
- `exchange`: 交易平台
- `symbol`: 交易对

### 4.3 hg_trading_strategy_template（策略模板表）

**关键字段：**
- `group_id`: 策略组ID
- `market_state`: 市场状态（trend/volatile/high_vol/low_vol）
- `risk_preference`: 风险偏好（conservative/balanced/aggressive）
- `monitor_window`: 监控窗口（秒）
- `volatility_threshold`: 波动阈值（USDT）
- `leverage`: 杠杆倍数
- `margin_percent`: 保证金比例（%）
- `stop_loss_percent`: 止损百分比（%）
- `auto_start_retreat_percent`: 启动止盈百分比（%）
- `profit_retreat_percent`: 止盈回撤百分比（%）
- `config_json`: 其他配置（JSON，包含反向阈值）

### 4.4 hg_trading_order（订单表）

**关键字段：**
- `robot_id`: 机器人ID
- `stop_loss_percent`: 止损百分比（下单时保存）
- `auto_start_retreat_percent`: 启动止盈百分比（下单时保存）
- `profit_retreat_percent`: 止盈回撤百分比（下单时保存）
- `margin_percent`: 保证金比例（下单时保存）

---

## 五、当前问题

### 5.1 映射关系未加载

**问题：** `loadRiskConfigFromRobot()` 函数已废弃，没有实际加载映射关系

**影响：** 市场状态变化时，风险偏好不会根据映射关系自动切换

**解决方案：** 实现 `loadRiskConfigFromRobot()` 函数，从 `CurrentStrategy` JSON 中加载映射关系

### 5.2 风险偏好未使用映射关系

**问题：** `checkAndUpdateStrategyConfig()` 直接使用 `Robot.RiskPreference`，没有使用映射关系

**影响：** 市场状态变化时，风险偏好不会自动切换

**解决方案：** 修改 `checkAndUpdateStrategyConfig()`，从 `MarketRiskMapping` 中根据市场状态获取风险偏好

---

## 六、策略调用流程图

```
┌─────────────────────────────────────────────────────────────┐
│                     机器人创建阶段                           │
├─────────────────────────────────────────────────────────────┤
│ 1. 保存 strategy_group_id 到数据库                         │
│ 2. 保存 CurrentStrategy JSON（包含映射关系）                │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                     机器人启动阶段                           │
├─────────────────────────────────────────────────────────────┤
│ 1. 初始化引擎（NewRobotEngine）                            │
│ 2. 启动主循环（runMainLoop）                                │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                     市场分析循环                             │
├─────────────────────────────────────────────────────────────┤
│ doAnalysis()                                                │
│   ↓                                                          │
│ Analyzer.Analyze() → 分析市场状态                           │
│   ↓                                                          │
│ checkAndUpdateStrategyConfig()                              │
│   ↓                                                          │
│ loadFullStrategyParams()                                   │
│   ↓                                                          │
│ 查询策略模板（hg_trading_strategy_template）                │
│   ↓                                                          │
│ 更新 CurrentStrategyParams                                  │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                     信号生成循环                             │
├─────────────────────────────────────────────────────────────┤
│ doSignalGeneration()                                        │
│   ↓                                                          │
│ SignalGen.Generate() → 生成方向信号                         │
│   ↓                                                          │
│ EvaluateWindowSignal() → 使用 MonitorConfig                │
│   ↓                                                          │
│ TryAutoTradeAndUpdate()                                     │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                     交易检查循环                             │
├─────────────────────────────────────────────────────────────┤
│ doTradingCheck()                                            │
│   ├─→ CheckAndOpenPosition()                               │
│   │     ↓                                                    │
│   │   executeOpen()                                         │
│   │     ↓                                                    │
│   │   使用 CurrentStrategyParams:                           │
│   │     - LeverageMin → 杠杆                                │
│   │     - MarginPercentMin → 保证金比例                     │
│   │     ↓                                                    │
│   │   下单并保存策略参数到订单表                             │
│   │                                                          │
│   └─→ CheckAndClosePosition()                                │
│         ↓                                                    │
│       shouldClose()                                          │
│         ↓                                                    │
│       获取策略参数（订单 → 模板 → 机器人配置）              │
│         ↓                                                    │
│       executeClose()                                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 七、总结

### 7.1 策略调用核心路径

1. **策略组绑定：** 创建时保存 `strategy_group_id`
2. **策略参数加载：** 市场状态变化时，根据 `strategy_group_id` + `market_state` + `risk_preference` 查询策略模板
3. **策略参数使用：** 下单时使用 `CurrentStrategyParams`，平仓时优先使用订单记录中的策略参数

### 7.2 数据流向

```
hg_trading_strategy_template（策略模板）
  ↓
CurrentStrategyParams（引擎缓存）
  ↓
hg_trading_order（订单记录）
  ↓
平仓判断（shouldClose）
```

### 7.3 关键改进点

1. **实现映射关系加载：** `loadRiskConfigFromRobot()` 需要实际加载映射关系
2. **使用映射关系：** `checkAndUpdateStrategyConfig()` 需要使用映射关系获取风险偏好
3. **统一市场状态格式：** 创建 `normalizeMarketState()` 函数统一市场状态格式

